<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shopping List üõí</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 1rem;
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    input[type="text"], input[type="number"], select, button {
      width: calc(100% - 20px);
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      background-color: #E75480;
      color: white;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #D4426A;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #f9f9f9;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      flex-wrap: wrap; /* Permet aux √©l√©ments de passer √† la ligne */
    }
    li.bought {
      text-decoration: line-through;
      color: #888;
      background-color: #e9e9e9;
    }
    .item-info {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .item-actions {
      display: flex;
      gap: 0.5rem; /* Espace entre les boutons */
      margin-top: 0.5rem; /* Espace si les boutons passent en dessous */
    }
    .item-actions button {
      width: auto;
      padding: 0.5rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 0.4rem;
      margin-bottom: 0; /* Override default button margin */
    }
    .item-actions .remove-btn {
      background-color: #f44336;
    }
    .item-actions .remove-btn:hover {
      background-color: #d32f2f;
    }
    .item-actions .buy-btn {
      background-color: #4CAF50;
    }
    .item-actions .buy-btn:hover {
      background-color: #45a049;
    }
    .item-actions .undo-btn {
      background-color: #ff9800;
    }
    .item-actions .undo-btn:hover {
      background-color: #e68a00;
    }
    .quantity-control {
        display: flex;
        align-items: center;
        gap: 0.2rem;
        margin-left: 0.5rem;
    }
    .quantity-control button {
        width: 30px;
        height: 30px;
        padding: 0;
        font-size: 1.2rem;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #ddd;
        color: #333;
    }
    .quantity-control button:hover {
        background-color: #ccc;
    }
    .quantity-control span {
        min-width: 20px;
        text-align: center;
        font-weight: bold;
    }

    .tab-buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .tab-buttons button {
      flex: 1;
      margin: 0 0.2rem;
      background-color: #f0f0f0;
      color: #E75480;
      border: 1px solid #E75480;
    }
    .tab-buttons button.active {
      background-color: #E75480;
      color: white;
    }
    .total-items {
        text-align: right;
        font-weight: bold;
        margin-top: 1rem;
        color: #E75480;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #E75480;
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
    }
    .nav-item {
      color: white;
      text-align: center;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .nav-item i {
      font-size: 1.5rem;
      margin-bottom: 0.2rem;
    }
    .nav-item.active {
      font-weight: bold;
      color: #FAD0C4;
    }

    /* Styles pour la barre de navigation √©tendue */
    .navigation-buttons {
      position: fixed;
      bottom: 4.5rem; /* Juste au-dessus de la barre de navigation principale */
      left: 0;
      width: 100%;
      background-color: #FFF;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      padding: 0.5rem 0;
      z-index: 999;
      transform: translateY(100%); /* Masqu√© par d√©faut */
      transition: transform 0.3s ease-out;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      overflow: hidden; /* Cache le contenu qui d√©passe pendant l'animation */
    }

    .navigation-buttons.show-options {
      transform: translateY(0); /* Affiche la barre */
    }

    .navigation-buttons button {
        background: none;
        border: none;
        color: #E75480;
        padding: 0.8rem 1rem;
        text-align: left;
        width: 100%;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
    }

    .navigation-buttons button i {
        margin-right: 0.5rem;
        font-size: 1.2rem;
    }

    .navigation-buttons button:hover {
        background-color: #f0f0f0;
    }

    /* Ic√¥ne de la fl√®che de basculement */
    .toggle-options {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        padding: 0.2rem 0;
        background-color: #E75480; /* Couleur de la barre inf√©rieure */
        color: white;
        cursor: pointer;
        font-size: 1.2rem;
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
        position: absolute;
        top: -1.5rem; /* Pour chevaucher l√©g√®rement la barre √©tendue */
        left: 0;
        z-index: 1001; /* Au-dessus de tout */
    }
    .nav-item.options {
        position: relative; /* Pour positionner la fl√®che par rapport √† cet √©l√©ment */
    }

    /* Style pour les sections cach√©es */
    .section.hidden {
      display: none;
    }

    /* Style pour la liste de suggestions */
    #suggestionList li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    #suggestionList .suggestion-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column; /* Nom et cat√©gorie sur des lignes diff√©rentes */
    }
    #suggestionList .suggestion-info .name {
        font-weight: bold;
    }
    #suggestionList .suggestion-info .category {
        font-size: 0.85em;
        color: #666;
    }
    #suggestionList .suggestion-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem; /* Espace si les boutons passent en dessous */
    }
  </style>
</head>
<body>
  <div id="shoppingList" class="section-container section">
    <h1>Ma Liste de Courses üõí</h1>
    <input type="text" id="shareCodeInput" placeholder="Entrez un code de partage" />
    <button id="loadShareCodeBtn">Charger/Cr√©er Liste</button>

    <div id="addItemForm" class="hidden">
        <input type="text" id="newItemInput" placeholder="Ajouter un article" />
        <input type="number" id="newQuantityInput" placeholder="Quantit√© (optionnel)" value="1" min="1" />
        <select id="newCategorySelect"></select>
        <button id="addItemBtn">Ajouter √† la liste</button>
    </div>
    
    <div class="tab-buttons" id="itemTabs">
      <button class="tab-btn active" data-tab="toBuy">√Ä Acheter</button>
      <button class="tab-btn" data-tab="bought">Achet√©s</button>
    </div>
    
    <ul id="shoppingListToBuy" class="item-list"></ul>
    <ul id="shoppingListBought" class="item-list hidden"></ul>

    <p class="total-items">Articles restants : <span id="totalRemainingItems">0</span></p>
  </div>

  <div id="buyLater" class="section-container section hidden">
    <h2>Acheter Plus Tard üõí</h2>
    <input type="text" id="newBuyLaterItemInput" placeholder="Article √† acheter plus tard" />
    <button id="addBuyLaterItemBtn">Ajouter</button>
    <ul id="buyLaterList"></ul>
  </div>

  <div id="suggestions" class="section-container section hidden">
    <h2>Suggestions üí°</h2>
    <input type="text" id="newSuggestionInput" placeholder="Sugg√©rer un article" />
    <select id="newSuggestionCategorySelect"></select> <button id="addSuggestionBtn">Ajouter Suggestion</button>
    <ul id="suggestionList"></ul>
  </div>

  <div id="categories" class="section-container section hidden">
    <h2>G√©rer les Cat√©gories üìÇ</h2>
    <input type="text" id="newCategoryInput" placeholder="Nouvelle cat√©gorie" />
    <button id="addCategoryBtn">Ajouter Cat√©gorie</button>
    <ul id="categoryList"></ul>
    <h3>Ordre des Cat√©gories</h3>
    <ul id="categoryOrderList" class="sortable-list"></ul>
    <button id="saveCategoryOrderBtn">Sauvegarder Ordre</button>
  </div>

  <div id="settings" class="section-container section hidden">
    <h2>Param√®tres ‚öôÔ∏è</h2>
    <p>Code de la liste active : <strong id="activeShareCode">N/A</strong></p>
    <button id="changeShareCodeBtn">Changer de liste / D√©connecter</button>
  </div>


  <div class="navigation-buttons">
    <button id="optionsMyListBtn"><i class="fas fa-shopping-basket"></i> Ma Liste</button>
    <button id="optionsBuyLaterBtn"><i class="fas fa-clock"></i> Acheter Plus Tard</button>
    <button id="optionsSuggestionsBtn"><i class="fas fa-lightbulb"></i> Suggestions</button>
    <button id="optionsCategoriesBtn"><i class="fas fa-folder"></i> G√©rer Cat√©gories</button>
    <button id="optionsSettingsBtn"><i class="fas fa-cog"></i> Param√®tres</button>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" id="navShoppingList">
      <i class="fas fa-shopping-basket"></i>
      <span>Ma Liste</span>
    </div>
    <div class="nav-item" id="navBuyLater">
      <i class="fas fa-clock"></i>
      <span>Plus Tard</span>
    </div>
    <div class="nav-item" id="navSuggestions">
      <i class="fas fa-lightbulb"></i>
      <span>Suggestions</span>
    </div>
    <div class="nav-item" id="navCategories">
      <i class="fas fa-folder"></i>
      <span>Cat√©gories</span>
    </div>
    <div class="nav-item" id="navSettings">
      <i class="fas fa-cog"></i>
      <span>Param√®tres</span>
    </div>
    <div class="nav-item options" id="navOptions">
        <i class="fas fa-bars"></i>
        <span>Options</span>
        <i class="fas fa-chevron-down toggle-options" id="toggleOptionsIcon"></i>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Configuration Supabase ---
    const SUPABASE_URL = 'https://cepqcretnxfhjbvdukkk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU';

    let supabase = null; // Sera initialis√© dans window.addEventListener('load')

    // --- Variables Globales ---
    let currentShareCode = null;
    let currentListId = null;
    const shoppingListToBuy = document.getElementById('shoppingListToBuy');
    const shoppingListBought = document.getElementById('shoppingListBought');
    const totalRemainingItemsSpan = document.getElementById('totalRemainingItems');
    const newItemInput = document.getElementById('newItemInput');
    const newQuantityInput = document.getElementById('newQuantityInput');
    const newCategorySelect = document.getElementById('newCategorySelect');
    const addItemBtn = document.getElementById('addItemBtn');
    const shareCodeInput = document.getElementById('shareCodeInput');
    const loadShareCodeBtn = document.getElementById('loadShareCodeBtn');
    const addItemForm = document.getElementById('addItemForm');

    // Sections
    const shoppingListSection = document.getElementById('shoppingList');
    const buyLaterSection = document.getElementById('buyLater');
    const suggestionsSection = document.getElementById('suggestions');
    const categoriesSection = document.getElementById('categories');
    const settingsSection = document.getElementById('settings'); // Nouvelle section param√®tres

    // Navigation
    const navShoppingList = document.getElementById('navShoppingList');
    const navBuyLater = document.getElementById('navBuyLater');
    const navSuggestions = document.getElementById('navSuggestions');
    const navCategories = document.getElementById('navCategories');
    const navSettings = document.getElementById('navSettings'); // Nouveau bouton de navigation
    const navOptions = document.getElementById('navOptions');
    const navigationButtonsContainer = document.querySelector('.navigation-buttons');
    const toggleOptionsIcon = document.getElementById('toggleOptionsIcon');

    // Options Navigation Buttons
    const optionsMyListBtn = document.getElementById('optionsMyListBtn');
    const optionsBuyLaterBtn = document.getElementById('optionsBuyLaterBtn');
    const optionsSuggestionsBtn = document.getElementById('optionsSuggestionsBtn');
    const optionsCategoriesBtn = document.getElementById('optionsCategoriesBtn');
    const optionsSettingsBtn = document.getElementById('optionsSettingsBtn'); // Nouveau bouton dans le menu √©tendu

    // Buy Later section elements
    const newBuyLaterItemInput = document.getElementById('newBuyLaterItemInput');
    const addBuyLaterItemBtn = document.getElementById('addBuyLaterItemBtn');
    const buyLaterList = document.getElementById('buyLaterList');

    // Suggestions section elements
    const newSuggestionInput = document.getElementById('newSuggestionInput');
    const newSuggestionCategorySelect = document.getElementById('newSuggestionCategorySelect'); // Nouveau
    const addSuggestionBtn = document.getElementById('addSuggestionBtn');
    const suggestionList = document.getElementById('suggestionList');

    // Categories section elements
    const newCategoryInput = document.getElementById('newCategoryInput');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoryList = document.getElementById('categoryList');
    const categoryOrderList = document.getElementById('categoryOrderList');
    const saveCategoryOrderBtn = document.getElementById('saveCategoryOrderBtn');

    // Settings section elements
    const activeShareCodeSpan = document.getElementById('activeShareCode');
    const changeShareCodeBtn = document.getElementById('changeShareCodeBtn');


    // --- Cat√©gories par d√©faut ---
    const initialDefaultCategories = [
        "Fruits et L√©gumes",
        "Produits Laitiers",
        "Viandes et Poissons",
        "Produits d'√âpicerie",
        "Boulangerie",
        "Boissons",
        "Surgel√©s",
        "Entretien",
        "Hygi√®ne",
        "Autres"
    ];

    // --- Fonctions utilitaires ---
    function generateShareCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    async function promptForShareCode() {
        let shareCode = localStorage.getItem('lastShareCode');
        if (!shareCode) {
            shareCode = prompt("Veuillez entrer un code de partage ou cliquez sur OK pour en g√©n√©rer un nouveau (vous pouvez aussi le taper dans le champ ci-dessous) :") || generateShareCode();
            localStorage.setItem('lastShareCode', shareCode); // Sauvegarde le code pour les prochaines fois
        }
        shareCodeInput.value = shareCode;
        await getOrCreateListByShareCode(shareCode);
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');

        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.getElementById('nav' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1)).classList.add('active');

        // Sp√©cifique pour la section settings
        if (sectionId === 'settings') {
            activeShareCodeSpan.textContent = currentShareCode || 'N/A';
        }
        // Charger les donn√©es sp√©cifiques √† la section si n√©cessaire
        if (sectionId === 'buyLater') {
            loadBuyLaterList();
        } else if (sectionId === 'suggestions') {
            loadSuggestions();
        } else if (sectionId === 'categories') {
            renderCategories();
            loadCategoryOrder();
        }
    }

    function updateSupabaseHeaders(shareCode) {
        if (supabase && supabase.rest) {
            supabase.rest.headers['X-Share-Code'] = shareCode;
            console.log(`Supabase headers updated with X-Share-Code: ${shareCode}`);
        } else {
            console.warn("Supabase client non initialis√© ou rest client non pr√™t, impossible de mettre √† jour les headers.");
        }
    }

    function getCategories() {
        return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
        localStorage.setItem('user_categories', JSON.stringify(categories));
    }

    function updateAllCategorySelects() {
        const categories = getCategories();
        const selects = document.querySelectorAll('select#newCategorySelect, select#newSuggestionCategorySelect');
        selects.forEach(select => {
            select.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        });
        if (categories.length > 0) {
            newCategorySelect.value = categories[0];
            newSuggestionCategorySelect.value = categories[0];
        }
    }

    // --- Fonctions Supabase ---

    async function getOrCreateListByShareCode(code) {
        updateSupabaseHeaders(code);
        
        try {
            const { data: lists, error: selectError } = await supabase
                .from('lists')
                .select('id, name')
                .eq('share_code', code);

            if (selectError && selectError.code !== '406') {
                if (selectError.code === 'PGRST400' && selectError.message.includes('406')) {
                } else {
                  throw selectError;
                }
            }

            if (lists && lists.length > 0) {
                console.log(`Liste trouv√©e pour le code ${code}:`, lists[0]);
                currentListId = lists[0].id;
                currentShareCode = code;
                shareCodeInput.value = code;
                addItemForm.classList.remove('hidden');
                setupRealtimeListener(currentListId);
                loadShoppingList();
                activeShareCodeSpan.textContent = currentShareCode; // Met √† jour l'affichage dans les param√®tres
                return lists[0];
            } else {
                console.log(`Aucune liste trouv√©e pour le code ${code}. Cr√©ation d'une nouvelle liste.`);
                const newList = {
                    name: `Liste ${code}`,
                    share_code: code
                };
                const { data: createdList, error: insertError } = await supabase
                    .from('lists')
                    .insert([newList])
                    .select('id, name');

                if (insertError) {
                    console.error("Erreur lors de la cr√©ation de la liste:", insertError);
                    alert("Erreur lors de la cr√©ation de la liste: " + insertError.message);
                    return null;
                } else {
                    console.log("Nouvelle liste cr√©√©e:", createdList[0]);
                    currentListId = createdList[0].id;
                    currentShareCode = code;
                    shareCodeInput.value = code;
                    addItemForm.classList.remove('hidden');
                    setupRealtimeListener(currentListId);
                    loadShoppingList();
                    activeShareCodeSpan.textContent = currentShareCode; // Met √† jour l'affichage dans les param√®tres
                    return createdList[0];
                }
            }
        } catch (error) {
            console.error("Erreur inattendue dans getOrCreateListByShareCode:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
            return null;
        }
    }

    // Modifi√© pour inclure la mise √† jour de quantit√©
    async function updateItemQuantity(itemId, newQuantity) {
        if (!currentListId) return;

        if (newQuantity <= 0) {
            // Si la quantit√© est 0 ou moins, supprimer l'article
            await deleteItem(itemId);
            return;
        }

        try {
            const { data, error } = await supabase
                .from('list_items')
                .update({ quantity: newQuantity })
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la mise √† jour de la quantit√© de l'article:", error);
                alert("Erreur lors de la mise √† jour de la quantit√© de l'article: " + error.message);
            }
            // La liste sera recharg√©e par le listener Realtime
        } catch (error) {
            console.error("Erreur inattendue lors de la mise √† jour de la quantit√©:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function addItem(name, quantity, category, listId) {
        if (!listId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('list_items')
                .insert([{ name, quantity, category, list_id: listId, bought: false }]);
            if (error) {
                console.error("Erreur lors de l'ajout de l'article:", error);
                alert("Erreur lors de l'ajout de l'article: " + error.message);
            } else {
                newItemInput.value = '';
                newQuantityInput.value = '1';
            }
        } catch (error) {
            console.error("Erreur inattendue lors de l'ajout de l'article:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function updateItemStatus(itemId, status) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('list_items')
                .update({ bought: status })
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la mise √† jour du statut de l'article:", error);
                alert("Erreur lors de la mise √† jour du statut de l'article: " + error.message);
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la mise √† jour du statut:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function deleteItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('list_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de l'article:", error);
                alert("Erreur lors de la suppression de l'article: " + error.message);
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadShoppingList() {
        if (!currentListId) {
            shoppingListToBuy.innerHTML = '';
            shoppingListBought.innerHTML = '';
            totalRemainingItemsSpan.textContent = '0';
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('list_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement de la liste de courses:", error);
                alert("Erreur lors du chargement de la liste: " + error.message);
                return;
            }

            shoppingListToBuy.innerHTML = '';
            shoppingListBought.innerHTML = '';
            let remainingItems = 0;

            const categories = getCategories();
            const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || categories;

            const groupedItems = {};
            // Initialize groupedItems with all known categories in order
            categoryOrder.forEach(cat => groupedItems[cat] = { toBuy: [], bought: [] });
            // Add any existing categories from items that might not be in the current user_categories
            items.forEach(item => {
                const category = item.category || 'Autres';
                if (!groupedItems[category]) {
                    groupedItems[category] = { toBuy: [], bought: [] };
                }
            });


            items.forEach(item => {
                const category = item.category || 'Autres';
                if (item.bought) {
                    groupedItems[category].bought.push(item);
                } else {
                    groupedItems[category].toBuy.push(item);
                    remainingItems++;
                }
            });

            // Render "To Buy" items for each category
            categoryOrder.forEach(category => {
                if (groupedItems[category] && groupedItems[category].toBuy.length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    groupedItems[category].toBuy.forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });
            // Handle items with categories not in the current category order (e.g., deleted categories)
            Object.keys(groupedItems).filter(cat => !categoryOrder.includes(cat)).forEach(category => {
                if (groupedItems[category].toBuy.length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    groupedItems[category].toBuy.forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });


            // Render "Bought" items for each category
            categoryOrder.forEach(category => {
                if (groupedItems[category] && groupedItems[category].bought.length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListBought.appendChild(categoryHeader);
                    groupedItems[category].bought.forEach(item => renderListItem(item, shoppingListBought));
                }
            });
            // Handle items with categories not in the current category order
            Object.keys(groupedItems).filter(cat => !categoryOrder.includes(cat)).forEach(category => {
                if (groupedItems[category].bought.length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListBought.appendChild(categoryHeader);
                    groupedItems[category].bought.forEach(item => renderListItem(item, shoppingListBought));
                }
            });

            totalRemainingItemsSpan.textContent = remainingItems;
            updateTabCounts();

        } catch (error) {
            console.error("Erreur inattendue lors du chargement de la liste de courses:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    function renderListItem(item, listElement) {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        li.classList.toggle('bought', item.bought);

        const itemInfo = document.createElement('div');
        itemInfo.classList.add('item-info');

        const itemName = document.createElement('span');
        itemName.textContent = item.name;
        itemInfo.appendChild(itemName);

        const quantityControl = document.createElement('div');
        quantityControl.classList.add('quantity-control');

        const minusBtn = document.createElement('button');
        minusBtn.textContent = '-';
        minusBtn.onclick = () => updateItemQuantity(item.id, item.quantity - 1);
        quantityControl.appendChild(minusBtn);

        const quantitySpan = document.createElement('span');
        quantitySpan.textContent = item.quantity;
        quantityControl.appendChild(quantitySpan);

        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.onclick = () => updateItemQuantity(item.id, item.quantity + 1);
        quantityControl.appendChild(plusBtn);

        itemInfo.appendChild(quantityControl);
        li.appendChild(itemInfo);

        const itemActions = document.createElement('div');
        itemActions.classList.add('item-actions');

        if (item.bought) {
            const undoBtn = document.createElement('button');
            undoBtn.textContent = 'Annuler';
            undoBtn.classList.add('undo-btn');
            undoBtn.onclick = () => updateItemStatus(item.id, false);
            itemActions.appendChild(undoBtn);
        } else {
            const buyBtn = document.createElement('button');
            buyBtn.textContent = 'Acheter';
            buyBtn.classList.add('buy-btn');
            buyBtn.onclick = () => updateItemStatus(item.id, true);
            itemActions.appendChild(buyBtn);
        }

        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Supprimer';
        removeBtn.classList.add('remove-btn');
        removeBtn.onclick = () => deleteItem(item.id);
        itemActions.appendChild(removeBtn);

        li.appendChild(itemActions);
        listElement.appendChild(li);
    }

    function setupRealtimeListener() {
      if (window.supabaseChannel) {
          supabase.removeChannel(window.supabaseChannel);
      }

      if (!currentListId) {
          console.warn("Pas de currentListId d√©fini, impossible de configurer le listener Realtime.");
          return;
      }

      window.supabaseChannel = supabase.channel(`list_items_changes:${currentListId}`)
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'list_items',
            filter: `list_id=eq.${currentListId}`
        }, (payload) => {
            console.log('Changement Realtime d√©tect√©:', payload);
            loadShoppingList();
        })
        .subscribe();

        // Listener pour les changements sur buy_later_items
        window.supabaseBuyLaterChannel = supabase.channel(`buy_later_items_changes:${currentListId}`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'buy_later_items',
                filter: `list_id=eq.${currentListId}`
            }, (payload) => {
                console.log('Changement Buy Later Realtime d√©tect√©:', payload);
                if (document.getElementById('buyLater').classList.contains('hidden')) {
                  // Ne recharger que si la section est active pour √©viter des appels inutiles
                } else {
                  loadBuyLaterList();
                }
            })
            .subscribe();
        
        // Listener pour les changements sur suggestions
        window.supabaseSuggestionsChannel = supabase.channel(`suggestions_changes:${currentListId}`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'suggestions',
                filter: `list_id=eq.${currentListId}`
            }, (payload) => {
                console.log('Changement Suggestions Realtime d√©tect√©:', payload);
                if (document.getElementById('suggestions').classList.contains('hidden')) {
                    // Ne recharger que si la section est active pour √©viter des appels inutiles
                } else {
                    loadSuggestions();
                }
            })
            .subscribe();

      console.log(`Listeners Realtime configur√©s pour list_id: ${currentListId}`);
    }


    // --- Fonctions Buy Later ---
    async function addBuyLaterItem(name) {
        if (!currentListId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .insert([{ name, list_id: currentListId }]);
            if (error) {
                console.error("Erreur lors de l'ajout de l'article 'Acheter Plus Tard':", error);
                alert("Erreur lors de l'ajout de l'article 'Acheter Plus Tard': " + error.message);
            } else {
                newBuyLaterItemInput.value = '';
                // loadBuyLaterList est g√©r√© par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de l'ajout de l'article 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function deleteBuyLaterItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de l'article 'Acheter Plus Tard':", error);
                alert("Erreur lors de la suppression de l'article 'Acheter Plus Tard': " + error.message);
            } else {
                // loadBuyLaterList est g√©r√© par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression d'article 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadBuyLaterList() {
        if (!currentListId) {
            buyLaterList.innerHTML = '';
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('buy_later_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement de la liste 'Acheter Plus Tard':", error);
                alert("Erreur lors du chargement de la liste 'Acheter Plus Tard': " + error.message);
                return;
            }

            buyLaterList.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.name;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Supprimer';
                removeBtn.classList.add('remove-btn');
                removeBtn.onclick = () => deleteBuyLaterItem(item.id);
                li.appendChild(removeBtn);
                buyLaterList.appendChild(li);
            });
        } catch (error) {
            console.error("Erreur inattendue lors du chargement de la liste 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }


    // --- Fonctions Suggestions ---
    async function addSuggestion(name, category) {
        if (!currentListId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('suggestions')
                .insert([{ name, category, list_id: currentListId }]);
            if (error) {
                console.error("Erreur lors de l'ajout de la suggestion:", error);
                alert("Erreur lors de l'ajout de la suggestion: " + error.message);
            } else {
                newSuggestionInput.value = '';
                // loadSuggestions est g√©r√© par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de l'ajout de la suggestion:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function deleteSuggestion(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('suggestions')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de la suggestion:", error);
                alert("Erreur lors de la suppression de la suggestion: " + error.message);
            } else {
                // loadSuggestions est g√©r√© par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression de suggestion:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadSuggestions() {
        if (!currentListId) {
            suggestionList.innerHTML = '';
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('suggestions')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement des suggestions:", error);
                alert("Erreur lors du chargement des suggestions: " + error.message);
                return;
            }

            suggestionList.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.dataset.id = item.id;

                const suggestionInfo = document.createElement('div');
                suggestionInfo.classList.add('suggestion-info');
                const nameSpan = document.createElement('span');
                nameSpan.classList.add('name');
                nameSpan.textContent = item.name;
                const categorySpan = document.createElement('span');
                categorySpan.classList.add('category');
                categorySpan.textContent = item.category ? `Cat√©gorie: ${item.category}` : 'Pas de cat√©gorie';
                suggestionInfo.appendChild(nameSpan);
                suggestionInfo.appendChild(categorySpan);
                li.appendChild(suggestionInfo);


                const suggestionActions = document.createElement('div');
                suggestionActions.classList.add('suggestion-actions');

                const addToListBtn = document.createElement('button');
                addToListBtn.textContent = 'Ajouter √† la liste';
                addToListBtn.classList.add('buy-btn'); // R√©utilise le style du bouton acheter
                addToListBtn.onclick = () => addItem(item.name, 1, item.category, currentListId);
                suggestionActions.appendChild(addToListBtn);

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Supprimer';
                removeBtn.classList.add('remove-btn');
                removeBtn.onclick = () => deleteSuggestion(item.id);
                suggestionActions.appendChild(removeBtn);

                li.appendChild(suggestionActions);
                suggestionList.appendChild(li);
            });
        } catch (error) {
            console.error("Erreur inattendue lors du chargement des suggestions:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }


    // --- Fonctions Cat√©gories ---
    function renderCategories() {
        const categories = getCategories();
        categoryList.innerHTML = '';
        categories.forEach(cat => {
            const li = document.createElement('li');
            li.textContent = cat;
            if (!initialDefaultCategories.includes(cat)) {
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Supprimer';
                removeBtn.classList.add('remove-btn');
                removeBtn.onclick = () => {
                    if (confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${cat}" ? Les articles existants de cette cat√©gorie ne seront pas supprim√©s, mais leur cat√©gorie pourrait devenir "Autres".`)) {
                        const updatedCategories = categories.filter(c => c !== cat);
                        saveCategories(updatedCategories);
                        updateAllCategorySelects();
                        renderCategories();
                        loadCategoryOrder();
                        loadShoppingList(); // Recharger la liste pour refl√©ter le changement de cat√©gorie
                    }
                };
                li.appendChild(removeBtn);
            }
            categoryList.appendChild(li);
        });
    }

    function addCategory() {
        const newCat = newCategoryInput.value.trim();
        if (newCat && !getCategories().includes(newCat)) {
            const categories = getCategories();
            categories.push(newCat);
            saveCategories(categories);
            newCategoryInput.value = '';
            updateAllCategorySelects();
            renderCategories();
            loadCategoryOrder();
        } else if (newCat) {
            alert("Cette cat√©gorie existe d√©j√†.");
        }
    }

    function loadCategoryOrder() {
        const categories = getCategories();
        const currentOrder = JSON.parse(localStorage.getItem('category_order')) || [];

        const filteredOrder = currentOrder.filter(cat => categories.includes(cat));
        const newCategories = categories.filter(cat => !filteredOrder.includes(cat));
        const finalOrder = [...filteredOrder, ...newCategories];

        localStorage.setItem('category_order', JSON.stringify(finalOrder));
        renderCategoryOrder(finalOrder);
    }

    function renderCategoryOrder(order) {
        categoryOrderList.innerHTML = '';
        order.forEach(cat => {
            const li = document.createElement('li');
            li.textContent = cat;
            li.dataset.category = cat;
            li.draggable = true;
            categoryOrderList.appendChild(li);
        });
        addDragAndDropListeners();
    }

    function addDragAndDropListeners() {
        let draggedItem = null;

        categoryOrderList.querySelectorAll('li').forEach(item => {
            item.addEventListener('dragstart', () => {
                draggedItem = item;
                setTimeout(() => item.style.display = 'none', 0);
            });

            item.addEventListener('dragend', () => {
                setTimeout(() => {
                    draggedItem.style.display = 'flex';
                    draggedItem = null;
                }, 0);
            });

            item.addEventListener('dragover', e => e.preventDefault());

            item.addEventListener('dragenter', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '#f0f0f0';
            });

            item.addEventListener('dragleave', function() {
                this.style.backgroundColor = '';
            });

            item.addEventListener('drop', function() {
                this.style.backgroundColor = '';
                if (draggedItem && draggedItem !== this) {
                    const thisIndex = Array.from(categoryOrderList.children).indexOf(this);
                    const draggedIndex = Array.from(categoryOrderList.children).indexOf(draggedItem);

                    if (thisIndex > draggedIndex) {
                        categoryOrderList.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        categoryOrderList.insertBefore(draggedItem, this);
                    }
                }
            });
        });
    }

    function saveCategoryOrder() {
        const newOrder = Array.from(categoryOrderList.children).map(li => li.dataset.category);
        localStorage.setItem('category_order', JSON.stringify(newOrder));
        alert("Ordre des cat√©gories sauvegard√© !");
        loadShoppingList();
    }

    // --- Gestion des onglets Achet√©s/√Ä Acheter ---
    function updateTabCounts() {
        const toBuyCount = shoppingListToBuy.querySelectorAll('li:not(.bought)').length;
        const boughtCount = shoppingListBought.querySelectorAll('li.bought').length;

        document.querySelector('.tab-btn[data-tab="toBuy"]').textContent = `√Ä Acheter (${toBuyCount})`;
        document.querySelector('.tab-btn[data-tab="bought"]').textContent = `Achet√©s (${boughtCount})`;
    }

    // --- Listeners d'√©v√©nements ---
    loadShareCodeBtn.addEventListener('click', () => {
        const code = shareCodeInput.value.trim();
        if (code) {
            localStorage.setItem('lastShareCode', code);
            getOrCreateListByShareCode(code);
        } else {
            promptForShareCode();
        }
    });

    addItemBtn.addEventListener('click', () => {
        const name = newItemInput.value.trim();
        const quantity = parseInt(newQuantityInput.value) || 1;
        const category = newCategorySelect.value;
        if (name && currentListId) {
            addItem(name, quantity, category, currentListId);
        } else if (!name) {
            alert("Veuillez entrer le nom de l'article.");
        }
    });

    document.getElementById('itemTabs').addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-btn')) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            const tab = e.target.dataset.tab;
            if (tab === 'toBuy') {
                shoppingListToBuy.classList.remove('hidden');
                shoppingListBought.classList.add('hidden');
            } else {
                shoppingListToBuy.classList.add('hidden');
                shoppingListBought.classList.remove('hidden');
            }
        }
    });

    // Navigation Buttons Listeners
    navShoppingList.addEventListener('click', () => showSection('shoppingList'));
    navBuyLater.addEventListener('click', () => showSection('buyLater'));
    navSuggestions.addEventListener('click', () => showSection('suggestions'));
    navCategories.addEventListener('click', () => showSection('categories'));
    navSettings.addEventListener('click', () => showSection('settings')); // Listener pour le bouton Param√®tres

    navOptions.addEventListener('click', () => {
        navigationButtonsContainer.classList.toggle('show-options');
        toggleOptionsIcon.classList.toggle('fa-chevron-down');
        toggleOptionsIcon.classList.toggle('fa-chevron-up');
    });

    // Options menu buttons
    optionsMyListBtn.addEventListener('click', () => {
        showSection('shoppingList');
        navigationButtonsContainer.classList.remove('show-options');
        toggleOptionsIcon.classList.remove('fa-chevron-up');
        toggleOptionsIcon.classList.add('fa-chevron-down');
    });

    optionsBuyLaterBtn.addEventListener('click', () => {
        showSection('buyLater');
        navigationButtonsContainer.classList.remove('show-options');
        toggleOptionsIcon.classList.remove('fa-chevron-up');
        toggleOptionsIcon.classList.add('fa-chevron-down');
    });

    optionsSuggestionsBtn.addEventListener('click', () => {
        showSection('suggestions');
        navigationButtonsContainer.classList.remove('show-options');
        toggleOptionsIcon.classList.remove('fa-chevron-up');
        toggleOptionsIcon.classList.add('fa-chevron-down');
    });

    optionsCategoriesBtn.addEventListener('click', () => {
        showSection('categories');
        navigationButtonsContainer.classList.remove('show-options');
        toggleOptionsIcon.classList.remove('fa-chevron-up');
        toggleOptionsIcon.classList.add('fa-chevron-down');
    });

    optionsSettingsBtn.addEventListener('click', () => { // Nouveau listener pour Param√®tres
        showSection('settings');
        navigationButtonsContainer.classList.remove('show-options');
        toggleOptionsIcon.classList.remove('fa-chevron-up');
        toggleOptionsIcon.classList.add('fa-chevron-down');
    });


    // Buy Later Listeners
    addBuyLaterItemBtn.addEventListener('click', () => {
        const name = newBuyLaterItemInput.value.trim();
        if (name) {
            addBuyLaterItem(name);
        } else {
            alert("Veuillez entrer un article.");
        }
    });

    // Suggestions Listeners
    addSuggestionBtn.addEventListener('click', () => {
        const name = newSuggestionInput.value.trim();
        const category = newSuggestionCategorySelect.value; // R√©cup√®re la cat√©gorie de la suggestion
        if (name) {
            addSuggestion(name, category);
        } else {
            alert("Veuillez entrer une suggestion.");
        }
    });

    // Categories Listeners
    addCategoryBtn.addEventListener('click', addCategory);
    saveCategoryOrderBtn.addEventListener('click', saveCategoryOrder);

    // Settings Listeners
    changeShareCodeBtn.addEventListener('click', () => {
        if (confirm("Voulez-vous vraiment changer de liste ? Cela vous d√©connectera de la liste actuelle.")) {
            localStorage.removeItem('lastShareCode'); // Efface le code m√©moris√©
            location.reload(); // Recharge l'application pour redemander un code
        }
    });

    // --- Initialization on page load ---
    window.addEventListener('load', async () => {
      if (!localStorage.getItem('user_categories')) {
          localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
      }
      if (!localStorage.getItem('category_order')) {
          localStorage.setItem('category_order', JSON.stringify(getCategories()));
      }

      updateAllCategorySelects();
      
      // Initialisation du client Supabase
      if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("Supabase client initialized successfully.");
      } else {
          console.error("Erreur: La fonction 'createClient' de Supabase n'est pas d√©finie ou la biblioth√®que Supabase n'est pas charg√©e correctement.");
          alert("Erreur de chargement: La biblioth√®que Supabase n'a pas pu √™tre initialis√©e. V√©rifiez votre connexion internet ou la configuration.");
          return;
      }

      let attempts = 0;
      const maxAttempts = 20;
      const delayMs = 50;

      while (!supabase.rest && attempts < maxAttempts) {
          console.log(`Attente de supabase.rest (tentative ${attempts + 1}/${maxAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, delayMs));
          attempts++;
      }

      if (supabase.rest) {
          console.log("supabase.rest est maintenant pr√™t !");
          await promptForShareCode();
      } else {
          console.error("Erreur: supabase.rest n'est pas devenu pr√™t apr√®s plusieurs tentatives. Impossible de d√©marrer l'application.");
          return;
      }
      
      showSection('shoppingList');
      navigationButtonsContainer.classList.remove('show-options');
      toggleOptionsIcon.classList.remove('fa-chevron-up');
      toggleOptionsIcon.classList.add('fa-chevron-down');
    });
  </script>
</body>
</html>