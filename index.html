<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>My Shopping List 🛒</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />

  <meta name="theme-color" content="#fcf2f2" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fcf2f2;
      color: #333;
      transition: padding-bottom 0.3s ease-out; /* Animation for padding */
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      cursor: pointer; /* Indicate clickable titles for scrolling */
      -webkit-user-select: none; /* For WebKit browsers (Chrome, Safari) */
      -moz-user-select: none;    /* For Firefox */
      -ms-user-select: none;     /* For Internet Explorer/Edge */
      user-select: none;         /* Standard */
      cursor: pointer; 
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #fcf2f2;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: bold;
      color: #6A057F; /* Color from index copy */
    }
    input[type="text"], input[type="number"], select, textarea { /* Added textarea */
      width: 100%; /* Changed from calc(100% - 20px) for consistency with padding */
      padding: 0.7rem; /* Adjusted from 0.8rem */
      margin-top: 0.4rem; /* Adjusted from margin-bottom */
      border: 1px solid #DDA0DD; /* Color from index copy */
      border-radius: 0.5rem;
      box-sizing: border-box;
      color: #333;
      font-size: 1rem;
    }
    button {
      background: #FF69B4; /* From index copy */
      color: #FFFFFF; /* From index copy */
      font-weight: bold; /* From index copy */
      cursor: pointer;
      transition: all 0.3s ease; /* From index copy */
      border: none; /* From index copy */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* From index copy */
      width: 100%; /* Ensure full width for general buttons */
      padding: 0.7rem; /* From index copy */
      margin-top: 0.4rem; /* From index copy */
      border-radius: 0.5rem; /* From index copy */
    }
    button:hover {
      background: #C71585; /* From index copy */
      transform: translateY(-2px); /* From index copy */
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* From index copy */
    }
    select {
        background: #F8F8FF; /* From index copy */
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='%23C71585' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>"); /* From index copy */
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%;
        background-size: 0.65em auto;
        padding-right: 2.5em;
    }

    /* Reset UL padding for left alignment */
    #shoppingListToBuy, #buyLaterList, #suggestionList, #categoryList, #categoryOrderList, #savedMessagesList { /* Added #savedMessagesList */
      list-style: none; /* Remove default bullet points */
      padding-left: 0; /* Remove default browser padding */
      margin-left: 0; /* Ensure no margin is pushing it */
    }

    /* Styles for the shopping list items (adapting from index copy's .shopping-list-item) */
    #shoppingListToBuy li, #buyLaterList li { /* ADDED #buyLaterList li here */
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFF0F5; /* From index copy */
      padding: 0.7rem 1.2rem 0.7rem 0; /* Adjusted padding-left for alignment */
      margin-top: 0.7rem; /* From index copy */
      border-radius: 0.75rem; /* From index copy */
      font-size: 1.1rem; /* From index copy */
      color: #6A057F; /* From index copy */
      border: 1px solid #FFC0CB; /* From index copy */
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* From index copy */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      flex-wrap: nowrap; /* Prevent wrapping in main list items */
    
    }
    
    /* Adapting delete/decrement buttons from index copy */
    .quantity-control {
      display: flex;
      align-items: center;
      /* margin-right: 10px; Removed as it's part of flex-grow now */
      flex-shrink: 0; /* Prevent it from shrinking */
    }
    .quantity-control button { /* This will be the decrement/increment buttons */
        background: none; /* Changed from #ddd */
        border: 1px solid #DDA0DD; /* Added border */
        border-radius: 50%; /* Rounded borders */
        color: #6A057F; /* Darker color for decrement, from index copy */
        font-size: 1rem; /* Slightly larger for visibility, from index copy */
        cursor: pointer;
        padding: 0; /* Remove padding */
        margin: 0 2px; /* Adjusted margin */
        width: 30px; /* Fixed width for round button */
        height: 30px; /* Fixed height for round button */
        display: flex; /* For centering content */
        justify-content: center; /* For centering content */
        align-items: center; /* For centering content */
        transition: background-color 0.3s ease, color 0.3s ease, transform 0.3s ease;
    }
    .quantity-control button:hover {
        background-color: #E6E6FA; /* Ensure no background on hover */
        color: #8A2BE2; /* Change color on hover for decrement, from index copy */
        transform: scale(1.05);
    }
    .quantity-control span {
        font-weight: bold; /* From index copy */
        margin: 0 5px; /* Adjusted margin */
        color: #FF8C00; /* From index copy */
        min-width: 20px;
        text-align: center;
    }

    .item-actions .remove-btn { /* This will be the main delete button for list items */
      background: none; /* Changed from #f44336 */
      border: 1px solid #FF6347; /* Added border for round button */
      border-radius: 50%; /* Make it round */
      color: #FF6347; /* From index copy */
      font-size: 1.2rem; /* Adjusted for round button */
      cursor: pointer;
      padding: 0; /* Remove padding for round button */
      margin: 0;
      width: 30px; /* Fixed width for round button */
      height: 30px; /* Fixed height for round button */
      display: flex;
      justify-content: center;
      align-items: center;
      transition: color 0.3s ease, background-color 0.3s ease;
      line-height: 1;
    }
    .item-actions .remove-btn:hover {
      background-color: #ffe0e0; /* Light red background on hover */
      color: #DC143C; /* From index copy */
    }
    /* Updated to use <i> tag directly, removing ::before */
    .item-actions .remove-btn i {
        font-family: "Font Awesome 6 Free"; /* Ensure correct font-family for FA6 */
        font-weight: 900;
    }
    .item-actions .remove-btn span {
        display: none; /* Hide original text */
    }

    /* Fixed bottom navigation (from index.html, retaining structure) */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #EE82EE; /* From index copy's navigation buttons */
      display: flex;
      white-space: nowrap;
      justify-content: space-around;
      padding: 0.5rem 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      transform: translateY(0);
      transition: transform 0.3s ease-out;
    }
    .bottom-nav.hidden-nav {
      transform: translateY(100%);
    }
    .nav-item {
      color: #FFFFFF; /* From index copy's navigation buttons */
      text-align: center;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .nav-item i {
      font-size: 1.5rem;
      margin-bottom: 0.2rem;
    }
    .nav-item.active {
      font-weight: bold;
      color: #FFD700; /* Active color from index copy's navigation buttons */
    }
    .toggle-nav-button {
      position: absolute;
      top: -45px;
      right: 20px;
      background-color: #9370DB; /* From index copy's toggle button */
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1001;
      transition: background-color 0.3s ease, transform 0.3s ease; /* Added transform for consistency */
    }
    .toggle-nav-button:hover {
        background-color: #8A2BE2; /* From index copy's toggle button hover */
        transform: translateY(-2px); /* Added for consistency */
    }
    .toggle-nav-button i {
      font-size: 1.2rem;
      transition: transform 0.3s ease; /* For icon rotation */
    }

    /* Style for hidden sections */
    .section.hidden {
      display: none;
    }

    /* Style for suggestion list items (adapting from index copy's .suggestion-item) */
    #suggestionList li {
      position: relative;
      background: #F8F8FF; /* From index copy */
      border: 1px solid #DDA0DD;
      color: #6A057F; /* From index copy */
      padding: 0.6rem 1.2rem 0.6rem 0; /* Adjusted padding-left for alignment */
      border-radius: 0.75rem; /* From index copy */
      text-align: left; /* Adjust from center for content */
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease; /* Unified transition */
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-right: 5px; /* From index copy */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* From index copy */
      margin-top: 0.7rem; /* Consistent spacing */
    }
    #suggestionList li:hover {
      background: #E6E6FA; /* From index copy */
      transform: translateY(-2px); /* From index copy */
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* From index copy */
    }
    /* Only apply hover effect to the item info part for adding to list */
    #suggestionList li .suggestion-info:hover {
        background: none; /* Reset background if it was changed */
        cursor: pointer;
    }

    #suggestionList .suggestion-info {
        flex-grow: 1;
        padding-right: 5px;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap; /* Ensure text stays on one line */
        padding: 0.6rem 0; /* Add padding to make the clickable area larger */
        /* Updated for combined name and category on one line with ellipsis */
        display: flex; /* Use flex to align name and category */
        gap: 5px; /* Small gap between name and category */
        align-items: center;
        position: relative;
        top: 5px;
    }
    #suggestionList .suggestion-info .name {
        font-weight: bold;
        color: #6A057F; /* Ensure visibility */
        padding-left: 1.2rem;
        white-space: nowrap; /* Prevent name from wrapping */
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 1; /* Allow name to shrink if needed */
        min-width: 0; /* Important for flex items with overflow */
    }
    #suggestionList .suggestion-info .category {
        font-size: 0.85em;
        color: #C71585; /* Lighter color for category */
        white-space: nowrap; /* Prevent category from wrapping */
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 0; /* Prevent category from shrinking much initially */
    }
    /* Adjusted styles for the item name within #shoppingListToBuy and #buyLaterList */
    #shoppingListToBuy li .item-name, #buyLaterList li .item-name {
        flex-grow: 1; /* Allow the name to take up available space */
        padding-left: 10px; /* Space between quantity controls and name */
        white-space: normal; /* Allow text to wrap naturally if there are spaces */
        overflow-wrap: break-word; /* Break long words if necessary */
        word-break: break-word; /* Fallback for older browsers */
        min-width: 0; /* Ensure it can shrink in flex container */
        color: #6A057F; /* Set explicit color */
        font-weight: normal; /* Ensure it's not bold */
    }
    /* Removed add-to-shopping-list-btn styles as the button is removed from HTML */
    #suggestionList .suggestion-actions .remove-btn {
      background: none; /* Changed from #f44336 */
      border: 1px solid #FF6347; /* Added border for round button */
      border-radius: 50%; /* Make it round */
      color: #FF6347; /* From index copy */
      font-size: 1.2rem; /* Adjusted for round button */
      cursor: pointer;
      padding: 0; /* Remove padding for round button */
      margin: 0;
      width: 30px; /* Fixed width for round button */
      height: 30px; /* Fixed height for round button */
      display: flex;
      justify-content: center;
      align-items: center;
      transition: color 0.3s ease, background-color 0.3s ease;
      line-height: 1;
    }
    #suggestionList .suggestion-actions .remove-btn:hover {
      background-color: #ffe0e0; /* Light red background on hover */
      color: #DC143C; /* From index copy */
    }
    /* Updated to use <i> tag directly, removing ::before */
    #suggestionList .suggestion-actions .remove-btn i {
        font-family: "Font Awesome 6 Free"; /* Ensure correct font-family for FA6 */
        font-weight: 900;
    }
    #suggestionList .suggestion-actions .remove-btn span {
        display: none; /* Hide original text */
    }

    /* Styles for category list items (adapting from index copy's #categoryOrderList li) */
    #categoryList li, #categoryOrderList li {
        background: #F8F8FF; /* From index copy */
        border: 1px solid #DDA0DD; /* From index copy */
        padding: 0.75rem 1.2rem 0.75rem 0; /* Adjusted padding-left for alignment */
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        padding-left: 1.2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold; /* From index copy */
        color: #6A057F; /* From index copy */
        cursor: grab; /* From index copy */
        transition: background-color 0.2s ease, transform 0.2s ease; /* From index copy */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    #categoryList li:hover, #categoryOrderList li:hover {
        background-color: #E6E6FA; /* From index copy */
        transform: scale(1.01); /* From index copy */
    }
    #categoryOrderList li.dragging { /* From index copy */
        opacity: 0.7;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .drag-handle { /* From index copy */
        font-size: 1.5rem;
        cursor: grab;
        margin-right: 10px;
        color: #EE82EE;
    }
    #categoryList .remove-btn { /* Adapting delete button for categories */
        background: none;
        border: 1px solid #FF6347; /* Added border for round button */
        border-radius: 50%; /* Make it round */
        color: #FF6347; /* From index copy */
        font-size: 1.2rem; /* Adjusted for round button */
        cursor: pointer;
        padding: 0; /* Remove padding for round button */
        margin: 0;
        width: 30px; /* Fixed width for round button */
        height: 30px; /* Fixed height for round button */
        display: flex;
        justify-content: center;
        align-items: center;
        transition: color 0.3s ease, background-color 0.3s ease;
        line-height: 1;
    }
    #categoryList .remove-btn:hover {
        background-color: #ffe0e0; /* Light red background on hover */
        color: #DC143C; /* From index copy */
    }
    /* Updated to use <i> tag directly, removing ::before */
    #categoryList .remove-btn i {
        font-family: "Font Awesome 6 Free"; /* Ensure correct font-family for FA6 */
        font-weight: 900;
    }
    #categoryList .remove-btn span {
        display: none; /* Hide original text */
    }

    /* Styles for add forms */
    .add-form { /* New style based on index copy structure */
        margin-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
        padding-top: 1rem;
    }
    /* Apply add-form to specific elements */
    #addItemForm, #addBuyLaterItemForm, #addSuggestionForm, #addCategoryForm {
        margin-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
        padding-top: 1rem;
    }
    #addItemForm label, #addBuyLaterItemForm label, #addSuggestionForm label, #addCategoryForm label {
        display: block;
        margin-top: 0.75rem;
        font-weight: bold;
        color: #6A057F;
    }

    /* Style for empty list text (adapting existing .total-items style) */
    p.empty-list-message { /* New class for clear distinction */
        color: #C71585 !important;
        font-style: italic;
        font-size: 0.95rem;
        text-align: center;
        margin-top: 0.5rem;
    }

    /* Styles for section headers */
    .section-container h3 {
        color: #E75480; /* From index copy */
        border-bottom: 1px solid #FFD1DC; /* From index copy */
        padding-bottom: 0.3rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        padding-left: 0; /* Ensure alignment with list items */
    }

    /* Bell icon for notification trigger */
    #shoppingListTitle .notification-bell {
        margin-left: 10px;
        font-size: 1.2em;
        color: #E75480;
        cursor: pointer;
        transition: color 0.2s ease, transform 0.2s ease;
    }
    #shoppingListTitle .notification-bell:hover {
        color: #C71585;
        transform: scale(1.1);
    }

    /* Notification Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000; /* Above everything else */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: #fcf2f2;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 450px;
        position: relative;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }
    .modal-overlay.visible .modal-content {
        transform: translateY(0);
    }
    .modal-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #888;
        cursor: pointer;
    }
    .modal-close-btn:hover {
        color: #333;
    }
    .modal-content h3 {
        color: #E75480;
        text-align: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #FFD1DC;
        padding-bottom: 0.5rem;
    }
    .modal-content textarea {
        min-height: 80px;
        resize: vertical;
        margin-bottom: 1rem;
    }
    .modal-content .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 1rem;
    }
    .modal-content .modal-buttons button {
        flex-grow: 1;
    }
    #savedMessagesList li {
        background: #F8F8FF;
        border: 1px solid #DDA0DD;
        color: #6A057F;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
        word-break: break-word; /* Allow long messages to wrap */
        white-space: normal; /* Ensure text wraps */
    }
    #savedMessagesList li:hover {
        background: #E6E6FA;
    }
    #savedMessagesList .message-actions .remove-btn {
        background: none;
        border: 1px solid #FF6347;
        border-radius: 50%;
        color: #FF6347;
        font-size: 0.9rem; /* Smaller for saved messages */
        cursor: pointer;
        width: 25px;
        height: 25px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: color 0.3s ease, background-color 0.3s ease;
    }
    #savedMessagesList .message-actions .remove-btn:hover {
        background-color: #ffe0e0;
        color: #DC143C;
    }
    #savedMessagesList .message-text {
        flex-grow: 1;
        margin-right: 10px;
    }

    @media (max-width: 640px) {
        body {
            /* Try to reduce horizontal padding (0.5rem here) */
            padding: 0.2rem 0.2rem; /* For example, very little lateral padding */
        }
        .section-container {
            /* Same for the section container (0.75rem here) */
            padding: 0.2rem 0.3rem; /* For example, very little lateral padding */
        }
        h1, h2 {
            /* Ajustez cette valeur négative pour remonter les titres. */
            /* Commencez avec une petite valeur comme -1rem et augmentez si nécessaire. */
            margin-top: -1.5rem; /* Exemple: remonte le titre de 1.5rem */
            /* Vous pouvez aussi ajuster les paddings si les précédents ajustements ne suffisent pas */
            padding-top: 0; /* Assurez-vous qu'il n'y a pas de padding supérieur indésirable sur les titres eux-mêmes */
            /* Conservez vos autres styles de titres pour mobile */
            padding-bottom: 0.8rem;
            margin-bottom: 0.8rem;
            line-height: 1.5;
            font-size: 1.8rem;
        }
        .bottom-nav {
            padding: 0.5rem 0;
        }
        .nav-item {
            font-size: 0.9rem;
            padding: 0.5rem;
        }
        .nav-item i {
            font-size: 2rem;
        }
        .toggle-nav-button {
            width: 35px;
            height: 35px;
            top: -40px;
            right: 15px;
        }
        .toggle-nav-button i {
            font-size: 1rem;
        }
        .modal-content {
            padding: 1rem;
        }
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.error('SW error:', err));
      });
    }
  </script>
</head>
<body>
  <div id="shoppingList" class="section-container section">
    <h1 id="shoppingListTitle">My Shopping List 🛒 <i class="fas fa-bell notification-bell" id="notificationBell"></i></h1>

    <ul id="shoppingListToBuy" class="item-list"></ul>
    <div id="addItemForm" class="add-form">
        <h3>Add an item</h3>
        <input type="text" id="newItemInput" placeholder="Add an item" />
        <input type="number" id="newQuantityInput" placeholder="Quantity (optional)" value="1" min="1" />
        <select id="newCategorySelect"></select>
        <button id="addItemBtn">Add to list</button>
    </div>
  </div>

  <div id="buyLater" class="section-container section hidden">
    <h2>Buy Later 🛒</h2>
    <div id="addBuyLaterItemForm" class="add-form">
        <label for="newBuyLaterItemInput">Add item to buy later:</label>
        <input type="text" id="newBuyLaterItemInput" placeholder="Item to buy later" />
        <button id="addBuyLaterItemBtn">Add</button>
    </div>
    <ul id="buyLaterList"></ul>
  </div>

  <div id="suggestions" class="section-container section hidden">
    <h2 id="suggestionsTitle">Suggestions 💡</h2>
    <div class="filter-controls">
        <label for="suggestionCategoryFilter">Filter by category:</label>
        <select id="suggestionCategoryFilter"></select>
    </div>
    <ul id="suggestionList"></ul>
    <div id="addSuggestionForm" class="add-form">
        <label for="newSuggestionInput">Add a suggestion:</label>
        <input type="text" id="newSuggestionInput" placeholder="Suggest an item" />
        <label for="newSuggestionCategorySelect">Category:</label>
        <select id="newSuggestionCategorySelect"></select>
        <button id="addSuggestionBtn">Add Suggestion</button>
    </div>
  </div>

  <div id="categories" class="section-container section hidden">
    <h2>Manage Categories 📂</h2>
    <div id="addCategoryForm" class="add-form">
        <label for="newCategoryInput">Add new category:</label>
        <input type="text" id="newCategoryInput" placeholder="New category" />
        <button id="addCategoryBtn">Add Category</button>
    </div>
    <h3>Your Categories</h3>
    <ul id="categoryList"></ul>
    <h3>Category Order</h3>
    <p class="empty-list-message">Drag categories to set their order.</p>
    <ul id="categoryOrderList" class="sortable-list"></ul>
    </div>

  <div id="settings" class="section-container section hidden">
    <h2>Settings ⚙️</h2>
    <p>Active list code: <strong id="activeShareCode">N/A</strong></p>
    <hr>
    <h3>Load / Create a List</h3>
    <input type="text" id="shareCodeInput" placeholder="Enter a share code" />
    <button id="loadShareCodeBtn">Load/Create List</button>
    <hr>
    <button id="changeShareCodeBtn">Change List / Disconnect</button>
  </div>

  <div id="notificationModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-btn" id="closeNotificationModalBtn">&times;</button>
      <h3>Send Notification</h3>
      <textarea id="notificationMessageInput" placeholder="Write your message here..."></textarea>
      <div class="modal-buttons">
        <button id="sendNotificationBtn">Send Notification</button>
        <button id="saveMessageBtn">Save Message</button>
      </div>

      <h4>Saved Messages</h4>
      <p id="emptySavedMessages" class="empty-list-message">No saved messages.</p>
      <ul id="savedMessagesList"></ul>
    </div>
  </div>

  <div class="bottom-nav">
    <button id="toggleNavBtn" class="toggle-nav-button">
      <i class="fas fa-chevron-down"></i>
    </button>
    <div class="nav-item active" id="navShoppingList">
      <i class="fas fa-shopping-basket"></i>
      <span>My List</span>
    </div>
    <div class="nav-item" id="navBuyLater">
      <i class="fas fa-clock"></i>
      <span>Later</span>
    </div>
    <div class="nav-item" id="navSuggestions">
      <i class="fas fa-lightbulb"></i>
      <span>Suggestions</span>
    </div>
    <div class="nav-item" id="navCategories">
      <i class="fas fa-folder"></i>
      <span>Categories</span>
    </div>
    <div class="nav-item" id="navSettings">
      <i class="fas fa-cog"></i>
      <span>Settings</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Supabase Configuration ---
    const SUPABASE_URL = 'https://cepqcretnxfhjbvdukkk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU'; // Replace with your actual anon key

    let supabase = null; // Will be initialized in window.addEventListener('load')

    // --- Global Variables ---
    let currentShareCode = null;
    let currentListId = null;

    const shoppingListToBuy = document.getElementById('shoppingListToBuy');
    const newItemInput = document.getElementById('newItemInput');
    const newQuantityInput = document.getElementById('newQuantityInput');
    const newCategorySelect = document.getElementById('newCategorySelect');
    const addItemBtn = document.getElementById('addItemBtn');
    const shoppingListTitle = document.getElementById('shoppingListTitle'); // Added for scroll

    // Moved to settings section
    const shareCodeInput = document.getElementById('shareCodeInput');
    const loadShareCodeBtn = document.getElementById('loadShareCodeBtn');
    const addItemForm = document.getElementById('addItemForm');

    // Sections
    const shoppingListSection = document.getElementById('shoppingList');
    const buyLaterSection = document.getElementById('buyLater');
    const suggestionsSection = document.getElementById('suggestions');
    const categoriesSection = document.getElementById('categories');
    const settingsSection = document.getElementById('settings');

    // Navigation
    const navShoppingList = document.getElementById('navShoppingList');
    const navBuyLater = document.getElementById('navBuyLater');
    const navSuggestions = document.getElementById('navSuggestions');
    const navCategories = document.getElementById('navCategories');
    const navSettings = document.getElementById('navSettings');
    const bottomNav = document.querySelector('.bottom-nav'); // Reference to the bottom menu

    // Buy Later section elements
    const newBuyLaterItemInput = document.getElementById('newBuyLaterItemInput');
    const addBuyLaterItemBtn = document.getElementById('addBuyLaterItemBtn');
    const buyLaterList = document.getElementById('buyLaterList');

    // Suggestions section elements
    const suggestionsTitle = document.getElementById('suggestionsTitle'); // Added for scroll
    const suggestionCategoryFilter = document.getElementById('suggestionCategoryFilter'); // New category filter
    const newSuggestionInput = document.getElementById('newSuggestionInput');
    const newSuggestionCategorySelect = document.getElementById('newSuggestionCategorySelect');
    const addSuggestionBtn = document.getElementById('addSuggestionBtn');
    const suggestionList = document.getElementById('suggestionList');

    // Categories section elements
    const newCategoryInput = document.getElementById('newCategoryInput');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoryList = document.getElementById('categoryList');
    const categoryOrderList = document.getElementById('categoryOrderList');

    // Settings section elements
    const activeShareCodeSpan = document.getElementById('activeShareCode');
    const changeShareCodeBtn = document.getElementById('changeShareCodeBtn');

    // New variable for the toggle button
    const toggleNavBtn = document.getElementById('toggleNavBtn');

    // Notification Modal Elements
    const notificationBell = document.getElementById('notificationBell');
    const notificationModal = document.getElementById('notificationModal');
    const closeNotificationModalBtn = document.getElementById('closeNotificationModalBtn');
    const notificationMessageInput = document.getElementById('notificationMessageInput');
    const sendNotificationBtn = document.getElementById('sendNotificationBtn');
    const saveMessageBtn = document.getElementById('saveMessageBtn');
    const savedMessagesList = document.getElementById('savedMessagesList');
    const emptySavedMessages = document.getElementById('emptySavedMessages');

    // --- Default Categories ---
    const initialDefaultCategories = [
      "Fruits et Légumes",
      "Produits Laitiers",
      "Viandes et Poissons",
      "Produits d'Épicerie",
      "Boulangerie",
      "Boissons",
      "Surgelés",
      "Entretien",
      "Hygiène",
      "Autres"
    ];

    // --- Utility Functions ---
    function generateShareCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    async function handleInitialLoad() {
      let shareCode = localStorage.getItem('lastShareCode');
      if (shareCode) {
        shareCodeInput.value = shareCode; // Set the input in settings
        await getOrCreateListByShareCode(shareCode);
        showSection('shoppingList'); // Show shopping list if connected
      } else {
        // If no share code, go to settings for the user to enter one
        showSection('settings'); // Optionally, pre-fill with a generated code to suggest creation
        shareCodeInput.value = generateShareCode();
        alert("Welcome! Please enter a share code or click 'Load/Create List' to generate a new one.");
      }
    }

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });
      document.getElementById(sectionId).classList.remove('hidden');

      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById('nav' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1)).classList.add('active');

      // Specific for the settings section
      if (sectionId === 'settings') {
        activeShareCodeSpan.textContent = currentShareCode || 'N/A';
      }

      // Load section-specific data if necessary
      if (sectionId === 'buyLater') {
        loadBuyLaterList();
      } else if (sectionId === 'suggestions') {
        updateSuggestionCategoryFilter(); // Update category filter
        loadSuggestions(); // Load suggestions after filter update
      } else if (sectionId === 'categories') {
        renderCategories();
        loadCategoryOrder();
      }
    }

    // New function to toggle the bottom navigation
    function toggleBottomNav() {
      const bottomNav = document.querySelector('.bottom-nav');
      const icon = toggleNavBtn.querySelector('i');

      if (bottomNav.classList.contains('hidden-nav')) {
        bottomNav.classList.remove('hidden-nav');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
      } else {
        bottomNav.classList.add('hidden-nav');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
      }
      updateBodyPadding(); // Update body padding after toggle
    }

    // New function to adjust body padding-bottom
    function updateBodyPadding() {
      const bottomNavHeight = bottomNav.offsetHeight;
      // The toggle button is outside the bottom-nav for fixed positioning.
      // We need to account for both the nav and the toggle button's height
      // to avoid content being hidden. Assuming toggle button is 40px height + 20px top margin from nav.
      const effectiveNavHeight = bottomNav.classList.contains('hidden-nav') ? 0 : bottomNavHeight;
      const toggleButtonHeight = bottomNav.classList.contains('hidden-nav') ? 40 : 0; // Only visible when nav is hidden
      document.body.style.paddingBottom = `${effectiveNavHeight + toggleButtonHeight + 20}px`;
    }

    function updateSupabaseHeaders(shareCode) {
      if (supabase && supabase.rest) {
        supabase.rest.headers['X-Share-Code'] = shareCode;
        console.log(`Supabase headers updated with X-Share-Code: ${shareCode}`);
      } else {
        console.warn("Supabase client not initialized or rest client not ready, cannot update headers.");
      }
    }

    function getCategories() {
      return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
      localStorage.setItem('user_categories', JSON.stringify(categories));
    }

    function updateAllCategorySelects() {
      const categories = getCategories();
      const selects = document.querySelectorAll('select#newCategorySelect, select#newSuggestionCategorySelect');
      selects.forEach(select => {
        select.innerHTML = '';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          select.appendChild(option);
        });
      });
      if (categories.length > 0) {
        newCategorySelect.value = categories[0];
        newSuggestionCategorySelect.value = categories[0];
      }
    }

    function updateSuggestionCategoryFilter() {
      const categories = getCategories();
      suggestionCategoryFilter.innerHTML = '';

      // Add "All" option
      const allOption = document.createElement('option');
      allOption.value = 'All';
      allOption.textContent = 'All Categories';
      suggestionCategoryFilter.appendChild(allOption);

      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        suggestionCategoryFilter.appendChild(option);
      });
      loadSuggestions(); // Reload suggestions after filter update
    }

    // --- Data Interaction Functions ---
    async function getOrCreateListByShareCode(shareCode) {
      if (!supabase) {
          console.error('Supabase client not initialized.');
          return null;
      }
      try {
        // First, try to get the list using the share code
        let { data: list, error } = await supabase
          .from('lists')
          .select('id')
          .eq('share_code', shareCode)
          .single();

        if (error && error.code === 'PGRST116') { // No rows found
          console.log(`List with share code ${shareCode} not found, creating a new one.`);
          const { data: newlist, error: createError } = await supabase
            .from('lists')
            .insert({ share_code: shareCode })
            .select('id')
            .single();

          if (createError) throw createError;
          list = newlist;
          alert(`New list created with code: ${shareCode}`);
        } else if (error) {
          throw error;
        }

        currentListId = list.id;
        currentShareCode = shareCode; // Store the share code
        localStorage.setItem('lastShareCode', shareCode);
        activeShareCodeSpan.textContent = currentShareCode; // Update settings display
        updateSupabaseHeaders(shareCode); // Update headers for RLS

        console.log(`Using list ID: ${currentListId} with share code: ${currentShareCode}`);
        await loadShoppingList(); // Load items for the newly set list

        return list.id;

      } catch (error) {
        console.error('Error getting or creating list:', error.message);
        alert('Error loading or creating list. Please try again.');
        currentListId = null;
        currentShareCode = null;
        activeShareCodeSpan.textContent = 'N/A';
        localStorage.removeItem('lastShareCode');
        return null;
      }
    }

    async function loadShoppingList() {
      if (!currentListId) {
        shoppingListToBuy.innerHTML = '<p class="empty-list-message">Please load or create a list in settings.</p>';
        return;
      }

      const { data, error } = await supabase
        .from('shopping_list_items')
        .select('*')
        .eq('list_id', currentListId)
        .order('category_order', { ascending: true }) // Order by category first
        .order('name', { ascending: true }); // Then by name

      if (error) {
        console.error('Error loading shopping list:', error.message);
        shoppingListToBuy.innerHTML = `<p class="empty-list-message">Error loading list: ${error.message}</p>`;
      } else {
        renderShoppingList(data);
      }
    }

    async function addItemToList(name, quantity, category) {
      if (!currentListId) {
        alert('Please load or create a list in settings first.');
        return;
      }
      if (!name) {
        alert('Item name cannot be empty.');
        return;
      }
      const { data, error } = await supabase
        .from('shopping_list_items')
        .insert([{ name, quantity, category, list_id: currentListId }])
        .select();

      if (error) {
        console.error('Error adding item:', error.message);
        alert('Error adding item: ' + error.message);
      } else {
        newItemInput.value = '';
        newQuantityInput.value = '1'; // Reset quantity to 1
        loadShoppingList(); // Reload list to show new item
      }
    }

    async function updateItemQuantity(itemId, newQuantity) {
      if (!currentListId) return; // Should not happen if UI is correct

      if (newQuantity <= 0) {
        await removeItemFromList(itemId); // Remove if quantity is 0 or less
        return;
      }

      const { data, error } = await supabase
        .from('shopping_list_items')
        .update({ quantity: newQuantity })
        .eq('id', itemId)
        .eq('list_id', currentListId); // Ensure RLS is applied

      if (error) {
        console.error('Error updating quantity:', error.message);
        alert('Error updating quantity: ' + error.message);
      } else {
        loadShoppingList();
      }
    }

    async function removeItemFromList(itemId) {
      if (!currentListId) return;

      const { error } = await supabase
        .from('shopping_list_items')
        .delete()
        .eq('id', itemId)
        .eq('list_id', currentListId); // Ensure RLS is applied

      if (error) {
        console.error('Error removing item:', error.message);
        alert('Error removing item: ' + error.message);
      } else {
        loadShoppingList();
      }
    }

    async function loadBuyLaterList() {
        if (!currentListId) {
            buyLaterList.innerHTML = '<p class="empty-list-message">Please load or create a list in settings.</p>';
            return;
        }

        const { data, error } = await supabase
            .from('buy_later_items')
            .select('*')
            .eq('list_id', currentListId)
            .order('created_at', { ascending: true }); // Order by creation time

        if (error) {
            console.error('Error loading buy later list:', error.message);
            buyLaterList.innerHTML = `<p class="empty-list-message">Error loading list: ${error.message}</p>`;
        } else {
            renderBuyLaterList(data);
        }
    }

    async function addBuyLaterItem(name) {
        if (!currentListId) {
            alert('Please load or create a list in settings first.');
            return;
        }
        if (!name) {
            alert('Item name cannot be empty.');
            return;
        }

        const { data, error } = await supabase
            .from('buy_later_items')
            .insert([{ name, list_id: currentListId }])
            .select();

        if (error) {
            console.error('Error adding buy later item:', error.message);
            alert('Error adding item to buy later: ' + error.message);
        } else {
            newBuyLaterItemInput.value = '';
            loadBuyLaterList();
        }
    }

    async function removeBuyLaterItem(itemId) {
        if (!currentListId) return;

        const { error } = await supabase
            .from('buy_later_items')
            .delete()
            .eq('id', itemId)
            .eq('list_id', currentListId);

        if (error) {
            console.error('Error removing buy later item:', error.message);
            alert('Error removing item from buy later: ' + error.message);
        } else {
            loadBuyLaterList();
        }
    }

    async function loadSuggestions() {
        if (!currentListId) {
            suggestionList.innerHTML = '<p class="empty-list-message">Please load or create a list in settings.</p>';
            return;
        }

        let query = supabase
            .from('suggestions')
            .select('*')
            .eq('list_id', currentListId)
            .order('name', { ascending: true });

        const selectedCategory = suggestionCategoryFilter.value;
        if (selectedCategory !== 'All') {
            query = query.eq('category', selectedCategory);
        }

        const { data, error } = await query;

        if (error) {
            console.error('Error loading suggestions:', error.message);
            suggestionList.innerHTML = `<p class="empty-list-message">Error loading suggestions: ${error.message}</p>`;
        } else {
            renderSuggestions(data);
        }
    }

    async function addSuggestion(name, category) {
        if (!currentListId) {
            alert('Please load or create a list in settings first.');
            return;
        }
        if (!name) {
            alert('Suggestion name cannot be empty.');
            return;
        }

        const { data, error } = await supabase
            .from('suggestions')
            .insert([{ name, category, list_id: currentListId }])
            .select();

        if (error) {
            console.error('Error adding suggestion:', error.message);
            alert('Error adding suggestion: ' + error.message);
        } else {
            newSuggestionInput.value = '';
            // Reset category select to the first category if desired, or 'All'
            newSuggestionCategorySelect.value = getCategories()[0];
            loadSuggestions(); // Reload suggestions after adding
        }
    }

    async function removeSuggestion(suggestionId) {
        if (!currentListId) return;

        const { error } = await supabase
            .from('suggestions')
            .delete()
            .eq('id', suggestionId)
            .eq('list_id', currentListId);

        if (error) {
            console.error('Error removing suggestion:', error.message);
            alert('Error removing suggestion: ' + error.message);
        } else {
            loadSuggestions();
        }
    }

    async function addCategory(name) {
        if (!name) {
            alert('Category name cannot be empty.');
            return;
        }

        let categories = getCategories();
        if (categories.includes(name)) {
            alert('Category already exists!');
            return;
        }

        categories.push(name);
        saveCategories(categories);
        updateAllCategorySelects();
        renderCategories();
        // Add to order list as well at the end
        const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || [];
        categoryOrder.push(name);
        localStorage.setItem('category_order', JSON.stringify(categoryOrder));
        loadCategoryOrder();
        newCategoryInput.value = '';
    }

    function removeCategory(name) {
        if (!confirm(`Are you sure you want to delete the category "${name}"? This will not delete items, but their category field will be blank.`)) {
            return;
        }
        let categories = getCategories().filter(cat => cat !== name);
        saveCategories(categories);
        updateAllCategorySelects();
        renderCategories();
        // Also remove from category order
        let categoryOrder = JSON.parse(localStorage.getItem('category_order')) || [];
        categoryOrder = categoryOrder.filter(cat => cat !== name);
        localStorage.setItem('category_order', JSON.stringify(categoryOrder));
        loadCategoryOrder();
    }

    function saveCategoryOrder(order) {
        localStorage.setItem('category_order', JSON.stringify(order));
        loadShoppingList(); // Reload shopping list to apply new order
    }

    async function saveMessage(message) {
        if (!message) {
            alert('Message cannot be empty.');
            return;
        }
        if (!currentListId) {
            alert('Please load or create a list in settings first.');
            return;
        }

        const { data, error } = await supabase
            .from('saved_messages')
            .insert([{ message_text: message, list_id: currentListId }])
            .select();

        if (error) {
            console.error('Error saving message:', error.message);
            alert('Error saving message: ' + error.message);
        } else {
            notificationMessageInput.value = '';
            loadSavedMessages();
        }
    }

    async function loadSavedMessages() {
        if (!currentListId) {
            emptySavedMessages.style.display = 'block';
            savedMessagesList.innerHTML = '';
            return;
        }

        const { data, error } = await supabase
            .from('saved_messages')
            .select('*')
            .eq('list_id', currentListId)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading saved messages:', error.message);
            emptySavedMessages.style.display = 'block';
            savedMessagesList.innerHTML = '';
        } else {
            renderSavedMessages(data);
        }
    }

    async function removeSavedMessage(messageId) {
        if (!currentListId) return;

        const { error } = await supabase
            .from('saved_messages')
            .delete()
            .eq('id', messageId)
            .eq('list_id', currentListId);

        if (error) {
            console.error('Error removing saved message:', error.message);
            alert('Error removing saved message: ' + error.message);
        } else {
            loadSavedMessages();
        }
    }

    async function sendPushNotification(message) {
        if (!currentListId) {
            alert('Please load or create a list in settings first to send notifications.');
            return;
        }
        if (!message) {
            alert('Notification message cannot be empty.');
            return;
        }

        try {
            const { data, error } = await supabase.functions.invoke('send-push-notification', {
                body: { 
                    list_id: currentListId, 
                    title: "Shopping List Update 🛒", 
                    body: message 
                },
            });

            if (error) {
                console.error('Error invoking Edge Function:', error);
                alert('Error sending notification: ' + error.message);
            } else {
                console.log('Push notification Edge Function invoked successfully:', data);
                alert('Notification sent (if subscribers exist for this list)!');
            }
        } catch (error) {
            console.error('Network or other error invoking Edge Function:', error);
            alert('Could not send notification. Network error or function issue.');
        }
    }


    // --- Rendering Functions ---
    function renderShoppingList(items) {
      shoppingListToBuy.innerHTML = '';
      if (items.length === 0) {
        shoppingListToBuy.innerHTML = '<p class="empty-list-message">Your shopping list is empty. Add some items!</p>';
        return;
      }

      // Group items by category and then sort by category order
      const categoriesOrder = JSON.parse(localStorage.getItem('category_order')) || [];
      const categorizedItems = {};

      items.forEach(item => {
        const category = item.category || 'Uncategorized';
        if (!categorizedItems[category]) {
          categorizedItems[category] = [];
        }
        categorizedItems[category].push(item);
      });

      // Sort categories based on saved order, then add uncategorized
      const sortedCategories = [...categoriesOrder, ...Object.keys(categorizedItems).filter(cat => !categoriesOrder.includes(cat))];
      // Move 'Uncategorized' to the end if it exists
      const uncategorizedIndex = sortedCategories.indexOf('Uncategorized');
      if (uncategorizedIndex > -1) {
          const uncategorized = sortedCategories.splice(uncategorizedIndex, 1)[0];
          sortedCategories.push(uncategorized);
      }

      sortedCategories.forEach(category => {
        if (categorizedItems[category] && categorizedItems[category].length > 0) {
          const categoryHeader = document.createElement('h3');
          categoryHeader.textContent = category;
          shoppingListToBuy.appendChild(categoryHeader);

          categorizedItems[category].forEach(item => {
            const li = document.createElement('li');
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-category', item.category); // Add data-category attribute

            const itemNameSpan = document.createElement('span');
            itemNameSpan.className = 'item-name';
            itemNameSpan.textContent = item.name;

            const quantityControlDiv = document.createElement('div');
            quantityControlDiv.className = 'quantity-control';

            const decrementBtn = document.createElement('button');
            decrementBtn.innerHTML = '<i class="fas fa-minus"></i>';
            decrementBtn.addEventListener('click', () => updateItemQuantity(item.id, item.quantity - 1));

            const quantitySpan = document.createElement('span');
            quantitySpan.textContent = item.quantity;

            const incrementBtn = document.createElement('button');
            incrementBtn.innerHTML = '<i class="fas fa-plus"></i>';
            incrementBtn.addEventListener('click', () => updateItemQuantity(item.id, item.quantity + 1));

            quantityControlDiv.appendChild(decrementBtn);
            quantityControlDiv.appendChild(quantitySpan);
            quantityControlDiv.appendChild(incrementBtn);

            const itemActionsDiv = document.createElement('div');
            itemActionsDiv.className = 'item-actions';

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>'; // Font Awesome X icon
            removeBtn.addEventListener('click', () => removeItemFromList(item.id));

            itemActionsDiv.appendChild(removeBtn);

            li.appendChild(quantityControlDiv);
            li.appendChild(itemNameSpan);
            li.appendChild(itemActionsDiv);
            shoppingListToBuy.appendChild(li);
          });
        }
      });
    }

    function renderBuyLaterList(items) {
        buyLaterList.innerHTML = '';
        if (items.length === 0) {
            buyLaterList.innerHTML = '<p class="empty-list-message">Your "Buy Later" list is empty.</p>';
            return;
        }

        items.forEach(item => {
            const li = document.createElement('li');
            li.setAttribute('data-id', item.id);

            const itemNameSpan = document.createElement('span');
            itemNameSpan.className = 'item-name';
            itemNameSpan.textContent = item.name;

            const itemActionsDiv = document.createElement('div');
            itemActionsDiv.className = 'item-actions';

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.addEventListener('click', () => removeBuyLaterItem(item.id));

            itemActionsDiv.appendChild(removeBtn);

            li.appendChild(itemNameSpan);
            li.appendChild(itemActionsDiv);
            buyLaterList.appendChild(li);
        });
    }

    function renderSuggestions(suggestions) {
        suggestionList.innerHTML = '';
        if (suggestions.length === 0) {
            suggestionList.innerHTML = '<p class="empty-list-message">No suggestions yet. Add some!</p>';
            return;
        }

        suggestions.forEach(suggestion => {
            const li = document.createElement('li');
            li.setAttribute('data-id', suggestion.id);
            li.setAttribute('data-name', suggestion.name);
            li.setAttribute('data-category', suggestion.category);

            // Item info part (name + category)
            const suggestionInfoDiv = document.createElement('div');
            suggestionInfoDiv.className = 'suggestion-info';
            suggestionInfoDiv.addEventListener('click', () => {
                // Add to main shopping list on click
                addItemToList(suggestion.name, 1, suggestion.category);
            });

            const suggestionNameSpan = document.createElement('span');
            suggestionNameSpan.className = 'name';
            suggestionNameSpan.textContent = suggestion.name;
            suggestionInfoDiv.appendChild(suggestionNameSpan);

            if (suggestion.category) {
                const suggestionCategorySpan = document.createElement('span');
                suggestionCategorySpan.className = 'category';
                suggestionCategorySpan.textContent = `(${suggestion.category})`;
                suggestionInfoDiv.appendChild(suggestionCategorySpan);
            }
            li.appendChild(suggestionInfoDiv);

            // Actions part (delete button)
            const suggestionActionsDiv = document.createElement('div');
            suggestionActionsDiv.className = 'suggestion-actions';

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.addEventListener('click', () => removeSuggestion(suggestion.id));
            suggestionActionsDiv.appendChild(removeBtn);

            li.appendChild(suggestionActionsDiv);
            suggestionList.appendChild(li);
        });
    }

    function renderCategories() {
        categoryList.innerHTML = '';
        const categories = getCategories();
        if (categories.length === 0) {
            categoryList.innerHTML = '<p class="empty-list-message">No categories yet. Add some!</p>';
            return;
        }
        categories.forEach(category => {
            const li = document.createElement('li');
            li.textContent = category;

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.addEventListener('click', () => removeCategory(category));

            li.appendChild(removeBtn);
            categoryList.appendChild(li);
        });
    }

    let draggedCategory = null;

    function loadCategoryOrder() {
        categoryOrderList.innerHTML = '';
        const categories = getCategories();
        const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || [];

        // Ensure all current categories are in the order list, adding new ones at the end if necessary
        const finalOrder = [...new Set([...categoryOrder, ...categories])];
        localStorage.setItem('category_order', JSON.stringify(finalOrder));

        if (finalOrder.length === 0) {
            document.querySelector('#categories p.empty-list-message').style.display = 'block';
            return;
        } else {
            document.querySelector('#categories p.empty-list-message').style.display = 'none';
        }

        finalOrder.forEach(category => {
            const li = document.createElement('li');
            li.textContent = category;
            li.setAttribute('draggable', 'true');
            li.classList.add('draggable'); // Add a class for drag-and-drop

            const dragHandle = document.createElement('span');
            dragHandle.className = 'drag-handle';
            dragHandle.innerHTML = '<i class="fas fa-grip-lines"></i>'; // Font Awesome grip lines icon
            li.prepend(dragHandle); // Add handle at the beginning of the li

            categoryOrderList.appendChild(li);
        });

        // Add drag and drop event listeners
        categoryOrderList.querySelectorAll('.draggable').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedCategory = item;
                setTimeout(() => item.classList.add('dragging'), 0);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', item.textContent.trim()); // Store the category name
            });

            item.addEventListener('dragend', () => {
                draggedCategory.classList.remove('dragging');
                draggedCategory = null;
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault(); // Allow drop
                const draggingItem = document.querySelector('.dragging');
                if (draggingItem && draggingItem !== item) {
                    const bounding = item.getBoundingClientRect();
                    const offset = bounding.y + (bounding.height / 2);
                    if (e.clientY > offset) {
                        categoryOrderList.insertBefore(draggingItem, item.nextSibling);
                    } else {
                        categoryOrderList.insertBefore(draggingItem, item);
                    }
                }
            });
        });

        categoryOrderList.addEventListener('drop', (e) => {
            e.preventDefault();
            const newOrder = Array.from(categoryOrderList.children).map(li => li.textContent.trim());
            saveCategoryOrder(newOrder);
        });

        categoryOrderList.addEventListener('dragleave', (e) => {
            // This can be tricky. Often not needed.
            // console.log('dragleave', e.target);
        });
    }

    function renderSavedMessages(messages) {
        savedMessagesList.innerHTML = '';
        if (messages.length === 0) {
            emptySavedMessages.style.display = 'block';
            return;
        } else {
            emptySavedMessages.style.display = 'none';
        }

        messages.forEach(message => {
            const li = document.createElement('li');
            li.setAttribute('data-id', message.id);

            const messageTextSpan = document.createElement('span');
            messageTextSpan.className = 'message-text';
            messageTextSpan.textContent = message.message_text;
            messageTextSpan.addEventListener('click', () => {
                notificationMessageInput.value = message.message_text;
                closeNotificationModal();
            });

            const messageActionsDiv = document.createElement('div');
            messageActionsDiv.className = 'message-actions';

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.addEventListener('click', () => removeSavedMessage(message.id));

            messageActionsDiv.appendChild(removeBtn);
            li.appendChild(messageTextSpan);
            li.appendChild(messageActionsDiv);
            savedMessagesList.appendChild(li);
        });
    }


    // --- Event Listeners ---
    window.addEventListener('load', async () => {
      // Initialize Supabase client here to ensure it's ready
      try {
          supabase = supabase_js.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("Supabase client initialized.");
      } catch (e) {
          console.error("Failed to initialize Supabase client:", e);
          alert("Loading error: Supabase library could not be initialized. Check your internet connection or configuration.");
          return;
      }

      let attempts = 0;
      const maxAttempts = 20;
      const delayMs = 50;

      while (!supabase.rest && attempts < maxAttempts) {
          console.log(`Waiting for supabase.rest (attempt ${attempts + 1}/${maxAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, delayMs));
          attempts++;
      }

      if (supabase.rest) {
          console.log("supabase.rest is now ready!");
          // Initialize categories if not present in local storage
          if (!localStorage.getItem('user_categories')) {
              localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
          }
          await handleInitialLoad(); // This will load data and set currentListId
          updateAllCategorySelects();
          updateSuggestionCategoryFilter();
          updateBodyPadding(); // Update body padding on initial load
          renderCategories(); // Initial rendering of categories list
          loadCategoryOrder(); // Initial load of category order list
      } else {
          console.error("Error: supabase.rest did not become ready after multiple attempts. Cannot start application.");
          alert("Startup error: Could not initialize database connection. Check your connection.");
          return;
      }
    });

    addItemBtn.addEventListener('click', () => {
      const itemName = newItemInput.value.trim();
      const quantity = parseInt(newQuantityInput.value, 10) || 1;
      const category = newCategorySelect.value;
      addItemToList(itemName, quantity, category);
    });

    newItemInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addItemBtn.click();
      }
    });

    // Navigation event listeners
    navShoppingList.addEventListener('click', () => showSection('shoppingList'));
    navBuyLater.addEventListener('click', () => showSection('buyLater'));
    navSuggestions.addEventListener('click', () => showSection('suggestions'));
    navCategories.addEventListener('click', () => showSection('categories'));
    navSettings.addEventListener('click', () => showSection('settings'));

    // Toggle navigation button
    toggleNavBtn.addEventListener('click', toggleBottomNav);

    // Initial padding adjustment
    window.addEventListener('resize', updateBodyPadding);


    // Buy Later section event listeners
    addBuyLaterItemBtn.addEventListener('click', () => {
        const itemName = newBuyLaterItemInput.value.trim();
        addBuyLaterItem(itemName);
    });

    newBuyLaterItemInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            addBuyLaterItemBtn.click();
        }
    });

    // Suggestions section event listeners
    addSuggestionBtn.addEventListener('click', () => {
        const suggestionName = newSuggestionInput.value.trim();
        const category = newSuggestionCategorySelect.value;
        addSuggestion(suggestionName, category);
    });

    newSuggestionInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            addSuggestionBtn.click();
        }
    });

    suggestionCategoryFilter.addEventListener('change', loadSuggestions);


    // Categories section event listeners
    addCategoryBtn.addEventListener('click', () => {
        const categoryName = newCategoryInput.value.trim();
        addCategory(categoryName);
    });

    newCategoryInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            addCategoryBtn.click();
        }
    });


    // Settings section event listeners
    loadShareCodeBtn.addEventListener('click', async () => {
      const shareCode = shareCodeInput.value.trim();
      if (shareCode) {
        await getOrCreateListByShareCode(shareCode);
        showSection('shoppingList'); // Switch to shopping list after loading/creating
      } else {
        alert('Please enter a share code.');
      }
    });

    changeShareCodeBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to change the active list? You will need to enter a new code or create a new list.')) {
        currentListId = null;
        currentShareCode = null;
        localStorage.removeItem('lastShareCode');
        activeShareCodeSpan.textContent = 'N/A';
        shareCodeInput.value = generateShareCode(); // Suggest new code
        showSection('settings'); // Stay in settings
        loadShoppingList(); // Clear current list display
        updateSupabaseHeaders(null); // Clear share code header
      }
    });

    // --- Notification Modal Logic ---
    function openNotificationModal() {
        notificationModal.classList.add('visible');
        loadSavedMessages(); // Load messages when modal opens
    }

    function closeNotificationModal() {
        notificationModal.classList.remove('visible');
    }

    notificationBell.addEventListener('click', openNotificationModal);
    closeNotificationModalBtn.addEventListener('click', closeNotificationModal);
    notificationModal.addEventListener('click', (e) => {
        if (e.target === notificationModal) {
            closeNotificationModal();
        }
    });

    saveMessageBtn.addEventListener('click', () => {
        const message = notificationMessageInput.value.trim();
        saveMessage(message);
    });

    sendNotificationBtn.addEventListener('click', () => {
        const message = notificationMessageInput.value.trim();
        sendPushNotification(message);
    });

    // Scroll to top for h1/h2 clicks
    shoppingListTitle.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    suggestionsTitle.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>
</body>
</html>