<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shopping List üõí</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 1rem;
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: none;
    }
    .section-container.active {
        display: block;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: bold;
      color: #6A057F;
    }
    input, button, select {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.4rem;
      border: 1px solid #DDA0DD;
      border-radius: 0.5rem;
      box-sizing: border-box;
      color: #333;
      font-size: 1rem;
    }
    button {
      background: #FF69B4;
      color: #FFFFFF;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover {
      background: #C71585;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    select {
        background: #F8F8FF;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='%23C71585' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%;
        background-size: 0.65em auto;
        padding-right: 2.5em;
    }

    /* Styles for navigation buttons */
    .navigation-buttons {
        text-align: center;
        margin-bottom: 2rem;
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }
    .navigation-buttons button {
        width: auto;
        padding: 0.8rem 1.8rem;
        font-size: 1.1rem;
        background-color: #EE82EE;
        color: #FFFFFF;
        border: 2px solid #DA70D6;
        border-radius: 25px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .navigation-buttons button.active {
        background: #FFD700;
        color: #6A057F;
        border-color: #FFA500;
        font-weight: bold;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .navigation-buttons button:hover:not(.active) {
        background-color: #DDA0DD;
        border-color: #BA55D3;
    }
    .navigation-buttons button i {
        margin-right: 0.5rem;
    }
    .navigation-buttons button#toggleOptions {
        background: #FF6347;
        border-color: #FF4500;
    }
    .navigation-buttons button#toggleOptions:hover {
        background: #CD5C5C;
        border-color: #DC143C;
    }
    .navigation-options {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-out;
        padding: 0 1rem;
        text-align: center;
    }
    .navigation-options.show-options {
        max-height: 200px;
        padding: 1rem;
    }

    /* Common List Item Style */
    ul {
        list-style: none;
        padding: 0;
    }
    li {
        background: #F0F8FF;
        border: 1px solid #E0BBE4;
        padding: 0.8rem 1rem;
        margin-bottom: 0.6rem;
        border-radius: 0.7rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    li:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    li.purchased {
        text-decoration: line-through;
        color: #888;
        background-color: #E8E8E8;
    }
    .item-info {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }
    .item-info strong {
        color: #6A057F;
    }
    .item-info span {
        font-size: 0.9em;
        color: #555;
    }
    .item-actions button {
        width: auto;
        padding: 0.4rem 0.7rem;
        border-radius: 0.4rem;
        font-size: 0.8rem;
    }
    .item-actions .purchase-btn {
        background: #8A2BE2;
    }
    .item-actions .purchase-btn:hover {
        background: #6A057F;
    }
    .item-actions .delete-btn {
        background: #FF4500;
    }
    .item-actions .delete-btn:hover {
        background: #DC143C;
    }
    .item-actions .edit-btn {
        background: #FFD700;
        color: #6A057F;
    }
    .item-actions .edit-btn:hover {
        background: #FFA500;
    }

    /* Specific Section Styles */
    #authentication, #myLists, #joinList {
        padding: 1rem;
    }
    #authentication form, #myLists form, #joinList form {
        margin-top: 1rem;
    }
    #myLists ul li {
        cursor: pointer;
    }
    #myLists ul li.active-list {
        background-color: #e6e6fa;
        font-weight: bold;
        border-color: #8a2be2;
    }
    #myLists .share-code-display {
        font-family: monospace;
        background-color: #eee;
        padding: 0.5rem;
        border-radius: 0.3rem;
        margin-top: 0.5rem;
        word-break: break-all;
    }

  </style>
</head>
<body>
  <h1>My Shopping List üõí</h1>

  <nav class="navigation-buttons">
    <button id="authBtn"><i class="fas fa-user"></i> Authentification</button>
    <button id="myListsBtn"><i class="fas fa-list"></i> Mes Listes</button>
    <button id="joinListBtn"><i class="fas fa-handshake"></i> Rejoindre Liste</button>
    <button id="shoppingListBtn" class="active"><i class="fas fa-shopping-basket"></i> Liste Active</button>
    <button id="toggleOptions"><i class="fas fa-chevron-down toggle-icon"></i> Options</button>
  </nav>

  <div class="navigation-options">
    <nav class="navigation-buttons">
        <button id="suggestionsBtn"><i class="fas fa-lightbulb"></i> Suggestions</button>
        <button id="buyLaterBtn"><i class="fas fa-clock"></i> Acheter Plus Tard</button>
        <button id="categoriesBtn"><i class="fas fa-tags"></i> Cat√©gories</button>
        <button id="settingsBtn"><i class="fas fa-cog"></i> Param√®tres</button>
        <button id="signOutBtn" style="background-color: #dc3545;"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>
    </nav>
  </div>

  <div id="authentication" class="section-container">
    <h2>Authentification</h2>
    <div id="authStatus"></div>
    <h3>Inscription</h3>
    <form id="signUpForm">
      <label for="signUpEmail">Email:</label>
      <input type="email" id="signUpEmail" placeholder="Votre email" required />
      <label for="signUpPassword">Mot de passe:</label>
      <input type="password" id="signUpPassword" placeholder="Votre mot de passe" required />
      <label for="signUpUsername">Nom d'utilisateur:</label>
      <input type="text" id="signUpUsername" placeholder="Votre nom d'utilisateur" required />
      <button type="submit">S'inscrire</button>
    </form>
    <h3>Connexion</h3>
    <form id="signInForm">
      <label for="signInEmail">Email:</label>
      <input type="email" id="signInEmail" placeholder="Votre email" required />
      <label for="signInPassword">Mot de passe:</label>
      <input type="password" id="signInPassword" placeholder="Votre mot de passe" required />
      <button type="submit">Se connecter</button>
    </form>
  </div>

  <div id="myLists" class="section-container">
    <h2>Mes Listes</h2>
    <form id="createListForm">
      <label for="newListName">Nom de la nouvelle liste:</label>
      <input type="text" id="newListName" placeholder="Ex: Courses du mois" required />
      <button type="submit"><i class="fas fa-plus"></i> Cr√©er Nouvelle Liste</button>
    </form>
    <h3>Vos Listes Actuelles</h3>
    <ul id="userListsDisplay">
      </ul>
  </div>

  <div id="joinList" class="section-container">
    <h2>Rejoindre une Liste par Code</h2>
    <form id="joinListForm">
      <label for="shareCodeInput">Code de Partage:</label>
      <input type="text" id="shareCodeInput" placeholder="Entrez le code unique" required />
      <button type="submit"><i class="fas fa-paper-plane"></i> Rejoindre la Liste</button>
    </form>
  </div>


  <div id="shoppingList" class="section-container active">
    <h2>Liste Active: <span id="currentListName">Aucune s√©lectionn√©e</span></h2>
    <form id="itemForm">
      <input type="text" id="itemName" placeholder="Nom de l'article" required />
      <input type="number" id="itemQuantity" placeholder="Quantit√©" value="1" min="1" />
      <select id="itemCategory">
        <option value="">S√©lectionner une cat√©gorie</option>
      </select>
      <button type="submit"><i class="fas fa-plus"></i> Ajouter √† la liste</button>
    </form>
    <ul id="shoppingListItems">
      </ul>
  </div>

  <div id="suggestions" class="section-container">
    <h2>Suggestions d'Articles</h2>
    <input type="text" id="suggestionSearch" placeholder="Rechercher des suggestions..." />
    <ul id="suggestionList">
      </ul>
  </div>

  <div id="buyLater" class="section-container">
    <h2>Articles √† Acheter Plus Tard</h2>
    <ul id="buyLaterList">
      </ul>
  </div>

  <div id="categories" class="section-container">
    <h2>G√©rer les Cat√©gories</h2>
    <form id="addCategoryForm">
      <input type="text" id="newCategoryName" placeholder="Nouvelle cat√©gorie" required />
      <button type="submit"><i class="fas fa-plus"></i> Ajouter Cat√©gorie</button>
    </form>
    <ul id="categoryList">
      </ul>
  </div>

  <div id="settings" class="section-container">
    <h2>Param√®tres</h2>
    <p>G√©rez les options de votre application ici.</p>
    </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://cepqcretnxfhjbvdukkk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- DOM Elements ---
    const authBtn = document.getElementById('authBtn');
    const myListsBtn = document.getElementById('myListsBtn');
    const joinListBtn = document.getElementById('joinListBtn');
    const shoppingListBtn = document.getElementById('shoppingListBtn');
    const suggestionsBtn = document.getElementById('suggestionsBtn');
    const buyLaterBtn = document.getElementById('buyLaterBtn');
    const categoriesBtn = document.getElementById('categoriesBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const toggleOptionsIcon = document.querySelector('#toggleOptions .toggle-icon');
    const navigationButtonsContainer = document.querySelector('.navigation-options');
    const allSectionContainers = document.querySelectorAll('.section-container');
    const shoppingListSection = document.getElementById('shoppingList');

    const authStatusDiv = document.getElementById('authStatus');
    const signUpForm = document.getElementById('signUpForm');
    const signInForm = document.getElementById('signInForm');
    const signOutBtn = document.getElementById('signOutBtn');

    const createListForm = document.getElementById('createListForm');
    const newListNameInput = document.getElementById('newListName');
    const userListsDisplayUl = document.getElementById('userListsDisplay');
    const currentListNameSpan = document.getElementById('currentListName');

    const joinListForm = document.getElementById('joinListForm');
    const shareCodeInput = document.getElementById('shareCodeInput');

    const itemForm = document.getElementById('itemForm');
    const itemNameInput = document.getElementById('itemName');
    const itemQuantityInput = document.getElementById('itemQuantity');
    const itemCategorySelect = document.getElementById('itemCategory');
    const shoppingListItemsUl = document.getElementById('shoppingListItems');

    // --- Global State Variables ---
    let currentUserId = null;
    let currentListId = null; // L'ID de la liste actuellement s√©lectionn√©e
    let userLists = []; // Pour stocker les listes auxquelles l'utilisateur a acc√®s

    // --- Helper Functions ---
    function showSection(sectionId) {
        allSectionContainers.forEach(container => {
            container.classList.remove('active');
        });
        document.getElementById(sectionId).classList.add('active');

        const allNavButtons = document.querySelectorAll('.navigation-buttons button');
        allNavButtons.forEach(button => {
            button.classList.remove('active');
        });
        if (sectionId === 'authentication') authBtn.classList.add('active');
        else if (sectionId === 'myLists') myListsBtn.classList.add('active');
        else if (sectionId === 'joinList') joinListBtn.classList.add('active');
        else if (sectionId === 'shoppingList') shoppingListBtn.classList.add('active');
        else if (sectionId === 'suggestions') suggestionsBtn.classList.add('active');
        else if (sectionId === 'buyLater') buyLaterBtn.classList.add('active');
        else if (sectionId === 'categories') categoriesBtn.classList.add('active');
        else if (sectionId === 'settings') settingsBtn.classList.add('active');
    }

    // --- AUTHENTICATION LOGIC ---
    async function updateAuthUI() {
        const { data: { user } } = await supabase.auth.getUser();
        currentUserId = user ? user.id : null;

        if (currentUserId) {
            authStatusDiv.textContent = `Connect√© en tant que ${user.email} (ID: ${user.id})`;
            signUpForm.style.display = 'none';
            signInForm.style.display = 'none';
            signOutBtn.style.display = 'inline-block'; // Show sign out button
            // Load user-specific data after successful login
            await loadUserLists();
            await loadCategoriesFromSupabase(); // Load categories for this user/app
        } else {
            authStatusDiv.textContent = 'Non connect√©.';
            signUpForm.style.display = 'block';
            signInForm.style.display = 'block';
            signOutBtn.style.display = 'none'; // Hide sign out button
            userListsDisplayUl.innerHTML = ''; // Clear lists
            shoppingListItemsUl.innerHTML = '<li>Veuillez vous connecter pour voir vos listes de courses.</li>';
            currentListNameSpan.textContent = 'Aucune s√©lectionn√©e';
            currentListId = null;
        }
    }

    signUpForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = signUpEmail.value;
        const password = signUpPassword.value;
        const username = signUpUsername.value;

        const { data, error } = await supabase.auth.signUp({ email, password });

        if (error) {
            alert(`Erreur d'inscription: ${error.message}`);
        } else if (data.user) {
            // Ins√©rer le profil apr√®s l'inscription
            const { error: profileError } = await supabase
                .from('profiles')
                .insert([{ id: data.user.id, username: username }]);
            if (profileError) {
                console.error("Erreur lors de la cr√©ation du profil:", profileError.message);
                alert("Inscription r√©ussie, mais √©chec de la cr√©ation du profil. Veuillez contacter l'administrateur.");
                await supabase.auth.signOut(); // D√©connecter l'utilisateur si le profil ne peut pas √™tre cr√©√©
            } else {
                alert('Inscription r√©ussie! Veuillez v√©rifier votre email pour confirmer.');
                signUpForm.reset();
            }
        }
    });

    signInForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = signInEmail.value;
        const password = signInPassword.value;

        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            alert(`Erreur de connexion: ${error.message}`);
        } else {
            alert('Connect√© avec succ√®s!');
            signInForm.reset();
        }
    });

    signOutBtn.addEventListener('click', async () => {
        const { error } = await supabase.auth.signOut();
        if (error) {
            console.error('Erreur de d√©connexion:', error.message);
        } else {
            alert('D√©connect√© avec succ√®s!');
        }
    });

    supabase.auth.onAuthStateChange((event, session) => {
        updateAuthUI();
        if (event === 'SIGNED_IN' && session) {
            console.log('User signed in:', session.user);
            // Redirigez vers "Mes Listes" apr√®s connexion
            showSection('myLists');
        } else if (event === 'SIGNED_OUT') {
            console.log('User signed out.');
            showSection('authentication'); // Redirigez vers l'authentification apr√®s d√©connexion
        }
    });

    // --- LIST MANAGEMENT LOGIC ---

    async function loadUserLists() {
        if (!currentUserId) {
            userListsDisplayUl.innerHTML = '<li>Connectez-vous pour voir vos listes.</li>';
            return;
        }

        const { data, error } = await supabase
            .from('list_members')
            .select(`
                list_id,
                role,
                lists (
                    id,
                    name,
                    owner_id,
                    share_code
                )
            `)
            .eq('user_id', currentUserId);

        if (error) {
            console.error('Erreur lors du chargement des listes de l\'utilisateur :', error.message);
            userListsDisplayUl.innerHTML = '<li>Erreur lors du chargement des listes.</li>';
            return;
        }

        userLists = data.map(member => ({
            ...member.lists,
            role: member.role // Ajouter le r√¥le pour chaque liste
        }));
        displayUserLists();
        // Si l'utilisateur a des listes et qu'aucune n'est s√©lectionn√©e, s√©lectionnez la premi√®re
        if (userLists.length > 0 && !currentListId) {
            selectList(userLists[0].id, userLists[0].name);
        } else if (userLists.length === 0) {
            shoppingListItemsUl.innerHTML = '<li>Vous n\'avez pas encore de listes. Cr√©ez-en une ou rejoignez-en une.</li>';
            currentListNameSpan.textContent = 'Aucune s√©lectionn√©e';
            currentListId = null;
        }
    }

    function displayUserLists() {
        userListsDisplayUl.innerHTML = '';
        userLists.forEach(list => {
            const li = document.createElement('li');
            li.dataset.listId = list.id;
            li.classList.toggle('active-list', list.id === currentListId);
            li.innerHTML = `
                <div>
                    <strong>${list.name}</strong> (${list.role})
                    ${list.owner_id === currentUserId ? ` <button class="generate-share-code-btn" data-list-id="${list.id}">G√©n√©rer Code</button>` : ''}
                </div>
                ${list.share_code ? `<div class="share-code-display">Code: ${list.share_code}</div>` : ''}
            `;
            li.addEventListener('click', () => selectList(list.id, list.name));
            userListsDisplayUl.appendChild(li);
        });

        // Add event listeners for generate share code buttons
        document.querySelectorAll('.generate-share-code-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                e.stopPropagation(); // Prevent li click
                const listId = e.target.dataset.listId;
                await generateShareCode(listId);
            });
        });
    }

    async function selectList(listId, listName) {
        currentListId = listId;
        currentListNameSpan.textContent = listName;
        // Mettre √† jour l'√©tat actif dans la liste des listes affich√©es
        document.querySelectorAll('#userListsDisplay li').forEach(li => {
            li.classList.toggle('active-list', li.dataset.listId === listId);
        });
        await loadShoppingList();
        // Optionnel: Passer directement √† la section de la liste de courses
        showSection('shoppingList');
    }

    createListForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUserId) {
            alert("Veuillez vous connecter pour cr√©er une liste.");
            return;
        }
        const newListName = newListNameInput.value.trim();
        if (!newListName) return;

        // 1. Cr√©er la liste
        const { data: listData, error: listError } = await supabase
            .from('lists')
            .insert([{ name: newListName, owner_id: currentUserId }])
            .select();

        if (listError) {
            console.error('Erreur lors de la cr√©ation de la liste:', listError.message);
            alert("Erreur lors de la cr√©ation de la liste.");
            return;
        }
        const newListId = listData[0].id;

        // 2. Ajouter l'utilisateur courant comme membre (propri√©taire) de la liste
        const { error: memberError } = await supabase
            .from('list_members')
            .insert([{ user_id: currentUserId, list_id: newListId, role: 'owner' }]);

        if (memberError) {
            console.error('Erreur lors de l\'ajout du membre √† la liste:', memberError.message);
            alert("Erreur lors de l'ajout de vous-m√™me comme propri√©taire de la liste.");
            // Consid√©rez de supprimer la liste si l'ajout de membre √©choue
            await supabase.from('lists').delete().eq('id', newListId);
            return;
        }

        alert(`Liste "${newListName}" cr√©√©e avec succ√®s!`);
        newListNameInput.value = '';
        await loadUserLists(); // Recharger les listes de l'utilisateur
        selectList(newListId, newListName); // S√©lectionner la nouvelle liste
    });

    async function generateShareCode(listId) {
        const listToUpdate = userLists.find(l => l.id === listId);
        if (!listToUpdate || listToUpdate.owner_id !== currentUserId) {
            alert("Vous n'√™tes pas le propri√©taire de cette liste.");
            return;
        }

        if (listToUpdate.share_code) {
            alert(`Code de partage d√©j√† existant pour cette liste : ${listToUpdate.share_code}`);
            return;
        }

        const newShareCode = crypto.randomUUID(); // G√©n√®re un UUID unique comme code

        const { data, error } = await supabase
            .from('lists')
            .update({ share_code: newShareCode })
            .eq('id', listId)
            .select();

        if (error) {
            console.error('Erreur lors de la g√©n√©ration du code de partage:', error.message);
            alert("Erreur lors de la g√©n√©ration du code de partage.");
        } else {
            alert(`Nouveau code de partage g√©n√©r√© pour "${listToUpdate.name}": ${newShareCode}`);
            await loadUserLists(); // Recharger les listes pour afficher le code
        }
    }

    joinListForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUserId) {
            alert("Veuillez vous connecter pour rejoindre une liste.");
            return;
        }
        const code = shareCodeInput.value.trim();
        if (!code) return;

        // 1. Trouver la liste par le code de partage
        const { data: listData, error: listError } = await supabase
            .from('lists')
            .select('id, name')
            .eq('share_code', code)
            .single();

        if (listError || !listData) {
            alert("Code de partage invalide ou liste introuvable.");
            console.error("Erreur ou liste introuvable pour le code:", error ? error.message : "Pas de donn√©es");
            return;
        }

        const targetListId = listData.id;
        const targetListName = listData.name;

        // V√©rifier si l'utilisateur est d√©j√† membre de cette liste
        const isMember = userLists.some(list => list.id === targetListId);
        if (isMember) {
            alert(`Vous √™tes d√©j√† membre de la liste "${targetListName}".`);
            selectList(targetListId, targetListName);
            return;
        }

        // 2. Ajouter l'utilisateur comme membre (√©diteur par d√©faut, ou r√¥le √† choisir)
        const { error: memberError } = await supabase
            .from('list_members')
            .insert([{ user_id: currentUserId, list_id: targetListId, role: 'editor' }]); // R√¥le par d√©faut

        if (memberError) {
            console.error('Erreur lors de l\'ajout du membre √† la liste:', memberError.message);
            alert("Erreur lors de la tentative de rejoindre la liste.");
            return;
        }

        alert(`Vous avez rejoint la liste "${targetListName}" avec succ√®s!`);
        shareCodeInput.value = '';
        await loadUserLists(); // Recharger les listes de l'utilisateur
        selectList(targetListId, targetListName); // S√©lectionner la liste rejointe
    });

    // --- SHOPPING LIST ITEMS LOGIC ---

    function setupRealtimeListener() {
        console.log("Configuration de l'√©couteur Supabase Realtime...");
        supabase.channel('public:shopping_items')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'shopping_items' }, payload => {
                console.log('Changement Realtime re√ßu !', payload);
                if (currentListId && payload.new && payload.new.list_id === currentListId) {
                    loadShoppingList(); // Recharge la liste si le changement concerne la liste active
                } else if (currentListId && payload.old && payload.old.list_id === currentListId && payload.eventType === 'DELETE') {
                    loadShoppingList(); // Aussi pour les suppressions
                }
            })
            .subscribe();
    }

    async function loadShoppingList() {
        if (!currentListId) {
            shoppingListItemsUl.innerHTML = '<li>Veuillez s√©lectionner ou cr√©er une liste.</li>';
            currentListNameSpan.textContent = 'Aucune s√©lectionn√©e';
            return;
        }
        console.log(`Chargement des articles pour la liste: ${currentListId}...`);

        const { data, error } = await supabase
            .from('shopping_items')
            .select('id, name, quantity, category, purchased')
            .eq('list_id', currentListId) // Filtre par l'ID de la liste active
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Erreur lors du chargement de la liste de courses :', error.message);
            shoppingListItemsUl.innerHTML = '<li>Erreur lors du chargement des articles.</li>';
            return;
        }

        shoppingListItemsUl.innerHTML = '';
        if (data.length === 0) {
            shoppingListItemsUl.innerHTML = '<li>Cette liste est vide. Ajoutez un article !</li>';
        }

        data.forEach(item => {
            const li = document.createElement('li');
            li.dataset.itemId = item.id;
            li.classList.toggle('purchased', item.purchased);

            li.innerHTML = `
                <div class="item-info">
                    <strong>${item.name}</strong>
                    <span>Quantit√©: ${item.quantity} ${item.category ? `(${item.category})` : ''}</span>
                </div>
                <div class="item-actions">
                    <button class="purchase-btn" data-id="${item.id}">${item.purchased ? 'Annuler Achat' : 'Acheter'}</button>
                    <button class="edit-btn" data-id="${item.id}">Modifier</button>
                    <button class="delete-btn" data-id="${item.id}">Supprimer</button>
                </div>
            `;

            li.querySelector('.purchase-btn').addEventListener('click', async (e) => {
                const itemId = e.target.dataset.id;
                const { error: updateError } = await supabase
                    .from('shopping_items')
                    .update({ purchased: !item.purchased })
                    .eq('id', itemId);
                if (updateError) console.error('Erreur lors de la mise √† jour de l\'article :', updateError.message);
                // loadShoppingList() sera appel√©e par le Realtime listener
            });

            li.querySelector('.delete-btn').addEventListener('click', async (e) => {
                const itemId = e.target.dataset.id;
                const { error: deleteError } = await supabase
                    .from('shopping_items')
                    .delete()
                    .eq('id', itemId);
                if (deleteError) console.error('Erreur lors de la suppression de l\'article :', deleteError.message);
                // loadShoppingList() sera appel√©e par le Realtime listener
            });

            // Ajoutez la fonctionnalit√© d'√©dition ici
            // li.querySelector('.edit-btn').addEventListener('click', ...)

            shoppingListItemsUl.appendChild(li);
        });
    }

    itemForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!currentListId) {
            alert("Veuillez s√©lectionner ou cr√©er une liste avant d'ajouter des articles.");
            return;
        }

        const itemName = itemNameInput.value.trim();
        const itemQuantity = parseInt(itemQuantityInput.value, 10);
        const itemCategory = itemCategorySelect.value;

        if (!itemName) {
            alert("Veuillez entrer le nom de l'article.");
            return;
        }

        try {
            const { error } = await supabase
                .from('shopping_items')
                .insert([
                    {
                        name: itemName,
                        quantity: itemQuantity,
                        category: itemCategory,
                        list_id: currentListId, // Assurez-vous que l'article est li√© √† la liste active
                        purchased: false
                    }
                ]);

            if (error) {
                console.error('Erreur lors de l\'ajout de l\'article :', error.message);
                alert("Erreur lors de l'ajout de l'article : " + error.message);
            } else {
                console.log('Article ajout√© avec succ√®s.');
                itemNameInput.value = '';
                itemQuantityInput.value = '1';
                itemCategorySelect.value = '';
                // loadShoppingList() sera appel√©e par le Realtime listener
            }
        } catch (e) {
            console.error("Une erreur inattendue est survenue :", e);
            alert("Une erreur inattendue est survenue.");
        }
    });

    // --- CATEGORIES LOGIC ---
    // Pour l'instant, les cat√©gories sont g√©r√©es en localstorage ou peuvent √™tre une table Supabase
    const initialDefaultCategories = ['Fruits & L√©gumes', 'Produits Laitiers', 'Viandes & Poissons', 'Boulangerie', '√âpicerie', 'Surgel√©s', 'Boissons', 'Maison & Entretien', 'Hygi√®ne & Beaut√©', 'Autres'];

    async function loadCategoriesFromSupabase() {
        // Id√©alement, les cat√©gories devraient √™tre stock√©es dans une table Supabase,
        // potentiellement par utilisateur ou globales. Pour simplifier, nous utiliserons
        // les cat√©gories par d√©faut ou celles du localStorage.
        // Si vous voulez des cat√©gories par utilisateur, liez-les √† `profiles.id`
        // Si globales, liez-les √† l'application.

        let categories = JSON.parse(localStorage.getItem('user_categories') || '[]');
        if (categories.length === 0) { // Si pas de cat√©gories dans localStorage, utilisez les d√©fauts
            categories = initialDefaultCategories;
            localStorage.setItem('user_categories', JSON.stringify(categories));
        }
        updateAllCategorySelects(categories);
    }

    function updateAllCategorySelects(categories) {
        itemCategorySelect.innerHTML = '<option value="">S√©lectionner une cat√©gorie</option>';
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            itemCategorySelect.appendChild(option);
        });
    }

    // --- OTHER SECTIONS PLACEHOLDERS ---
    function loadSuggestions() { console.log("Chargement des suggestions..."); }
    function loadBuyLaterList() { console.log("Chargement de la liste 'Acheter Plus Tard'..."); }
    function loadCategoryOrder() { console.log("Chargement de l'ordre des cat√©gories..."); }


    // --- Initialisation au chargement de la page ---
    window.addEventListener('load', async () => {
      // Configuration initiale des cat√©gories (peut √™tre remplac√© par un chargement Supabase)
      await loadCategoriesFromSupabase();

      // IMPORTANT : Initialise le listener Realtime de Supabase
      setupRealtimeListener();

      // V√©rifie l'√©tat d'authentification et met √† jour l'UI
      await updateAuthUI();

      // G√©rer l'affichage initial
      showSection(currentUserId ? 'myLists' : 'authentication');

      // S'assurer que les options sont cach√©es au chargement initial et que la fl√®che pointe vers le bas
      navigationButtonsContainer.classList.remove('show-options');
      toggleOptionsIcon.classList.remove('fa-chevron-up');
      toggleOptionsIcon.classList.add('fa-chevron-down');
    });

    // --- Event Listeners for Navigation Buttons ---
    authBtn.addEventListener('click', () => showSection('authentication'));
    myListsBtn.addEventListener('click', () => showSection('myLists'));
    joinListBtn.addEventListener('click', () => showSection('joinList'));
    shoppingListBtn.addEventListener('click', () => showSection('shoppingList'));
    suggestionsBtn.addEventListener('click', () => loadSuggestions()); // Should also show section
    buyLaterBtn.addEventListener('click', () => loadBuyLaterList()); // Should also show section
    categoriesBtn.addEventListener('click', () => showSection('categories'));
    settingsBtn.addEventListener('click', () => showSection('settings'));

    document.getElementById('toggleOptions').addEventListener('click', () => {
        const isShowing = navigationButtonsContainer.classList.contains('show-options');
        if (!isShowing) {
            navigationButtonsContainer.classList.add('show-options');
            toggleOptionsIcon.classList.remove('fa-chevron-down');
            toggleOptionsIcon.classList.add('fa-chevron-up');
        } else {
            navigationButtonsContainer.classList.remove('show-options');
            toggleOptionsIcon.classList.remove('fa-chevron-up');
            toggleOptionsIcon.classList.add('fa-chevron-down');
            if (!shoppingListSection.classList.contains('active')) {
                showSection('shoppingList'); // Retour √† la liste par d√©faut si les options se ferment
            }
        }
    });

  </script>
</body>
</html>