<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shopping List 🛒</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 1rem;
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: none;
    }
    .section-container.active {
        display: block;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: bold;
      color: #6A057F;
    }
    input, button, select {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.4rem;
      border: 1px solid #DDA0DD;
      border-radius: 0.5rem;
      box-sizing: border-box;
      color: #333;
      font-size: 1rem;
    }
    button {
      background: #FF69B4;
      color: #FFFFFF;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover {
      background: #C71585;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    select {
        background: #F8F8FF;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='%23C71585' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%;
        background-size: 0.65em auto;
        padding-right: 2.5em;
    }

    /* Styles for navigation buttons */
    .navigation-buttons {
        text-align: center;
        margin-bottom: 2rem;
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }
    .navigation-buttons button {
        width: auto;
        padding: 0.8rem 1.8rem;
        font-size: 1.1rem;
        background-color: #EE82EE;
        color: #FFFFFF;
        border: 2px solid #DA70D6;
        border-radius: 25px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: inline-flex; /* Use flex to align icon and text */
        align-items: center;
        justify-content: center;
    }
    .navigation-buttons button.active {
        background: #FFD700;
        color: #6A057F;
        border-color: #FFA500;
        font-weight: bold;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .navigation-buttons button:hover:not(.active) {
        background-color: #DDA0DD;
        border-color: #BA55D3;
    }
    .navigation-buttons .toggle-options-btn {
        background-color: #9370DB; /* Couleur différente pour le bouton toggle */
        border-color: #8A2BE2;
        padding: 0.8rem 1.2rem; /* Plus petit pour l'icône */
    }
    .navigation-buttons .toggle-options-btn:hover {
        background-color: #8A2BE2;
        border-color: #6A057F;
    }
    .navigation-buttons .toggle-options-btn i {
        transition: transform 0.3s ease;
    }
    .navigation-buttons .option-button {
        display: none; /* Hidden by default */
    }
    .navigation-buttons.show-options .option-button {
        display: inline-flex; /* Show when parent has show-options class */
    }

    /* Styles for the shopping list */
    .shopping-list-item, .buy-later-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFF0F5;
      padding: 0.7rem 1.2rem;
      margin-top: 0.7rem;
      border-radius: 0.75rem;
      font-size: 1.1rem;
      color: #6A057F;
      border: 1px solid #FFC0CB;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      /* Prevent text selection on drag for iOS/Safari */
      -webkit-user-select: none; /* Safari */
      -moz-user-select: none;    /* Firefox */
      -ms-user-select: none;     /* IE10+ */
      user-select: none;         /* Standard */
    }
    .shopping-list-item .delete-btn, 
    .shopping-list-item .decrement-btn,
    .buy-later-item .delete-btn {
      background: none;
      border: none;
      color: #FF6347;
      font-size: 1.6rem;
      cursor: pointer;
      padding: 0 0.5rem;
      margin: 0;
      width: auto;
      transition: color 0.3s ease;
      line-height: 1; /* Ensure consistent vertical alignment */
    }
    .shopping-list-item .decrement-btn {
        color: #6A057F; /* Darker color for decrement */
        font-size: 1.8rem; /* Slightly larger for visibility */
        margin-right: 5px; /* Space between - and quantity */
    }
    .shopping-list-item .delete-btn:hover, 
    .buy-later-item .delete-btn:hover {
      color: #DC143C;
    }
    .shopping-list-item .decrement-btn:hover {
        color: #8A2BE2; /* Change color on hover for decrement */
    }

    .shopping-list-item span, .buy-later-item span {
        flex-grow: 1;
        padding-right: 10px;
    }
    .quantity {
        font-weight: bold;
        margin-left: 8px; /* Space after quantity */
        margin-right: 8px; /* Space before quantity if decrement is present */
        color: #FF8C00;
        min-width: 20px; /* Ensure space for quantity */
        text-align: center;
    }

    /* Styles for the suggestions list */
    .suggestions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 0.7rem;
      margin-top: 1.5rem;
    }
    .suggestion-item {
      position: relative;
      background: #9370DB;
      color: #FFFFFF;
      padding: 0.6rem 1rem;
      border-radius: 0.75rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      white-space: nowrap; /* Prevent wrapping */
      overflow: hidden; /* Hide overflow */
      text-overflow: ellipsis; /* Add ellipsis for overflowed text */
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-right: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .suggestion-item:hover {
      background: #8A2BE2;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .suggestion-item-text {
        flex-grow: 1;
        padding-right: 5px;
        font-weight: 500;
        overflow: hidden; /* Ensure text overflow ellipsis works */
        text-overflow: ellipsis;
        white-space: nowrap; /* Keep on single line */
    }
    .delete-suggestion-btn {
      background: none;
      border: none;
      color: #FFD700;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 0 0.2rem;
      margin: 0;
      width: auto;
      transition: color 0.3s ease;
      line-height: 1;
      flex-shrink: 0; /* Prevent button from shrinking */
    }
    .delete-suggestion-btn:hover {
      color: #FF4500;
    }

    .add-form { /* General style for add forms */
        margin-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
        padding-top: 1rem;
    }
    .filter-controls {
        margin-bottom: 1.5rem;
    }

    /* Style for empty list text */
    p[style*="text-align: center"] {
        color: #C71585 !important;
        font-style: italic;
        font-size: 0.95rem;
    }

    /* Category order list styles */
    #categoryOrderList, #manageCategoryList {
        list-style: none;
        padding: 0;
    }
    #categoryOrderList li, #manageCategoryList li {
        background: #F8F8FF;
        border: 1px solid #DDA0DD;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        color: #6A057F;
        cursor: grab; /* Indicate draggable */
        transition: background-color 0.2s ease, transform 0.2s ease;
        /* Prevent text selection on drag for iOS/Safari */
        -webkit-user-select: none; /* Safari */
        -moz-user-select: none;    /* Firefox */
        -ms-user-select: none;     /* IE10+ */
        user-select: none;         /* Standard */
    }
    #categoryOrderList li:hover {
        background-color: #E6E6FA;
        transform: scale(1.01);
    }
    #categoryOrderList li.dragging {
        opacity: 0.7;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .drag-handle {
        font-size: 1.5rem;
        cursor: grab;
        margin-right: 10px;
        color: #EE82EE;
    }
    #manageCategoryList li .delete-category-btn {
        background: none;
        border: none;
        color: #FF6347;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0 0.2rem;
        margin-left: 10px;
        transition: color 0.3s ease;
    }
    #manageCategoryList li .delete-category-btn:hover {
        color: #DC143C;
    }

    /* Styles for the new "Manage Categories" subsection */
    .manage-categories-subsection {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
    }
    .manage-categories-subsection h3 {
        color: #E75480;
        text-align: center;
        margin-bottom: 1rem;
    }

    /* Styles for share code section */
    .share-code-section {
        max-width: 600px;
        margin: 1rem auto;
        background: #FFFFFF;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 2rem;
    }
    .share-code-section h2 {
        margin-bottom: 1rem;
    }
    .share-code-section input {
        margin-bottom: 1rem;
    }
    .current-list-display {
        background: #F8F8FF;
        padding: 0.7rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
        font-weight: bold;
        color: #6A057F;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }
    .current-list-display button {
        width: auto;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        margin: 0;
        flex-shrink: 0;
    }

    @media (max-width: 640px) {
        .suggestions-grid {
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        }
        .navigation-buttons button {
          padding: 0.6rem 1rem;
          font-size: 0.9rem;
        }
        .navigation-buttons .toggle-options-btn {
            padding: 0.6rem 1rem; /* Adjust padding for smaller screens */
        }
    }
  </style>
</head>
<body>
  <h1>My Shopping List 🛒</h1>

  <div class="share-code-section">
      <h2>Connect to Your List</h2>
      <p id="currentListDisplay" class="current-list-display">Not connected</p>
      <label for="shareCodeInput">Enter List Code:</label>
      <input type="text" id="shareCodeInput" placeholder="Enter a code or leave blank for new list" />
      <button id="connectListBtn">Connect / Create List</button>
  </div>

  <div class="navigation-buttons" id="navigationButtonsContainer">
    <button id="showShoppingListBtn" class="active">My List</button>
    <button id="toggleOptionsBtn" class="toggle-options-btn"><i class="fas fa-chevron-up"></i></button>
    <button id="showSuggestionsBtn" class="option-button">Suggestions</button>
    <button id="showCategoryOrderBtn" class="option-button">Order by Category</button>
    <button id="showBuyLaterBtn" class="option-button">Buy Later</button>
  </div>

  <div id="shoppingListSection" class="section-container active">
    <h2>Items to Buy</h2>
    <div id="shoppingList" style="margin-top: 1rem;">
      </div>
    <form id="shoppingForm" autocomplete="off" class="add-form">
        <label for="newItem">Add an item:</label>
        <input type="text" id="newItem" placeholder="Ex: Milk, Bread, Apples..." required />
        <button type="submit">Add to List ✅</button>
    </form>
  </div>

  <div id="suggestionsSection" class="section-container">
    <h2>Suggestions by Category</h2>
    <div class="filter-controls">
        <label for="categoryFilter">Filter by category:</label>
        <select id="categoryFilter">
        </select>
    </div>
    <div id="suggestionsList" class="suggestions-grid">
    </div>
    <form id="addSuggestionForm" autocomplete="off" class="add-form">
        <label for="newSuggestion">New suggestion:</label>
        <input type="text" id="newSuggestion" placeholder="Ex: Cheese, Chocolate..." required />
        <label for="suggestionCategory">Category:</label>
        <select id="suggestionCategory" required>
        </select>
        <button type="submit">Add as suggestion ✨</button>
    </form>
  </div>

  <div id="categoryOrderSection" class="section-container">
    <h2>Order Categories</h2>
    <p style="text-align: center; color: #6A057F; margin-top: 0.5rem;">Drag and drop categories to set their order in 'My List'.</p>
    <ul id="categoryOrderList">
    </ul>
    <div class="manage-categories-subsection">
        <h3>Manage Categories</h3>
        <form id="addCategoryForm" autocomplete="off" class="add-form">
            <label for="newCategoryName">Add new category:</label>
            <input type="text" id="newCategoryName" placeholder="Ex: Pet Food, Snacks..." required />
            <button type="submit">Add Category ➕</button>
        </form>
        <ul id="manageCategoryList">
        </ul>
    </div>
  </div>

  <div id="buyLaterSection" class="section-container">
    <h2>Items to Buy Later</h2>
    <div id="buyLaterList" style="margin-top: 1rem;">
    </div>
    <form id="buyLaterForm" autocomplete="off" class="add-form">
        <label for="newBuyLaterItem">Add item to buy later:</label>
        <input type="text" id="newBuyLaterItem" placeholder="Ex: New book, Fancy gadget..." required />
        <button type="submit">Add to Buy Later ➡️</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Supabase Configuration ---
    // REMPLACEZ CES VALEURS PAR LES VÔTRES !
    const supabaseUrl = 'https://cepqcretnxfhjbvdukkk.supabase.co'; // Exemple: 'https://abcdefghijk.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU'; // Exemple: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdo...
    
    let supabase = null; // Déclaré ici, initialisé dans l'écouteur de chargement

    // --- Global State for Supabase List Management ---
    let currentShareCode = null;
    let currentListId = null;
    let REALTIME_SUBSCRIPTION = null;

    // --- DOM Elements ---
    const shoppingForm = document.getElementById('shoppingForm');
    const newItemInput = document.getElementById('newItem');
    const shoppingListDiv = document.getElementById('shoppingList');
    const addSuggestionForm = document.getElementById('addSuggestionForm');
    const newSuggestionInput = document.getElementById('newSuggestion');
    const suggestionCategorySelect = document.getElementById('suggestionCategory');
    const suggestionsListDiv = document.getElementById('suggestionsList');
    const categoryFilterSelect = document.getElementById('categoryFilter');
    const buyLaterForm = document.getElementById('buyLaterForm');
    const newBuyLaterItemInput = document.getElementById('newBuyLaterItem');
    const buyLaterListDiv = document.getElementById('buyLaterList');
    const addCategoryForm = document.getElementById('addCategoryForm');
    const newCategoryNameInput = document.getElementById('newCategoryName');
    const manageCategoryList = document.getElementById('manageCategoryList');

    // Navigation buttons
    const navigationButtonsContainer = document.getElementById('navigationButtonsContainer');
    const showShoppingListBtn = document.getElementById('showShoppingListBtn');
    const toggleOptionsBtn = document.getElementById('toggleOptionsBtn');
    const toggleOptionsIcon = toggleOptionsBtn.querySelector('i');
    const showSuggestionsBtn = document.getElementById('showSuggestionsBtn');
    const showCategoryOrderBtn = document.getElementById('showCategoryOrderBtn');
    const showBuyLaterBtn = document.getElementById('showBuyLaterBtn');

    // Sections
    const shoppingListSection = document.getElementById('shoppingListSection');
    const suggestionsSection = document.getElementById('suggestionsSection');
    const categoryOrderSection = document.getElementById('categoryOrderSection');
    const buyLaterSection = document.getElementById('buyLaterSection');
    const categoryOrderList = document.getElementById('categoryOrderList');

    // Share code elements
    const shareCodeInput = document.getElementById('shareCodeInput');
    const connectListBtn = document.getElementById('connectListBtn');
    const currentListDisplay = document.getElementById('currentListDisplay');

    // --- Default Categories ---
    const initialDefaultCategories = [
      "Fruits et Légumes",
      "Produits Laitiers",
      "Viandes et Poissons",
      "Produits d'Épicerie",
      "Boulangerie",
      "Boissons",
      "Surgelés",
      "Entretien",
      "Hygiène",
      "Autres"
    ];

    // --- Utility Functions ---
    function generateShareCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function showSection(sectionId) {
      document.querySelectorAll('.section-container').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');

      // Update active class for navigation buttons
      document.querySelectorAll('.navigation-buttons button').forEach(btn => {
        btn.classList.remove('active');
      });
      if (sectionId === 'shoppingListSection') {
        showShoppingListBtn.classList.add('active');
      } else if (sectionId === 'suggestionsSection') {
        showSuggestionsBtn.classList.add('active');
      } else if (sectionId === 'categoryOrderSection') {
        showCategoryOrderBtn.classList.add('active');
      } else if (sectionId === 'buyLaterSection') {
        showBuyLaterBtn.classList.add('active');
      }
    }

    function getCategories() {
      return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
      localStorage.setItem('user_categories', JSON.stringify(categories));
    }

    function updateAllCategorySelects() {
      const categories = getCategories();
      const selects = document.querySelectorAll('select#suggestionCategory, select#categoryFilter'); // Select all category dropdowns
      selects.forEach(select => {
        select.innerHTML = ''; // Clear existing options
        // Add default "All Categories" option for filter
        if (select.id === 'categoryFilter') {
          const allOption = document.createElement('option');
          allOption.value = 'all';
          allOption.textContent = 'All Categories';
          select.appendChild(allOption);
        }
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          select.appendChild(option);
        });
      });
      // Set initial selection for suggestion category if available
      const suggestionCatSelect = document.getElementById('suggestionCategory');
      if (categories.length > 0 && suggestionCatSelect) {
        suggestionCatSelect.value = categories[0];
      }
    }

    function renderCategoryOrderList() {
      const categories = getCategories();
      categoryOrderList.innerHTML = '';
      categories.forEach(category => {
        const li = document.createElement('li');
        li.draggable = true;
        li.dataset.category = category;
        li.innerHTML = `<i class="fas fa-grip-lines drag-handle"></i><span>${category}</span>`;
        categoryOrderList.appendChild(li);
      });
      addDragAndDropListeners(categoryOrderList);
    }

    function renderManageCategoryList() {
        const categories = getCategories();
        manageCategoryList.innerHTML = '';
        categories.forEach(category => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${category}</span>
                <button class="delete-category-btn" data-category="${category}">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            manageCategoryList.appendChild(li);
        });
    }

    // --- Supabase Functions ---
    async function getOrCreateListByShareCode(code) {
        if (!supabase) {
            console.error("Supabase client not initialized.");
            alert("Erreur: La connexion à la base de données n'est pas prête. Veuillez recharger la page.");
            return null;
        }

        try {
            // Try to retrieve existing list
            const { data: lists, error: selectError } = await supabase
                .from('lists')
                .select('id, name')
                .eq('share_code', code);

            if (selectError && selectError.code !== '406' && selectError.code !== 'PGRST400') {
                console.error("Supabase error fetching list:", selectError);
                throw selectError;
            }

            if (lists && lists.length > 0) {
                console.log(`List found for code ${code}:`, lists[0]);
                currentListId = lists[0].id;
                currentShareCode = code;
                currentListDisplay.innerHTML = `Connected to: <strong>${lists[0].name}</strong> <button id="copyShareCodeBtn" class="small-btn">Copy Code</button>`;
                document.getElementById('copyShareCodeBtn').onclick = () => copyTextToClipboard(currentShareCode);
                
                setupRealtimeListener(currentListId);
                await loadShoppingList();
                await loadSuggestions();
                await loadBuyLaterItems();
                return lists[0];
            } else {
                console.log(`No list found for code ${code}. Creating a new list.`);
                const newList = { name: `Liste ${code}`, share_code: code };
                const { data: createdList, error: insertError } = await supabase
                    .from('lists')
                    .insert([newList])
                    .select('id, name');

                if (insertError) {
                    console.error("Error creating list:", insertError);
                    alert("Erreur lors de la création de la liste: " + insertError.message);
                    return null;
                } else {
                    console.log("New list created:", createdList[0]);
                    currentListId = createdList[0].id;
                    currentShareCode = code;
                    currentListDisplay.innerHTML = `Created new list: <strong>${createdList[0].name}</strong> <button id="copyShareCodeBtn" class="small-btn">Copy Code</button>`;
                    document.getElementById('copyShareCodeBtn').onclick = () => copyTextToClipboard(currentShareCode);

                    setupRealtimeListener(currentListId);
                    await loadShoppingList(); // Load empty list
                    await loadSuggestions();
                    await loadBuyLaterItems();
                    return createdList[0];
                }
            }
        } catch (error) {
            console.error("Unexpected error in getOrCreateListByShareCode:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
            return null;
        }
    }

    async function addItem(name, quantity, category) {
      if (!currentListId) {
        alert("Please connect to a list first!");
        return;
      }
      try {
        const { data, error } = await supabase
          .from('items')
          .insert([{ name, quantity, category, list_id: currentListId, bought: false }]);
        if (error) throw error;
        newItemInput.value = ''; // Clear input
        console.log("Item added:", data);
        // List will be reloaded by real-time listener
      } catch (error) {
        console.error("Error adding item:", error.message);
        alert("Error adding item: " + error.message);
      }
    }

    async function updateItemBoughtStatus(itemId, boughtStatus) {
      if (!currentListId) return;
      try {
        const { data, error } = await supabase
          .from('items')
          .update({ bought: boughtStatus })
          .eq('id', itemId)
          .eq('list_id', currentListId); // Ensure item belongs to current list
        if (error) throw error;
        console.log("Item status updated:", data);
      } catch (error) {
        console.error("Error updating item status:", error.message);
        alert("Error updating item status: " + error.message);
      }
    }

    async function updateItemQuantity(itemId, newQuantity) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('items')
                .update({ quantity: newQuantity })
                .eq('id', itemId)
                .eq('list_id', currentListId);
            if (error) throw error;
            console.log("Item quantity updated:", data);
        } catch (error) {
            console.error("Error updating item quantity:", error.message);
            alert("Error updating item quantity: " + error.message);
        }
    }

    async function deleteItem(itemId) {
      if (!currentListId) return;
      try {
        const { data, error } = await supabase
          .from('items')
          .delete()
          .eq('id', itemId)
          .eq('list_id', currentListId); // Ensure item belongs to current list
        if (error) throw error;
        console.log("Item deleted:", data);
      } catch (error) {
        console.error("Error deleting item:", error.message);
        alert("Error deleting item: " + error.message);
      }
    }

    async function loadShoppingList() {
      if (!currentListId) {
        shoppingListDiv.innerHTML = '<p style="text-align: center;">Connect to a list to see your items.</p>';
        return;
      }
      try {
        const { data: items, error } = await supabase
          .from('items')
          .select('*')
          .eq('list_id', currentListId)
          .order('created_at', { ascending: false });
        if (error) throw error;

        renderShoppingList(items);
      } catch (error) {
        console.error("Error loading shopping list:", error.message);
        shoppingListDiv.innerHTML = `<p style="text-align: center; color: red;">Error loading list: ${error.message}</p>`;
      }
    }

    function renderShoppingList(items) {
        shoppingListDiv.innerHTML = '';
        if (items.length === 0) {
            shoppingListDiv.innerHTML = '<p style="text-align: center;">Your shopping list is empty!</p>';
            return;
        }

        const categories = getCategories();
        const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || categories;

        // Group items by category
        const categorizedItems = {};
        categories.forEach(cat => categorizedItems[cat] = []);
        items.forEach(item => {
            if (item.category && categorizedItems[item.category]) {
                categorizedItems[item.category].push(item);
            } else {
                // Handle items with no category or unknown category
                if (!categorizedItems['Autres']) {
                    categorizedItems['Autres'] = [];
                }
                categorizedItems['Autres'].push(item);
            }
        });

        // Render categories in specified order
        categoryOrder.forEach(category => {
            if (categorizedItems[category] && categorizedItems[category].length > 0) {
                const categoryHeader = document.createElement('h3');
                categoryHeader.style.color = '#C71585';
                categoryHeader.style.marginTop = '1.5rem';
                categoryHeader.style.marginBottom = '0.5rem';
                categoryHeader.textContent = category;
                shoppingListDiv.appendChild(categoryHeader);

                categorizedItems[category].forEach(item => {
                    const li = document.createElement('div');
                    li.classList.add('shopping-list-item');
                    li.innerHTML = `
                        <span style="${item.bought ? 'text-decoration: line-through; color: #888;' : ''}">${item.name}</span>
                        <div>
                            <button class="decrement-btn" data-id="${item.id}" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                            <span class="quantity">${item.quantity}</span>
                            <button class="buy-toggle-btn" data-id="${item.id}" data-bought="${item.bought}">
                                <i class="fas ${item.bought ? 'fa-undo' : 'fa-check'}"></i>
                            </button>
                            <button class="delete-btn" data-id="${item.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    shoppingListDiv.appendChild(li);
                });
            }
        });

        // Add event listeners for buy/undo and delete buttons
        shoppingListDiv.querySelectorAll('.buy-toggle-btn').forEach(button => {
            button.onclick = (e) => {
                const itemId = e.currentTarget.dataset.id;
                const currentBoughtStatus = e.currentTarget.dataset.bought === 'true';
                updateItemBoughtStatus(itemId, !currentBoughtStatus);
            };
        });
        shoppingListDiv.querySelectorAll('.delete-btn').forEach(button => {
            button.onclick = (e) => {
                const itemId = e.currentTarget.dataset.id;
                deleteItem(itemId);
            };
        });
        shoppingListDiv.querySelectorAll('.decrement-btn').forEach(button => {
            button.onclick = async (e) => {
                const itemId = e.currentTarget.dataset.id;
                const itemElement = e.currentTarget.closest('.shopping-list-item');
                const quantitySpan = itemElement.querySelector('.quantity');
                let currentQuantity = parseInt(quantitySpan.textContent);
                if (currentQuantity > 1) {
                    await updateItemQuantity(itemId, currentQuantity - 1);
                }
            };
        });
    }


    async function addSuggestion(name, category) {
      if (!supabase) return;
      try {
        const { data, error } = await supabase
          .from('suggestions')
          .insert([{ name, category }]);
        if (error) throw error;
        newSuggestionInput.value = '';
        console.log("Suggestion added:", data);
        await loadSuggestions(); // Reload suggestions to show new one
      } catch (error) {
        console.error("Error adding suggestion:", error.message);
        alert("Error adding suggestion: " + error.message);
      }
    }

    async function deleteSuggestion(suggestionId) {
      if (!supabase) return;
      try {
        const { data, error } = await supabase
          .from('suggestions')
          .delete()
          .eq('id', suggestionId);
        if (error) throw error;
        console.log("Suggestion deleted:", data);
        await loadSuggestions(); // Reload suggestions
      } catch (error) {
        console.error("Error deleting suggestion:", error.message);
        alert("Error deleting suggestion: " + error.message);
      }
    }

    async function loadSuggestions() {
      if (!supabase) {
        suggestionsListDiv.innerHTML = '<p style="text-align: center;">Suggestions loading error.</p>';
        return;
      }
      try {
        const selectedCategory = categoryFilterSelect.value;
        let query = supabase.from('suggestions').select('*').order('name', { ascending: true });
        
        if (selectedCategory !== 'all') {
            query = query.eq('category', selectedCategory);
        }

        const { data: suggestions, error } = await query;

        if (error) throw error;

        suggestionsListDiv.innerHTML = '';
        if (suggestions.length === 0) {
            suggestionsListDiv.innerHTML = '<p style="text-align: center;">No suggestions found for this category.</p>';
            return;
        }

        suggestions.forEach(suggestion => {
          const div = document.createElement('div');
          div.classList.add('suggestion-item');
          div.innerHTML = `
            <span class="suggestion-item-text">${suggestion.name}</span>
            <button class="delete-suggestion-btn" data-id="${suggestion.id}">
                <i class="fas fa-times-circle"></i>
            </button>
          `;
          div.onclick = (e) => {
            if (!e.target.classList.contains('delete-suggestion-btn') && !e.target.closest('.delete-suggestion-btn')) {
                newItemInput.value = suggestion.name;
                showSection('shoppingListSection'); // Switch to shopping list section
            }
          };
          suggestionsListDiv.appendChild(div);
        });

        suggestionsListDiv.querySelectorAll('.delete-suggestion-btn').forEach(button => {
            button.onclick = (e) => {
                e.stopPropagation(); // Prevent triggering the parent div's click
                const suggestionId = e.currentTarget.dataset.id;
                deleteSuggestion(suggestionId);
            };
        });

      } catch (error) {
        console.error("Error loading suggestions:", error.message);
        suggestionsListDiv.innerHTML = `<p style="text-align: center; color: red;">Error loading suggestions: ${error.message}</p>`;
      }
    }

    async function addBuyLaterItem(name) {
        if (!currentListId) {
            alert("Please connect to a list first!");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .insert([{ name, list_id: currentListId }]);
            if (error) throw error;
            newBuyLaterItemInput.value = '';
            console.log("Buy later item added:", data);
        } catch (error) {
            console.error("Error adding buy later item:", error.message);
            alert("Error adding buy later item: " + error.message);
        }
    }

    async function deleteBuyLaterItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .delete()
                .eq('id', itemId)
                .eq('list_id', currentListId);
            if (error) throw error;
            console.log("Buy later item deleted:", data);
        } catch (error) {
            console.error("Error deleting buy later item:", error.message);
            alert("Error deleting buy later item: " + error.message);
        }
    }

    async function loadBuyLaterItems() {
        if (!currentListId) {
            buyLaterListDiv.innerHTML = '<p style="text-align: center;">Connect to a list to see your "Buy Later" items.</p>';
            return;
        }
        try {
            const { data: items, error } = await supabase
                .from('buy_later_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('created_at', { ascending: false });
            if (error) throw error;

            buyLaterListDiv.innerHTML = '';
            if (items.length === 0) {
                buyLaterListDiv.innerHTML = '<p style="text-align: center;">Your "Buy Later" list is empty!</p>';
                return;
            }

            items.forEach(item => {
                const li = document.createElement('div');
                li.classList.add('buy-later-item');
                li.innerHTML = `
                    <span>${item.name}</span>
                    <div>
                        <button class="delete-btn" data-id="${item.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                buyLaterListDiv.appendChild(li);
            });

            buyLaterListDiv.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    const itemId = e.currentTarget.dataset.id;
                    deleteBuyLaterItem(itemId);
                };
            });

        } catch (error) {
            console.error("Error loading buy later items:", error.message);
            buyLaterListDiv.innerHTML = `<p style="text-align: center; color: red;">Error loading "Buy Later" items: ${error.message}</p>`;
        }
    }


    function setupRealtimeListener(listId) {
        // Unsubscribe from existing subscription if any
        if (REALTIME_SUBSCRIPTION) {
            supabase.removeChannel(REALTIME_SUBSCRIPTION);
            REALTIME_SUBSCRIPTION = null;
        }

        REALTIME_SUBSCRIPTION = supabase
            .channel(`items_list_${listId}`)
            .on(
                'postgres_changes',
                {
                    event: '*', // Listen for all events (INSERT, UPDATE, DELETE)
                    schema: 'public',
                    table: 'items',
                    filter: `list_id=eq.${listId}`
                },
                (payload) => {
                    console.log('Change received!', payload);
                    // Reload the list when a change occurs
                    loadShoppingList();
                }
            )
            .on(
                'postgres_changes',
                {
                    event: '*',
                    schema: 'public',
                    table: 'buy_later_items',
                    filter: `list_id=eq.${listId}`
                },
                (payload) => {
                    console.log('Buy later change received!', payload);
                    loadBuyLaterItems();
                }
            )
            .subscribe();
    }

    // --- Drag and Drop for Category Order ---
    let draggedItem = null;

    function addDragAndDropListeners(listElement) {
        listElement.querySelectorAll('li').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                setTimeout(() => item.classList.add('dragging'), 0);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', item.dataset.category); // Store category name
            });

            item.addEventListener('dragend', () => {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault(); // Allow drop
                const bounding = item.getBoundingClientRect();
                const offset = bounding.y + (bounding.height / 2);
                if (e.clientY < offset) {
                    item.classList.remove('after');
                    item.classList.add('before');
                } else {
                    item.classList.remove('before');
                    item.classList.add('after');
                }
            });

            item.addEventListener('dragleave', () => {
                item.classList.remove('before', 'after');
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedItem && draggedItem !== item) {
                    if (item.classList.contains('before')) {
                        listElement.insertBefore(draggedItem, item);
                    } else {
                        listElement.insertBefore(draggedItem, item.nextSibling);
                    }
                    saveCategoryOrder();
                }
                item.classList.remove('before', 'after');
            });
        });
    }

    function saveCategoryOrder() {
        const orderedCategories = Array.from(categoryOrderList.children).map(li => li.dataset.category);
        localStorage.setItem('category_order', JSON.stringify(orderedCategories));
        console.log("Category order saved:", orderedCategories);
        loadShoppingList(); // Re-render shopping list with new order
    }

    function loadCategoryOrder() {
        renderCategoryOrderList();
    }

    // --- Clipboard Function ---
    async function copyTextToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            alert('Code copié dans le presse-papiers!');
        } catch (err) {
            console.error('Impossible de copier le texte: ', err);
            alert('Impossible de copier le code. Veuillez le sélectionner et le copier manuellement.');
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize Supabase client
      supabase = Supabase.createClient(supabaseUrl, supabaseKey); // CORRECTED: Changed supabaseJs.createClient to Supabase.createClient

      if (!supabase) {
          console.error("Supabase client failed to initialize.");
          alert("Erreur critique: La connexion à la base de données Supabase a échoué. Veuillez recharger la page.");
          return;
      }

      // --- CODE MODIFIÉ : Attendre que supabase.rest soit prêt ---
      let attempts = 0;
      const maxAttempts = 20; // Essayer jusqu'à 20 fois
      const delayMs = 50;     // Attendre 50ms entre chaque tentative

      while (!supabase.rest && attempts < maxAttempts) {
          console.log(`Attente de supabase.rest (tentative ${attempts + 1}/${maxAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, delayMs));
          attempts++;
      }

      if (supabase.rest) {
          console.log("supabase.rest est maintenant prêt !");
          // Initialisation des données locales (categories, etc.)
          if (!localStorage.getItem('user_categories')) {
              localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
          }
          if (!localStorage.getItem('category_order')) {
              localStorage.setItem('category_order', JSON.stringify(getCategories()));
          }

          updateAllCategorySelects();
          loadCategoryOrder(); // Load category order and render lists
          renderManageCategoryList(); // Render manage categories list

          // Prompt for share code as soon as the page loads, which will then load lists from Supabase
          // Check if a share code is in localStorage, otherwise generate one
          let initialShareCode = localStorage.getItem('last_share_code');
          if (!initialShareCode) {
              initialShareCode = generateShareCode();
              localStorage.setItem('last_share_code', initialShareCode);
          }
          shareCodeInput.value = initialShareCode;
          await getOrCreateListByShareCode(initialShareCode);

          showSection('shoppingListSection'); // Ensure initial section is shown
          // Ensure options are visible on initial load
          navigationButtonsContainer.classList.add('show-options');
          toggleOptionsIcon.classList.remove('fa-chevron-down');
          toggleOptionsIcon.classList.add('fa-chevron-up');
      } else {
          console.error("Erreur: supabase.rest n'est pas devenu prêt après plusieurs tentatives. Impossible de démarrer l'application.");
          alert("Erreur critique: La connexion à la base de données Supabase a échoué après plusieurs tentatives. Veuillez recharger la page ou vérifier votre connexion.");
          return;
      }

      // Existing event listeners
      shoppingForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const itemName = newItemInput.value.trim();
        const itemQuantity = 1; // Default quantity
        const itemCategory = suggestionCategorySelect.value; // Use the value from the suggestion category select
        if (itemName) {
          addItem(itemName, itemQuantity, itemCategory);
        }
      });

      addSuggestionForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const suggestionName = newSuggestionInput.value.trim();
          const suggestionCat = suggestionCategorySelect.value;
          if (suggestionName) {
              addSuggestion(suggestionName, suggestionCat);
          }
      });

      categoryFilterSelect.addEventListener('change', loadSuggestions);

      buyLaterForm.addEventListener('submit', (e) => { // Corrected: Changed addBuyLaterForm to buyLaterForm
          e.preventDefault();
          const buyLaterItemName = newBuyLaterItemInput.value.trim();
          if (buyLaterItemName) {
              addBuyLaterItem(buyLaterItemName);
          }
      });

      addCategoryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newCatName = newCategoryNameInput.value.trim();
        if (newCatName && !getCategories().includes(newCatName)) {
            const currentCategories = getCategories();
            currentCategories.push(newCatName);
            saveCategories(currentCategories);
            updateAllCategorySelects();
            renderCategoryOrderList();
            renderManageCategoryList();
            newCategoryNameInput.value = '';
        } else if (getCategories().includes(newCatName)) {
            alert("Category already exists!");
        }
      });

      manageCategoryList.addEventListener('click', (e) => {
          if (e.target.classList.contains('delete-category-btn') || e.target.closest('.delete-category-btn')) {
              const btn = e.target.closest('.delete-category-btn');
              const categoryToDelete = btn.dataset.category;
              if (confirm(`Are you sure you want to delete the category "${categoryToDelete}"? This will not delete items already assigned to it.`)) {
                  let currentCategories = getCategories();
                  currentCategories = currentCategories.filter(cat => cat !== categoryToDelete);
                  saveCategories(currentCategories);
                  updateAllCategorySelects();
                  renderCategoryOrderList();
                  renderManageCategoryList();
              }
          }
      });

      // Navigation button event listeners
      showShoppingListBtn.addEventListener('click', () => showSection('shoppingListSection'));
      showSuggestionsBtn.addEventListener('click', () => showSection('suggestionsSection'));
      showCategoryOrderBtn.addEventListener('click', () => showSection('categoryOrderSection'));
      showBuyLaterBtn.addEventListener('click', () => showSection('buyLaterSection'));

      toggleOptionsBtn.addEventListener('click', () => {
          navigationButtonsContainer.classList.toggle('show-options');
          toggleOptionsIcon.classList.toggle('fa-chevron-up');
          toggleOptionsIcon.classList.toggle('fa-chevron-down');
      });

      connectListBtn.addEventListener('click', async () => {
          const code = shareCodeInput.value.trim();
          if (code) {
              localStorage.setItem('last_share_code', code); // Save last used share code
              await getOrCreateListByShareCode(code);
          } else {
              alert("Please enter a share code or leave blank to create a new one.");
          }
      });
    });
  </script>
</body>
</html>