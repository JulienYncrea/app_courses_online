<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shopping List ðŸ›’</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 1rem;
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
    }
    input[type="text"], button, select {
      width: calc(100% - 20px);
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      background-color: #FF69B4;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #E04D9F;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #FFF0F5;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: inset 0 0.1rem 0.3rem rgba(0,0,0,0.05);
    }
    li.checked {
      text-decoration: line-through;
      color: #888;
      background: #F8F8F8;
    }
    .item-controls button {
      background: none;
      border: none;
      color: #E75480;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0 0.3rem;
      width: auto;
    }
    .item-controls button:hover {
      color: #D33678;
    }
    .add-item-container {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .add-item-container input {
      flex-grow: 1;
      margin-bottom: 0;
    }
    .add-item-container button {
      width: auto;
      padding: 0.8rem 1.2rem;
      margin-bottom: 0;
    }
    .category-select {
      margin-left: auto;
      margin-right: 0.5rem;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #ddd;
      background-color: white;
    }
    .item-text {
      flex-grow: 1;
      cursor: pointer;
    }
    .options-section {
        background: #FAD0C4;
        padding: 1rem;
        border-radius: 1rem;
        margin-top: 1rem;
    }
    .options-section button {
        margin-top: 0.5rem;
        width: 100%;
    }
    #shareCodeDisplay, #lastUpdatedDisplay {
        text-align: center;
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
    }
    .hidden {
      display: none;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      cursor: pointer;
    }
    .section-header h2 {
      margin: 0;
      flex-grow: 1;
      text-align: left;
    }
    .toggle-icon {
      font-size: 1.5rem;
      color: #E75480;
    }
    .options-container {
        overflow: hidden;
        max-height: 0;
        transition: max-height 0.5s ease-out;
    }
    .options-container.show-options {
        max-height: 500px; /* Adjust based on content height */
        transition: max-height 0.5s ease-in;
    }
    .category-management-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #FFD1DC;
    }
    .category-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px dashed #eee;
    }
    .category-item:last-child {
        border-bottom: none;
    }
    .category-item span {
        flex-grow: 1;
    }
    .category-item button {
        width: auto;
        padding: 0.3rem 0.6rem;
        font-size: 0.9rem;
        margin-left: 0.5rem;
    }
    .category-drag-handle {
        cursor: grab;
        margin-right: 0.5rem;
        color: #999;
    }
    .category-item.dragging {
        opacity: 0.5;
        background-color: #f0f0f0;
    }
    .buy-later-list li {
      background: #F0F8FF; /* Light blue for buy later items */
    }
    .buy-later-list .item-controls button {
        color: #6A5ACD; /* Purple for buy later controls */
    }
    #share-list-section, #join-list-section {
      margin-bottom: 1rem;
    }
    #shareCodeInput {
      width: calc(100% - 120px);
      display: inline-block;
    }
    #joinListBtn {
      width: 100px;
      display: inline-block;
      margin-left: 10px;
    }
    #shareListBtn {
        margin-top: 0.5rem;
    }
    #clearAllItemsBtn, #moveCheckedToBuyLaterBtn, #clearBuyLaterBtn {
        background-color: #DC143C; /* Crimson for destructive actions */
    }
    #clearAllItemsBtn:hover, #moveCheckedToBuyLaterBtn:hover, #clearBuyLaterBtn:hover {
        background-color: #B22222; /* Firebrick */
    }
    .suggestion-item {
        background: #e9f7ef; /* Light green for suggestions */
        border-radius: 0.5rem;
        padding: 0.5rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        display: inline-block;
        cursor: pointer;
        font-size: 0.9em;
        color: #3e8e6b;
    }
    .suggestion-item:hover {
        background: #d6f2e2;
    }
    #suggestionsContainer {
        margin-top: 1rem;
        border-top: 1px solid #e0ffe0;
        padding-top: 1rem;
    }
    .footer-links {
      text-align: center;
      margin-top: 2rem;
    }
    .footer-links a {
      color: #E75480;
      text-decoration: none;
      margin: 0 0.5rem;
    }
    .footer-links a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="section-container">
    <div class="section-header" id="toggleOptionsHeader">
      <h2>My Shopping List ðŸ›’</h2>
      <i class="fas fa-chevron-down toggle-icon" id="toggleOptionsIcon"></i>
    </div>
    <div class="options-container" id="navigationButtonsContainer">
      <div id="share-list-section">
        <h3>Share List</h3>
        <input type="text" id="shareCodeDisplay" readonly value="Loading..." />
        <button id="shareListBtn">Copy Share Code</button>
      </div>

      <div id="join-list-section">
        <h3>Join a Shared List</h3>
        <input type="text" id="shareCodeInput" placeholder="Enter Share Code" />
        <button id="joinListBtn">Join List</button>
      </div>

      <div id="item-add-section">
        <h3>Add Item</h3>
        <div class="add-item-container">
          <input type="text" id="newItemInput" placeholder="Add a new item..." />
          <select id="newItemCategory" class="category-select"></select>
          <button id="addItemBtn">Add</button>
        </div>
        <div id="suggestionsContainer">
            <h4>Suggestions:</h4>
            </div>
      </div>

      <div id="list-management-section">
        <h3>List Actions</h3>
        <button id="clearAllItemsBtn">Clear All Items</button>
        <button id="moveCheckedToBuyLaterBtn">Move Checked to Buy Later</button>
      </div>

      <div class="category-management-section">
        <h3>Manage Categories</h3>
        <div class="add-item-container">
          <input type="text" id="newCategoryInput" placeholder="New Category Name" />
          <button id="addCategoryBtn">Add Category</button>
        </div>
        <ul id="categoryList">
          </ul>
      </div>

      <div id="buy-later-management-section">
        <h3>Buy Later List</h3>
        <ul id="buyLaterList">
          </ul>
        <button id="clearBuyLaterBtn">Clear Buy Later List</button>
      </div>
    </div>
    <div id="shoppingListSection">
      <h3>Items</h3>
      <ul id="shoppingList">
        </ul>
      <p id="lastUpdatedDisplay">Last Updated: Never</p>
    </div>
  </div>

  <div class="footer-links">
    <a href="https://github.com/julienyncrea/app_courses_online" target="_blank">GitHub</a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Configuration Supabase - REMPLACEZ PAR VOS PROPRES CLÃ‰S !
    const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // Remplacez par l'URL de votre projet Supabase
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Remplacez par votre clÃ© anon publique Supabase

    let supabase; // Variable globale pour le client Supabase
    let currentListId = null;
    let shareCodeInput = document.getElementById('shareCodeInput');
    let shareCodeDisplay = document.getElementById('shareCodeDisplay');
    let lastUpdatedDisplay = document.getElementById('lastUpdatedDisplay');
    let newItemInput = document.getElementById('newItemInput');
    let addItemBtn = document.getElementById('addItemBtn');
    let shoppingList = document.getElementById('shoppingList');
    let clearAllItemsBtn = document.getElementById('clearAllItemsBtn');
    let moveCheckedToBuyLaterBtn = document.getElementById('moveCheckedToBuyLaterBtn');
    let buyLaterList = document.getElementById('buyLaterList');
    let clearBuyLaterBtn = document.getElementById('clearBuyLaterBtn');
    let newItemCategory = document.getElementById('newItemCategory');
    let addCategoryBtn = document.getElementById('addCategoryBtn');
    let newCategoryInput = document.getElementById('newCategoryInput');
    let categoryList = document.getElementById('categoryList');
    let joinListBtn = document.getElementById('joinListBtn');
    let shareListBtn = document.getElementById('shareListBtn');
    let toggleOptionsHeader = document.getElementById('toggleOptionsHeader');
    let navigationButtonsContainer = document.getElementById('navigationButtonsContainer');
    let toggleOptionsIcon = document.getElementById('toggleOptionsIcon');
    let suggestionsContainer = document.getElementById('suggestionsContainer');

    // Default categories in French
    const initialDefaultCategories = [
      { name: "Fruits et LÃ©gumes", id: "fruits-legumes" },
      { name: "Produits Laitiers", id: "produits-laitiers" },
      { name: "Viandes et Poissons", id: "viandes-poissons" },
      { name: "Boulangerie", id: "boulangerie" },
      { name: "Ã‰picerie", id: "epicerie" },
      { name: "SurgelÃ©s", id: "surgeles" },
      { name: "Boissons", id: "boissons" },
      { name: "HygiÃ¨ne et BeautÃ©", id: "hygiene-beaute" },
      { name: "Entretien", id: "entretien" },
      { name: "Autres", id: "autres" }
    ];

    // Functions for Local Storage Management
    function getCategories() {
        return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
        localStorage.setItem('user_categories', JSON.stringify(categories));
    }

    function getCategoryOrder() {
        const order = JSON.parse(localStorage.getItem('category_order'));
        const categories = getCategories();
        if (order && order.length === categories.length && order.every(id => categories.some(cat => cat.id === id))) {
            return order;
        } else {
            // Rebuild order if categories changed or order is invalid
            return categories.map(cat => cat.id);
        }
    }

    function saveCategoryOrder(order) {
        localStorage.setItem('category_order', JSON.stringify(order));
    }

    function getShareCode() {
        return localStorage.getItem('current_share_code') || generateShareCode();
    }

    function setShareCode(code) {
        localStorage.setItem('current_share_code', code);
        shareCodeDisplay.value = code; // Update display immediately
    }

    // Utility function to generate unique IDs
    function generateUniqueId() {
        return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    // Function to generate a random 6-character alphanumeric share code
    function generateShareCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section-container > div').forEach(section => {
            if (section.id !== 'toggleOptionsHeader' && section.id !== 'navigationButtonsContainer' && section.id !== 'shoppingListSection') {
                section.classList.add('hidden');
            }
        });
        document.getElementById(sectionId).classList.remove('hidden');
    }

    // Update the last updated timestamp
    function updateLastUpdatedDisplay() {
        const now = new Date();
        lastUpdatedDisplay.textContent = `Last Updated: ${now.toLocaleTimeString()} ${now.toLocaleDateString()}`;
    }

    // Supabase Operations
    async function getOrCreateListByShareCode(code) {
        try {
            if (!supabase) {
                console.error("Supabase client is not initialized.");
                return;
            }
            // Try to find an existing list
            let { data: lists, error: findError } = await supabase
                .from('shopping_lists')
                .select('id')
                .eq('share_code', code);

            if (findError && findError.code !== 'PGRST116') { // PGRST116 means no rows found
                throw findError;
            }

            if (lists && lists.length > 0) {
                currentListId = lists[0].id;
                console.log(`Joined existing list with ID: ${currentListId}`);
            } else {
                // Create a new list if none found
                let { data: newList, error: createError } = await supabase
                    .from('shopping_lists')
                    .insert([{ share_code: code }])
                    .select();

                if (createError) throw createError;
                currentListId = newList[0].id;
                console.log(`Created new list with ID: ${currentListId}`);
            }
            setShareCode(code); // Save the share code to local storage
            await fetchAndRenderListItems(); // Fetch and render items for the current list
            updateLastUpdatedDisplay();

        } catch (error) {
            console.error('Error getting or creating list:', error.message);
            alert('Failed to connect or create list. Please try again. Error: ' + error.message);
            // Optionally revert to a default local state or provide a retry option
        }
    }

    async function fetchAndRenderListItems() {
        if (!supabase || !currentListId) {
            console.warn("Supabase client not initialized or no list selected.");
            return;
        }

        try {
            const { data: items, error } = await supabase
                .from('list_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('created_at', { ascending: true }); // Order by creation time

            if (error) throw error;

            renderListItems(items);
            updateLastUpdatedDisplay(); // Update timestamp after rendering
        } catch (error) {
            console.error('Error fetching list items:', error.message);
        }
    }

    async function addOrUpdateItem(itemName, categoryId, isChecked = false, isBuyLater = false, itemId = null) {
        if (!supabase || !currentListId) {
            console.warn("Supabase client not initialized or no list selected.");
            return;
        }

        const itemData = {
            name: itemName,
            category_id: categoryId,
            is_checked: isChecked,
            is_buy_later: isBuyLater,
            list_id: currentListId,
            updated_at: new Date().toISOString()
        };

        try {
            if (itemId) {
                // Update existing item
                const { error } = await supabase
                    .from('list_items')
                    .update(itemData)
                    .eq('id', itemId);
                if (error) throw error;
                console.log('Item updated:', itemName);
            } else {
                // Add new item
                const { error } = await supabase
                    .from('list_items')
                    .insert([itemData]);
                if (error) throw error;
                console.log('Item added:', itemName);
            }
            await fetchAndRenderListItems(); // Re-fetch to update the UI
            newItemInput.value = ''; // Clear input after adding
            updateLastUpdatedDisplay();
        } catch (error) {
            console.error('Error adding/updating item:', error.message);
        }
    }

    async function deleteItem(itemId) {
        if (!supabase || !currentListId) return;
        try {
            const { error } = await supabase
                .from('list_items')
                .delete()
                .eq('id', itemId);
            if (error) throw error;
            console.log('Item deleted:', itemId);
            await fetchAndRenderListItems(); // Re-fetch to update the UI
            updateLastUpdatedDisplay();
        } catch (error) {
            console.error('Error deleting item:', error.message);
        }
    }

    async function clearAllItems() {
        if (!supabase || !currentListId) return;
        if (!confirm('Are you sure you want to clear all items from the list?')) return;
        try {
            const { error } = await supabase
                .from('list_items')
                .delete()
                .eq('list_id', currentListId)
                .eq('is_buy_later', false); // Only clear shopping list items
            if (error) throw error;
            console.log('All shopping list items cleared.');
            await fetchAndRenderListItems();
            updateLastUpdatedDisplay();
        } catch (error) {
            console.error('Error clearing all items:', error.message);
        }
    }

    async function clearBuyLaterItems() {
        if (!supabase || !currentListId) return;
        if (!confirm('Are you sure you want to clear all items from the "Buy Later" list?')) return;
        try {
            const { error } = await supabase
                .from('list_items')
                .delete()
                .eq('list_id', currentListId)
                .eq('is_buy_later', true);
            if (error) throw error;
            console.log('All "Buy Later" items cleared.');
            await fetchAndRenderListItems();
            updateLastUpdatedDisplay();
        } catch (error) {
            console.error('Error clearing buy later items:', error.message);
        }
    }

    async function moveCheckedToBuyLater() {
        if (!supabase || !currentListId) return;
        try {
            // Fetch all checked items from the main list
            const { data: checkedItems, error: fetchError } = await supabase
                .from('list_items')
                .select('*')
                .eq('list_id', currentListId)
                .eq('is_checked', true)
                .eq('is_buy_later', false);

            if (fetchError) throw fetchError;

            if (checkedItems.length === 0) {
                alert('No checked items to move.');
                return;
            }

            // Update these items to be 'buy_later' and uncheck them
            const itemsToUpdate = checkedItems.map(item => ({
                id: item.id,
                is_buy_later: true,
                is_checked: false, // Uncheck when moving to buy later
                updated_at: new Date().toISOString()
            }));

            const { error: updateError } = await supabase
                .from('list_items')
                .upsert(itemsToUpdate, { onConflict: 'id' });

            if (updateError) throw updateError;

            console.log(`${checkedItems.length} items moved to Buy Later list.`);
            await fetchAndRenderListItems();
            updateLastUpdatedDisplay();
        } catch (error) {
            console.error('Error moving checked items to buy later:', error.message);
            alert('Failed to move items to "Buy Later" list. Error: ' + error.message);
        }
    }

    // Render Functions
    function renderListItems(items) {
        shoppingList.innerHTML = '';
        buyLaterList.innerHTML = '';

        const categories = getCategories();
        const categoryOrder = getCategoryOrder();

        // Group items by category
        const categorizedItems = {};
        categories.forEach(cat => categorizedItems[cat.id] = []);

        items.forEach(item => {
            if (item.is_buy_later) {
                // Render buy later items directly to the buyLaterList
                buyLaterList.appendChild(createItemElement(item));
            } else {
                // Categorize shopping list items
                const category = categories.find(c => c.id === item.category_id) || categories.find(c => c.name === "Autres") || initialDefaultCategories.find(c => c.name === "Autres");
                if (category) {
                    categorizedItems[category.id].push(item);
                } else {
                    // Fallback for uncategorized items (shouldn't happen with default "Autres")
                    (categorizedItems["autres"] || categorizedItems[initialDefaultCategories.find(c => c.name === "Autres").id]).push(item);
                }
            }
        });

        // Render shopping list items, respecting category order
        categoryOrder.forEach(categoryId => {
            const categoryName = categories.find(c => c.id === categoryId)?.name;
            if (categoryName && categorizedItems[categoryId] && categorizedItems[categoryId].length > 0) {
                const categoryHeader = document.createElement('h4');
                categoryHeader.textContent = categoryName;
                shoppingList.appendChild(categoryHeader);

                categorizedItems[categoryId].forEach(item => {
                    shoppingList.appendChild(createItemElement(item));
                });
            }
        });
    }

    function createItemElement(item) {
        const li = document.createElement('li');
        li.dataset.id = item.id; // Store Supabase ID
        li.classList.toggle('checked', item.is_checked);

        const itemText = document.createElement('span');
        itemText.textContent = item.name;
        itemText.classList.add('item-text');
        itemText.addEventListener('click', async () => {
            await addOrUpdateItem(item.name, item.category_id, !item.is_checked, item.is_buy_later, item.id);
        });

        const categorySelect = document.createElement('select');
        categorySelect.classList.add('category-select');
        populateCategorySelect(categorySelect, item.category_id);
        categorySelect.addEventListener('change', async (e) => {
            await addOrUpdateItem(item.name, e.target.value, item.is_checked, item.is_buy_later, item.id);
        });

        const controls = document.createElement('div');
        controls.classList.add('item-controls');

        const moveButton = document.createElement('button');
        if (item.is_buy_later) {
            moveButton.innerHTML = '<i class="fas fa-shopping-cart"></i>'; // Move back to main list
            moveButton.title = "Move to shopping list";
            moveButton.addEventListener('click', async () => {
                await addOrUpdateItem(item.name, item.category_id, false, false, item.id); // Uncheck and move to main list
            });
        } else {
            moveButton.innerHTML = '<i class="fas fa-archive"></i>'; // Move to buy later
            moveButton.title = "Move to Buy Later";
            moveButton.addEventListener('click', async () => {
                await addOrUpdateItem(item.name, item.category_id, false, true, item.id); // Uncheck and move to buy later
            });
        }

        const deleteButton = document.createElement('button');
        deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
        deleteButton.title = "Delete item";
        deleteButton.addEventListener('click', async () => {
            await deleteItem(item.id);
        });

        controls.appendChild(categorySelect);
        controls.appendChild(moveButton);
        controls.appendChild(deleteButton);

        li.appendChild(itemText);
        li.appendChild(controls);

        return li;
    }

    function populateCategorySelect(selectElement, selectedId = null) {
        selectElement.innerHTML = '';
        const categories = getCategories();
        const categoryOrder = getCategoryOrder(); // Get ordered category IDs

        // Create a map for quick lookup
        const categoryMap = new Map(categories.map(cat => [cat.id, cat.name]));

        // Sort categories based on order
        const sortedCategories = categoryOrder
            .map(id => ({ id, name: categoryMap.get(id) }))
            .filter(cat => cat.name !== undefined); // Filter out any IDs not found in current categories

        sortedCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            if (selectedId && category.id === selectedId) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
    }

    function updateAllCategorySelects() {
        document.querySelectorAll('.category-select').forEach(select => {
            const currentSelectedId = select.value;
            populateCategorySelect(select, currentSelectedId);
        });
        populateCategorySelect(newItemCategory, getCategories()[0]?.id); // Set default for new item
    }

    function renderCategoriesManagement() {
        categoryList.innerHTML = '';
        const categories = getCategories();
        const categoryOrder = getCategoryOrder();

        const sortedCategories = categoryOrder.map(id => categories.find(cat => cat.id === id)).filter(Boolean);

        sortedCategories.forEach(category => {
            const li = document.createElement('li');
            li.dataset.id = category.id;
            li.classList.add('category-item');
            li.draggable = true;

            const dragHandle = document.createElement('span');
            dragHandle.innerHTML = '<i class="fas fa-grip-vertical category-drag-handle"></i>';

            const span = document.createElement('span');
            span.textContent = category.name;

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.title = `Delete ${category.name} category`;
            deleteBtn.addEventListener('click', () => deleteCategory(category.id));

            li.appendChild(dragHandle);
            li.appendChild(span);
            li.appendChild(deleteBtn);
            categoryList.appendChild(li);
        });
        addCategoryDragListeners();
    }

    function addCategory(name) {
        const categories = getCategories();
        const categoryOrder = getCategoryOrder();
        const newId = generateUniqueId();
        const newCategory = { name: name, id: newId };

        if (categories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
            alert('Category already exists!');
            return;
        }

        categories.push(newCategory);
        saveCategories(categories);
        categoryOrder.push(newId); // Add new category to the end of the order
        saveCategoryOrder(categoryOrder);

        renderCategoriesManagement();
        updateAllCategorySelects();
        newCategoryInput.value = '';
        fetchAndRenderListItems(); // Re-render lists to reflect new categories
    }

    function deleteCategory(id) {
        if (!confirm('Deleting a category will remove it from all items. Continue?')) return;

        let categories = getCategories();
        let categoryOrder = getCategoryOrder();

        categories = categories.filter(cat => cat.id !== id);
        categoryOrder = categoryOrder.filter(catId => catId !== id);

        saveCategories(categories);
        saveCategoryOrder(categoryOrder);
        renderCategoriesManagement();
        updateAllCategorySelects();
        fetchAndRenderListItems(); // Re-render lists
    }

    // Drag and Drop for Categories
    let draggedCategory = null;

    function addCategoryDragListeners() {
        document.querySelectorAll('#categoryList .category-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedCategory = item;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', item.dataset.id);
                setTimeout(() => item.classList.add('dragging'), 0);
            });

            item.addEventListener('dragend', () => {
                draggedCategory.classList.remove('dragging');
                draggedCategory = null;
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault(); // Allows us to drop
                if (draggedCategory && draggedCategory !== item) {
                    const rect = item.getBoundingClientRect();
                    const next = (e.clientY - rect.top) / rect.height > 0.5;
                    categoryList.insertBefore(draggedCategory, next && item.nextSibling || item);
                }
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedCategory && draggedCategory !== item) {
                    updateCategoryOrderFromDOM();
                }
            });
        });
    }

    function updateCategoryOrderFromDOM() {
        const newOrder = Array.from(categoryList.children).map(li => li.dataset.id);
        saveCategoryOrder(newOrder);
        console.log('Category order updated:', newOrder);
        fetchAndRenderListItems(); // Re-render to reflect new order
    }

    // Suggestions
    function loadSuggestions() {
        const storedSuggestions = JSON.parse(localStorage.getItem('suggestions')) || [];
        renderSuggestions(storedSuggestions);
    }

    function saveSuggestions(suggestions) {
        localStorage.setItem('suggestions', JSON.stringify(suggestions));
        renderSuggestions(suggestions);
    }

    function addSuggestion(text) {
        let suggestions = JSON.parse(localStorage.getItem('suggestions')) || [];
        if (!suggestions.includes(text)) {
            suggestions.push(text);
            saveSuggestions(suggestions);
        }
    }

    function removeSuggestion(text) {
        let suggestions = JSON.parse(localStorage.getItem('suggestions')) || [];
        suggestions = suggestions.filter(s => s !== text);
        saveSuggestions(suggestions);
    }

    function renderSuggestions(suggestions) {
        suggestionsContainer.innerHTML = '<h4>Suggestions:</h4>';
        if (suggestions.length === 0) {
            suggestionsContainer.innerHTML += '<p>No suggestions yet. Add some items!</p>';
            return;
        }
        suggestions.forEach(suggestionText => {
            const span = document.createElement('span');
            span.classList.add('suggestion-item');
            span.textContent = suggestionText;
            span.title = 'Click to add, Alt/Option + click to remove';
            span.addEventListener('click', (e) => {
                if (e.altKey || e.metaKey) { // Alt key for Windows/Linux, Option key for Mac
                    removeSuggestion(suggestionText);
                } else {
                    newItemInput.value = suggestionText;
                    addItemBtn.click(); // Simulate click to add item
                }
            });
            suggestionsContainer.appendChild(span);
        });
    }

    function loadBuyLaterList() {
      // This function now just relies on fetchAndRenderListItems()
      // to populate the buyLaterList as part of the overall item fetch.
      // It's kept for conceptual consistency but its direct rendering role is diminished.
    }

    function loadCategoryOrder() {
        renderCategoriesManagement(); // Render categories in their saved order
    }

    // Event Listeners
    window.addEventListener('load', async () => {
      // Initialize local storage defaults
      if (!localStorage.getItem('user_categories')) {
          localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
      }
      if (!localStorage.getItem('category_order')) {
          localStorage.setItem('category_order', JSON.stringify(getCategories().map(cat => cat.id)));
      }

      // Update UI elements based on local storage
      updateAllCategorySelects();
      loadSuggestions();
      loadBuyLaterList();
      loadCategoryOrder();

      // --- NEW CODE: Wait for window.supabase to be defined ---
      let supabaseLoadAttempts = 0;
      const maxSupabaseLoadAttempts = 50; // Increased attempts to ensure loading
      const supabaseLoadDelayMs = 100;    // Longer delay per attempt

      while ((typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') && supabaseLoadAttempts < maxSupabaseLoadAttempts) {
          console.log(`Waiting for window.supabase (attempt ${supabaseLoadAttempts + 1}/${maxSupabaseLoadAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, supabaseLoadDelayMs));
          supabaseLoadAttempts++;
      }

      // Initialisation du client Supabase
      if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("Supabase client initialized successfully.");
      } else {
          console.error("Erreur: La bibliothÃ¨que Supabase n'a pas pu Ãªtre chargÃ©e ou initialisÃ©e correctement aprÃ¨s plusieurs tentatives.");
          alert("Erreur de chargement: La bibliothÃ¨que Supabase n'a pas pu Ãªtre initialisÃ©e. VÃ©rifiez votre connexion internet ou la configuration.");
          return; // ArrÃªter l'exÃ©cution si Supabase n'est pas initialisÃ©
      }
      // --- END NEW CODE ---

      // --- CODE MODIFIÃ‰ : Attendre que supabase.rest soit prÃªt ---
      let attempts = 0;
      const maxAttempts = 20; // Essayer jusqu'Ã  20 fois
      const delayMs = 50;     // Attendre 50ms entre chaque tentative

      while (!supabase.rest && attempts < maxAttempts) {
          console.log(`Attente de supabase.rest (tentative ${attempts + 1}/${maxAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, delayMs));
          attempts++;
      }

      if (supabase.rest) {
          console.log("supabase.rest est maintenant prÃªt !");
          // Appeler les fonctions qui dÃ©pendent de Supabase ici
          await promptForShareCode(); // Ceci dÃ©clenchera le prompt et la crÃ©ation/chargement de la liste
      } else {
          console.error("Erreur: supabase.rest n'est pas devenu prÃªt aprÃ¨s plusieurs tentatives. Impossible de dÃ©marrer l'application.");
          // GÃ©rer l'erreur, par exemple afficher un message Ã  l'utilisateur
          return;
      }

      showSection('shoppingListSection');
      // Ensure options are hidden on initial load and arrow points down
      navigationButtonsContainer.classList.remove('show-options');
      toggleOptionsIcon.classList.remove('fa-chevron-up');
      toggleOptionsIcon.classList.add('fa-chevron-down');
    });

    addItemBtn.addEventListener('click', async () => {
        const itemName = newItemInput.value.trim();
        const categoryId = newItemCategory.value;
        if (itemName) {
            await addOrUpdateItem(itemName, categoryId);
            addSuggestion(itemName); // Add item to suggestions
        } else {
            alert('Please enter an item name.');
        }
    });

    clearAllItemsBtn.addEventListener('click', clearAllItems);
    clearBuyLaterBtn.addEventListener('click', clearBuyLaterItems);
    moveCheckedToBuyLaterBtn.addEventListener('click', moveCheckedToBuyLater);

    addCategoryBtn.addEventListener('click', () => {
        const categoryName = newCategoryInput.value.trim();
        if (categoryName) {
            addCategory(categoryName);
        } else {
            alert('Please enter a category name.');
        }
    });

    shareListBtn.addEventListener('click', async () => {
        const shareCode = shareCodeDisplay.value;
        if (shareCode) {
            try {
                await navigator.clipboard.writeText(shareCode);
                alert('Share code copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text:', err);
                alert('Failed to copy share code. Please copy manually: ' + shareCode);
            }
        }
    });

    joinListBtn.addEventListener('click', async () => {
        const code = shareCodeInput.value.trim().toUpperCase();
        if (code) {
            await getOrCreateListByShareCode(code);
            shareCodeInput.value = ''; // Clear input after joining
        } else {
            alert('Please enter a share code.');
        }
    });

    toggleOptionsHeader.addEventListener('click', () => {
        navigationButtonsContainer.classList.toggle('show-options');
        toggleOptionsIcon.classList.toggle('fa-chevron-down');
        toggleOptionsIcon.classList.toggle('fa-chevron-up');
    });

    async function promptForShareCode() {
        let code = getShareCode();
        if (code) {
            await getOrCreateListByShareCode(code);
        } else {
            // Should ideally not happen if getShareCode generates one, but as fallback
            let newCode = generateShareCode();
            await getOrCreateListByShareCode(newCode);
        }
    }

    // Supabase Realtime Listener
    // Listen for changes in list_items table only for the current list
    if (supabase) { // Ensure supabase client is initialized before setting up listener
        supabase
            .channel('list_items_changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'list_items', filter: `list_id=eq.${currentListId}` }, payload => {
                console.log('Change received!', payload);
                fetchAndRenderListItems(); // Re-fetch and render on any change
            })
            .subscribe();
    }
  </script>
</body>
</html>