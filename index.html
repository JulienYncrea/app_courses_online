<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shopping List 🛒</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 1rem;
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: none;
    }
    .section-container.active {
        display: block;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: bold;
      color: #6A057F;
    }
    input, button, select {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.4rem;
      border: 1px solid #DDA0DD;
      border-radius: 0.5rem;
      box-sizing: border-box;
      color: #333;
      font-size: 1rem;
    }
    button {
      background: #FF69B4;
      color: #FFFFFF;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover {
      background: #C71585;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    select {
        background: #F8F8FF;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='%23C71585' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%;
        background-size: 0.65em auto;
        padding-right: 2.5em;
    }

    /* Styles for navigation buttons */
    .navigation-buttons {
        text-align: center;
        margin-bottom: 2rem;
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }
    .navigation-buttons button {
        width: auto;
        padding: 0.8rem 1.8rem;
        font-size: 1.1rem;
        background-color: #EE82EE;
        color: #FFFFFF;
        border: 2px solid #DA70D6;
        border-radius: 25px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: inline-flex; /* Use flex to align icon and text */
        align-items: center;
        justify-content: center;
    }
    .navigation-buttons button.active {
        background: #FFD700;
        color: #6A057F;
        border-color: #FFA500;
        font-weight: bold;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .navigation-buttons button:hover:not(.active) {
        background-color: #DDA0DD;
        border-color: #BA55D3;
    }
    .navigation-buttons .toggle-options-btn {
        background-color: #9370DB; /* Couleur différente pour le bouton toggle */
        border-color: #8A2BE2;
        padding: 0.8rem 1.2rem; /* Plus petit pour l'icône */
    }
    .navigation-buttons .toggle-options-btn:hover {
        background-color: #8A2BE2;
        border-color: #6A057F;
    }
    .navigation-buttons .toggle-options-btn i {
        transition: transform 0.3s ease;
    }
    .navigation-buttons .option-button {
        display: none; /* Hidden by default */
    }
    .navigation-buttons.show-options .option-button {
        display: inline-flex; /* Show when parent has show-options class */
    }

    /* Styles for the shopping list */
    .shopping-list-item, .buy-later-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFF0F5;
      padding: 0.7rem 1.2rem;
      margin-top: 0.7rem;
      border-radius: 0.75rem;
      font-size: 1.1rem;
      color: #6A057F;
      border: 1px solid #FFC0CB;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      /* Prevent text selection on drag for iOS/Safari */
      -webkit-user-select: none; /* Safari */
      -moz-user-select: none;    /* Firefox */
      -ms-user-select: none;     /* IE10+ */
      user-select: none;         /* Standard */
    }
    .shopping-list-item .delete-btn, 
    .shopping-list-item .decrement-btn,
    .buy-later-item .delete-btn {
      background: none;
      border: none;
      color: #FF6347;
      font-size: 1.6rem;
      cursor: pointer;
      padding: 0 0.5rem;
      margin: 0;
      width: auto;
      transition: color 0.3s ease;
      line-height: 1; /* Ensure consistent vertical alignment */
    }
    .shopping-list-item .decrement-btn {
        color: #6A057F; /* Darker color for decrement */
        font-size: 1.8rem; /* Slightly larger for visibility */
        margin-right: 5px; /* Space between - and quantity */
    }
    .shopping-list-item .delete-btn:hover, 
    .buy-later-item .delete-btn:hover {
      color: #DC143C;
    }
    .shopping-list-item .decrement-btn:hover {
        color: #8A2BE2; /* Change color on hover for decrement */
    }

    .shopping-list-item span, .buy-later-item span {
        flex-grow: 1;
        padding-right: 10px;
    }
    .quantity {
        font-weight: bold;
        margin-left: 8px; /* Space after quantity */
        margin-right: 8px; /* Space before quantity if decrement is present */
        color: #FF8C00;
        min-width: 20px; /* Ensure space for quantity */
        text-align: center;
    }

    /* Styles for the suggestions list */
    .suggestions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 0.7rem;
      margin-top: 1.5rem;
    }
    .suggestion-item {
      position: relative;
      background: #9370DB;
      color: #FFFFFF;
      padding: 0.6rem 1rem;
      border-radius: 0.75rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      white-space: nowrap; /* Prevent wrapping */
      overflow: hidden; /* Hide overflow */
      text-overflow: ellipsis; /* Add ellipsis for overflowed text */
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-right: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .suggestion-item:hover {
      background: #8A2BE2;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .suggestion-item-text {
        flex-grow: 1;
        padding-right: 5px;
        font-weight: 500;
        overflow: hidden; /* Ensure text overflow ellipsis works */
        text-overflow: ellipsis;
        white-space: nowrap; /* Keep on single line */
    }
    .delete-suggestion-btn {
      background: none;
      border: none;
      color: #FFD700;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 0 0.2rem;
      margin: 0;
      width: auto;
      transition: color 0.3s ease;
      line-height: 1;
      flex-shrink: 0; /* Prevent button from shrinking */
    }
    .delete-suggestion-btn:hover {
      color: #FF4500;
    }

    .add-form { /* General style for add forms */
        margin-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
        padding-top: 1rem;
    }
    .filter-controls {
        margin-bottom: 1.5rem;
    }

    /* Style for empty list text */
    p[style*="text-align: center"] {
        color: #C71585 !important;
        font-style: italic;
        font-size: 0.95rem;
    }

    /* Category order list styles */
    #categoryOrderList, #manageCategoryList {
        list-style: none;
        padding: 0;
    }
    #categoryOrderList li, #manageCategoryList li {
        background: #F8F8FF;
        border: 1px solid #DDA0DD;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        color: #6A057F;
        cursor: grab; /* Indicate draggable */
        transition: background-color 0.2s ease, transform 0.2s ease;
        /* Prevent text selection on drag for iOS/Safari */
        -webkit-user-select: none; /* Safari */
        -moz-user-select: none;    /* Firefox */
        -ms-user-select: none;     /* IE10+ */
        user-select: none;         /* Standard */
    }
    #categoryOrderList li:hover {
        background-color: #E6E6FA;
        transform: scale(1.01);
    }
    #categoryOrderList li.dragging {
        opacity: 0.7;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .drag-handle {
        font-size: 1.5rem;
        cursor: grab;
        margin-right: 10px;
        color: #EE82EE;
    }
    #manageCategoryList li .delete-category-btn {
        background: none;
        border: none;
        color: #FF6347;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0 0.2rem;
        margin-left: 10px;
        transition: color 0.3s ease;
    }
    #manageCategoryList li .delete-category-btn:hover {
        color: #DC143C;
    }

    /* Styles for the new "Manage Categories" subsection */
    .manage-categories-subsection {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
    }
    .manage-categories-subsection h3 {
        color: #E75480;
        text-align: center;
        margin-bottom: 1rem;
    }

    /* Styles for share code section */
    .share-code-section {
        max-width: 600px;
        margin: 1rem auto;
        background: #FFFFFF;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 2rem;
    }
    .share-code-section h2 {
        margin-bottom: 1rem;
    }
    .share-code-section input {
        margin-bottom: 1rem;
    }
    .current-list-display {
        background: #F8F8FF;
        padding: 0.7rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
        font-weight: bold;
        color: #6A057F;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }
    .current-list-display button {
        width: auto;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        margin: 0;
        flex-shrink: 0;
    }

    @media (max-width: 640px) {
        .suggestions-grid {
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        }
        .navigation-buttons button {
          padding: 0.6rem 1rem;
          font-size: 0.9rem;
        }
        .navigation-buttons .toggle-options-btn {
            padding: 0.6rem 1rem; /* Adjust padding for smaller screens */
        }
    }
  </style>
</head>
<body>
  <h1>My Shopping List 🛒</h1>

  <div class="share-code-section">
      <h2>Connect to Your List</h2>
      <p id="currentListDisplay" class="current-list-display">Not connected</p>
      <label for="shareCodeInput">Enter List Code:</label>
      <input type="text" id="shareCodeInput" placeholder="Enter a code or leave blank for new list" />
      <button id="connectListBtn">Connect / Create List</button>
  </div>

  <div class="navigation-buttons" id="navigationButtonsContainer">
    <button id="showShoppingListBtn" class="active">My List</button>
    <button id="toggleOptionsBtn" class="toggle-options-btn"><i class="fas fa-chevron-up"></i></button>
    <button id="showSuggestionsBtn" class="option-button">Suggestions</button>
    <button id="showCategoryOrderBtn" class="option-button">Order by Category</button>
    <button id="showBuyLaterBtn" class="option-button">Buy Later</button>
  </div>

  <div id="shoppingListSection" class="section-container active">
    <h2>Items to Buy</h2>
    <div id="shoppingList" style="margin-top: 1rem;">
      </div>
    <form id="shoppingForm" autocomplete="off" class="add-form">
        <label for="newItem">Add an item:</label>
        <input type="text" id="newItem" placeholder="Ex: Milk, Bread, Apples..." required />
        <button type="submit">Add to List ✅</button>
    </form>
  </div>

  <div id="suggestionsSection" class="section-container">
    <h2>Suggestions by Category</h2>
    <div class="filter-controls">
        <label for="categoryFilter">Filter by category:</label>
        <select id="categoryFilter">
        </select>
    </div>
    <div id="suggestionsList" class="suggestions-grid">
    </div>
    <form id="addSuggestionForm" autocomplete="off" class="add-form">
        <label for="newSuggestion">New suggestion:</label>
        <input type="text" id="newSuggestion" placeholder="Ex: Cheese, Chocolate..." required />
        <label for="suggestionCategory">Category:</label>
        <select id="suggestionCategory" required>
        </select>
        <button type="submit">Add as suggestion ✨</button>
    </form>
  </div>

  <div id="categoryOrderSection" class="section-container">
    <h2>Order Categories</h2>
    <p style="text-align: center; color: #6A057F; margin-top: 0.5rem;">Drag and drop categories to set their order in 'My List'.</p>
    <ul id="categoryOrderList">
    </ul>
    <div class="manage-categories-subsection">
        <h3>Manage Categories</h3>
        <form id="addCategoryForm" autocomplete="off" class="add-form">
            <label for="newCategoryName">Add new category:</label>
            <input type="text" id="newCategoryName" placeholder="Ex: Pet Food, Snacks..." required />
            <button type="submit">Add Category ➕</button>
        </form>
        <ul id="manageCategoryList">
        </ul>
    </div>
  </div>

  <div id="buyLaterSection" class="section-container">
    <h2>Items to Buy Later</h2>
    <div id="buyLaterList" style="margin-top: 1rem;">
    </div>
    <form id="buyLaterForm" autocomplete="off" class="add-form">
        <label for="newBuyLaterItem">Add item to buy later:</label>
        <input type="text" id="newBuyLaterItem" placeholder="Ex: New book, Fancy gadget..." required />
        <button type="submit">Add to Buy Later ➡️</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Supabase Configuration ---
    // REMPLACEZ CES VALEURS PAR LES VÔTRES !
    const supabaseUrl = 'https://cepqcretnxfhjbvdukkk.supabase.co'; // Exemple: 'https://abcdefghijk.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU'; // Exemple: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdo...

    let supabase = null; // Déclaré ici, initialisé dans l'écouteur de chargement

    // --- Global State for Supabase List Management ---
    let currentShareCode = null;
    let currentListId = null;
    let REALTIME_SUBSCRIPTION = null;

    // --- DOM Elements ---
    const shoppingForm = document.getElementById('shoppingForm');
    const newItemInput = document.getElementById('newItem');
    const shoppingListDiv = document.getElementById('shoppingList');
    const addSuggestionForm = document.getElementById('addSuggestionForm');
    const newSuggestionInput = document.getElementById('newSuggestion');
    const suggestionCategorySelect = document.getElementById('suggestionCategory');
    const suggestionsListDiv = document.getElementById('suggestionsList');
    const categoryFilterSelect = document.getElementById('categoryFilter');
    const buyLaterForm = document.getElementById('buyLaterForm');
    const newBuyLaterItemInput = document.getElementById('newBuyLaterItem');
    const buyLaterListDiv = document.getElementById('buyLaterList');
    const addCategoryForm = document.getElementById('addCategoryForm');
    const newCategoryNameInput = document.getElementById('newCategoryName');
    const manageCategoryList = document.getElementById('manageCategoryList');

    // Navigation buttons
    const navigationButtonsContainer = document.getElementById('navigationButtonsContainer');
    const showShoppingListBtn = document.getElementById('showShoppingListBtn');
    const toggleOptionsBtn = document.getElementById('toggleOptionsBtn');
    const toggleOptionsIcon = toggleOptionsBtn.querySelector('i');
    const showSuggestionsBtn = document.getElementById('showSuggestionsBtn');
    const showCategoryOrderBtn = document.getElementById('showCategoryOrderBtn');
    const showBuyLaterBtn = document.getElementById('showBuyLaterBtn');

    // Sections
    const shoppingListSection = document.getElementById('shoppingListSection');
    const suggestionsSection = document.getElementById('suggestionsSection');
    const categoryOrderSection = document.getElementById('categoryOrderSection');
    const buyLaterSection = document.getElementById('buyLaterSection');
    const categoryOrderList = document.getElementById('categoryOrderList');

    // Share code elements
    const shareCodeInput = document.getElementById('shareCodeInput');
    const connectListBtn = document.getElementById('connectListBtn');
    const currentListDisplay = document.getElementById('currentListDisplay');


    // --- Default Categories ---
    const initialDefaultCategories = [
        "Fruits et Légumes", "Produits Laitiers", "Viandes et Poissons",
        "Produits d'Épicerie", "Boulangerie", "Boissons", "Surgelés",
        "Entretien", "Hygiène", "Autres"
    ];


    // --- Utility Functions ---
    function generateShareCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section-container').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(sectionId).classList.add('active');
        // Update active class for navigation buttons
        document.querySelectorAll('.navigation-buttons button').forEach(btn => {
            btn.classList.remove('active');
        });
        if (sectionId === 'shoppingListSection') {
            showShoppingListBtn.classList.add('active');
        } else if (sectionId === 'suggestionsSection') {
            showSuggestionsBtn.classList.add('active');
        } else if (sectionId === 'categoryOrderSection') {
            showCategoryOrderBtn.classList.add('active');
        } else if (sectionId === 'buyLaterSection') {
            showBuyLaterBtn.classList.add('active');
        }
    }

    function getCategories() {
        return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
        localStorage.setItem('user_categories', JSON.stringify(categories));
    }

    function updateAllCategorySelects() {
        const categories = getCategories();
        const selects = document.querySelectorAll('select#suggestionCategory, select#categoryFilter'); // Select all category dropdowns
        selects.forEach(select => {
            select.innerHTML = ''; // Clear existing options

            // Add default "All Categories" option for filter
            if (select.id === 'categoryFilter') {
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'All Categories';
                select.appendChild(allOption);
            }

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        });

        // Set initial selection for suggestion category if available
        const suggestionCatSelect = document.getElementById('suggestionCategory');
        if (categories.length > 0 && suggestionCatSelect) {
            suggestionCatSelect.value = categories[0];
        }
    }

    function renderCategoryOrderList() {
        const categories = getCategories();
        categoryOrderList.innerHTML = '';
        categories.forEach(category => {
            const li = document.createElement('li');
            li.draggable = true;
            li.dataset.category = category;
            li.innerHTML = `<i class="fas fa-grip-lines drag-handle"></i><span>${category}</span>`;
            categoryOrderList.appendChild(li);
        });
        addDragAndDropListeners();
    }

    function renderManageCategoryList() {
        const categories = getCategories();
        manageCategoryList.innerHTML = '';
        categories.forEach(category => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${category}</span>
                <button class="delete-category-btn" data-category="${category}"><i class="fas fa-trash-alt"></i></button>
            `;
            manageCategoryList.appendChild(li);
        });
        document.querySelectorAll('.delete-category-btn').forEach(button => {
            button.addEventListener('click', deleteCategory);
        });
    }

    function loadCategoryOrder() {
        renderCategoryOrderList();
        renderManageCategoryList();
    }


    // --- Supabase Functions ---

    // NOUVEAU : Fonction pour mettre à jour les en-têtes Supabase avec le code de partage
    function updateSupabaseHeaders(shareCode) {
        if (supabase && supabase.rest) {
            supabase.rest.headers['X-Share-Code'] = shareCode;
            console.log(`Supabase headers updated with X-Share-Code: ${shareCode}`);
        } else {
            console.warn("Supabase client non initialisé ou rest client non prêt, impossible de mettre à jour les headers.");
        }
    }

    // NOUVEAU : Fonction pour gérer la connexion ou la création de liste via Supabase
    async function getOrCreateListByShareCode(code) {
        currentShareCode = code;
        updateSupabaseHeaders(code); // Assurez-vous que les headers sont mis à jour avant la première requête

        try {
            // Tente de récupérer la liste existante
            const { data: lists, error: selectError } = await supabase
                .from('lists')
                .select('id, name')
                .eq('share_code', code);

            if (selectError && selectError.code !== '406' && !(selectError.code === 'PGRST400' && selectError.message.includes('406'))) {
                // Ignore 406 (RLS policy) as it means "not found", but log other errors
                console.error("Supabase error fetching list:", selectError);
            }

            if (lists && lists.length > 0) {
                currentListId = lists[0].id;
                currentListDisplay.innerHTML = `Connected: <strong>${lists[0].name || code}</strong> <button id="disconnectBtn">Disconnect</button>`;
                console.log("Connected to existing list:", currentListId);
            } else {
                // Si aucune liste n'est trouvée, la créer
                const listName = prompt(`List with code "${code}" not found. Enter a name for the new list:`);
                if (!listName) {
                    alert("List creation cancelled.");
                    currentListId = null;
                    currentShareCode = null;
                    currentListDisplay.innerHTML = "Not connected";
                    return;
                }

                const { data: newList, error: insertError } = await supabase
                    .from('lists')
                    .insert([{ share_code: code, name: listName }])
                    .select('id, name');

                if (insertError) {
                    console.error("Error creating new list:", insertError);
                    alert("Error creating new list: " + insertError.message);
                    currentListId = null;
                    currentShareCode = null;
                    currentListDisplay.innerHTML = "Not connected";
                    return;
                }

                currentListId = newList[0].id;
                currentListDisplay.innerHTML = `Connected: <strong>${newList[0].name}</strong> <button id="disconnectBtn">Disconnect</button>`;
                console.log("Created new list:", currentListId);
            }
            // Start real-time subscription only after a list is connected
            startRealtimeSubscription();
            loadShoppingList(); // Load items for the connected list
            loadSuggestions(); // Load suggestions for the connected list
            loadBuyLaterList(); // Load buy later items for the connected list

            // Add event listener for disconnect button after it's created
            document.getElementById('disconnectBtn').addEventListener('click', handleDisconnect);

        } catch (error) {
            console.error("Unexpected error in getOrCreateListByShareCode:", error);
            alert("An unexpected error occurred: " + error.message);
            currentListId = null;
            currentShareCode = null;
            currentListDisplay.innerHTML = "Not connected";
        }
    }

    function handleDisconnect() {
        if (REALTIME_SUBSCRIPTION) {
            supabase.removeChannel(REALTIME_SUBSCRIPTION);
            REALTIME_SUBSCRIPTION = null;
            console.log("Realtime subscription disconnected.");
        }
        currentListId = null;
        currentShareCode = null;
        currentListDisplay.innerHTML = "Not connected";
        // Clear displayed items and lists
        shoppingListDiv.innerHTML = '<p style="text-align: center; color: #C71585;">Connect to a list to see items.</p>';
        suggestionsListDiv.innerHTML = '<p style="text-align: center; color: #C71585;">Connect to a list to see suggestions.</p>';
        buyLaterListDiv.innerHTML = '<p style="text-align: center; color: #C71585;">Connect to a list to see "buy later" items.</p>';
        alert("Disconnected from the list.");
    }

    function startRealtimeSubscription() {
        if (REALTIME_SUBSCRIPTION) {
            supabase.removeChannel(REALTIME_SUBSCRIPTION); // Remove existing subscription if any
        }

        if (!currentListId) {
            console.warn("Cannot start real-time subscription: no list connected.");
            return;
        }

        REALTIME_SUBSCRIPTION = supabase
            .channel(`list:${currentListId}`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'items',
                filter: `list_id=eq.${currentListId}`
            }, payload => {
                console.log('Change received!', payload);
                // Re-fetch and render the list to reflect changes
                loadShoppingList();
            })
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'suggestions',
                filter: `list_id=eq.${currentListId}`
            }, payload => {
                console.log('Suggestion change received!', payload);
                loadSuggestions();
            })
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'buy_later_items',
                filter: `list_id=eq.${currentListId}`
            }, payload => {
                console.log('Buy Later change received!', payload);
                loadBuyLaterList();
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log(`Realtime subscription to list ${currentListId} successful!`);
                } else if (status === 'CHANNEL_ERROR') {
                    console.error(`Realtime subscription error for list ${currentListId}.`);
                }
            });
    }


    // --- Item Management (Shopping List) ---
    async function loadShoppingList() {
        if (!currentListId) {
            shoppingListDiv.innerHTML = '<p style="text-align: center; color: #C71585;">Connect to a list to see items.</p>';
            return;
        }
        try {
            const { data: items, error } = await supabase
                .from('items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: false });

            if (error) throw error;

            renderShoppingList(items);
        } catch (error) {
            console.error("Error loading shopping list:", error.message);
            shoppingListDiv.innerHTML = `<p style="text-align: center; color: #FF0000;">Error loading list: ${error.message}</p>`;
        }
    }

    function renderShoppingList(items) {
        shoppingListDiv.innerHTML = '';
        if (items.length === 0) {
            shoppingListDiv.innerHTML = '<p style="text-align: center;">Your list is empty. Add some items!</p>';
            return;
        }

        // Group items by category and sort categories based on stored order
        const categories = getCategories();
        const groupedItems = {};
        categories.forEach(cat => groupedItems[cat] = []); // Initialize with all categories
        items.forEach(item => {
            const category = item.category || 'Autres'; // Default to 'Others' if category is null
            if (!groupedItems[category]) {
                groupedItems[category] = []; // Add category if it's new
            }
            groupedItems[category].push(item);
        });

        // Render sections in category order
        categories.forEach(category => {
            if (groupedItems[category] && groupedItems[category].length > 0) {
                const categoryHeader = document.createElement('h3');
                categoryHeader.style.color = '#E75480';
                categoryHeader.style.marginTop = '1.5rem';
                categoryHeader.style.marginBottom = '0.5rem';
                categoryHeader.textContent = category;
                shoppingListDiv.appendChild(categoryHeader);

                groupedItems[category].forEach(item => {
                    const li = document.createElement('div');
                    li.classList.add('shopping-list-item');
                    li.dataset.id = item.id;
                    li.innerHTML = `
                        <span class="item-text">${item.name}</span>
                        <div class="item-controls">
                            ${item.quantity > 1 ? `<button class="decrement-btn" data-id="${item.id}" data-quantity="${item.quantity}"><i class="fas fa-minus"></i></button>` : ''}
                            <span class="quantity">${item.quantity}</span>
                            <button class="delete-btn" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    shoppingListDiv.appendChild(li);
                });
            }
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', deleteItem);
        });
        document.querySelectorAll('.decrement-btn').forEach(button => {
            button.addEventListener('click', decrementItemQuantity);
        });
    }

    async function addItem(event) {
        event.preventDefault();
        if (!currentListId) {
            alert("Please connect to or create a list first!");
            return;
        }

        const itemName = newItemInput.value.trim();
        if (!itemName) return;

        const category = document.getElementById('suggestionCategory').value; // Get category from the suggestions select for consistency

        try {
            // Check if item already exists in the list for the current list_id
            const { data: existingItems, error: fetchError } = await supabase
                .from('items')
                .select('id, quantity')
                .eq('list_id', currentListId)
                .eq('name', itemName);

            if (fetchError) throw fetchError;

            if (existingItems && existingItems.length > 0) {
                // Item exists, increment quantity
                const existingItem = existingItems[0];
                const newQuantity = existingItem.quantity + 1;
                const { error: updateError } = await supabase
                    .from('items')
                    .update({ quantity: newQuantity })
                    .eq('id', existingItem.id);
                if (updateError) throw updateError;
                console.log(`Incremented quantity for item: ${itemName}`);
            } else {
                // Item does not exist, insert new item
                const { error: insertError } = await supabase
                    .from('items')
                    .insert([{ name: itemName, quantity: 1, list_id: currentListId, category: category }]);
                if (insertError) throw insertError;
                console.log(`Added new item: ${itemName}`);
            }

            newItemInput.value = '';
            loadShoppingList(); // Reload list to reflect changes
            removeSuggestion(itemName); // Remove from suggestions if added
        } catch (error) {
            console.error("Error adding/updating item:", error.message);
            alert("Error adding item: " + error.message);
        }
    }

    async function deleteItem(event) {
        const itemId = event.currentTarget.dataset.id;
        try {
            const { error } = await supabase
                .from('items')
                .delete()
                .eq('id', itemId)
                .eq('list_id', currentListId); // Ensure only items from current list are deleted

            if (error) throw error;
            console.log(`Deleted item with ID: ${itemId}`);
            loadShoppingList();
        } catch (error) {
            console.error("Error deleting item:", error.message);
            alert("Error deleting item: " + error.message);
        }
    }

    async function decrementItemQuantity(event) {
        const itemId = event.currentTarget.dataset.id;
        const currentQuantity = parseInt(event.currentTarget.dataset.quantity);

        if (currentQuantity > 1) {
            try {
                const newQuantity = currentQuantity - 1;
                const { error } = await supabase
                    .from('items')
                    .update({ quantity: newQuantity })
                    .eq('id', itemId)
                    .eq('list_id', currentListId);

                if (error) throw error;
                console.log(`Decremented quantity for item ID ${itemId} to ${newQuantity}`);
                loadShoppingList();
            } catch (error) {
                console.error("Error decrementing quantity:", error.message);
                alert("Error decrementing quantity: " + error.message);
            }
        } else {
            // If quantity is 1, treat as a delete operation
            deleteItem(event);
        }
    }


    // --- Suggestion Management ---
    async function loadSuggestions() {
        if (!currentListId) {
            suggestionsListDiv.innerHTML = '<p style="text-align: center; color: #C71585;">Connect to a list to see suggestions.</p>';
            return;
        }
        try {
            let query = supabase.from('suggestions').select('*').eq('list_id', currentListId).order('name', { ascending: true });

            const selectedCategory = categoryFilterSelect.value;
            if (selectedCategory && selectedCategory !== 'all') {
                query = query.eq('category', selectedCategory);
            }

            const { data: suggestions, error } = await query;

            if (error) throw error;

            renderSuggestions(suggestions);
        } catch (error) {
            console.error("Error loading suggestions:", error.message);
            suggestionsListDiv.innerHTML = `<p style="text-align: center; color: #FF0000;">Error loading suggestions: ${error.message}</p>`;
        }
    }

    function renderSuggestions(suggestions) {
        suggestionsListDiv.innerHTML = '';
        if (suggestions.length === 0) {
            suggestionsListDiv.innerHTML = '<p style="text-align: center;">No suggestions yet. Add some!</p>';
            return;
        }
        suggestions.forEach(suggestion => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('suggestion-item');
            itemDiv.dataset.id = suggestion.id;
            itemDiv.innerHTML = `
                <span class="suggestion-item-text">${suggestion.name} (${suggestion.category || 'Autres'})</span>
                <button class="delete-suggestion-btn" data-id="${suggestion.id}"><i class="fas fa-times-circle"></i></button>
            `;
            itemDiv.addEventListener('click', (e) => {
                // Only add to list if not clicking the delete button
                if (!e.target.closest('.delete-suggestion-btn')) {
                    newItemInput.value = suggestion.name;
                    document.getElementById('suggestionCategory').value = suggestion.category || getCategories()[0]; // Set category too
                    shoppingForm.dispatchEvent(new Event('submit')); // Programmatically submit the shopping form
                }
            });
            suggestionsListDiv.appendChild(itemDiv);
        });

        document.querySelectorAll('.delete-suggestion-btn').forEach(button => {
            button.addEventListener('click', deleteSuggestion);
        });
    }

    async function addSuggestion(event) {
        event.preventDefault();
        if (!currentListId) {
            alert("Please connect to or create a list first!");
            return;
        }

        const suggestionName = newSuggestionInput.value.trim();
        const category = suggestionCategorySelect.value;
        if (!suggestionName) return;

        try {
            // Check if suggestion already exists for the current list_id and name
            const { data: existingSuggestions, error: fetchError } = await supabase
                .from('suggestions')
                .select('id')
                .eq('list_id', currentListId)
                .eq('name', suggestionName);

            if (fetchError) throw fetchError;

            if (existingSuggestions && existingSuggestions.length > 0) {
                alert(`Suggestion "${suggestionName}" already exists!`);
                newSuggestionInput.value = '';
                return;
            }

            const { error } = await supabase
                .from('suggestions')
                .insert([{ name: suggestionName, list_id: currentListId, category: category }]);

            if (error) throw error;
            console.log(`Added new suggestion: ${suggestionName}`);
            newSuggestionInput.value = '';
            loadSuggestions(); // Reload suggestions list
        } catch (error) {
            console.error("Error adding suggestion:", error.message);
            alert("Error adding suggestion: " + error.message);
        }
    }

    async function deleteSuggestion(event) {
        event.stopPropagation(); // Prevent parent item's click event
        const suggestionId = event.currentTarget.dataset.id;
        try {
            const { error } = await supabase
                .from('suggestions')
                .delete()
                .eq('id', suggestionId)
                .eq('list_id', currentListId);

            if (error) throw error;
            console.log(`Deleted suggestion with ID: ${suggestionId}`);
            loadSuggestions();
        } catch (error) {
            console.error("Error deleting suggestion:", error.message);
            alert("Error deleting suggestion: " + error.message);
        }
    }

    async function removeSuggestion(itemName) {
        if (!currentListId) return; // Cannot remove if not connected

        try {
            const { error } = await supabase
                .from('suggestions')
                .delete()
                .eq('list_id', currentListId)
                .eq('name', itemName); // Delete by name for current list

            if (error && error.code !== '406' && !(error.code === 'PGRST400' && error.message.includes('406'))) {
                 // Ignore 406 (RLS policy) as it means "not found", but log other errors
                console.warn(`Could not remove suggestion "${itemName}" (it might not exist or RLS policy prevented it):`, error.message);
            } else if (!error) {
                console.log(`Removed suggestion: ${itemName}`);
                loadSuggestions(); // Reload suggestions list
            }
        } catch (error) {
            console.error("Unexpected error removing suggestion:", error.message);
        }
    }


    // --- Buy Later Management ---
    async function loadBuyLaterList() {
        if (!currentListId) {
            buyLaterListDiv.innerHTML = '<p style="text-align: center; color: #C71585;">Connect to a list to see "buy later" items.</p>';
            return;
        }
        try {
            const { data: items, error } = await supabase
                .from('buy_later_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: false });

            if (error) throw error;

            renderBuyLaterList(items);
        } catch (error) {
            console.error("Error loading 'buy later' list:", error.message);
            buyLaterListDiv.innerHTML = `<p style="text-align: center; color: #FF0000;">Error loading 'buy later' list: ${error.message}</p>`;
        }
    }

    function renderBuyLaterList(items) {
        buyLaterListDiv.innerHTML = '';
        if (items.length === 0) {
            buyLaterListDiv.innerHTML = '<p style="text-align: center;">No "buy later" items yet. Add some!</p>';
            return;
        }
        items.forEach(item => {
            const li = document.createElement('div');
            li.classList.add('buy-later-item');
            li.dataset.id = item.id;
            li.innerHTML = `
                <span>${item.name}</span>
                <button class="delete-btn" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
            `;
            buyLaterListDiv.appendChild(li);
        });

        document.querySelectorAll('#buyLaterList .delete-btn').forEach(button => {
            button.addEventListener('click', deleteBuyLaterItem);
        });
    }

    async function addBuyLaterItem(event) {
        event.preventDefault();
        if (!currentListId) {
            alert("Please connect to or create a list first!");
            return;
        }

        const itemName = newBuyLaterItemInput.value.trim();
        if (!itemName) return;

        try {
            const { error } = await supabase
                .from('buy_later_items')
                .insert([{ name: itemName, list_id: currentListId }]);

            if (error) throw error;
            console.log(`Added new 'buy later' item: ${itemName}`);
            newBuyLaterItemInput.value = '';
            loadBuyLaterList();
        } catch (error) {
            console.error("Error adding 'buy later' item:", error.message);
            alert("Error adding 'buy later' item: " + error.message);
        }
    }

    async function deleteBuyLaterItem(event) {
        const itemId = event.currentTarget.dataset.id;
        try {
            const { error } = await supabase
                .from('buy_later_items')
                .delete()
                .eq('id', itemId)
                .eq('list_id', currentListId);

            if (error) throw error;
            console.log(`Deleted 'buy later' item with ID: ${itemId}`);
            loadBuyLaterList();
        } catch (error) {
            console.error("Error deleting 'buy later' item:", error.message);
            alert("Error deleting 'buy later' item: " + error.message);
        }
    }


    // --- Category Management (Order and Add/Delete) ---
    async function addCategory(event) {
        event.preventDefault();
        const newCategoryName = newCategoryNameInput.value.trim();
        if (!newCategoryName) return;

        let categories = getCategories();
        if (categories.includes(newCategoryName)) {
            alert(`Category "${newCategoryName}" already exists!`);
            return;
        }
        categories.push(newCategoryName);
        saveCategories(categories);
        newCategoryNameInput.value = '';
        updateAllCategorySelects();
        loadCategoryOrder(); // Re-render both category lists
    }

    function deleteCategory(event) {
        const categoryToDelete = event.currentTarget.dataset.category;
        if (!confirm(`Are you sure you want to delete the category "${categoryToDelete}"? This will not delete items, but their category will revert to 'Autres'.`)) {
            return;
        }

        let categories = getCategories();
        categories = categories.filter(cat => cat !== categoryToDelete);
        saveCategories(categories);
        updateAllCategorySelects();
        loadCategoryOrder(); // Re-render both category lists
    }


    // --- Drag and Drop for Category Order ---
    let draggedItem = null;

    function addDragAndDropListeners() {
        const listItems = categoryOrderList.querySelectorAll('li');
        listItems.forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('dragleave', handleDragLeave);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragend', handleDragEnd);
        });
    }

    function handleDragStart(e) {
        draggedItem = this;
        setTimeout(() => this.classList.add('dragging'), 0);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragOver(e) {
        e.preventDefault(); // Necessary to allow drop
        if (this.classList.contains('dragging')) return; // Don't highlight self
        this.style.borderTop = '2px solid #DDA0DD'; // Indicate drop zone
    }

    function handleDragLeave() {
        this.style.borderTop = '';
    }

    function handleDrop(e) {
        e.preventDefault();
        this.style.borderTop = ''; // Remove highlight

        if (this === draggedItem) return;

        const allItems = Array.from(categoryOrderList.children);
        const draggedIndex = allItems.indexOf(draggedItem);
        const targetIndex = allItems.indexOf(this);

        if (draggedIndex < targetIndex) {
            this.after(draggedItem);
        } else {
            this.before(draggedItem);
        }

        saveNewCategoryOrder();
    }

    function handleDragEnd() {
        this.classList.remove('dragging');
        draggedItem = null;
        // Ensure all borders are reset
        categoryOrderList.querySelectorAll('li').forEach(item => {
            item.style.borderTop = '';
        });
    }

    function saveNewCategoryOrder() {
        const newOrder = Array.from(categoryOrderList.children).map(li => li.dataset.category);
        localStorage.setItem('category_order', JSON.stringify(newOrder));
        // Also update user_categories in localStorage to reflect new order for consistency
        saveCategories(newOrder);
        updateAllCategorySelects(); // Re-populate selects with new order
        loadShoppingList(); // Re-render shopping list with new category order
    }


    // --- Event Listeners ---
    // Navigation buttons
    showShoppingListBtn.addEventListener('click', () => showSection('shoppingListSection'));
    showSuggestionsBtn.addEventListener('click', () => showSection('suggestionsSection'));
    showCategoryOrderBtn.addEventListener('click', () => showSection('categoryOrderSection'));
    showBuyLaterBtn.addEventListener('click', () => showSection('buyLaterSection'));

    // Toggle options visibility
    toggleOptionsBtn.addEventListener('click', () => {
        if (navigationButtonsContainer.classList.contains('show-options')) {
            navigationButtonsContainer.classList.remove('show-options');
            toggleOptionsIcon.classList.remove('fa-chevron-up');
            toggleOptionsIcon.classList.add('fa-chevron-down');
            // If the current section is one of the hidden ones, switch to "My List"
            if (!shoppingListSection.classList.contains('active')) {
                showSection('shoppingListSection'); // Change to shoppingListSection
            }
        } else {
            navigationButtonsContainer.classList.add('show-options');
            toggleOptionsIcon.classList.remove('fa-chevron-down');
            toggleOptionsIcon.classList.add('fa-chevron-up');
        }
    });

    // Forms
    shoppingForm.addEventListener('submit', addItem);
    addSuggestionForm.addEventListener('submit', addSuggestion);
    buyLaterForm.addEventListener('submit', addBuyLaterItem);
    addCategoryForm.addEventListener('submit', addCategory);

    // Filter suggestions by category
    categoryFilterSelect.addEventListener('change', loadSuggestions);

    // Connect/Create List button
    connectListBtn.addEventListener('click', async () => {
        const code = shareCodeInput.value.trim();
        if (code) {
            await getOrCreateListByShareCode(code);
        } else {
            await getOrCreateListByShareCode(generateShareCode()); // Generate new if empty
        }
    });


    // --- Initialization on page load ---
    window.addEventListener('load', async () => {
        // Service Worker registration
        if ('serviceWorker' in navigator) {
            try {
                const reg = await navigator.serviceWorker.register('service-worker.js');
                console.log('Service Worker registered:', reg.scope);
            } catch (err) {
                console.error('SW error:', err);
            }
        }

        // Supabase client initialization
        console.log("Type of Supabase at initialization:", typeof Supabase); // AJOUTEZ CETTE LIGNE

        supabase = Supabase.createClient(supabaseUrl, supabaseKey);
        if (!supabase) {
            console.error("Erreur: Supabase n'a pas pu être initialisé. Vérifiez votre connexion Internet ou la configuration.");
            alert("Erreur: Impossible d'initialiser Supabase. Vérifiez votre connexion Internet ou la configuration.");
            return;
        }

        // Attendre que supabase.rest soit prêt
        let attempts = 0;
        const maxAttempts = 20; // Essayer jusqu'à 20 fois
        const delayMs = 50;     // Attendre 50ms entre chaque tentative

        while (!supabase.rest && attempts < maxAttempts) {
            console.log(`Attente de supabase.rest (tentative ${attempts + 1}/${maxAttempts})...`);
            await new Promise(resolve => setTimeout(resolve, delayMs));
            attempts++;
        }

        if (supabase.rest) {
            console.log("supabase.rest est maintenant prêt !");
            // Initialisation des données locales (categories, etc.)
            if (!localStorage.getItem('user_categories')) {
                localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
            }
            if (!localStorage.getItem('category_order')) {
                localStorage.setItem('category_order', JSON.stringify(getCategories()));
            }

            updateAllCategorySelects();
            loadCategoryOrder(); // Load category order and render lists

            // Prompt for share code as soon as the page loads, which will then load lists from Supabase
            await getOrCreateListByShareCode(generateShareCode()); // Directly connect/create on load

            showSection('shoppingListSection'); // Ensure initial section is shown
            // Ensure options are visible on initial load
            navigationButtonsContainer.classList.add('show-options');
            toggleOptionsIcon.classList.remove('fa-chevron-down');
            toggleOptionsIcon.classList.add('fa-chevron-up');
        } else {
            console.error("Erreur: supabase.rest n'est pas devenu prêt après plusieurs tentatives. Impossible de démarrer l'application.");
            alert("Erreur critique: La connexion à la base de données Supabase a échoué après plusieurs tentatives. Veuillez recharger la page ou vérifier votre connexion.");
        }
    });
  </script>
</body>
</html>