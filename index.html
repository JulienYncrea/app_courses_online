<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shopping List 🛒</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 1rem;
      padding-bottom: 70px; /* Initial space for the bottom menu */
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
      transition: padding-bottom 0.3s ease-out; /* Animation for padding */
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      cursor: pointer; /* Indicate clickable titles for scrolling */
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Updated shadow */
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: bold;
      color: #6A057F; /* Color from index copy */
    }
    input[type="text"], input[type="number"], select {
      width: 100%; /* Changed from calc(100% - 20px) for consistency with padding */
      padding: 0.7rem; /* Adjusted from 0.8rem */
      margin-top: 0.4rem; /* Adjusted from margin-bottom */
      border: 1px solid #DDA0DD; /* Color from index copy */
      border-radius: 0.5rem;
      box-sizing: border-box;
      color: #333;
      font-size: 1rem;
    }
    button {
      background: #FF69B4; /* From index copy */
      color: #FFFFFF; /* From index copy */
      font-weight: bold; /* From index copy */
      cursor: pointer;
      transition: all 0.3s ease; /* From index copy */
      border: none; /* From index copy */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* From index copy */
      width: 100%; /* Ensure full width for general buttons */
      padding: 0.7rem; /* From index copy */
      margin-top: 0.4rem; /* From index copy */
      border-radius: 0.5rem; /* From index copy */
    }
    button:hover {
      background: #C71585; /* From index copy */
      transform: translateY(-2px); /* From index copy */
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* From index copy */
    }
    select {
        background: #F8F8FF; /* From index copy */
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='%23C71585' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>"); /* From index copy */
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%;
        background-size: 0.65em auto;
        padding-right: 2.5em;
    }

    /* Styles for the shopping list items (adapting from index copy's .shopping-list-item) */
    #shoppingListToBuy li, #buyLaterList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFF0F5; /* From index copy */
      padding: 0.7rem 1.2rem; /* From index copy */
      margin-top: 0.7rem; /* From index copy */
      border-radius: 0.75rem; /* From index copy */
      font-size: 1.1rem; /* From index copy */
      color: #6A057F; /* From index copy */
      border: 1px solid #FFC0CB; /* From index copy */
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* From index copy */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      flex-wrap: nowrap; /* Prevent wrapping in main list items */
    }
    /* Adapting delete/decrement buttons from index copy */
    .quantity-control button { /* This will be the decrement/increment buttons */
        background: none; /* Changed from #ddd */
        border: none; /* Changed from none */
        color: #6A057F; /* Darker color for decrement, from index copy */
        font-size: 1.8rem; /* Slightly larger for visibility, from index copy */
        cursor: pointer;
        padding: 0 0.5rem; /* Adjusted padding */
        margin: 0;
        width: auto; /* Ensure auto width */
        height: auto; /* Ensure auto height */
        border-radius: 0; /* Remove round border */
        transition: color 0.3s ease;
    }
    .quantity-control button:hover {
        background-color: transparent; /* Ensure no background on hover */
        color: #8A2BE2; /* Change color on hover for decrement, from index copy */
    }
    .quantity-control span {
        font-weight: bold; /* From index copy */
        margin-left: 8px;
        margin-right: 8px;
        color: #FF8C00; /* From index copy */
        min-width: 20px;
        text-align: center;
    }

    .item-actions .remove-btn { /* This will be the main delete button for list items */
      background: none; /* Changed from #f44336 */
      border: none;
      color: #FF6347; /* From index copy */
      font-size: 1.6rem; /* From index copy */
      cursor: pointer;
      padding: 0 0.5rem;
      margin: 0;
      width: auto;
      height: auto;
      border-radius: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: color 0.3s ease;
      line-height: 1;
    }
    .item-actions .remove-btn:hover {
      background-color: transparent; /* Ensure no background on hover */
      color: #DC143C; /* From index copy */
    }
    .item-actions .remove-btn::before {
        content: "\f00d"; /* Font Awesome 'times' icon */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
    }
    .item-actions .remove-btn span {
        display: none; /* Hide original text */
    }

    .total-items {
        color: #C71585 !important; /* From index copy, specific style for empty text */
        font-style: italic; /* From index copy */
        font-size: 0.95rem; /* From index copy */
        text-align: center; /* From index copy, but keeping original for context */
        margin-top: 1rem;
        font-weight: bold; /* Keeping original for clarity */
    }

    /* Fixed bottom navigation (from index.html, retaining structure) */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #EE82EE; /* From index copy's navigation buttons */
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      transform: translateY(0);
      transition: transform 0.3s ease-out;
    }
    .bottom-nav.hidden-nav {
      transform: translateY(100%);
    }
    .nav-item {
      color: #FFFFFF; /* From index copy's navigation buttons */
      text-align: center;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .nav-item i {
      font-size: 1.5rem;
      margin-bottom: 0.2rem;
    }
    .nav-item.active {
      font-weight: bold;
      color: #FFD700; /* Active color from index copy's navigation buttons */
    }
    .toggle-nav-button {
      position: absolute;
      top: -20px;
      right: 20px;
      background-color: #9370DB; /* From index copy's toggle button */
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1001;
      transition: background-color 0.3s ease, transform 0.3s ease; /* Added transform for consistency */
    }
    .toggle-nav-button:hover {
        background-color: #8A2BE2; /* From index copy's toggle button hover */
        transform: translateY(-2px); /* Added for consistency */
    }
    .toggle-nav-button i {
      font-size: 1.2rem;
      transition: transform 0.3s ease; /* For icon rotation */
    }

    /* Style for hidden sections */
    .section.hidden {
      display: none;
    }

    /* Style for suggestion list items (adapting from index copy's .suggestion-item) */
    #suggestionList li {
      position: relative;
      background: #9370DB; /* From index copy */
      color: #FFFFFF; /* From index copy */
      padding: 0.6rem 1rem; /* From index copy */
      border-radius: 0.75rem; /* From index copy */
      text-align: left; /* Adjust from center for content */
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-right: 5px; /* From index copy */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* From index copy */
      margin-top: 0.7rem; /* Consistent spacing */
    }
    #suggestionList li:hover {
      background: #8A2BE2; /* From index copy */
      transform: translateY(-2px); /* From index copy */
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* From index copy */
    }
    #suggestionList .suggestion-info {
        flex-grow: 1;
        padding-right: 5px;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    #suggestionList .suggestion-info .name {
        font-weight: bold;
        color: #FFFFFF; /* Ensure visibility */
    }
    #suggestionList .suggestion-info .category {
        font-size: 0.85em;
        color: rgba(255, 255, 255, 0.8); /* Lighter color for category */
    }
    #suggestionList .suggestion-actions .remove-btn {
      background: none;
      border: none;
      color: #FFD700; /* From index copy */
      font-size: 1.3rem; /* From index copy */
      cursor: pointer;
      padding: 0 0.2rem;
      margin: 0;
      width: auto;
      height: auto;
      border-radius: 0;
      transition: color 0.3s ease;
      line-height: 1;
      flex-shrink: 0;
    }
    #suggestionList .suggestion-actions .remove-btn:hover {
      color: #FF4500; /* From index copy */
    }
    #suggestionList .suggestion-actions .remove-btn::before {
        content: "\f00d"; /* Font Awesome 'times' icon */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
    }
    #suggestionList .suggestion-actions .remove-btn span {
        display: none; /* Hide original text */
    }

    /* Styles for category list items (adapting from index copy's #categoryOrderList li) */
    #categoryList li, #categoryOrderList li {
        background: #F8F8FF; /* From index copy */
        border: 1px solid #DDA0DD; /* From index copy */
        padding: 0.75rem 1rem; /* From index copy */
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold; /* From index copy */
        color: #6A057F; /* From index copy */
        cursor: grab; /* From index copy */
        transition: background-color 0.2s ease, transform 0.2s ease; /* From index copy */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    #categoryList li:hover, #categoryOrderList li:hover {
        background-color: #E6E6FA; /* From index copy */
        transform: scale(1.01); /* From index copy */
    }
    #categoryOrderList li.dragging { /* From index copy */
        opacity: 0.7;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .drag-handle { /* From index copy */
        font-size: 1.5rem;
        cursor: grab;
        margin-right: 10px;
        color: #EE82EE;
    }
    #categoryList .remove-btn { /* Adapting delete button for categories */
        background: none;
        border: none;
        color: #FF6347; /* From index copy */
        font-size: 1.2rem; /* From index copy */
        cursor: pointer;
        padding: 0 0.2rem;
        margin-left: 10px;
        transition: color 0.3s ease;
        width: auto;
        height: auto;
        border-radius: 0;
    }
    #categoryList .remove-btn:hover {
        background-color: transparent;
        color: #DC143C; /* From index copy */
    }
    #categoryList .remove-btn::before {
        content: "\f00d"; /* Font Awesome 'times' icon */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
    }
    #categoryList .remove-btn span {
        display: none; /* Hide original text */
    }

    /* Styles for add forms */
    .add-form { /* New style based on index copy structure */
        margin-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
        padding-top: 1rem;
    }
    /* Apply add-form to specific elements */
    #addItemForm, #addBuyLaterItemForm, #addSuggestionForm, #addCategoryForm {
        margin-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
        padding-top: 1rem;
    }
    #addItemForm label, #addBuyLaterItemForm label, #addSuggestionForm label, #addCategoryForm label {
        display: block;
        margin-top: 0.75rem;
        font-weight: bold;
        color: #6A057F;
    }

    /* Style for empty list text (adapting existing .total-items style) */
    p.empty-list-message { /* New class for clear distinction */
        color: #C71585 !important;
        font-style: italic;
        font-size: 0.95rem;
        text-align: center;
        margin-top: 0.5rem;
    }

    /* Styles for section headers */
    .section-container h3 {
        color: #E75480; /* From index copy */
        border-bottom: 1px solid #FFD1DC; /* From index copy */
        padding-bottom: 0.3rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }

    @media (max-width: 640px) {
        .bottom-nav {
            padding: 0.5rem 0;
        }
        .nav-item {
            font-size: 0.7rem;
            padding: 0.3rem;
        }
        .nav-item i {
            font-size: 1.2rem;
        }
        .toggle-nav-button {
            width: 35px;
            height: 35px;
            top: -18px;
            right: 15px;
        }
        .toggle-nav-button i {
            font-size: 1rem;
        }
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.error('SW error:', err));
      });
    }
  </script>
</head>
<body>
  <div id="shoppingList" class="section-container section">
    <h1 id="shoppingListTitle">Ma Liste de Courses 🛒</h1>

    <ul id="shoppingListToBuy" class="item-list"></ul>
    <p class="total-items empty-list-message">Articles restants : <span id="totalRemainingItems">0</span></p>

    <div id="addItemForm" class="add-form">
        <h3>Ajouter un article</h3>
        <input type="text" id="newItemInput" placeholder="Ajouter un article" />
        <input type="number" id="newQuantityInput" placeholder="Quantité (optionnel)" value="1" min="1" />
        <select id="newCategorySelect"></select>
        <button id="addItemBtn">Ajouter à la liste</button>
    </div>
  </div>

  <div id="buyLater" class="section-container section hidden">
    <h2>Acheter Plus Tard 🛒</h2>
    <div id="addBuyLaterItemForm" class="add-form">
        <label for="newBuyLaterItemInput">Ajouter article à acheter plus tard:</label>
        <input type="text" id="newBuyLaterItemInput" placeholder="Article à acheter plus tard" />
        <button id="addBuyLaterItemBtn">Ajouter</button>
    </div>
    <ul id="buyLaterList"></ul>
  </div>

  <div id="suggestions" class="section-container section hidden">
    <h2 id="suggestionsTitle">Suggestions 💡</h2>
    <div class="filter-controls">
        <label for="suggestionCategoryFilter">Filtrer par catégorie:</label>
        <select id="suggestionCategoryFilter"></select>
    </div>
    <ul id="suggestionList"></ul>
    <div id="addSuggestionForm" class="add-form">
        <label for="newSuggestionInput">Ajouter une suggestion:</label>
        <input type="text" id="newSuggestionInput" placeholder="Suggérer un article" />
        <label for="newSuggestionCategorySelect">Catégorie:</label>
        <select id="newSuggestionCategorySelect"></select>
        <button id="addSuggestionBtn">Ajouter Suggestion</button>
    </div>
  </div>

  <div id="categories" class="section-container section hidden">
    <h2>Gérer les Catégories 📂</h2>
    <div id="addCategoryForm" class="add-form">
        <label for="newCategoryInput">Ajouter nouvelle catégorie:</label>
        <input type="text" id="newCategoryInput" placeholder="Nouvelle catégorie" />
        <button id="addCategoryBtn">Ajouter Catégorie</button>
    </div>
    <h3>Vos Catégories</h3>
    <ul id="categoryList"></ul>
    <h3>Ordre des Catégories</h3>
    <p class="empty-list-message">Faites glisser les catégories pour définir leur ordre.</p>
    <ul id="categoryOrderList" class="sortable-list"></ul>
    <button id="saveCategoryOrderBtn">Sauvegarder Ordre</button>
  </div>

  <div id="settings" class="section-container section hidden">
    <h2>Paramètres ⚙️</h2>
    <p>Code de la liste active : <strong id="activeShareCode">N/A</strong></p>
    <hr>
    <h3>Charger / Créer une liste</h3>
    <input type="text" id="shareCodeInput" placeholder="Entrez un code de partage" />
    <button id="loadShareCodeBtn">Charger/Créer Liste</button>
    <hr>
    <button id="changeShareCodeBtn">Changer de liste / Déconnecter</button>
  </div>


  <div class="bottom-nav">
    <button id="toggleNavBtn" class="toggle-nav-button">
      <i class="fas fa-chevron-down"></i> </button>
    <div class="nav-item active" id="navShoppingList">
      <i class="fas fa-shopping-basket"></i>
      <span>Ma Liste</span>
    </div>
    <div class="nav-item" id="navBuyLater">
      <i class="fas fa-clock"></i>
      <span>Plus Tard</span>
    </div>
    <div class="nav-item" id="navSuggestions">
      <i class="fas fa-lightbulb"></i>
      <span>Suggestions</span>
    </div>
    <div class="nav-item" id="navCategories">
      <i class="fas fa-folder"></i>
      <span>Catégories</span>
    </div>
    <div class="nav-item" id="navSettings">
      <i class="fas fa-cog"></i>
      <span>Paramètres</span>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Configuration Supabase ---
    const SUPABASE_URL = 'https://cepqcretnxfhjbvdukkk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU';

    let supabase = null; // Sera initialisé dans window.addEventListener('load')

    // --- Variables Globales ---
    let currentShareCode = null;
    let currentListId = null;
    const shoppingListToBuy = document.getElementById('shoppingListToBuy');
    const totalRemainingItemsSpan = document.getElementById('totalRemainingItems');
    const newItemInput = document.getElementById('newItemInput');
    const newQuantityInput = document.getElementById('newQuantityInput');
    const newCategorySelect = document.getElementById('newCategorySelect');
    const addItemBtn = document.getElementById('addItemBtn');
    const shoppingListTitle = document.getElementById('shoppingListTitle'); // Added for scroll

    // Moved to settings section
    const shareCodeInput = document.getElementById('shareCodeInput');
    const loadShareCodeBtn = document.getElementById('loadShareCodeBtn');
    const addItemForm = document.getElementById('addItemForm');

    // Sections
    const shoppingListSection = document.getElementById('shoppingList');
    const buyLaterSection = document.getElementById('buyLater');
    const suggestionsSection = document.getElementById('suggestions');
    const categoriesSection = document.getElementById('categories');
    const settingsSection = document.getElementById('settings');

    // Navigation
    const navShoppingList = document.getElementById('navShoppingList');
    const navBuyLater = document.getElementById('navBuyLater');
    const navSuggestions = document.getElementById('navSuggestions');
    const navCategories = document.getElementById('navCategories');
    const navSettings = document.getElementById('navSettings');
    const bottomNav = document.querySelector('.bottom-nav'); // Référence au menu du bas

    // Buy Later section elements
    const newBuyLaterItemInput = document.getElementById('newBuyLaterItemInput');
    const addBuyLaterItemBtn = document.getElementById('addBuyLaterItemBtn');
    const buyLaterList = document.getElementById('buyLaterList');

    // Suggestions section elements
    const suggestionsTitle = document.getElementById('suggestionsTitle'); // Added for scroll
    const suggestionCategoryFilter = document.getElementById('suggestionCategoryFilter'); // Nouveau filtre de catégorie
    const newSuggestionInput = document.getElementById('newSuggestionInput');
    const newSuggestionCategorySelect = document.getElementById('newSuggestionCategorySelect');
    const addSuggestionBtn = document.getElementById('addSuggestionBtn');
    const suggestionList = document.getElementById('suggestionList');

    // Categories section elements
    const newCategoryInput = document.getElementById('newCategoryInput');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoryList = document.getElementById('categoryList');
    const categoryOrderList = document.getElementById('categoryOrderList');
    const saveCategoryOrderBtn = document.getElementById('saveCategoryOrderBtn');

    // Settings section elements
    const activeShareCodeSpan = document.getElementById('activeShareCode');
    const changeShareCodeBtn = document.getElementById('changeShareCodeBtn');

    // Nouvelle variable pour le bouton de bascule
    const toggleNavBtn = document.getElementById('toggleNavBtn');


    // --- Catégories par défaut ---
    const initialDefaultCategories = [
        "Fruits et Légumes",
        "Produits Laitiers",
        "Viandes et Poissons",
        "Produits d'Épicerie",
        "Boulangerie",
        "Boissons",
        "Surgelés",
        "Entretien",
        "Hygiène",
        "Autres"
    ];

    // --- Fonctions utilitaires ---
    function generateShareCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    async function handleInitialLoad() {
        let shareCode = localStorage.getItem('lastShareCode');
        if (shareCode) {
            shareCodeInput.value = shareCode; // Set the input in settings
            await getOrCreateListByShareCode(shareCode);
            showSection('shoppingList'); // Show shopping list if connected
        } else {
            // If no share code, go to settings for the user to enter one
            showSection('settings');
            // Optionally, pre-fill with a generated code to suggest creation
            shareCodeInput.value = generateShareCode();
            alert("Bienvenue ! Veuillez entrer un code de partage ou cliquez sur 'Charger/Créer Liste' pour en générer un nouveau.");
        }
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');

        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.getElementById('nav' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1)).classList.add('active');

        // Spécifique pour la section settings
        if (sectionId === 'settings') {
            activeShareCodeSpan.textContent = currentShareCode || 'N/A';
        }
        // Charger les données spécifiques à la section si nécessaire
        if (sectionId === 'buyLater') {
            loadBuyLaterList();
        } else if (sectionId === 'suggestions') {
            updateSuggestionCategoryFilter(); // Mettre à jour le filtre de catégories
            loadSuggestions(); // Charger les suggestions après la mise à jour du filtre
        } else if (sectionId === 'categories') {
            renderCategories();
            loadCategoryOrder();
        }
    }

    // Nouvelle fonction pour basculer le menu du bas
    function toggleBottomNav() {
        const bottomNav = document.querySelector('.bottom-nav');
        const icon = toggleNavBtn.querySelector('i');

        if (bottomNav.classList.contains('hidden-nav')) {
            bottomNav.classList.remove('hidden-nav');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            bottomNav.classList.add('hidden-nav');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
        updateBodyPadding(); // Met à jour le padding du body après le basculement
    }

    // Nouvelle fonction pour ajuster le padding-bottom du body
    function updateBodyPadding() {
        const bottomNavHeight = bottomNav.offsetHeight;
        // The toggle button is outside the bottom-nav for fixed positioning.
        // We need to account for both the nav and the toggle button's height
        // to avoid content being hidden. Assuming toggle button is 40px height + 20px top margin from nav.
        const effectiveNavHeight = bottomNav.classList.contains('hidden-nav') ? 0 : bottomNavHeight;
        const toggleButtonHeight = bottomNav.classList.contains('hidden-nav') ? 40 : 0; // Only visible when nav is hidden

        document.body.style.paddingBottom = `${effectiveNavHeight + toggleButtonHeight + 20}px`;
    }


    function updateSupabaseHeaders(shareCode) {
        if (supabase && supabase.rest) {
            supabase.rest.headers['X-Share-Code'] = shareCode;
            console.log(`Supabase headers updated with X-Share-Code: ${shareCode}`);
        } else {
            console.warn("Supabase client non initialisé ou rest client non prêt, impossible de mettre à jour les headers.");
        }
    }

    function getCategories() {
        return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
        localStorage.setItem('user_categories', JSON.stringify(categories));
    }

    function updateAllCategorySelects() {
        const categories = getCategories();
        const selects = document.querySelectorAll('select#newCategorySelect, select#newSuggestionCategorySelect');
        selects.forEach(select => {
            select.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        });
        if (categories.length > 0) {
            newCategorySelect.value = categories[0];
            newSuggestionCategorySelect.value = categories[0];
        }
    }

    function updateSuggestionCategoryFilter() {
        const categories = getCategories();
        suggestionCategoryFilter.innerHTML = '';

        // Add "Toutes les catégories" option
        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'Toutes les catégories';
        suggestionCategoryFilter.appendChild(allOption);

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            suggestionCategoryFilter.appendChild(option);
        });
        suggestionCategoryFilter.value = 'all'; // Default to "All Categories"
    }

    // --- Fonctions Supabase ---

    async function getOrCreateListByShareCode(code) {
        updateSupabaseHeaders(code);

        try {
            const { data: lists, error: selectError } = await supabase
                .from('lists')
                .select('id, name')
                .eq('share_code', code);

            if (selectError && selectError.code !== '406') {
                if (selectError.code === 'PGRST400' && selectError.message.includes('406')) {
                } else {
                  throw selectError;
                }
            }

            if (lists && lists.length > 0) {
                console.log(`Liste trouvée pour le code ${code}:`, lists[0]);
                currentListId = lists[0].id;
                currentShareCode = code;
                localStorage.setItem('lastShareCode', shareCodeInput.value); // Save on successful load
                // addItemForm.classList.remove('hidden'); // No longer hidden by default for shoppingList section
                setupRealtimeListener(currentListId);
                loadShoppingList();
                activeShareCodeSpan.textContent = currentShareCode; // Met à jour l'affichage dans les paramètres
                return lists[0];
            } else {
                console.log(`Aucune liste trouvée pour le code ${code}. Création d'une nouvelle liste.`);
                const newList = {
                    name: `Liste ${code}`,
                    share_code: code
                };
                const { data: createdList, error: insertError } = await supabase
                    .from('lists')
                    .insert([newList])
                    .select('id, name');

                if (insertError) {
                    console.error("Erreur lors de la création de la liste:", insertError);
                    alert("Erreur lors de la création de la liste: " + insertError.message);
                    return null;
                } else {
                    console.log("Nouvelle liste créée:", createdList[0]);
                    currentListId = createdList[0].id;
                    currentShareCode = code;
                    localStorage.setItem('lastShareCode', shareCodeInput.value); // Save on successful creation
                    // addItemForm.classList.remove('hidden'); // No longer hidden by default for shoppingList section
                    setupRealtimeListener(currentListId);
                    loadShoppingList();
                    activeShareCodeSpan.textContent = currentShareCode; // Met à jour l'affichage dans les paramètres
                    return createdList[0];
                }
            }
        } catch (error) {
            console.error("Erreur inattendue dans getOrCreateListByShareCode:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
            return null;
        }
    }

    async function updateItemQuantity(itemId, newQuantity) {
        if (!currentListId) return;

        if (newQuantity <= 0) {
            // Si la quantité est 0 ou moins, supprimer l'article
            await deleteItem(itemId);
            return;
        }

        try {
            const { data, error } = await supabase
                .from('list_items')
                .update({ quantity: newQuantity })
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la mise à jour de la quantité de l'article:", error);
                alert("Erreur lors de la mise à jour de la quantité de l'article: " + error.message);
            }
            // La liste sera rechargée par le listener Realtime
        } catch (error) {
            console.error("Erreur inattendue lors de la mise à jour de la quantité:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function addItem(name, quantity, category, listId) {
        if (!listId) {
            alert("Veuillez charger ou créer une liste d'abord.");
            return;
        }
        try {
            // Check if item already exists in the current list
            const { data: existingItems, error: selectError } = await supabase
                .from('list_items')
                .select('id, quantity')
                .eq('list_id', listId)
                .eq('name', name)
                .eq('category', category); // Include category in check

            if (selectError) throw selectError;

            if (existingItems && existingItems.length > 0) {
                // Item exists, update its quantity
                const existingItem = existingItems[0];
                const newQuantity = existingItem.quantity + quantity;
                const { data, error: updateError } = await supabase
                    .from('list_items')
                    .update({ quantity: newQuantity })
                    .eq('id', existingItem.id);
                if (updateError) throw updateError;
                console.log(`Quantité de l'article '${name}' mise à jour à ${newQuantity}.`);
            } else {
                // Item does not exist, insert new
                const { data, error: insertError } = await supabase
                    .from('list_items')
                    .insert([{ name, quantity, category, list_id: listId }]);
                if (insertError) throw insertError;
                console.log(`Article '${name}' ajouté à la liste.`);
            }

            // Add category to local storage if it doesn't exist
            if (category) {
                const currentCategories = getCategories();
                if (!currentCategories.includes(category)) {
                    currentCategories.push(category);
                    saveCategories(currentCategories);
                    updateAllCategorySelects(); // Update category dropdowns
                    updateSuggestionCategoryFilter(); // Update filter dropdown
                    renderCategories(); // Re-render category list in 'Gérer les Catégories'
                    loadCategoryOrder(); // Update category order list
                }
            }

            newItemInput.value = '';
            newQuantityInput.value = '1';
        } catch (error) {
            console.error("Erreur lors de l'ajout/mise à jour de l'article:", error);
            alert("Erreur lors de l'ajout/mise à jour de l'article: " + error.message);
        }
    }

    async function deleteItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('list_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de l'article:", error);
                alert("Erreur lors de la suppression de l'article: " + error.message);
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadShoppingList() {
        if (!currentListId) {
            shoppingListToBuy.innerHTML = '<p class="empty-list-message">Votre liste est vide pour le moment !</p>';
            totalRemainingItemsSpan.textContent = '0';
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('list_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement de la liste de courses:", error);
                alert("Erreur lors du chargement de la liste: " + error.message);
                return;
            }

            shoppingListToBuy.innerHTML = '';
            let remainingItems = 0;

            if (items.length === 0) {
                shoppingListToBuy.innerHTML = '<p class="empty-list-message">Votre liste est vide pour le moment !</p>';
                totalRemainingItemsSpan.textContent = '0';
                return;
            }

            const categories = getCategories();
            const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || categories;

            const groupedItems = {};
            // Initialize groupedItems with all known categories in order
            categoryOrder.forEach(cat => groupedItems[cat] = []);
            // Add any existing categories from items that might not be in the current user_categories
            items.forEach(item => {
                const category = item.category || 'Autres';
                if (!groupedItems[category]) {
                    groupedItems[category] = [];
                }
            });

            items.forEach(item => {
                const category = item.category || 'Autres';
                groupedItems[category].push(item);
                remainingItems++; // All items are "remaining" now
            });

            // Render items for each category
            categoryOrder.forEach(category => {
                if (groupedItems[category] && groupedItems[category].length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    // Sort items alphabetically within each category
                    groupedItems[category].sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));
                    groupedItems[category].forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });
            // Handle items with categories not in the current category order (e.g., deleted categories)
            Object.keys(groupedItems).filter(cat => !categoryOrder.includes(cat)).forEach(category => {
                if (groupedItems[category].length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    // Sort items alphabetically within 'Autres' category
                    groupedItems[category].sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));
                    groupedItems[category].forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });

            totalRemainingItemsSpan.textContent = remainingItems;
        } catch (error) {
            console.error("Erreur inattendue lors du chargement de la liste de courses:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    function renderListItem(item, listElement) {
        const li = document.createElement('li');
        li.dataset.id = item.id;

        const itemInfo = document.createElement('div');
        itemInfo.classList.add('item-info');

        const itemName = document.createElement('span');
        itemName.textContent = item.name;
        itemInfo.appendChild(itemName);

        const quantityControl = document.createElement('div');
        quantityControl.classList.add('quantity-control');

        const minusBtn = document.createElement('button');
        minusBtn.textContent = '-';
        minusBtn.onclick = () => updateItemQuantity(item.id, item.quantity - 1);
        quantityControl.appendChild(minusBtn);

        const quantitySpan = document.createElement('span');
        quantitySpan.textContent = item.quantity;
        quantityControl.appendChild(quantitySpan);

        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.onclick = () => updateItemQuantity(item.id, item.quantity + 1);
        quantityControl.appendChild(plusBtn);

        itemInfo.appendChild(quantityControl);
        li.appendChild(itemInfo);

        const itemActions = document.createElement('div');
        itemActions.classList.add('item-actions');

        const removeBtn = document.createElement('button');
        removeBtn.classList.add('remove-btn');
        removeBtn.onclick = () => deleteItem(item.id);
        itemActions.appendChild(removeBtn);

        li.appendChild(itemActions);
        listElement.appendChild(li);
    }

    function setupRealtimeListener() {
      if (window.supabaseChannel) {
          supabase.removeChannel(window.supabaseChannel);
      }

      if (!currentListId) {
          console.warn("Pas de currentListId défini, impossible de configurer le listener Realtime.");
          return;
      }

      window.supabaseChannel = supabase.channel(`list_items_changes:${currentListId}`)
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'list_items',
            filter: `list_id=eq.${currentListId}`
        }, (payload) => {
            console.log('Changement Realtime détecté:', payload);
            loadShoppingList();
        })
        .subscribe();

        // Listener pour les changements sur buy_later_items
        window.supabaseBuyLaterChannel = supabase.channel(`buy_later_items_changes:${currentListId}`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'buy_later_items',
                filter: `list_id=eq.${currentListId}`
            }, (payload) => {
                console.log('Changement Buy Later Realtime détecté:', payload);
                if (document.getElementById('buyLater').classList.contains('hidden')) {
                  // Ne recharger que si la section est active pour éviter des appels inutiles
                } else {
                  loadBuyLaterList();
                }
            })
            .subscribe();

        // Listener pour les changements sur list_suggestions
        window.supabaseSuggestionsChannel = supabase.channel(`list_suggestions_changes:${currentListId}`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'list_suggestions',
                filter: `list_id=eq.${currentListId}`
            }, (payload) => {
                console.log('Changement Suggestions Realtime détecté:', payload);
                if (document.getElementById('suggestions').classList.contains('hidden')) {
                    // Ne recharger que si la section est active
                } else {
                    loadSuggestions();
                }
            })
            .subscribe();

      console.log(`Listeners Realtime configurés pour list_id: ${currentListId}`);
    }


    // --- Fonctions Buy Later ---
    async function addBuyLaterItem(name) {
        if (!currentListId) {
            alert("Veuillez charger ou créer une liste d'abord.");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .insert([{ name, list_id: currentListId }]);
            if (error) {
                console.error("Erreur lors de l'ajout de l'article 'Acheter Plus Tard':", error);
                alert("Erreur lors de l'ajout de l'article 'Acheter Plus Tard': " + error.message);
            } else {
                newBuyLaterItemInput.value = '';
                // loadBuyLaterList est géré par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de l'ajout de l'article 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function deleteBuyLaterItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de l'article 'Acheter Plus Tard':", error);
                alert("Erreur lors de la suppression de l'article 'Acheter Plus Tard': " + error.message);
            } else {
                // loadBuyLaterList est géré par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression d'article 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadBuyLaterList() {
        if (!currentListId) {
            buyLaterList.innerHTML = '<p class="empty-list-message">Votre liste "Acheter Plus Tard" est vide !</p>';
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('buy_later_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement de la liste 'Acheter Plus Tard':", error);
                alert("Erreur lors du chargement de la liste 'Acheter Plus Tard': " + error.message);
                return;
            }

            buyLaterList.innerHTML = '';
            if (items.length === 0) {
                buyLaterList.innerHTML = '<p class="empty-list-message">Votre liste "Acheter Plus Tard" est vide !</p>';
                return;
            }
            // Sort buy later items alphabetically
            items.sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));

            items.forEach(item => {
                const li = document.createElement('li');
                li.dataset.id = item.id;
                li.textContent = item.name;
                const removeBtn = document.createElement('button');
                removeBtn.classList.add('remove-btn');
                removeBtn.onclick = () => deleteBuyLaterItem(item.id);
                li.appendChild(removeBtn);
                buyLaterList.appendChild(li);
            });
        } catch (error) {
            console.error("Erreur inattendue lors du chargement de la liste 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    // --- Fonctions Suggestions ---
    async function addSuggestion(name, category) {
        if (!currentListId) {
            alert("Veuillez charger ou créer une liste d'abord.");
            return;
        }
        if (!name.trim() || !category) {
            alert("Veuillez entrer un nom et choisir une catégorie pour la suggestion.");
            return;
        }
        try {
            // Check for existing suggestion in the same list and category
            const { data: existingSuggestions, error: selectError } = await supabase
                .from('list_suggestions')
                .select('id')
                .eq('list_id', currentListId)
                .eq('name', name.trim())
                .eq('category', category);

            if (selectError) throw selectError;

            if (existingSuggestions && existingSuggestions.length > 0) {
                alert(`"${name.trim()}" est déjà une suggestion dans la catégorie "${category}" !`);
                return;
            }

            const { data, error } = await supabase
                .from('list_suggestions')
                .insert([{ name: name.trim(), category, list_id: currentListId }]);
            if (error) {
                console.error("Erreur lors de l'ajout de la suggestion:", error);
                alert("Erreur lors de l'ajout de la suggestion: " + error.message);
            } else {
                newSuggestionInput.value = '';
                // loadSuggestions géré par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de l'ajout de la suggestion:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function deleteSuggestion(suggestionId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('list_suggestions')
                .delete()
                .eq('id', suggestionId);
            if (error) {
                console.error("Erreur lors de la suppression de la suggestion:", error);
                alert("Erreur lors de la suppression de la suggestion: " + error.message);
            } else {
                // loadSuggestions géré par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression de la suggestion:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadSuggestions() {
        if (!currentListId) {
            suggestionList.innerHTML = '<p class="empty-list-message">Aucune suggestion disponible pour le moment.</p>';
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: suggestions, error } = await supabase
                .from('list_suggestions')
                .select('*')
                .eq('list_id', currentListId)
                .order('name', { ascending: true }); // Order by name

            if (error) {
                console.error("Erreur lors du chargement des suggestions:", error);
                alert("Erreur lors du chargement des suggestions: " + error.message);
                return;
            }

            suggestionList.innerHTML = '';
            
            const selectedCategory = suggestionCategoryFilter.value;
            let filteredSuggestions = selectedCategory === 'all'
                ? suggestions
                : suggestions.filter(sug => sug.category === selectedCategory);

            if (filteredSuggestions.length === 0) {
                suggestionList.innerHTML = '<p class="empty-list-message">Aucune suggestion pour cette catégorie. Ajoutez-en ci-dessous !</p>';
                return;
            }

            filteredSuggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.dataset.id = suggestion.id; // Store ID for deletion
                li.innerHTML = `
                    <div class="suggestion-info">
                        <span class="name">${suggestion.name}</span>
                        <span class="category">${suggestion.category}</span>
                    </div>
                    <div class="suggestion-actions">
                        <button class="add-to-shopping-list-btn" data-name="${suggestion.name}" data-category="${suggestion.category}">+</button>
                        <button class="remove-btn" data-id="${suggestion.id}">✖</button>
                    </div>
                `;
                // Add event listener to add to shopping list when clicking the item text
                li.querySelector('.suggestion-info').addEventListener('click', () => {
                    addItem(suggestion.name, 1, suggestion.category, currentListId);
                });
                // Add event listener for the "+" button
                li.querySelector('.add-to-shopping-list-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent li click from firing
                    addItem(suggestion.name, 1, suggestion.category, currentListId);
                });
                // Add event listener for the "✖" button
                li.querySelector('.remove-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent li click from firing
                    if (confirm(`Supprimer la suggestion "${suggestion.name}" (${suggestion.category})?`)) {
                        deleteSuggestion(suggestion.id);
                    }
                });
                suggestionList.appendChild(li);
            });
        } catch (error) {
            console.error("Erreur inattendue lors du chargement des suggestions:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    // --- Fonctions Catégories ---
    async function addCategory(categoryName) {
        if (!categoryName.trim()) {
            alert('Veuillez entrer un nom de catégorie.');
            return;
        }
        let categories = getCategories();
        if (categories.some(cat => cat.toLowerCase() === categoryName.trim().toLowerCase())) {
            alert(`La catégorie "${categoryName.trim()}" existe déjà !`);
            return;
        }
        categories.push(categoryName.trim());
        saveCategories(categories);
        newCategoryInput.value = '';
        updateAllCategorySelects();
        updateSuggestionCategoryFilter();
        renderCategories();
        loadCategoryOrder(); // Refresh the order list
    }

    function deleteCategory(categoryName) {
        if (!confirm(`Êtes-vous sûr de vouloir supprimer la catégorie "${categoryName}" ? Cela supprimera également toutes les suggestions liées à celle-ci.`)) {
            return;
        }
        let categories = getCategories();
        categories = categories.filter(cat => cat !== categoryName);
        saveCategories(categories);

        // Remove from local category order if present
        let currentOrder = JSON.parse(localStorage.getItem('category_order')) || [];
        currentOrder = currentOrder.filter(cat => cat !== categoryName);
        localStorage.setItem('category_order', JSON.stringify(currentOrder));

        // Logic to remove suggestions linked to this category from Supabase (or locally if not using DB for suggestions)
        // For now, assuming suggestions are managed via Supabase, you might need a server-side trigger
        // or a client-side deletion loop for suggestions if they are local:
        // let suggestions = JSON.parse(localStorage.getItem('shopping_suggestions')) || [];
        // suggestions = suggestions.filter(sug => sug.category !== categoryName);
        // localStorage.setItem('shopping_suggestions', JSON.stringify(suggestions));
        // loadSuggestions(); // Refresh suggestions list
        
        // If using Supabase for suggestions, you would need to delete them from the DB:
        if (currentListId) {
            supabase
                .from('list_suggestions')
                .delete()
                .eq('list_id', currentListId)
                .eq('category', categoryName)
                .then(({ error }) => {
                    if (error) {
                        console.error("Erreur lors de la suppression des suggestions liées:", error);
                    } else {
                        console.log(`Suggestions liées à la catégorie "${categoryName}" supprimées.`);
                        loadSuggestions(); // Refresh suggestions list
                    }
                });
        }
        
        updateAllCategorySelects();
        updateSuggestionCategoryFilter();
        renderCategories();
        loadCategoryOrder();
        loadShoppingList(); // Reload shopping list to reflect category changes
    }

    function renderCategories() {
        const categories = getCategories();
        categoryList.innerHTML = '';
        if (categories.length === 0) {
            categoryList.innerHTML = '<p class="empty-list-message">Aucune catégorie définie. Ajoutez-en ci-dessus !</p>';
            return;
        }
        categories.forEach(category => {
            const li = document.createElement('li');
            li.textContent = category;
            li.innerHTML = `
                <span>${category}</span>
                <button class="remove-btn" data-category="${category}">✖</button>
            `;
            li.querySelector('.remove-btn').addEventListener('click', (e) => {
                deleteCategory(e.target.dataset.category);
            });
            categoryList.appendChild(li);
        });
    }

    let draggingCategoryElement = null;

    function loadCategoryOrder() {
        let categories = getCategories();
        let currentOrder = JSON.parse(localStorage.getItem('category_order')) || [];

        // Ensure currentOrder only contains valid categories and adds new ones to the end
        const newOrder = categories.filter(cat => currentOrder.includes(cat));
        categories.forEach(cat => {
            if (!newOrder.includes(cat)) {
                newOrder.push(cat);
            }
        });
        localStorage.setItem('category_order', JSON.stringify(newOrder)); // Save reconciled order
        currentOrder = newOrder; // Use the reconciled order

        categoryOrderList.innerHTML = '';
        if (currentOrder.length === 0) {
            categoryOrderList.innerHTML = '<p class="empty-list-message">Faites glisser les catégories pour définir leur ordre.</p>';
            return;
        }

        currentOrder.forEach(category => {
            const li = document.createElement('li');
            li.textContent = category;
            li.draggable = true;
            li.classList.add('category-item'); // Add a class for styling/selection
            li.innerHTML = `<i class="fas fa-grip-vertical drag-handle"></i><span>${category}</span>`;
            categoryOrderList.appendChild(li);
        });
    }

    function saveCategoryOrder() {
        const items = Array.from(categoryOrderList.children);
        const newOrder = items.map(li => li.textContent.trim()); // Trim to remove potential handle text
        localStorage.setItem('category_order', JSON.stringify(newOrder));
        alert('Ordre des catégories sauvegardé !');
        loadShoppingList(); // Reload shopping list to apply new order
    }

    // --- Event Listeners ---
    addItemBtn.addEventListener('click', () => {
        const itemName = newItemInput.value;
        const quantity = parseInt(newQuantityInput.value) || 1;
        const category = newCategorySelect.value;
        addItem(itemName, quantity, category, currentListId);
    });

    addBuyLaterItemBtn.addEventListener('click', () => {
        addBuyLaterItem(newBuyLaterItemInput.value);
    });

    addSuggestionBtn.addEventListener('click', () => {
        addSuggestion(newSuggestionInput.value, newSuggestionCategorySelect.value);
    });

    addCategoryBtn.addEventListener('click', () => {
        addCategory(newCategoryInput.value);
    });

    saveCategoryOrderBtn.addEventListener('click', saveCategoryOrder);

    // Navigation button event listeners
    navShoppingList.addEventListener('click', () => showSection('shoppingList'));
    navBuyLater.addEventListener('click', () => showSection('buyLater'));
    navSuggestions.addEventListener('click', () => showSection('suggestions'));
    navCategories.addEventListener('click', () => showSection('categories'));
    navSettings.addEventListener('click', () => showSection('settings'));

    // Toggle nav button listener
    toggleNavBtn.addEventListener('click', toggleBottomNav);

    // Filter suggestions by category
    suggestionCategoryFilter.addEventListener('change', loadSuggestions);

    // Share code functionality
    loadShareCodeBtn.addEventListener('click', async () => {
        const code = shareCodeInput.value.trim().toUpperCase();
        if (code) {
            await getOrCreateListByShareCode(code);
            if (currentListId) { // If successfully connected/created
                showSection('shoppingList'); // Go to shopping list
            }
        } else {
            alert("Veuillez entrer un code de partage.");
        }
    });

    changeShareCodeBtn.addEventListener('click', () => {
        if (confirm("Voulez-vous vraiment changer de liste / vous déconnecter ? Cela effacera le code de partage actuel de cet appareil.")) {
            localStorage.removeItem('lastShareCode');
            currentListId = null;
            currentShareCode = null;
            if (window.supabaseChannel) {
                supabase.removeChannel(window.supabaseChannel);
                window.supabaseChannel = null;
            }
            if (window.supabaseBuyLaterChannel) {
                supabase.removeChannel(window.supabaseBuyLaterChannel);
                window.supabaseBuyLaterChannel = null;
            }
            if (window.supabaseSuggestionsChannel) {
                supabase.removeChannel(window.supabaseSuggestionsChannel);
                window.supabaseSuggestionsChannel = null;
            }
            // Clear current list display
            shoppingListToBuy.innerHTML = '<p class="empty-list-message">Votre liste est vide pour le moment !</p>';
            totalRemainingItemsSpan.textContent = '0';
            buyLaterList.innerHTML = '<p class="empty-list-message">Votre liste "Acheter Plus Tard" est vide !</p>';
            suggestionList.innerHTML = '<p class="empty-list-message">Aucune suggestion disponible pour le moment.</p>';
            categoryList.innerHTML = '<p class="empty-list-message">Aucune catégorie définie. Ajoutez-en ci-dessus !</p>';
            categoryOrderList.innerHTML = '<p class="empty-list-message">Faites glisser les catégories pour définir leur ordre.</p>';

            shareCodeInput.value = generateShareCode(); // Suggest a new code
            activeShareCodeSpan.textContent = 'N/A';
            showSection('settings');
            alert("Vous avez été déconnecté. Veuillez entrer un nouveau code de partage ou en créer un.");
        }
    });

    // Drag and Drop for Category Order
    categoryOrderList.addEventListener('dragstart', (e) => {
        draggingCategoryElement = e.target;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', draggingCategoryElement.innerHTML);
        e.target.classList.add('dragging');
    });

    categoryOrderList.addEventListener('dragover', (e) => {
        e.preventDefault(); // Necessary to allow dropping
        e.dataTransfer.dropEffect = 'move';
        const target = e.target.closest('li.category-item');
        if (target && target !== draggingCategoryElement) {
            const rect = target.getBoundingClientRect();
            const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > .5;
            categoryOrderList.insertBefore(draggingCategoryElement, next && target.nextSibling || target);
        }
    });

    categoryOrderList.addEventListener('dragend', (e) => {
        e.target.classList.remove('dragging');
        draggingCategoryElement = null;
        saveCategoryOrder(); // Save order immediately after drag
    });


    // --- Initialization on page load ---
    window.addEventListener('load', async () => {
      // Initialisation du client Supabase
      if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("Supabase client initialized successfully.");
      } else {
          console.error("Erreur: La fonction 'createClient' de Supabase n'est pas définie ou la bibliothèque Supabase n'est pas chargée correctement.");
          alert("Erreur de chargement: La bibliothèque Supabase n'a pas pu être initialisée. Vérifiez votre connexion internet ou la configuration.");
          return;
      }

      let attempts = 0;
      const maxAttempts = 20;
      const delayMs = 50;

      while (!supabase.rest && attempts < maxAttempts) {
          console.log(`Attente de supabase.rest (tentative ${attempts + 1}/${maxAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, delayMs));
          attempts++;
      }

      if (supabase.rest) {
          console.log("supabase.rest est maintenant prêt !");
          // Initialize categories if not present in local storage
          if (!localStorage.getItem('user_categories')) {
              localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
          }
          await handleInitialLoad(); // This will load data and set currentListId
          updateAllCategorySelects();
          updateSuggestionCategoryFilter();
          updateBodyPadding(); // Update body padding on initial load
          renderCategories(); // Initial rendering of categories list
          loadCategoryOrder(); // Initial load of category order list
      } else {
          console.error("Erreur: supabase.rest n'est pas devenu prêt après plusieurs tentatives. Impossible de démarrer l'application.");
          alert("Erreur de démarrage: Impossible d'initialiser la connexion à la base de données. Vérifiez votre connexion.");
          return;
      }
    });
  </script>
</body>
</html>