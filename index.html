<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>My Shopping List üõí</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />

  <meta name="theme-color" content="#fcf2f2" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fcf2f2;
      color: #333;
      transition: padding-bottom 0.3s ease-out; /* Animation for padding */
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      cursor: pointer; /* Indicate clickable titles for scrolling */
      -webkit-user-select: none; /* For WebKit browsers (Chrome, Safari) */
      -moz-user-select: none;    /* For Firefox */
      -ms-user-select: none;     /* For Internet Explorer/Edge */
      user-select: none;         /* Standard */
      cursor: pointer; 
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #fcf2f2;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: bold;
      color: #6A057F; /* Color from index copy */
    }
    input[type="text"], input[type="number"], select, textarea { /* Added textarea */
      width: 100%; /* Changed from calc(100% - 20px) for consistency with padding */
      padding: 0.7rem; /* Adjusted from 0.8rem */
      margin-top: 0.4rem; /* Adjusted from margin-bottom */
      border: 1px solid #DDA0DD; /* Color from index copy */
      border-radius: 0.5rem;
      box-sizing: border-box;
      color: #333;
      font-size: 1rem;
    }
    button {
      background: #FF69B4; /* From index copy */
      color: #FFFFFF; /* From index copy */
      font-weight: bold; /* From index copy */
      cursor: pointer;
      transition: all 0.3s ease; /* From index copy */
      border: none; /* From index copy */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* From index copy */
      width: 100%; /* Ensure full width for general buttons */
      padding: 0.7rem; /* From index copy */
      margin-top: 0.4rem; /* From index copy */
      border-radius: 0.5rem; /* From index copy */
    }
    button:hover {
      background: #C71585; /* From index copy */
      transform: translateY(-2px); /* From index copy */
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* From index copy */
    }
    select {
        background: #F8F8FF; /* From index copy */
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='%23C71585' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>"); /* From index copy */
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%;
        background-size: 0.65em auto;
        padding-right: 2.5em;
    }

    /* Reset UL padding for left alignment */
    #shoppingListToBuy, #buyLaterList, #suggestionList, #categoryList, #categoryOrderList, #savedMessagesList { /* Added #savedMessagesList */
      list-style: none; /* Remove default bullet points */
      padding-left: 0; /* Remove default browser padding */
      margin-left: 0; /* Ensure no margin is pushing it */
    }

    /* Styles for the shopping list items (adapting from index copy's .shopping-list-item) */
    #shoppingListToBuy li, #buyLaterList li { /* ADDED #buyLaterList li here */
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFF0F5; /* From index copy */
      padding: 0.7rem 1.2rem 0.7rem 0; /* Adjusted padding-left for alignment */
      margin-top: 0.7rem; /* From index copy */
      border-radius: 0.75rem; /* From index copy */
      font-size: 1.1rem; /* From index copy */
      color: #6A057F; /* From index copy */
      border: 1px solid #FFC0CB; /* From index copy */
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* From index copy */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      flex-wrap: nowrap; /* Prevent wrapping in main list items */
    
    }
    
    /* Adapting delete/decrement buttons from index copy */
    .quantity-control {
      display: flex;
      align-items: center;
      /* margin-right: 10px; Removed as it's part of flex-grow now */
      flex-shrink: 0; /* Prevent it from shrinking */
    }
    .quantity-control button { /* This will be the decrement/increment buttons */
        background: none; /* Changed from #ddd */
        border: 1px solid #DDA0DD; /* Added border */
        border-radius: 50%; /* Rounded borders */
        color: #6A057F; /* Darker color for decrement, from index copy */
        font-size: 1rem; /* Slightly larger for visibility, from index copy */
        cursor: pointer;
        padding: 0; /* Remove padding */
        margin: 0 2px; /* Adjusted margin */
        width: 30px; /* Fixed width for round button */
        height: 30px; /* Fixed height for round button */
        display: flex; /* For centering content */
        justify-content: center; /* For centering content */
        align-items: center; /* For centering content */
        transition: background-color 0.3s ease, color 0.3s ease, transform 0.3s ease;
    }
    .quantity-control button:hover {
        background-color: #E6E6FA; /* Ensure no background on hover */
        color: #8A2BE2; /* Change color on hover for decrement, from index copy */
        transform: scale(1.05);
    }
    .quantity-control span {
        font-weight: bold; /* From index copy */
        margin: 0 5px; /* Adjusted margin */
        color: #FF8C00; /* From index copy */
        min-width: 20px;
        text-align: center;
    }

    .item-actions .remove-btn { /* This will be the main delete button for list items */
      background: none; /* Changed from #f44336 */
      border: 1px solid #FF6347; /* Added border for round button */
      border-radius: 50%; /* Make it round */
      color: #FF6347; /* From index copy */
      font-size: 1.2rem; /* Adjusted for round button */
      cursor: pointer;
      padding: 0; /* Remove padding for round button */
      margin: 0;
      width: 30px; /* Fixed width for round button */
      height: 30px; /* Fixed height for round button */
      display: flex;
      justify-content: center;
      align-items: center;
      transition: color 0.3s ease, background-color 0.3s ease;
      line-height: 1;
    }
    .item-actions .remove-btn:hover {
      background-color: #ffe0e0; /* Light red background on hover */
      color: #DC143C; /* From index copy */
    }
    /* Updated to use <i> tag directly, removing ::before */
    .item-actions .remove-btn i {
        font-family: "Font Awesome 6 Free"; /* Ensure correct font-family for FA6 */
        font-weight: 900;
    }
    .item-actions .remove-btn span {
        display: none; /* Hide original text */
    }

    /* Fixed bottom navigation (from index.html, retaining structure) */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #EE82EE; /* From index copy's navigation buttons */
      display: flex;
      white-space: nowrap;
      justify-content: space-around;
      padding: 0.5rem 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      transform: translateY(0);
      transition: transform 0.3s ease-out;
    }
    .bottom-nav.hidden-nav {
      transform: translateY(100%);
    }
    .nav-item {
      color: #FFFFFF; /* From index copy's navigation buttons */
      text-align: center;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .nav-item i {
      font-size: 1.5rem;
      margin-bottom: 0.2rem;
    }
    .nav-item.active {
      font-weight: bold;
      color: #FFD700; /* Active color from index copy's navigation buttons */
    }
    .toggle-nav-button {
      position: absolute;
      top: -45px;
      right: 20px;
      background-color: #9370DB; /* From index copy's toggle button */
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1001;
      transition: background-color 0.3s ease, transform 0.3s ease; /* Added transform for consistency */
    }
    .toggle-nav-button:hover {
        background-color: #8A2BE2; /* From index copy's toggle button hover */
        transform: translateY(-2px); /* Added for consistency */
    }
    .toggle-nav-button i {
      font-size: 1.2rem;
      transition: transform 0.3s ease; /* For icon rotation */
    }

    /* Style for hidden sections */
    .section.hidden {
      display: none;
    }

    /* Style for suggestion list items (adapting from index copy's .suggestion-item) */
    #suggestionList li {
      position: relative;
      background: #F8F8FF; /* From index copy */
      border: 1px solid #DDA0DD;
      color: #6A057F; /* From index copy */
      padding: 0.6rem 1.2rem 0.6rem 0; /* Adjusted padding-left for alignment */
      border-radius: 0.75rem; /* From index copy */
      text-align: left; /* Adjust from center for content */
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease; /* Unified transition */
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-right: 5px; /* From index copy */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* From index copy */
      margin-top: 0.7rem; /* Consistent spacing */
    }
    #suggestionList li:hover {
      background: #E6E6FA; /* From index copy */
      transform: translateY(-2px); /* From index copy */
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* From index copy */
    }
    /* Only apply hover effect to the item info part for adding to list */
    #suggestionList li .suggestion-info:hover {
        background: none; /* Reset background if it was changed */
        cursor: pointer;
    }

    #suggestionList .suggestion-info {
        flex-grow: 1;
        padding-right: 5px;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap; /* Ensure text stays on one line */
        padding: 0.6rem 0; /* Add padding to make the clickable area larger */
        /* Updated for combined name and category on one line with ellipsis */
        display: flex; /* Use flex to align name and category */
        gap: 5px; /* Small gap between name and category */
        align-items: center;
        position: relative;
        top: 5px;
    }
    #suggestionList .suggestion-info .name {
        font-weight: bold;
        color: #6A057F; /* Ensure visibility */
        padding-left: 1.2rem;
        white-space: nowrap; /* Prevent name from wrapping */
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 1; /* Allow name to shrink if needed */
        min-width: 0; /* Important for flex items with overflow */
    }
    #suggestionList .suggestion-info .category {
        font-size: 0.85em;
        color: #C71585; /* Lighter color for category */
        white-space: nowrap; /* Prevent category from wrapping */
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 0; /* Prevent category from shrinking much initially */
    }
    /* Adjusted styles for the item name within #shoppingListToBuy and #buyLaterList */
    #shoppingListToBuy li .item-name, #buyLaterList li .item-name {
        flex-grow: 1; /* Allow the name to take up available space */
        padding-left: 10px; /* Space between quantity controls and name */
        white-space: normal; /* Allow text to wrap naturally if there are spaces */
        overflow-wrap: break-word; /* Break long words if necessary */
        word-break: break-word; /* Fallback for older browsers */
        min-width: 0; /* Ensure it can shrink in flex container */
        color: #6A057F; /* Set explicit color */
        font-weight: normal; /* Ensure it's not bold */
    }
    /* Removed add-to-shopping-list-btn styles as the button is removed from HTML */
    #suggestionList .suggestion-actions .remove-btn {
      background: none; /* Changed from #f44336 */
      border: 1px solid #FF6347; /* Added border for round button */
      border-radius: 50%; /* Make it round */
      color: #FF6347; /* From index copy */
      font-size: 1.2rem; /* Adjusted for round button */
      cursor: pointer;
      padding: 0; /* Remove padding for round button */
      margin: 0;
      width: 30px; /* Fixed width for round button */
      height: 30px; /* Fixed height for round button */
      display: flex;
      justify-content: center;
      align-items: center;
      transition: color 0.3s ease, background-color 0.3s ease;
      line-height: 1;
    }
    #suggestionList .suggestion-actions .remove-btn:hover {
      background-color: #ffe0e0; /* Light red background on hover */
      color: #DC143C; /* From index copy */
    }
    /* Updated to use <i> tag directly, removing ::before */
    #suggestionList .suggestion-actions .remove-btn i {
        font-family: "Font Awesome 6 Free"; /* Ensure correct font-family for FA6 */
        font-weight: 900;
    }
    #suggestionList .suggestion-actions .remove-btn span {
        display: none; /* Hide original text */
    }

    /* Styles for category list items (adapting from index copy's #categoryOrderList li) */
    #categoryList li, #categoryOrderList li {
        background: #F8F8FF; /* From index copy */
        border: 1px solid #DDA0DD; /* From index copy */
        padding: 0.75rem 1.2rem 0.75rem 0; /* Adjusted padding-left for alignment */
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        padding-left: 1.2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold; /* From index copy */
        color: #6A057F; /* From index copy */
        cursor: grab; /* From index copy */
        transition: background-color 0.2s ease, transform 0.2s ease; /* From index copy */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    #categoryList li:hover, #categoryOrderList li:hover {
        background-color: #E6E6FA; /* From index copy */
        transform: scale(1.01); /* From index copy */
    }
    #categoryOrderList li.dragging { /* From index copy */
        opacity: 0.7;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .drag-handle { /* From index copy */
        font-size: 1.5rem;
        cursor: grab;
        margin-right: 10px;
        color: #EE82EE;
    }
    #categoryList .remove-btn { /* Adapting delete button for categories */
        background: none;
        border: 1px solid #FF6347; /* Added border for round button */
        border-radius: 50%; /* Make it round */
        color: #FF6347; /* From index copy */
        font-size: 1.2rem; /* Adjusted for round button */
        cursor: pointer;
        padding: 0; /* Remove padding for round button */
        margin: 0;
        width: 30px; /* Fixed width for round button */
        height: 30px; /* Fixed height for round button */
        display: flex;
        justify-content: center;
        align-items: center;
        transition: color 0.3s ease, background-color 0.3s ease;
        line-height: 1;
    }
    #categoryList .remove-btn:hover {
        background-color: #ffe0e0; /* Light red background on hover */
        color: #DC143C; /* From index copy */
    }
    /* Updated to use <i> tag directly, removing ::before */
    #categoryList .remove-btn i {
        font-family: "Font Awesome 6 Free"; /* Ensure correct font-family for FA6 */
        font-weight: 900;
    }
    #categoryList .remove-btn span {
        display: none; /* Hide original text */
    }

    /* Styles for add forms */
    .add-form { /* New style based on index copy structure */
        margin-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
        padding-top: 1rem;
    }
    /* Apply add-form to specific elements */
    #addItemForm, #addBuyLaterItemForm, #addSuggestionForm, #addCategoryForm {
        margin-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
        padding-top: 1rem;
    }
    #addItemForm label, #addBuyLaterItemForm label, #addSuggestionForm label, #addCategoryForm label {
        display: block;
        margin-top: 0.75rem;
        font-weight: bold;
        color: #6A057F;
    }

    /* Style for empty list text (adapting existing .total-items style) */
    p.empty-list-message { /* New class for clear distinction */
        color: #C71585 !important;
        font-style: italic;
        font-size: 0.95rem;
        text-align: center;
        margin-top: 0.5rem;
    }

    /* Styles for section headers */
    .section-container h3 {
        color: #E75480; /* From index copy */
        border-bottom: 1px solid #FFD1DC; /* From index copy */
        padding-bottom: 0.3rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        padding-left: 0; /* Ensure alignment with list items */
    }

    /* Bell icon for notification trigger */
    #shoppingListTitle .notification-bell {
        margin-left: 10px;
        font-size: 1.2em;
        color: #E75480;
        cursor: pointer;
        transition: color 0.2s ease, transform 0.2s ease;
    }
    #shoppingListTitle .notification-bell:hover {
        color: #C71585;
        transform: scale(1.1);
    }

    /* Notification Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000; /* Above everything else */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: #fcf2f2;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 450px;
        position: relative;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }
    .modal-overlay.visible .modal-content {
        transform: translateY(0);
    }
    .modal-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #888;
        cursor: pointer;
    }
    .modal-close-btn:hover {
        color: #333;
    }
    .modal-content h3 {
        color: #E75480;
        text-align: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #FFD1DC;
        padding-bottom: 0.5rem;
    }
    .modal-content textarea {
        min-height: 80px;
        resize: vertical;
        margin-bottom: 1rem;
    }
    .modal-content .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 1rem;
    }
    .modal-content .modal-buttons button {
        flex-grow: 1;
    }
    #savedMessagesList li {
        background: #F8F8FF;
        border: 1px solid #DDA0DD;
        color: #6A057F;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
        word-break: break-word; /* Allow long messages to wrap */
        white-space: normal; /* Ensure text wraps */
    }
    #savedMessagesList li:hover {
        background: #E6E6FA;
    }
    #savedMessagesList .message-actions .remove-btn {
        background: none;
        border: 1px solid #FF6347;
        border-radius: 50%;
        color: #FF6347;
        font-size: 0.9rem; /* Smaller for saved messages */
        cursor: pointer;
        width: 25px;
        height: 25px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: color 0.3s ease, background-color 0.3s ease;
    }
    #savedMessagesList .message-actions .remove-btn:hover {
        background-color: #ffe0e0;
        color: #DC143C;
    }
    #savedMessagesList .message-text {
        flex-grow: 1;
        margin-right: 10px;
    }

    @media (max-width: 640px) {
        body {
            /* Try to reduce horizontal padding (0.5rem here) */
            padding: 0.2rem 0.2rem; /* For example, very little lateral padding */
        }
        .section-container {
            /* Same for the section container (0.75rem here) */
            padding: 0.2rem 0.3rem; /* For example, very little lateral padding */
        }
        h1, h2 {
            /* Ajustez cette valeur n√©gative pour remonter les titres. */
            /* Commencez avec une petite valeur comme -1rem et augmentez si n√©cessaire. */
            margin-top: -1.5rem; /* Exemple: remonte le titre de 1.5rem */
            /* Vous pouvez aussi ajuster les paddings si les pr√©c√©dents ajustements ne suffisent pas */
            padding-top: 0; /* Assurez-vous qu'il n'y a pas de padding sup√©rieur ind√©sirable sur les titres eux-m√™mes */
            /* Conservez vos autres styles de titres pour mobile */
            padding-bottom: 0.8rem;
            margin-bottom: 0.8rem;
            line-height: 1.5;
            font-size: 1.8rem;
        }
        .bottom-nav {
            padding: 0.5rem 0;
        }
        .nav-item {
            font-size: 0.9rem;
            padding: 0.5rem;
        }
        .nav-item i {
            font-size: 2rem;
        }
        .toggle-nav-button {
            width: 35px;
            height: 35px;
            top: -40px;
            right: 15px;
        }
        .toggle-nav-button i {
            font-size: 1rem;
        }
        .modal-content {
            padding: 1rem;
        }
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.error('SW error:', err));
      });
    }
  </script>
</head>
<body>
  <div id="shoppingList" class="section-container section">
    <h1 id="shoppingListTitle">My Shopping List üõí <i class="fas fa-bell notification-bell" id="notificationBell"></i></h1>

    <ul id="shoppingListToBuy" class="item-list"></ul>
    <div id="addItemForm" class="add-form">
        <h3>Add an item</h3>
        <input type="text" id="newItemInput" placeholder="Add an item" />
        <input type="number" id="newQuantityInput" placeholder="Quantity (optional)" value="1" min="1" />
        <select id="newCategorySelect"></select>
        <button id="addItemBtn">Add to list</button>
    </div>
  </div>

  <div id="buyLater" class="section-container section hidden">
    <h2>Buy Later üõí</h2>
    <div id="addBuyLaterItemForm" class="add-form">
        <label for="newBuyLaterItemInput">Add item to buy later:</label>
        <input type="text" id="newBuyLaterItemInput" placeholder="Item to buy later" />
        <button id="addBuyLaterItemBtn">Add</button>
    </div>
    <ul id="buyLaterList"></ul>
  </div>

  <div id="suggestions" class="section-container section hidden">
    <h2 id="suggestionsTitle">Suggestions üí°</h2>
    <div class="filter-controls">
        <label for="suggestionCategoryFilter">Filter by category:</label>
        <select id="suggestionCategoryFilter"></select>
    </div>
    <ul id="suggestionList"></ul>
    <div id="addSuggestionForm" class="add-form">
        <label for="newSuggestionInput">Add a suggestion:</label>
        <input type="text" id="newSuggestionInput" placeholder="Suggest an item" />
        <label for="newSuggestionCategorySelect">Category:</label>
        <select id="newSuggestionCategorySelect"></select>
        <button id="addSuggestionBtn">Add Suggestion</button>
    </div>
  </div>

  <div id="categories" class="section-container section hidden">
    <h2>Manage Categories üìÇ</h2>
    <div id="addCategoryForm" class="add-form">
        <label for="newCategoryInput">Add new category:</label>
        <input type="text" id="newCategoryInput" placeholder="New category" />
        <button id="addCategoryBtn">Add Category</button>
    </div>
    <h3>Your Categories</h3>
    <ul id="categoryList"></ul>
    <h3>Category Order</h3>
    <p class="empty-list-message">Drag categories to set their order.</p>
    <ul id="categoryOrderList" class="sortable-list"></ul>
    </div>

  <div id="settings" class="section-container section hidden">
    <h2>Settings ‚öôÔ∏è</h2>
    <p>Active list code: <strong id="activeShareCode">N/A</strong></p>
    <hr>
    <h3>Load / Create a List</h3>
    <input type="text" id="shareCodeInput" placeholder="Enter a share code" />
    <button id="loadShareCodeBtn">Load/Create List</button>
    <hr>
    <button id="changeShareCodeBtn">Change List / Disconnect</button>
  </div>

  <div id="notificationModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-btn" id="closeNotificationModalBtn">&times;</button>
      <h3>Send Notification</h3>
      <textarea id="notificationMessageInput" placeholder="Write your message here..."></textarea>
      <div class="modal-buttons">
        <button id="sendNotificationBtn">Send Notification</button>
        <button id="saveMessageBtn">Save Message</button>
      </div>

      <h4>Saved Messages</h4>
      <p id="emptySavedMessages" class="empty-list-message">No saved messages.</p>
      <ul id="savedMessagesList"></ul>
    </div>
  </div>


  <div class="bottom-nav">
    <button id="toggleNavBtn" class="toggle-nav-button">
      <i class="fas fa-chevron-down"></i> </button>
    <div class="nav-item active" id="navShoppingList">
      <i class="fas fa-shopping-basket"></i>
      <span>My List</span>
    </div>
    <div class="nav-item" id="navBuyLater">
      <i class="fas fa-clock"></i>
      <span>Later</span>
    </div>
    <div class="nav-item" id="navSuggestions">
      <i class="fas fa-lightbulb"></i>
      <span>Suggestions</span>
    </div>
    <div class="nav-item" id="navCategories">
      <i class="fas fa-folder"></i>
      <span>Categories</span>
    </div>
    <div class="nav-item" id="navSettings">
      <i class="fas fa-cog"></i>
      <span>Settings</span>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Supabase Configuration ---
    const SUPABASE_URL = 'https://cepqcretnxfhjbvdukkk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU'; // Replace with your actual anon key
    let supabase = null; // Will be initialized in window.addEventListener('load')

    // --- Global Variables ---
    let currentShareCode = null;
    let currentListId = null;
    const shoppingListToBuy = document.getElementById('shoppingListToBuy');
    const newItemInput = document.getElementById('newItemInput');
    const newQuantityInput = document.getElementById('newQuantityInput');
    const newCategorySelect = document.getElementById('newCategorySelect');
    const addItemBtn = document.getElementById('addItemBtn');
    const shoppingListTitle = document.getElementById('shoppingListTitle'); // Added for scroll

    // Moved to settings section
    const shareCodeInput = document.getElementById('shareCodeInput');
    const loadShareCodeBtn = document.getElementById('loadShareCodeBtn');
    const addItemForm = document.getElementById('addItemForm');

    // Sections
    const shoppingListSection = document.getElementById('shoppingList');
    const buyLaterSection = document.getElementById('buyLater');
    const suggestionsSection = document.getElementById('suggestions');
    const categoriesSection = document.getElementById('categories');
    const settingsSection = document.getElementById('settings');

    // Navigation
    const navShoppingList = document.getElementById('navShoppingList');
    const navBuyLater = document.getElementById('navBuyLater');
    const navSuggestions = document.getElementById('navSuggestions');
    const navCategories = document.getElementById('navCategories');
    const navSettings = document.getElementById('navSettings');
    const bottomNav = document.querySelector('.bottom-nav'); // Reference to the bottom menu

    // Buy Later section elements
    const newBuyLaterItemInput = document.getElementById('newBuyLaterItemInput');
    const addBuyLaterItemBtn = document.getElementById('addBuyLaterItemBtn');
    const buyLaterList = document.getElementById('buyLaterList');

    // Suggestions section elements
    const suggestionsTitle = document.getElementById('suggestionsTitle'); // Added for scroll
    const suggestionCategoryFilter = document.getElementById('suggestionCategoryFilter'); // New category filter
    const newSuggestionInput = document.getElementById('newSuggestionInput');
    const newSuggestionCategorySelect = document.getElementById('newSuggestionCategorySelect');
    const addSuggestionBtn = document.getElementById('addSuggestionBtn');
    const suggestionList = document.getElementById('suggestionList');

    // Categories section elements
    const newCategoryInput = document.getElementById('newCategoryInput');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoryList = document.getElementById('categoryList');
    const categoryOrderList = document.getElementById('categoryOrderList');

    // Settings section elements
    const activeShareCodeSpan = document.getElementById('activeShareCode');
    const changeShareCodeBtn = document.getElementById('changeShareCodeBtn');

    // New variable for the toggle button
    const toggleNavBtn = document.getElementById('toggleNavBtn');

    // Notification Modal Elements
    const notificationBell = document.getElementById('notificationBell');
    const notificationModal = document.getElementById('notificationModal');
    const closeNotificationModalBtn = document.getElementById('closeNotificationModalBtn');
    const notificationMessageInput = document.getElementById('notificationMessageInput');
    const sendNotificationBtn = document.getElementById('sendNotificationBtn');
    const saveMessageBtn = document.getElementById('saveMessageBtn');
    const savedMessagesList = document.getElementById('savedMessagesList');
    const emptySavedMessages = document.getElementById('emptySavedMessages');


    // --- Default Categories ---
    const initialDefaultCategories = [
        "Fruits et L√©gumes",
        "Produits Laitiers",
        "Viandes et Poissons",
        "Produits d'√âpicerie",
        "Boulangerie",
        "Boissons",
        "Surgel√©s",
        "Entretien",
        "Hygi√®ne",
        "Autres"
    ];
    async function subscribeUserToPush() {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            console.warn('Push messaging is not supported.');
            alert('Les notifications push ne sont pas prises en charge par ce navigateur.');
            return;
        }

        if (Notification.permission === 'denied') {
            alert('Les notifications sont bloqu√©es. Veuillez les autoriser dans les param√®tres de votre navigateur.');
            return;
        }

        try {
            const registration = await navigator.serviceWorker.ready;
            const existingSubscription = await registration.pushManager.getSubscription();

            if (existingSubscription) {
                console.log('Existing push subscription found:', existingSubscription);
                // Si l'abonnement existe d√©j√†, v√©rifiez s'il est dans la BDD.
                // Pour simplifier, nous allons juste le sauvegarder √† nouveau pour s'assurer
                // qu'il est associ√© √† la bonne list_id actuelle.
                // Dans une vraie app, vous pourriez d'abord v√©rifier sa pr√©sence avant de r√©ins√©rer.
                await saveSubscriptionToDatabase(existingSubscription);
                alert('Vous √™tes d√©j√† abonn√© aux notifications pour cette liste.');
                return;
            }

            // R√©cup√©rez votre cl√© publique VAPID depuis les variables d'environnement de votre fonction Edge
            // ou ins√©rez-la directement si vous la hardcodez.
            // Il est fortement recommand√© de la charger depuis une source s√©curis√©e.
            // Pour l'exemple, nous l'ins√©rons directement. REMPLACEZ PAR VOTRE VAPID_PUBLIC_KEY !
            const VAPID_PUBLIC_KEY = 'BC-_2wv1Kjqb8G575LuS7iuvgBSPrUqE7MIo-8aY8ro9CqMBVMMvJU0na3CAyO-EjJEnNG4nAiBxphlNcik_YYo'; // <-- REMPLACEZ CECI

            const convertedVapidKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
            
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: convertedVapidKey
            });

            console.log('New push subscription:', subscription);
            await saveSubscriptionToDatabase(subscription);
            alert('Abonnement aux notifications r√©ussi !');

        } catch (err) {
            console.error('Failed to subscribe the user:', err);
            alert('√âchec de l\'abonnement aux notifications.');
        }
    }

    // Fonction utilitaire pour convertir la cl√© VAPID
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
    function arrayBufferToBase64(buffer) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
        }
    // Fonction pour sauvegarder l'abonnement dans la base de donn√©es Supabase
    async function saveSubscriptionToDatabase(subscription) {
        if (!currentListId) {
            console.error('No currentListId defined. Cannot save subscription.');
            alert('Veuillez charger ou cr√©er une liste dans les param√®tres avant de vous abonner aux notifications.');
            return;
        }

        // R√©cup√©rer p256dh et auth via getKey() et les convertir en Base64
        const p256dh = arrayBufferToBase64(subscription.getKey('p256dh'));
        const auth = arrayBufferToBase64(subscription.getKey('auth'));

        const { data, error } = await supabase
            .from('subscriptions')
            .insert([
                {
                    list_id: currentListId,
                    endpoint: subscription.endpoint,
                    p256dh: p256dh,
                    auth: auth
                }
            ])
            .select();

        if (error) {
            console.error('Error saving subscription:', error.message);
            alert('Erreur lors de l\'enregistrement de l\'abonnement : ' + error.message);
        } else {
            console.log('Subscription saved:', data);
        }
    }

    // --- √âcouteur d'√©v√©nements pour la cloche de notification ---
    notificationBell.addEventListener('click', async () => {
        // Appeler la fonction d'abonnement ici
        await subscribeUserToPush();
        // Optionnellement, vous pouvez ensuite ouvrir le modal d'envoi si l'abonnement est r√©ussi
        // openNotificationModal(); 
    });
    // --- Utility Functions ---
    function generateShareCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    async function handleInitialLoad() {
        let shareCode = localStorage.getItem('lastShareCode');
        if (shareCode) {
            shareCodeInput.value = shareCode; // Set the input in settings
            await getOrCreateListByShareCode(shareCode);
            showSection('shoppingList'); // Show shopping list if connected
        } else {
            // If no share code, go to settings for the user to enter one
            showSection('settings');
            // Optionally, pre-fill with a generated code to suggest creation
            shareCodeInput.value = generateShareCode();
            alert("Welcome! Please enter a share code or click 'Load/Create List' to generate a new one.");
        }
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');

        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.getElementById('nav' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1)).classList.add('active');

        // Specific for the settings section
        if (sectionId === 'settings') {
            activeShareCodeSpan.textContent = currentShareCode || 'N/A';
        }
        // Load section-specific data if necessary
        if (sectionId === 'buyLater') {
            loadBuyLaterList();
        } else if (sectionId === 'suggestions') {
            updateSuggestionCategoryFilter(); // Update category filter
            loadSuggestions(); // Load suggestions after filter update
        } else if (sectionId === 'categories') {
            renderCategories();
            loadCategoryOrder();
        }
    }

    // New function to toggle the bottom navigation
    function toggleBottomNav() {
        const bottomNav = document.querySelector('.bottom-nav');
        const icon = toggleNavBtn.querySelector('i');

        if (bottomNav.classList.contains('hidden-nav')) {
            bottomNav.classList.remove('hidden-nav');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            bottomNav.classList.add('hidden-nav');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
        updateBodyPadding(); // Update body padding after toggle
    }

    // New function to adjust body padding-bottom
    function updateBodyPadding() {
        const bottomNavHeight = bottomNav.offsetHeight;
        // The toggle button is outside the bottom-nav for fixed positioning.
        // We need to account for both the nav and the toggle button's height
        // to avoid content being hidden. Assuming toggle button is 40px height + 20px top margin from nav.
        const effectiveNavHeight = bottomNav.classList.contains('hidden-nav') ? 0 : bottomNavHeight;
        const toggleButtonHeight = bottomNav.classList.contains('hidden-nav') ? 40 : 0; // Only visible when nav is hidden

        document.body.style.paddingBottom = `${effectiveNavHeight + toggleButtonHeight + 20}px`;
    }


    function updateSupabaseHeaders(shareCode) {
        if (supabase && supabase.rest) {
            supabase.rest.headers['X-Share-Code'] = shareCode;
            console.log(`Supabase headers updated with X-Share-Code: ${shareCode}`);
        } else {
            console.warn("Supabase client not initialized or rest client not ready, cannot update headers.");
        }
    }

    function getCategories() {
        return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
        localStorage.setItem('user_categories', JSON.stringify(categories));
    }

    function updateAllCategorySelects() {
        const categories = getCategories();
        const selects = document.querySelectorAll('select#newCategorySelect, select#newSuggestionCategorySelect');
        selects.forEach(select => {
            select.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        });
        if (categories.length > 0) {
            newCategorySelect.value = categories[0];
            newSuggestionCategorySelect.value = categories[0];
        }
    }

    function updateSuggestionCategoryFilter() {
        const categories = getCategories();
        suggestionCategoryFilter.innerHTML = '';

        // Add "All categories" option
        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'All categories';
        suggestionCategoryFilter.appendChild(allOption);

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            suggestionCategoryFilter.appendChild(option);
        });
        suggestionCategoryFilter.value = 'all'; // Default to "All Categories"
    }

    // --- Supabase Functions ---

    async function getOrCreateListByShareCode(code) {
        updateSupabaseHeaders(code);

        try {
            const { data: lists, error: selectError } = await supabase
                .from('lists')
                .select('id, name')
                .eq('share_code', code);

            if (selectError && selectError.code !== '406') {
                if (selectError.code === 'PGRST400' && selectError.message.includes('406')) {
                } else {
                  throw selectError;
                }
            }

            if (lists && lists.length > 0) {
                console.log(`List found for code ${code}:`, lists[0]);
                currentListId = lists[0].id;
                console.log(currentListId)
                currentShareCode = code;
                localStorage.setItem('lastShareCode', shareCodeInput.value); // Save on successful load
                setupRealtimeListener(currentListId);
                loadShoppingList();
                activeShareCodeSpan.textContent = currentShareCode; // Update display in settings
                return lists[0];
            } else {
                console.log(`No list found for code ${code}. Creating a new list.`);
                const newList = {
                    name: `List ${code}`,
                    share_code: code
                };
                const { data: createdList, error: insertError } = await supabase
                    .from('lists')
                    .insert([newList])
                    .select('id, name');

                if (insertError) {
                    console.error("Error creating list:", insertError);
                    alert("Error creating list: " + insertError.message);
                    return null;
                } else {
                    console.log("New list created:", createdList[0]);
                    currentListId = createdList[0].id;
                    currentShareCode = code;
                    localStorage.setItem('lastShareCode', shareCodeInput.value); // Save on successful creation
                    setupRealtimeListener(currentListId);
                    loadShoppingList();
                    activeShareCodeSpan.textContent = currentShareCode; // Update display in settings
                    return createdList[0];
                }
            }
        } catch (error) {
            console.error("Unexpected error in getOrCreateListByShareCode:", error);
            alert("An unexpected error occurred: " + error.message);
            return null;
        }
    }

    async function updateItemQuantity(itemId, newQuantity) {
        if (!currentListId) return;

        const listItemElement = document.querySelector(`#shoppingListToBuy li[data-id="${itemId}"]`);
        const quantitySpan = listItemElement ? listItemElement.querySelector('.quantity-control span') : null;

        // Update the data-quantity attribute on the <li>
        if (listItemElement) {
            listItemElement.dataset.quantity = newQuantity.toString(); // Update the "source of truth" value
        }

        // Optimistically update the textual display (can be slower or ignored if loadShoppingList is called)
        if (quantitySpan) {
            quantitySpan.textContent = `${newQuantity}x`;
        }

        if (newQuantity <= 0) {
            try {
                await deleteItem(itemId);
            } catch (error) {
                console.error("Error deleting item:", error);
                alert("Error deleting item: " + error.message);
                loadShoppingList(); // Reload to ensure consistency if error
            }
            return;
        }

        try {
            const { data, error } = await supabase
                .from('list_items')
                .update({ quantity: newQuantity })
                .eq('id', itemId);
            if (error) {
                console.error("Error updating quantity:", error);
                alert("Error updating item quantity: " + error.message);
                loadShoppingList(); // <-- ESSENTIAL: Reload list in case of error
            } else {
                // loadShoppingList(); // Realtime listener handles this
            }
        } catch (error) {
            console.error("Unexpected error updating quantity:", error);
            alert("An unexpected error occurred: " + error.message);
            loadShoppingList(); // Reload list in case of unexpected error
        }
    }

    async function addItem(name, quantity, category, listId) {
        if (!listId) {
            alert("Please load or create a list first.");
            return;
        }
        try {
            const { data: existingItems, error: selectError } = await supabase
                .from('list_items')
                .select('id, quantity')
                .eq('list_id', listId)
                .eq('name', name)
                .eq('category', category); // Include category in check

            if (selectError) throw selectError;

            if (existingItems && existingItems.length > 0) {
                // Item exists, update its quantity
                const existingItem = existingItems[0];
                const newQuantity = existingItem.quantity + quantity;
                const { data, error: updateError } = await supabase
                    .from('list_items')
                    .update({ quantity: newQuantity })
                    .eq('id', existingItem.id);
                if (updateError) throw updateError;
                console.log(`Quantity of item '${name}' updated to ${newQuantity}.`);
            } else {
                // Item does not exist, insert new
                const { data, error: insertError } = await supabase
                    .from('list_items')
                    .insert([{ name, quantity, category, list_id: listId }]);
                if (insertError) throw insertError;
                console.log(`Item '${name}' added to list.`);
            }

            // Add category to local storage if it doesn't exist
            if (category) {
                const currentCategories = getCategories();
                if (!currentCategories.includes(category)) {
                    currentCategories.push(category);
                    saveCategories(currentCategories);
                    updateAllCategorySelects(); // Update category dropdowns
                    updateSuggestionCategoryFilter(); // Update filter dropdown
                    renderCategories(); // Re-render category list in 'Manage Categories'
                    loadCategoryOrder(); // Update category order list
                }
            }

            newItemInput.value = '';
            newQuantityInput.value = '1';
        } catch (error) {
            console.error("Error adding/updating item:", error);
            alert("Error adding/updating item: " + error.message);
        }
    }

    async function deleteItem(itemId) {
        if (!currentListId) return;

        // Optimistic UI update: Remove the item from the DOM immediately
        const listItemElement = document.querySelector(`#shoppingListToBuy li[data-id="${itemId}"]`);
        if (listItemElement) {
            listItemElement.remove();
        }

        try {
            const { data, error } = await supabase
                .from('list_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Error deleting item:", error);
                alert("Error deleting item: " + error.message);
                loadShoppingList(); // If there's an error, reload the list to re-add the item if deletion failed on backend
            } else {
                console.log(`Item with ID ${itemId} deleted.`);
                // No need to call loadShoppingList() here, as the Realtime listener for 'DELETE' will handle updates for other clients.
                // For the current client, the item is already optimistically removed.
            }
        } catch (error) {
            console.error("Unexpected error during deletion:", error);
            alert("An unexpected error occurred: " + error.message);
            loadShoppingList(); // Reload in case of unexpected JS error
        }
    }

    async function loadShoppingList() {
        if (!currentListId) {
            shoppingListToBuy.innerHTML = '<p class="empty-list-message">Your list is empty for now!</p>';
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('list_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Error loading shopping list:", error);
                alert("Error loading list: " + error.message);
                return;
            }

            shoppingListToBuy.innerHTML = '';

            if (items.length === 0) {
                shoppingListToBuy.innerHTML = '<p class="empty-list-message">Your list is empty for now!</p>';
                return;
            }

            const categories = getCategories();
            const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || categories;

            const groupedItems = {};
            // Initialize groupedItems with all known categories in order
            categoryOrder.forEach(cat => groupedItems[cat] = []);
            // Add any existing categories from items that might not be in the current user_categories
            items.forEach(item => {
                const category = item.category || 'Autres'; // Default to "Others" if category is null/empty
                if (!groupedItems[category]) {
                    groupedItems[category] = [];
                }
            });

            items.forEach(item => {
                const category = item.category || 'Autres'; // Default to "Others"
                groupedItems[category].push(item);
            });

            // Render items for each category
            categoryOrder.forEach(category => {
                if (groupedItems[category] && groupedItems[category].length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    // Sort items alphabetically within each category
                    groupedItems[category].sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));
                    groupedItems[category].forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });
            // Handle items with categories not in the current category order (e.g., deleted categories)
            Object.keys(groupedItems).filter(cat => !categoryOrder.includes(cat)).forEach(category => {
                if (groupedItems[category].length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    // Sort items alphabetically within this category
                    groupedItems[category].sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));
                    groupedItems[category].forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });

        } catch (error) {
            console.error("Unexpected error loading shopping list:", error);
            alert("An unexpected error occurred: " + error.message);
        }
    }

    function renderListItem(item, listElement) {
        const li = document.createElement('li');
        li.dataset.id = item.id;

        // Check if it's a shopping list item (has quantity controls) or a buy later item
        const isShoppingListItem = listElement === shoppingListToBuy;

        if (isShoppingListItem) {
            // Container for quantity and item name
            const quantityAndNameContainer = document.createElement('div');
            quantityAndNameContainer.style.display = 'flex'; // Use flexbox
            quantityAndNameContainer.style.alignItems = 'center';
            quantityAndNameContainer.style.flexGrow = '1'; // Allow it to take available space

            const quantityControl = document.createElement('div');
            quantityControl.classList.add('quantity-control');
            quantityControl.style.display = 'flex'; // Ensure buttons are inline
            quantityControl.style.alignItems = 'center';

            const minusBtn = document.createElement('button');
            minusBtn.textContent = '-';
            minusBtn.onclick = () => {
                const currentDisplayedQuantity = parseInt(quantitySpan.textContent.replace('x', ''));
                updateItemQuantity(item.id, currentDisplayedQuantity - 1);
            };
            quantityControl.appendChild(minusBtn);

            const quantitySpan = document.createElement('span');
            quantitySpan.textContent = `${item.quantity}x`; // Add 'x' here
            quantityControl.appendChild(quantitySpan);

            const plusBtn = document.createElement('button');
            plusBtn.textContent = '+';
            plusBtn.onclick = () => {
                const currentDisplayedQuantity = parseInt(quantitySpan.textContent.replace('x', ''));
                updateItemQuantity(item.id, currentDisplayedQuantity + 1);
            };
            quantityControl.appendChild(plusBtn);

            // Add quantity controls to the container
            quantityAndNameContainer.appendChild(quantityControl);

            // Create a span for the item name, applying the new CSS class
            const itemName = document.createElement('span');
            itemName.classList.add('item-name'); /* Add this class */
            itemName.textContent = item.name;
            quantityAndNameContainer.appendChild(itemName);

            li.appendChild(quantityAndNameContainer); // Add the main container
        } else { // For buyLaterList
            const itemName = document.createElement('span');
            itemName.classList.add('item-name'); /* Add this class for consistency */
            itemName.textContent = item.name;
            itemName.style.paddingLeft = '1.2rem'; /* Match li padding-left */
            itemName.style.flexGrow = '1'; /* Allow name to take available space */
            li.appendChild(itemName);
        }


        const itemActions = document.createElement('div');
        itemActions.classList.add('item-actions');

        const removeBtn = document.createElement('button');
        removeBtn.classList.add('remove-btn');
        // Use Font Awesome cross icon directly
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        if (isShoppingListItem) {
            removeBtn.onclick = () => deleteItem(item.id);
        } else { // For buyLaterList
            removeBtn.onclick = () => deleteBuyLaterItem(item.id);
        }

        itemActions.appendChild(removeBtn);

        li.appendChild(itemActions);
        listElement.appendChild(li);
    }


    function setupRealtimeListener() {
      if (window.supabaseChannel) {
          supabase.removeChannel(window.supabaseChannel);
      }

      if (!currentListId) {
          console.warn("No currentListId defined, cannot set up Realtime listener.");
          return;
      }

      window.supabaseChannel = supabase.channel(`list_items_changes:${currentListId}`)
        .on('postgres_changes', {
            event: 'UPDATE', // Listen specifically for UPDATEs
            schema: 'public',
            table: 'list_items',
            filter: `list_id=eq.${currentListId}`
        }, (payload) => {
            console.log('Realtime UPDATE detected:', payload);
            const updatedItem = payload.new;
            const listItemElement = document.querySelector(`#shoppingListToBuy li[data-id="${updatedItem.id}"]`);
            if (listItemElement) {
                const quantitySpan = listItemElement.querySelector('.quantity-control span');
                if (quantitySpan) {
                    quantitySpan.textContent = `${updatedItem.quantity}x`;
                }
            } else {
                // Fallback: If for some reason the element is not found, reload the whole list
                loadShoppingList();
            }
        })
        .on('postgres_changes', {
            event: 'INSERT', // Listen specifically for INSERTs
            schema: 'public',
            table: 'list_items',
            filter: `list_id=eq.${currentListId}`
        }, (payload) => {
            console.log('Realtime INSERT detected:', payload);
            loadShoppingList(); // Reload entire list to handle adding in the correct category/order
        })
        .on('postgres_changes', {
            event: 'DELETE', // Listen specifically for DELETEs
            schema: 'public',
            table: 'list_items',
            filter: `list_id=eq.${currentListId}`
        }, (payload) => {
            console.log('Realtime DELETE detected:', payload);
            // The optimistic UI update for delete is handled in deleteItem() itself.
            // This reload is a fallback for other clients or robustness.
            loadShoppingList(); // Reload list to re-evaluate empty message and categories
        })
        .subscribe();

        // Listener for changes on buy_later_items
        window.supabaseBuyLaterChannel = supabase.channel(`buy_later_items_changes:${currentListId}`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'buy_later_items',
                filter: `list_id=eq.${currentListId}`
            }, (payload) => {
                console.log('Buy Later Realtime change detected:', payload);
                // Always reload if a change is detected, regardless of section visibility
                loadBuyLaterList();
            })
            .subscribe();

      console.log(`Realtime listeners configured for list_id: ${currentListId}`);
    }


    // --- Buy Later Functions ---
    async function addBuyLaterItem(name) {
        if (!currentListId) {
            alert("Please load or create a list first.");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .insert([{ name, list_id: currentListId }]);
            if (error) {
                console.error("Error adding 'Buy Later' item:", error);
                alert("Error adding 'Buy Later' item: " + error.message);
            } else {
                newBuyLaterItemInput.value = '';
                // loadBuyLaterList is handled by the Realtime listener
            }
        } catch (error) {
            console.error("Unexpected error adding 'Buy Later' item:", error);
            alert("An unexpected error occurred: " + error.message);
        }
    }

    async function deleteBuyLaterItem(itemId) {
        if (!currentListId) return;

        // Optimistic UI update: Remove the item from the DOM immediately
        const listItemElement = document.querySelector(`#buyLaterList li[data-id="${itemId}"]`);
        if (listItemElement) {
            listItemElement.remove();
        }

        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Error deleting 'Buy Later' item:", error);
                alert("Error deleting 'Buy Later' item: " + error.message);
                loadBuyLaterList(); // Reload if there's an error
            } else {
                // loadBuyLaterList is handled by the Realtime listener
            }
        } catch (error) {
            console.error("Unexpected error deleting 'Buy Later' item:", error);
            alert("An unexpected error occurred: " + error.message);
            loadBuyLaterList(); // Reload in case of unexpected JS error
        }
    }

    async function loadBuyLaterList() {
        if (!currentListId) {
            buyLaterList.innerHTML = '<p class="empty-list-message">Your "Buy Later" list is empty!</p>';
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('buy_later_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Error loading 'Buy Later' list:", error);
                alert("Error loading 'Buy Later' list: " + error.message);
                return;
            }

            buyLaterList.innerHTML = '';
            if (items.length === 0) {
                buyLaterList.innerHTML = '<p class="empty-list-message">Your "Buy Later" list is empty!</p>';
                return;
            }
            // Sort buy later items alphabetically
            items.sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));

            items.forEach(item => {
                // Use the shared renderListItem function
                renderListItem(item, buyLaterList);
            });
        } catch (error) {
            console.error("Unexpected error loading 'Buy Later' list:", error);
            alert("An unexpected error occurred: " + error.message);
        }
    }

    // --- Suggestions Functions (LOCAL STORAGE) ---
    function getSuggestions() {
        return JSON.parse(localStorage.getItem('shopping_suggestions') || '[]');
    }

    function saveSuggestions(suggestions) {
        localStorage.setItem('shopping_suggestions', JSON.stringify(suggestions));
    }

    async function addSuggestion(name, category) {
        if (!name.trim() || !category) {
            alert("Please enter a name and choose a category for the suggestion.");
            return;
        }
        const suggestions = getSuggestions();
        // Check for existing suggestion
        if (suggestions.some(sug => sug.name.toLowerCase() === name.trim().toLowerCase() && sug.category.toLowerCase() === category.toLowerCase())) {
            alert(`"${name.trim()}" is already a suggestion in category "${category}"!`);
            return;
        }

        const newSuggestion = {
            id: Date.now(), // Simple unique ID
            name: name.trim(),
            category: category
        };
        suggestions.push(newSuggestion);
        saveSuggestions(suggestions);
        newSuggestionInput.value = '';
        loadSuggestions(); // Refresh the list
    }

    async function deleteSuggestion(suggestionId) {
        // Optimistic UI update: Remove the item from the DOM immediately
        const listItemElement = document.querySelector(`#suggestionList li[data-id="${suggestionId}"]`);
        if (listItemElement) {
            listItemElement.remove();
        }

        let suggestions = getSuggestions();
        suggestions = suggestions.filter(sug => sug.id !== suggestionId);
        saveSuggestions(suggestions);
        // No need to call loadSuggestions() here, as the item is optimistically removed.
        // If there's an error (which is less likely with local storage), it would need manual refresh.
    }

    async function loadSuggestions() {
        let suggestions = getSuggestions();
        suggestionList.innerHTML = '';

        const selectedCategory = suggestionCategoryFilter.value;
        let filteredSuggestions = selectedCategory === 'all'
            ? suggestions
            : suggestions.filter(sug => sug.category === selectedCategory);

        if (filteredSuggestions.length === 0) {
            suggestionList.innerHTML = '<p class="empty-list-message">No suggestions for this category. Add some below!</p>';
            return;
        }

        // Sort suggestions alphabetically by name
        filteredSuggestions.sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));

        filteredSuggestions.forEach(suggestion => {
            const li = document.createElement('li');
            li.dataset.id = suggestion.id; // Store ID for deletion
            li.innerHTML = `
                <div class="suggestion-info">
                    <span class="name">${suggestion.name}</span>
                    <span class="category">${suggestion.category}</span>
                </div>
                <div class="suggestion-actions">
                    <button class="remove-btn" data-id="${suggestion.id}"><i class="fas fa-times"></i></button>
                </div>
            `;
            // Add event listener to add to shopping list when clicking the item text
            li.querySelector('.suggestion-info').addEventListener('click', () => {
                addItem(suggestion.name, 1, suggestion.category, currentListId);
            });
            // Add event listener for the "‚úñ" button
            li.querySelector('.remove-btn').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent li click from firing
                if (confirm(`Delete suggestion "${suggestion.name}" (${suggestion.category})?`)) {
                    deleteSuggestion(suggestion.id);
                }
            });
            suggestionList.appendChild(li);
        });
    }

    // --- Category Functions ---
    async function addCategory(categoryName) {
        if (!categoryName.trim()) {
            alert('Please enter a category name.');
            return;
        }
        let categories = getCategories();
        if (categories.some(cat => cat.toLowerCase() === categoryName.trim().toLowerCase())) {
            alert(`Category "${categoryName.trim()}" already exists!`);
            return;
        }
        categories.push(categoryName.trim());
        saveCategories(categories);
        newCategoryInput.value = '';
        updateAllCategorySelects();
        updateSuggestionCategoryFilter();
        renderCategories();
        loadCategoryOrder(); // Refresh the order list
    }

    function deleteCategory(categoryName) {
        if (!confirm(`Are you sure you want to delete category "${categoryName}"? This will also delete all linked suggestions.`)) {
            return;
        }
        let categories = getCategories();
        categories = categories.filter(cat => cat !== categoryName);
        saveCategories(categories);

        // Remove from local category order if present
        let currentOrder = JSON.parse(localStorage.getItem('category_order')) || [];
        currentOrder = currentOrder.filter(cat => cat !== categoryName);
        localStorage.setItem('category_order', JSON.stringify(currentOrder));

        // Logic to remove suggestions linked to this category from local storage
        let suggestions = getSuggestions();
        suggestions = suggestions.filter(sug => sug.category !== categoryName);
        saveSuggestions(suggestions);
        loadSuggestions(); // Refresh suggestions list

        updateAllCategorySelects();
        updateSuggestionCategoryFilter();
        renderCategories();
        loadCategoryOrder();
        loadShoppingList(); // Reload shopping list to reflect category changes
    }

    function renderCategories() {
        const categories = getCategories();
        categoryList.innerHTML = '';
        if (categories.length === 0) {
            categoryList.innerHTML = '<p class="empty-list-message">No categories defined. Add some above!</p>';
            return;
        }
        // Sort categories alphabetically for "Your Categories" list
        const sortedCategories = [...categories].sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));

        sortedCategories.forEach(category => {
            const li = document.createElement('li');
            li.textContent = category;
            li.innerHTML = `
                <span>${category}</span>
                <button class="remove-btn" data-category="${category}"><i class="fas fa-times"></i></button>
            `;
            // FIX: Use closest('.remove-btn') to get the button element that has the data-category attribute
            li.querySelector('.remove-btn').addEventListener('click', (e) => {
                deleteCategory(e.target.closest('.remove-btn').dataset.category);
            });
            categoryList.appendChild(li);
        });
    }

    let draggingCategoryElement = null;

    function loadCategoryOrder() {
        let categories = getCategories(); // Toutes les cat√©gories actuelles
        let savedOrder = JSON.parse(localStorage.getItem('category_order')) || []; // Ordre sauvegard√© depuis localStorage

        // Filtrer les cat√©gories de savedOrder qui n'existent plus dans getCategories()
        // Et s'assurer que les nouvelles cat√©gories de getCategories() sont ajout√©es √† la fin de l'ordre
        let newOrder = savedOrder.filter(cat => categories.includes(cat));

        categories.forEach(cat => {
            if (!newOrder.includes(cat)) {
                newOrder.push(cat); // Ajouter les nouvelles cat√©gories √† la fin
            }
        });

        // Si apr√®s r√©conciliation, l'ordre a chang√©, le sauvegarder
        if (JSON.stringify(savedOrder) !== JSON.stringify(newOrder)) {
            localStorage.setItem('category_order', JSON.stringify(newOrder));
        }
        // Utiliser l'ordre r√©concili√© et potentiellement sauvegard√© pour le rendu
        let currentOrder = newOrder;

        categoryOrderList.innerHTML = ''; // Effacer la liste d'abord

        if (currentOrder.length === 0) {
            categoryOrderList.innerHTML = '<p class="empty-list-message">Faites glisser les cat√©gories pour d√©finir leur ordre.</p>'; // Conserver le texte original
            return;
        }

        currentOrder.forEach(category => {
            const li = document.createElement('li');
            li.textContent = category;
            li.draggable = true;
            li.classList.add('category-item'); // Ajouter une classe pour le style/la s√©lection
            li.innerHTML = `<i class="fas fa-grip-vertical drag-handle"></i><span>${category}</span>`;
            categoryOrderList.appendChild(li);
        });
    }

    function saveCategoryOrder() {
        const items = Array.from(categoryOrderList.children);
        const newOrder = items.map(li => li.querySelector('span').textContent.trim()); // Get text from span
        localStorage.setItem('category_order', JSON.stringify(newOrder));
        console.log('Category order saved!'); // Log instead of alert
        loadShoppingList(); // Reload shopping list to apply new order
    }

    // --- Notification Push Functions (MODAL & SENDING) ---

    // Function to send the push notification via the Edge Function
    async function sendPushNotification(message) {
        if (!currentListId) {
            alert("Please load or create a list first before sending notifications.");
            return;
        }
        if (!message || message.trim() === '') {
            alert("Please enter a message to send.");
            return;
        }

        try {
            console.log(`Attempting to send push notification for list: ${currentListId}, message: "${message}"`);
            const { data, error } = await supabase.functions.invoke('send-push-notification', {
                body: {
                    listId: currentListId,
                    message: message // Now sending a generic message
                }
            });

            if (error) {
                console.error("Error invoking send-push-notification Edge Function:", error);
                if (error.message.includes('No subscriptions found for list')) {
                    alert(`Notification sent to list ${currentShareCode} (no push subscriptions found).`);
                } else {
                    alert("Failed to send push notification: " + error.message);
                }
            } else {
                console.log("Push notification Edge Function invoked successfully:", data);
                alert("Notification sent successfully!");
                closeNotificationModal(); // Close modal on success
                notificationMessageInput.value = ''; // Clear message input
            }
        } catch (error) {
            console.error("Unexpected error calling send-push-notification:", error);
            alert("An unexpected error occurred while sending notification: " + error.message);
        }
    }

    function openNotificationModal() {
        if (!currentListId) {
            alert("Please load or create a list first to send notifications.");
            showSection('settings');
            return;
        }
        notificationModal.classList.add('visible');
        notificationMessageInput.value = ''; // Clear input when opening
        renderSavedMessages(); // Load saved messages
    }

    function closeNotificationModal() {
        notificationModal.classList.remove('visible');
    }

    // Saved Messages management (Local Storage)
    function getSavedMessages() {
        return JSON.parse(localStorage.getItem('saved_notification_messages')) || [];
    }

    function saveSavedMessages(messages) {
        localStorage.setItem('saved_notification_messages', JSON.stringify(messages));
    }

    function addSavedMessage(message) {
        if (!message || message.trim() === '') {
            alert('Cannot save an empty message.');
            return;
        }
        let messages = getSavedMessages();
        // Check for duplicates
        if (messages.some(m => m.text.trim() === message.trim())) {
            alert('This message is already saved!');
            return;
        }
        messages.push({ id: Date.now(), text: message.trim() });
        saveSavedMessages(messages);
        renderSavedMessages();
        alert('Message saved!');
    }

    function deleteSavedMessage(id) {
        if (!confirm('Are you sure you want to delete this saved message?')) {
            return;
        }
        let messages = getSavedMessages();
        messages = messages.filter(m => m.id !== id);
        saveSavedMessages(messages);
        renderSavedMessages();
    }

    function renderSavedMessages() {
        const messages = getSavedMessages();
        savedMessagesList.innerHTML = '';
        if (messages.length === 0) {
            emptySavedMessages.style.display = 'block';
        } else {
            emptySavedMessages.style.display = 'none';
        }

        messages.forEach(msg => {
            const li = document.createElement('li');
            li.dataset.id = msg.id;
            li.innerHTML = `
                <span class="message-text">${msg.text}</span>
                <div class="message-actions">
                    <button class="remove-btn" data-id="${msg.id}"><i class="fas fa-times"></i></button>
                </div>
            `;
            li.querySelector('.message-text').addEventListener('click', () => {
                notificationMessageInput.value = msg.text; // Populate input with saved message
            });
            li.querySelector('.remove-btn').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent li click
                deleteSavedMessage(msg.id);
            });
            savedMessagesList.appendChild(li);
        });
    }

    // --- Event Listeners ---
    addItemBtn.addEventListener('click', () => {
        const itemName = newItemInput.value;
        const quantity = parseInt(newQuantityInput.value) || 1;
        const category = newCategorySelect.value;
        addItem(itemName, quantity, category, currentListId);
    });

    addBuyLaterItemBtn.addEventListener('click', () => {
        addBuyLaterItem(newBuyLaterItemInput.value);
    });

    addSuggestionBtn.addEventListener('click', () => {
        addSuggestion(newSuggestionInput.value, newSuggestionCategorySelect.value);
    });

    addCategoryBtn.addEventListener('click', () => {
        addCategory(newCategoryInput.value);
    });

    // Navigation button event listeners
    navShoppingList.addEventListener('click', () => showSection('shoppingList'));
    navBuyLater.addEventListener('click', () => showSection('buyLater'));
    navSuggestions.addEventListener('click', () => showSection('suggestions'));
    navCategories.addEventListener('click', () => showSection('categories'));
    navSettings.addEventListener('click', () => showSection('settings'));

    // Toggle nav button listener
    toggleNavBtn.addEventListener('click', toggleBottomNav);

    // Filter suggestions by category
    suggestionCategoryFilter.addEventListener('change', loadSuggestions);

    // Share code functionality
    loadShareCodeBtn.addEventListener('click', async () => {
        const code = shareCodeInput.value.trim().toUpperCase();
        if (code) {
            await getOrCreateListByShareCode(code);
            if (currentListId) { // If successfully connected/created
                showSection('shoppingList'); // Go to shopping list
            }
        } else {
            alert("Please enter a share code.");
        }
    });

    changeShareCodeBtn.addEventListener('click', () => {
        if (confirm("Are you sure you want to change lists / disconnect? This will clear the current share code from this device.")) {
            localStorage.removeItem('lastShareCode');
            currentListId = null;
            currentShareCode = null;
            if (window.supabaseChannel) {
                supabase.removeChannel(window.supabaseChannel);
                window.supabaseChannel = null;
            }
            if (window.supabaseBuyLaterChannel) {
                supabase.removeChannel(window.supabaseBuyLaterChannel);
                window.supabaseBuyLaterChannel = null;
            }

            // Clear current list display
            shoppingListToBuy.innerHTML = '<p class="empty-list-message">Your list is empty for now!</p>';
            buyLaterList.innerHTML = '<p class="empty-list-message">Your "Buy Later" list is empty!</p>';
            suggestionList.innerHTML = '<p class="empty-list-message">No suggestions available at the moment.</p>';
            categoryList.innerHTML = '<p class="empty-list-message">No categories defined. Add some above!</p>';
            categoryOrderList.innerHTML = '<p class="empty-list-message">Drag categories to set their order.</p>';

            shareCodeInput.value = generateShareCode(); // Suggest a new code
            activeShareCodeSpan.textContent = 'N/A';
            showSection('settings');
            alert("You have been disconnected. Please enter a new share code or create one.");
        }
    });

    // Scroll to form when title is clicked
    shoppingListTitle.addEventListener('click', (event) => { // Added event parameter
        event.preventDefault(); // Prevent default browser behavior (e.g., text selection)
        // Check if the click was on the bell icon itself, if so, don't scroll
        if (event.target.id === 'notificationBell') {
            return;
        }
        event.stopPropagation(); // Stop event propagation to avoid other actions
        document.body.scrollIntoView({ behavior: 'smooth', block: 'end' });
    });

    suggestionsTitle.addEventListener('click', (event) => { // Added event parameter
        event.preventDefault(); // Prevent default browser behavior (e.g., text selection)
        event.stopPropagation(); // Stop event propagation to avoid other actions
        document.body.scrollIntoView({ behavior: 'smooth', block: 'end' });
    });


    // Drag and Drop for Category Order
    categoryOrderList.addEventListener('dragstart', (e) => {
        draggingCategoryElement = e.target;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', draggingCategoryElement.innerHTML);
        e.target.classList.add('dragging');
    });

    categoryOrderList.addEventListener('dragover', (e) => {
        e.preventDefault(); // Necessary to allow dropping
        e.dataTransfer.dropEffect = 'move';
        const target = e.target.closest('li.category-item');
        if (target && target !== draggingCategoryElement) {
            const rect = target.getBoundingClientRect();
            const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > .5;
            categoryOrderList.insertBefore(draggingCategoryElement, next && target.nextSibling || target);
        }
    });

    categoryOrderList.addEventListener('dragend', (e) => {
        e.target.classList.remove('dragging');
        draggingCategoryElement = null;
        saveCategoryOrder(); // Save order immediately after drag
    });

    // Notification modal event listeners
    notificationBell.addEventListener('click', openNotificationModal);
    closeNotificationModalBtn.addEventListener('click', closeNotificationModal);
    // Close modal if clicking outside content
    notificationModal.addEventListener('click', (e) => {
        if (e.target === notificationModal) {
            closeNotificationModal();
        }
    });
    sendNotificationBtn.addEventListener('click', () => {
        sendPushNotification(notificationMessageInput.value);
    });
    saveMessageBtn.addEventListener('click', () => {
        addSavedMessage(notificationMessageInput.value);
    });


    // --- Initialization on page load ---
    window.addEventListener('load', async () => {
      // Initialize Supabase client
      if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("Supabase client initialized successfully.");
      } else {
          console.error("Error: Supabase 'createClient' function is not defined or the Supabase library is not loaded correctly.");
          alert("Loading error: Supabase library could not be initialized. Check your internet connection or configuration.");
          return;
      }

      let attempts = 0;
      const maxAttempts = 20;
      const delayMs = 50;

      while (!supabase.rest && attempts < maxAttempts) {
          console.log(`Waiting for supabase.rest (attempt ${attempts + 1}/${maxAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, delayMs));
          attempts++;
      }

      if (supabase.rest) {
          console.log("supabase.rest is now ready!");
          // Initialize categories if not present in local storage
          if (!localStorage.getItem('user_categories')) {
              localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
          }
          await handleInitialLoad(); // This will load data and set currentListId
          updateAllCategorySelects();
          updateSuggestionCategoryFilter();
          updateBodyPadding(); // Update body padding on initial load
          renderCategories(); // Initial rendering of categories list
          loadCategoryOrder(); // Initial load of category order list
      } else {
          console.error("Error: supabase.rest did not become ready after multiple attempts. Cannot start application.");
          alert("Startup error: Could not initialize database connection. Check your connection.");
          return;
      }
    });
  </script>
</body>
</html>