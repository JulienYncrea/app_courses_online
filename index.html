<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ma Liste de Courses üõí</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 1rem;
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none; /* Hidden by default */
      min-height: 200px;
    }
    .section-container.active {
      display: block;
    }
    input[type="text"], input[type="number"], select, button {
      width: calc(100% - 20px);
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      background-color: #E75480;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #D14771;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #f9f9f9;
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    li.purchased {
      background-color: #e0ffe0;
      text-decoration: line-through;
      color: #888;
    }
    .item-actions button {
      width: auto;
      padding: 5px 10px;
      margin-left: 5px;
      font-size: 0.8rem;
      border-radius: 3px;
    }
    .item-info {
      flex-grow: 1;
    }
    .add-item-form, .settings-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }
    .add-item-form input, .add-item-form select, .settings-form input {
      flex-grow: 1;
      width: auto;
      margin-bottom: 0;
    }
    .add-item-form button {
      flex-shrink: 0;
      width: auto;
      margin-bottom: 0;
    }
    .message {
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    .message.success {
      background-color: #d4edda;
      color: #155724;
    }
    .message.error {
      background-color: #f8d7da;
      color: #721c24;
    }
    .message.info {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    /* Navigation */
    nav {
      text-align: center;
      margin-bottom: 1rem;
      position: relative;
    }
    .nav-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap; /* Allows wrapping on smaller screens */
      gap: 10px; /* Space between buttons */
    }
    .nav-button {
      background-color: #FF69B4; /* Hot Pink */
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font-weight: bold;
      text-decoration: none; /* For potential future links */
      white-space: nowrap; /* Prevents text from breaking */
    }
    .nav-button:hover, .nav-button.active {
      background-color: #E75480; /* Deeper Pink */
    }

    /* Hidden Navigation Options */
    .hidden-nav-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      padding: 0;
      width: 100%; /* Ensure it spans full width */
      align-items: center; /* Center items if they don't fill width */
    }
    .hidden-nav-options.show-options {
      max-height: 200px; /* Adjust based on content */
    }
    .hidden-nav-options .nav-button {
      width: calc(100% - 20px); /* Fill width, adjust for padding */
      text-align: center;
    }

    /* Toggle icon for navigation */
    .toggle-options-button {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #E75480;
        font-size: 1.5rem;
        cursor: pointer;
    }
    .toggle-options-button:hover {
        color: #D14771;
    }

    .current-share-code-display {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: bold;
      color: #E75480;
    }
  </style>
</head>
<body>
  <h1>Ma Liste de Courses üõí</h1>

  <div class="current-share-code-display">
    Code de Liste Actuel: <span id="displayShareCode">Non d√©fini</span>
  </div>

  <nav>
    <div class="nav-buttons">
      <button class="nav-button active" data-section="shoppingList">Ma Liste</button>
      <button class="nav-button" data-section="buyLaterList">A Acheter Plus Tard</button>
      <button class="nav-button" data-section="categoriesManagement">Cat√©gories</button>
      <button class="nav-button" data-section="settings">Param√®tres</button>
    </div>
  </nav>

  <div id="shoppingListSection" class="section-container active">
    <h2>Articles de la Liste</h2>
    <div class="add-item-form">
      <input type="text" id="itemInput" placeholder="Nom de l'article" autocomplete="off" list="suggestions">
      <datalist id="suggestions"></datalist>
      <input type="number" id="quantityInput" placeholder="Quantit√©" value="1">
      <select id="categorySelect"></select>
      <button onclick="addItem()">Ajouter</button>
    </div>
    <ul id="shoppingList">
      </ul>
  </div>

  <div id="buyLaterListSection" class="section-container">
    <h2>Articles √† Acheter Plus Tard</h2>
    <ul id="buyLaterList">
      </ul>
  </div>

  <div id="categoriesManagementSection" class="section-container">
    <h2>Gestion des Cat√©gories</h2>
    <div class="add-item-form">
      <input type="text" id="newCategoryInput" placeholder="Nom de la nouvelle cat√©gorie">
      <button onclick="addCategory()">Ajouter Cat√©gorie</button>
    </div>
    <ul id="categoryList">
      </ul>
    <button onclick="saveCategoryOrder()">Sauvegarder Ordre des Cat√©gories</button>
  </div>

  <div id="settingsSection" class="section-container">
    <h2>Param√®tres</h2>
    <div class="settings-form">
        <label for="shareCodeInput">Code de Liste:</label>
        <input type="text" id="shareCodeInput" placeholder="Entrez un code de liste">
        <button onclick="changeShareCode()">Changer de Liste</button>
    </div>
    <p class="message" id="settingsMessage"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Configuration Supabase ---
    const SUPABASE_URL = 'https://cepqcretnxfhjbvdukkk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU';
    
    // Initialise le client Supabase (createClient est directement disponible)
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Variables Globales ---
    let currentListId = null; // ID UUID de la liste active (r√©cup√©r√© via le share_code)
    let currentShareCode = null; // Le code de partage actuellement utilis√© par l'utilisateur
    let shoppingListChannel = null; // Pour le Realtime de Supabase

    // --- √âl√©ments du DOM ---
    const shoppingListSection = document.getElementById('shoppingListSection');
    const buyLaterListSection = document.getElementById('buyLaterListSection');
    const categoriesManagementSection = document.getElementById('categoriesManagementSection');
    const settingsSection = document.getElementById('settingsSection'); // Nouvelle section param√®tres

    const itemInput = document.getElementById('itemInput');
    const quantityInput = document.getElementById('quantityInput');
    const categorySelect = document.getElementById('categorySelect');
    const shoppingList = document.getElementById('shoppingList');
    const buyLaterList = document.getElementById('buyLaterList');
    const suggestionsDatalist = document.getElementById('suggestions');
    const newCategoryInput = document.getElementById('newCategoryInput');
    const categoryListUl = document.getElementById('categoryList');

    const displayShareCodeSpan = document.getElementById('displayShareCode');
    const shareCodeInput = document.getElementById('shareCodeInput');
    const settingsMessage = document.getElementById('settingsMessage');

    const navigationButtons = document.querySelectorAll('.nav-button');

    // Cat√©gories par d√©faut si aucune n'est d√©finie
    const initialDefaultCategories = ["Fruits & L√©gumes", "Boulangerie", "Viandes & Poissons", "Produits laitiers", "√âpicerie", "Surgel√©s", "Boissons", "Entretien", "Hygi√®ne"];

    // --- Fonctions utilitaires ---
    function displayMessage(message, type, targetElement = null) {
      const element = targetElement || document.getElementById('settingsMessage'); // Fallback sur settingsMessage
      if (element) {
        element.textContent = message;
        element.className = `message ${type}`;
        element.style.display = 'block';
        setTimeout(() => { element.style.display = 'none'; }, 5000);
      } else {
        console.log(`Message (${type}): ${message}`);
      }
    }

    function showSection(sectionId) {
      document.querySelectorAll('.section-container').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`${sectionId}Section`).classList.add('active');

      navigationButtons.forEach(button => {
        if (button.dataset.section === sectionId) {
          button.classList.add('active');
        } else {
          button.classList.remove('active');
        }
      });
    }

    // --- Gestion du Code de Partage ---

    // Met √† jour l'en-t√™te X-Share-Code pour toutes les requ√™tes Supabase
    function updateSupabaseHeaders(shareCode) {
      if (shareCode) {
        supabase.postgrest.headers['X-Share-Code'] = shareCode;
      } else {
        // Supprime l'en-t√™te si le code n'est pas d√©fini
        delete supabase.postgrest.headers['X-Share-Code'];
      }
    }

    // Tente de r√©cup√©rer ou de cr√©er une liste bas√©e sur le code de partage
    async function getOrCreateListByShareCode(shareCode) {
        // Mettre √† jour l'en-t√™te pour cette requ√™te
        updateSupabaseHeaders(shareCode);

        // 1. Essayer de r√©cup√©rer la liste existante
        let { data: list, error: fetchError } = await supabase
            .from('lists')
            .select('id, name')
            .eq('share_code', shareCode)
            .single();

        if (fetchError && fetchError.code === 'PGRST116') { // PGRST116 = pas de ligne trouv√©e
            // 2. Si la liste n'existe pas, la cr√©er
            console.log(`Aucune liste trouv√©e pour le code ${shareCode}. Cr√©ation d'une nouvelle liste.`);
            displayMessage(`Cr√©ation de la liste pour le code ${shareCode}...`, 'info');

            const { data: newlist, error: createError } = await supabase
                .from('lists')
                .insert({ name: `Liste #${shareCode}`, share_code: shareCode })
                .select('id, name')
                .single();

            if (createError) {
                console.error('Erreur lors de la cr√©ation de la liste:', createError.message);
                displayMessage('Erreur lors de la cr√©ation de la liste: ' + createError.message, 'error');
                return null;
            }
            list = newlist;
        } else if (fetchError) {
            console.error('Erreur lors de la r√©cup√©ration de la liste:', fetchError.message);
            displayMessage('Erreur lors de la r√©cup√©ration de la liste: ' + fetchError.message, 'error');
            return null;
        }
        
        currentListId = list.id;
        currentShareCode = shareCode; // Met √† jour le code de partage global
        displayShareCodeSpan.textContent = currentShareCode; // Met √† jour l'affichage
        localStorage.setItem('active_share_code', shareCode); // Sauvegarde dans le localStorage

        displayMessage(`Liste "${list.name}" charg√©e avec succ√®s !`, 'success');
        return list.id;
    }

    // Demande √† l'utilisateur d'entrer un code de partage
    async function promptForShareCode(isInitialLoad = true) {
        let shareCode = prompt("Veuillez entrer le code de votre liste:");
        shareCode = shareCode ? shareCode.trim() : null;

        if (shareCode) {
            const listId = await getOrCreateListByShareCode(shareCode);
            if (listId) {
                console.log(`Liste initialis√©e avec ID: ${listId} pour le code: ${shareCode}`);
                loadShoppingList();
                setupRealtimeListener(listId);
            } else {
                displayMessage('Impossible de charger ou cr√©er la liste pour le code fourni.', 'error');
                if (isInitialLoad) {
                    promptForShareCode(true); // Redemander le code si √©chec initial
                }
            }
        } else {
            displayMessage('Un code de liste est n√©cessaire pour continuer.', 'error');
            if (isInitialLoad) {
                promptForShareCode(true); // Redemander le code si initial et annul√©
            }
        }
    }

    // Change le code de partage depuis les param√®tres
    async function changeShareCode() {
      let newShareCode = shareCodeInput.value.trim();
      if (!newShareCode) {
          displayMessage('Veuillez entrer un nouveau code de liste.', 'error', settingsMessage);
          return;
      }
      if (newShareCode === currentShareCode) {
          displayMessage('Ceci est d√©j√† votre code de liste actuel.', 'info', settingsMessage);
          return;
      }

      const listId = await getOrCreateListByShareCode(newShareCode);
      if (listId) {
          displayMessage(`Bascul√© vers la liste avec le code: ${newShareCode}`, 'success', settingsMessage);
          loadShoppingList();
          setupRealtimeListener(listId);
          showSection('shoppingList'); // Revenir √† la liste principale
      } else {
          displayMessage('Impossible de basculer vers la liste avec ce code.', 'error', settingsMessage);
      }
    }

    // --- Fonctions de Gestion de Liste (modifi√©es pour utiliser currentListId) ---

    async function loadShoppingList() {
      if (!currentListId) {
        shoppingList.innerHTML = '<li style="text-align: center;">Veuillez d\'abord entrer un code de liste.</li>';
        return;
      }

      // S'assurer que l'en-t√™te est d√©fini avant la requ√™te
      updateSupabaseHeaders(currentShareCode);

      const { data, error } = await supabase
        .from('shopping_items')
        .select('*')
        .eq('list_id', currentListId) // Filtre par l'ID UUID de la liste
        .order('category', { ascending: true })
        .order('created_at', { ascending: true });

      if (error) {
        console.error('Erreur de chargement des articles:', error.message);
        displayMessage('Erreur de chargement des articles.', 'error');
        return;
      }

      displayShoppingList(data);
      loadSuggestions();
    }

    function displayShoppingList(items) {
      shoppingList.innerHTML = '';
      if (items.length === 0) {
        shoppingList.innerHTML = '<li style="text-align: center;">Votre liste est vide. Ajoutez des articles !</li>';
        return;
      }

      const categorizedItems = {};
      const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || getCategories();

      categoryOrder.forEach(category => {
        categorizedItems[category] = [];
      });

      items.forEach(item => {
        if (categorizedItems[item.category]) {
          categorizedItems[item.category].push(item);
        } else {
          // Pour les cat√©gories non tri√©es explicitement, ajoutez-les √† la fin
          if (!categorizedItems['Autres']) {
            categorizedItems['Autres'] = [];
          }
          categorizedItems['Autres'].push(item);
        }
      });

      for (const category of categoryOrder) {
        if (categorizedItems[category] && categorizedItems[category].length > 0) {
          const categoryHeader = document.createElement('h3');
          categoryHeader.textContent = category;
          shoppingList.appendChild(categoryHeader);

          categorizedItems[category].forEach(item => {
            const li = document.createElement('li');
            li.dataset.id = item.id;
            li.className = item.purchased ? 'purchased' : '';
            li.innerHTML = `
              <span class="item-info">
                ${item.name} (${item.quantity})
              </span>
              <div class="item-actions">
                <button onclick="togglePurchased('${item.id}', ${item.purchased})">
                  <i class="fas ${item.purchased ? 'fa-undo' : 'fa-check'}"></i>
                </button>
                <button onclick="moveToBuyLater('${item.id}')" style="background-color: #f0ad4e;"><i class="fas fa-archive"></i></button>
                <button onclick="deleteItem('${item.id}')" style="background-color: #dc3545;"><i class="fas fa-trash"></i></button>
              </div>
            `;
            shoppingList.appendChild(li);
          });
        }
      }
      // Add 'Autres' if it exists and wasn't explicitly ordered
      if (categorizedItems['Autres'] && categorizedItems['Autres'].length > 0) {
        const categoryHeader = document.createElement('h3');
        categoryHeader.textContent = 'Autres';
        shoppingList.appendChild(categoryHeader);
        categorizedItems['Autres'].forEach(item => {
          const li = document.createElement('li');
          li.dataset.id = item.id;
          li.className = item.purchased ? 'purchased' : '';
          li.innerHTML = `
            <span class="item-info">
              ${item.name} (${item.quantity})
            </span>
            <div class="item-actions">
              <button onclick="togglePurchased('${item.id}', ${item.purchased})">
                <i class="fas ${item.purchased ? 'fa-undo' : 'fa-check'}"></i>
              </button>
              <button onclick="moveToBuyLater('${item.id}')" style="background-color: #f0ad4e;"><i class="fas fa-archive"></i></button>
              <button onclick="deleteItem('${item.id}')" style="background-color: #dc3545;"><i class="fas fa-trash"></i></button>
            </div>
          `;
          shoppingList.appendChild(li);
        });
      }
    }

    async function addItem() {
      if (!currentListId) {
        displayMessage('Veuillez s√©lectionner une liste avant d\'ajouter des articles.', 'error');
        return;
      }

      const itemName = itemInput.value.trim();
      const quantity = parseInt(quantityInput.value);
      const category = categorySelect.value;

      if (!itemName || isNaN(quantity) || quantity <= 0) {
        displayMessage('Veuillez remplir le nom et la quantit√© de l\'article.', 'error');
        return;
      }

      // S'assurer que l'en-t√™te est d√©fini avant la requ√™te
      updateSupabaseHeaders(currentShareCode);

      const { data, error } = await supabase
        .from('shopping_items')
        .insert({ name: itemName, quantity: quantity, category: category, list_id: currentListId });

      if (error) {
        console.error('Erreur d\'ajout d\'article:', error.message);
        displayMessage('Erreur d\'ajout d\'article.', 'error');
        return;
      }

      itemInput.value = '';
      quantityInput.value = '1';
      categorySelect.value = getCategories()[0]; // Reset to first category
      loadShoppingList(); // Recharger la liste pour afficher le nouvel article
      addSuggestion(itemName); // Ajouter √† la liste de suggestions
      displayMessage('Article ajout√© avec succ√®s !', 'success');
    }

    async function togglePurchased(id, currentStatus) {
      if (!currentListId) return;

      // S'assurer que l'en-t√™te est d√©fini avant la requ√™te
      updateSupabaseHeaders(currentShareCode);

      const { data, error } = await supabase
        .from('shopping_items')
        .update({ purchased: !currentStatus })
        .eq('id', id);

      if (error) {
        console.error('Erreur de mise √† jour de l\'article:', error.message);
        displayMessage('Erreur de mise √† jour de l\'article.', 'error');
        return;
      }

      loadShoppingList(); // Recharger la liste pour refl√©ter le changement
    }

    async function deleteItem(id) {
      if (!currentListId) return;

      if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet article ?')) {
        return;
      }

      // S'assurer que l'en-t√™te est d√©fini avant la requ√™te
      updateSupabaseHeaders(currentShareCode);

      const { data, error } = await supabase
        .from('shopping_items')
        .delete()
        .eq('id', id);

      if (error) {
        console.error('Erreur de suppression d\'article:', error.message);
        displayMessage('Erreur de suppression d\'article.', 'error');
        return;
      }

      displayMessage('Article supprim√© avec succ√®s !', 'success');
      loadShoppingList(); // Recharger la liste
    }

    // --- Fonctions Realtime ---
    async function setupRealtimeListener(listId) {
        // D√©sabonnement de l'ancien canal si il existe
        if (shoppingListChannel) {
            await supabase.removeChannel(shoppingListChannel);
            shoppingListChannel = null;
        }

        if (!listId) {
            console.warn('Impossible de configurer le listener Realtime sans un ID de liste.');
            return;
        }

        shoppingListChannel = supabase.channel(`shopping_items_list_${listId}`)
            .on(
                'postgres_changes',
                {
                    event: '*', // 'INSERT', 'UPDATE', 'DELETE'
                    schema: 'public',
                    table: 'shopping_items',
                    filter: `list_id=eq.${listId}` // Filtrer par l'ID UUID de la liste
                },
                (payload) => {
                    console.log('Changement re√ßu!', payload);
                    // Recharger la liste principale pour refl√©ter le changement
                    loadShoppingList();
                    loadBuyLaterList();
                }
            )
            .subscribe();

        console.log(`Listener Realtime configur√© pour la liste ID: ${listId}`);
    }

    // --- Fonctions pour "Acheter Plus Tard" (n√©cessitent de g√©rer la "status" ou "archive" colonne) ---
    async function moveToBuyLater(id) {
        if (!currentListId) return;

        // S'assurer que l'en-t√™te est d√©fini avant la requ√™te
        updateSupabaseHeaders(currentShareCode);

        // Cette fonction n√©cessiterait une colonne 'status' ou 'archived' dans shopping_items
        // Pour l'exemple, nous allons simplement le supprimer de la liste principale et l'ajouter √† une "liste acheter plus tard" locale
        // Dans une vraie application, vous changeriez le statut dans la DB, ou le d√©placeriez vers une autre table/liste.
        // Pour l'instant, je vais juste le supprimer de la liste principale
        if (!confirm('Voulez-vous d√©placer cet article dans "Acheter Plus Tard" (ce qui le supprimera de la liste principale) ?')) {
            return;
        }

        const { data, error } = await supabase
            .from('shopping_items')
            .delete()
            .eq('id', id);

        if (error) {
            console.error('Erreur de d√©placement de l\'article:', error.message);
            displayMessage('Erreur de d√©placement de l\'article.', 'error');
            return;
        }
        displayMessage('Article d√©plac√© dans "Acheter Plus Tard" (supprim√© de la liste principale).', 'success');
        loadShoppingList(); // Recharger la liste principale
        loadBuyLaterList(); // Recharger la liste "acheter plus tard" (qui est factice ici)
    }

    function loadBuyLaterList() {
        // Cette fonction serait li√©e √† une vraie base de donn√©es pour une liste "acheter plus tard"
        // Pour l'instant, elle reste une d√©mo
        buyLaterList.innerHTML = '<li style="text-align: center; color: #888;">Cette liste est pour l\'exemple. Les articles y seraient d√©plac√©s depuis la liste principale.</li>';
    }


    // --- Fonctions de Gestion des Cat√©gories ---
    function getCategories() {
      return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
      localStorage.setItem('user_categories', JSON.stringify(categories));
      localStorage.setItem('category_order', JSON.stringify(categories)); // Mettre √† jour l'ordre aussi
      updateAllCategorySelects();
      loadCategoryOrder();
    }

    function addCategory() {
      const newCategoryName = newCategoryInput.value.trim();
      if (newCategoryName && !getCategories().includes(newCategoryName)) {
        const updatedCategories = [...getCategories(), newCategoryName];
        saveCategories(updatedCategories);
        newCategoryInput.value = '';
        displayMessage('Cat√©gorie ajout√©e !', 'success', categoriesManagementSection.querySelector('.message'));
      } else {
        displayMessage('Nom de cat√©gorie invalide ou d√©j√† existante.', 'error', categoriesManagementSection.querySelector('.message'));
      }
    }

    function deleteCategory(categoryToDelete) {
      if (confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${categoryToDelete}" ?`)) {
        const updatedCategories = getCategories().filter(cat => cat !== categoryToDelete);
        saveCategories(updatedCategories);
        displayMessage('Cat√©gorie supprim√©e !', 'success', categoriesManagementSection.querySelector('.message'));
      }
    }

    function updateCategoryListDisplay() {
      categoryListUl.innerHTML = '';
      getCategories().forEach(category => {
        const li = document.createElement('li');
        li.textContent = category;
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Supprimer';
        deleteButton.style.backgroundColor = '#dc3545';
        deleteButton.style.width = 'auto';
        deleteButton.style.marginLeft = '10px';
        deleteButton.onclick = () => deleteCategory(category);
        li.appendChild(deleteButton);
        categoryListUl.appendChild(li);
      });
    }

    function updateAllCategorySelects() {
      const selects = document.querySelectorAll('select#categorySelect');
      const categories = getCategories();
      selects.forEach(select => {
        select.innerHTML = '';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          select.appendChild(option);
        });
      });
    }

    // Drag and drop categories
    function loadCategoryOrder() {
      const categories = JSON.parse(localStorage.getItem('category_order')) || getCategories();
      categoryListUl.innerHTML = '';
      categories.forEach(category => {
        const li = document.createElement('li');
        li.textContent = category;
        li.draggable = true;
        li.dataset.category = category;
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Supprimer';
        deleteButton.style.backgroundColor = '#dc3545';
        deleteButton.style.width = 'auto';
        deleteButton.style.marginLeft = '10px';
        deleteButton.onclick = (event) => {
            event.stopPropagation(); // Emp√™che le dragstart si on clique sur le bouton
            deleteCategory(category);
        };
        li.appendChild(deleteButton);
        categoryListUl.appendChild(li);
      });
      addDragDropListeners();
    }

    function addDragDropListeners() {
      let draggedItem = null;
      categoryListUl.querySelectorAll('li').forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          setTimeout(() => item.style.display = 'none', 0);
        });

        item.addEventListener('dragend', () => {
          setTimeout(() => draggedItem.style.display = 'flex', 0);
          draggedItem = null;
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault(); // Permet le drop
        });

        item.addEventListener('dragenter', (e) => {
          e.preventDefault();
          if (item !== draggedItem) {
            item.style.borderTop = '2px solid #E75480';
          }
        });

        item.addEventListener('dragleave', () => {
          item.style.borderTop = '';
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          item.style.borderTop = '';
          if (item !== draggedItem) {
            const allItems = Array.from(categoryListUl.querySelectorAll('li'));
            const draggedIndex = allItems.indexOf(draggedItem);
            const targetIndex = allItems.indexOf(item);

            if (draggedIndex < targetIndex) {
              item.parentNode.insertBefore(draggedItem, item.nextSibling);
            } else {
              item.parentNode.insertBefore(draggedItem, item);
            }
          }
        });
      });
    }

    function saveCategoryOrder() {
      const orderedCategories = Array.from(categoryListUl.querySelectorAll('li')).map(li => li.dataset.category);
      localStorage.setItem('category_order', JSON.stringify(orderedCategories));
      displayMessage('Ordre des cat√©gories sauvegard√© !', 'success', categoriesManagementSection.querySelector('.message'));
      updateAllCategorySelects(); // Mettre √† jour les selects apr√®s avoir sauvegard√© l'ordre
    }

    // --- Suggestions pour les Noms d'Articles ---
    function addSuggestion(name) {
      let suggestions = JSON.parse(localStorage.getItem('item_suggestions')) || [];
      if (!suggestions.includes(name)) {
        suggestions.push(name);
        localStorage.setItem('item_suggestions', JSON.stringify(suggestions));
      }
    }

    function loadSuggestions() {
      const suggestions = JSON.parse(localStorage.getItem('item_suggestions')) || [];
      suggestionsDatalist.innerHTML = '';
      suggestions.forEach(suggestion => {
        const option = document.createElement('option');
        option.value = suggestion;
        suggestionsDatalist.appendChild(option);
      });
    }

    // --- Initialisation au chargement de la page ---
    window.addEventListener('load', async () => {
        // Initialisation des cat√©gories
        if (!localStorage.getItem('user_categories')) {
            localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
        }
        if (!localStorage.getItem('category_order')) {
            localStorage.setItem('category_order', JSON.stringify(getCategories()));
        }

        updateAllCategorySelects();
        loadSuggestions();
        loadBuyLaterList(); 
        loadCategoryOrder(); 
        
        // --- NOUVELLE LOGIQUE D'INITIALISATION SANS AUTH ---
        const storedShareCode = localStorage.getItem('active_share_code');
        if (storedShareCode) {
            shareCodeInput.value = storedShareCode; // Pr√©-remplit l'input des param√®tres
            await getOrCreateListByShareCode(storedShareCode);
            if (currentListId) {
                loadShoppingList();
                setupRealtimeListener(currentListId);
            } else {
                // Si le chargement initial √©choue, demander √† nouveau
                promptForShareCode(true);
            }
        } else {
            promptForShareCode(true); // Demander le code au premier chargement
        }

        showSection('shoppingList'); // Afficher la section de la liste principale par d√©faut
    });


    // --- Listeners pour la navigation ---
    navigationButtons.forEach(button => {
      button.addEventListener('click', () => {
        showSection(button.dataset.section);
      });
    });

  </script>
</body>
</html>