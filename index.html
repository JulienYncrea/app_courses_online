<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shopping List üõí</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 1rem;
      padding-bottom: 70px; /* Espace initial pour le menu du bas */
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
      transition: padding-bottom 0.3s ease-out; /* Animation pour le padding */
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      cursor: pointer; /* Indicate clickable titles for scrolling */
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    input[type="text"], input[type="number"], select, button {
      width: calc(100% - 20px);
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      background-color: #E75480;
      color: white;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #D4426A;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #f9f9f9;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      flex-wrap: wrap; /* Permet aux √©l√©ments de passer √† la ligne */
    }
    .item-info {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .item-actions {
      display: flex;
      gap: 0.5rem; /* Espace entre les boutons */
      margin-top: 0.5rem; /* Espace si les boutons passent en dessous */
    }
    .item-actions button {
      width: auto;
      padding: 0.5rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 0.4rem;
      margin-bottom: 0; /* Override default button margin */
    }
    /* Styles pour les boutons de suppression en croix dans la liste de courses */
    .item-actions .remove-btn,
    #buyLaterList .remove-btn { /* These use text 'X' directly or span for 'X' */
      background-color: #f44336;
      width: 28px; /* Plus petit */
      height: 28px; /* Plus petit */
      padding: 0;
      font-size: 1rem; /* Taille de la croix plus petite */
      border-radius: 50%; /* Rond */
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
      line-height: 1; /* Pour centrer le 'X' */
    }
    .item-actions .remove-btn:hover,
    #buyLaterList .remove-btn:hover {
      background-color: #d32f2f;
    }
    /* Masque le texte "Supprimer" pour les croix */
    .item-actions .remove-btn::before,
    #buyLaterList .remove-btn::before {
      content: "X";
    }
    .item-actions .remove-btn span,
    #buyLaterList .remove-btn span {
        display: none; /* Cache le texte original */
    }

    /* Styles for buttons using Font Awesome icons (like categories, suggestions) */
    #categoryList .remove-btn,
    #suggestionList .remove-btn {
        background-color: #f44336; /* Consistent background */
        width: 28px;
        height: 28px;
        padding: 0;
        font-size: 1.1rem; /* Slightly larger for FA icon */
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        text-align: center;
        line-height: 1;
    }
    /* Ensure Font Awesome icon is visible and not hidden by ::before or span */
    #categoryList .remove-btn i,
    #suggestionList .remove-btn i {
        display: block; /* Make sure the icon is shown */
        line-height: 1;
    }
    /* Remove any conflicting ::before or span hiding rules for these specific elements */
    #categoryList .remove-btn::before,
    #categoryList .remove-btn span,
    #suggestionList .remove-btn::before,
    #suggestionList .remove-btn span {
        content: none !important; /* Override the 'X' and hide any spans */
        display: none !important; /* Ensure nothing else is displayed */
    }


    .quantity-control {
        display: flex;
        align-items: center;
        gap: 0.2rem;
        /* margin-left: 0.5rem; */ /* Removed to allow placement before name */
    }
    .quantity-control button {
        width: 28px; /* Rendre les boutons + et - plus petits */
        height: 28px; /* Rendre les boutons + et - plus petits */
        padding: 0;
        font-size: 1.1rem; /* Taille de la police l√©g√®rement r√©duite */
        border-radius: 50%; /* Fully rounded */
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #ddd;
        color: #333;
    }
    .quantity-control button:hover {
        background-color: #ccc;
    }
    .quantity-control span {
        min-width: 20px;
        text-align: center;
        font-weight: bold;
    }

    /* .total-items { */ /* Removed this block as per user request */
    /* text-align: right;
        font-weight: bold;
        margin-top: 1rem;
        color: #E75480;
    } */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #E75480;
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      transform: translateY(0); /* Position initiale visible */
      transition: transform 0.3s ease-out; /* Animation douce */
      position: relative; /* Pour positionner la fl√®che √† droite */
    }
    .bottom-nav.hidden-nav {
      transform: translateY(100%); /* Masque le menu en le d√©pla√ßant vers le bas */
    }
    .nav-item {
      color: white;
      text-align: center;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .nav-item i {
      font-size: 1.5rem;
      margin-bottom: 0.2rem;
    }
    .nav-item.active {
      font-weight: bold;
      color: #FAD0C4;
    }
    .toggle-nav-button {
      position: absolute;
      top: -20px; /* Positionne la fl√®che au-dessus du menu */
      right: 20px; /* Positionne la fl√®che √† droite */
      background-color: #E75480;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1001; /* Assure qu'il est au-dessus du menu */
    }
    .toggle-nav-button i {
      font-size: 1.2rem;
    }

    /* Style pour les sections cach√©es */
    .section.hidden {
      display: none;
    }

    /* Styles for the suggestions list */
    .suggestions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 0.7rem;
      margin-top: 1.5rem;
    }
    .suggestion-item {
      position: relative;
      background: #9370DB;
      color: #FFFFFF;
      padding: 0.6rem 1rem;
      border-radius: 0.75rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      white-space: nowrap; /* Prevent wrapping */
      overflow: hidden; /* Hide overflow */
      text-overflow: ellipsis; /* Add ellipsis for overflowed text */
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-right: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .suggestion-item:hover {
      background: #8A2BE2;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .suggestion-item-text {
        flex-grow: 1;
        padding-right: 5px;
        font-weight: 500;
        overflow: hidden; /* Ensure text overflow ellipsis works */
        text-overflow: ellipsis;
        white-space: nowrap; /* Keep on single line */
    }

    /* Styles pour les titres de cat√©gorie dans la liste de courses */
    .section-container h3 {
        color: #E75480;
        border-bottom: 1px solid #FFD1DC;
        padding-bottom: 0.3rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }

    /* Category order list styles */
    #categoryOrderList {
        list-style: none;
        padding: 0;
    }
    #categoryOrderList li {
        background: #F8F8FF;
        border: 1px solid #DDA0DD;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        color: #6A057F;
        cursor: grab; /* Indicate draggable */
        transition: background-color 0.2s ease, transform 0.2s ease;
        /* Prevent text selection on drag for iOS/Safari */
        -webkit-user-select: none; /* Safari */
        -moz-user-select: none;    /* Firefox */
        -ms-user-select: none;     /* IE10+ */
        user-select: none;         /* Standard */
    }
    #categoryOrderList li:hover {
        background-color: #E6E6FA;
        transform: scale(1.01);
    }
    #categoryOrderList li.dragging {
        opacity: 0.5;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        border: 2px dashed #E75480; /* Visual cue for dragging */
    }
    .drag-handle {
        font-size: 1.5rem;
        cursor: grab;
        margin-right: 10px;
        color: #EE82EE;
    }

    /* Styles for category management list (not draggable) */
    #categoryList li {
      background: #f9f9f9; /* Match general li style */
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      font-weight: bold; /* Added for consistency */
      color: #333; /* Default text color */
    }

    @media (max-width: 640px) {
        .suggestions-grid {
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        }
    }
  </style>
</head>
<body>
  <div id="shoppingList" class="section-container section">
    <h1 id="shoppingListTitle">Ma Liste de Courses üõí</h1>

    <ul id="shoppingListToBuy" class="item-list"></ul>
    <div id="addItemForm">
        <h3>Ajouter un article</h3>
        <input type="text" id="newItemInput" placeholder="Ajouter un article" />
        <input type="number" id="newQuantityInput" placeholder="Quantit√© (optionnel)" value="1" min="1" />
        <select id="newCategorySelect"></select>
        <button id="addItemBtn">Ajouter √† la liste</button>
    </div>
  </div>

  <div id="buyLater" class="section-container section hidden">
    <h2>Acheter Plus Tard üõí</h2>
    <input type="text" id="newBuyLaterItemInput" placeholder="Article √† acheter plus tard" />
    <button id="addBuyLaterItemBtn">Ajouter</button>
    <ul id="buyLaterList"></ul>
  </div>

  <div id="suggestions" class="section-container section hidden">
    <h2 id="suggestionsTitle">Suggestions üí°</h2>
    <select id="suggestionCategoryFilter"></select> <ul id="suggestionList" class="suggestions-grid"></ul>
    <h3>Ajouter une suggestion</h3>
    <input type="text" id="newSuggestionInput" placeholder="Sugg√©rer un article" />
    <select id="newSuggestionCategorySelect"></select>
    <button id="addSuggestionBtn">Ajouter Suggestion</button>
  </div>

  <div id="categories" class="section-container section hidden">
    <h2>G√©rer les Cat√©gories üìÇ</h2>
    <h3>Vos Cat√©gories</h3>
    <input type="text" id="newCategoryInput" placeholder="Nouvelle cat√©gorie" />
    <button id="addCategoryBtn">Ajouter Cat√©gorie</button>
    <ul id="categoryList"></ul>
    <h3>Ordre des Cat√©gories</h3>
    <p style="text-align: center; color: #6A057F; margin-top: 0.5rem;">Faites glisser les cat√©gories pour d√©finir leur ordre dans 'Ma Liste'.</p>
    <ul id="categoryOrderList" class="sortable-list"></ul>
    </div>

  <div id="settings" class="section-container section hidden">
    <h2>Param√®tres ‚öôÔ∏è</h2>
    <p>Code de la liste active : <strong id="activeShareCode">N/A</strong></p>
    <hr>
    <h3>Charger / Cr√©er une liste</h3>
    <input type="text" id="shareCodeInput" placeholder="Entrez un code de partage" />
    <button id="loadShareCodeBtn">Charger/Cr√©er Liste</button>
    <hr>
    <button id="changeShareCodeBtn">Changer de liste / D√©connecter</button>
  </div>


  <div class="bottom-nav">
    <button id="toggleNavBtn" class="toggle-nav-button">
      <i class="fas fa-chevron-down"></i> </button>
    <div class="nav-item active" id="navShoppingList">
      <i class="fas fa-shopping-basket"></i>
      <span>Ma Liste</span>
    </div>
    <div class="nav-item" id="navBuyLater">
      <i class="fas fa-clock"></i>
      <span>Plus Tard</span>
    </div>
    <div class="nav-item" id="navSuggestions">
      <i class="fas fa-lightbulb"></i>
      <span>Suggestions</span>
    </div>
    <div class="nav-item" id="navCategories">
      <i class="fas fa-folder"></i>
      <span>Cat√©gories</span>
    </div>
    <div class="nav-item" id="navSettings">
      <i class="fas fa-cog"></i>
      <span>Param√®tres</span>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Configuration Supabase ---
    const SUPABASE_URL = 'https://cepqcretnxfhjbvdukkk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU';

    let supabase = null; // Sera initialis√© dans window.addEventListener('load')

    // --- Variables Globales ---
    let currentShareCode = null;
    let currentListId = null;
    const shoppingListToBuy = document.getElementById('shoppingListToBuy');
    // const totalRemainingItemsSpan = document.getElementById('totalRemainingItems'); // Removed as per request
    const newItemInput = document.getElementById('newItemInput');
    const newQuantityInput = document.getElementById('newQuantityInput');
    const newCategorySelect = document.getElementById('newCategorySelect');
    const addItemBtn = document.getElementById('addItemBtn');
    const shoppingListTitle = document.getElementById('shoppingListTitle'); // Added for scroll

    // Moved to settings section
    const shareCodeInput = document.getElementById('shareCodeInput');
    const loadShareCodeBtn = document.getElementById('loadShareCodeBtn');
    const addItemForm = document.getElementById('addItemForm');

    // Sections
    const shoppingListSection = document.getElementById('shoppingList');
    const buyLaterSection = document.getElementById('buyLater');
    const suggestionsSection = document.getElementById('suggestions');
    const categoriesSection = document.getElementById('categories');
    const settingsSection = document.getElementById('settings');

    // Navigation
    const navShoppingList = document.getElementById('navShoppingList');
    const navBuyLater = document.getElementById('navBuyLater');
    const navSuggestions = document.getElementById('navSuggestions');
    const navCategories = document.getElementById('navCategories');
    const navSettings = document.getElementById('navSettings');
    const bottomNav = document.querySelector('.bottom-nav'); // R√©f√©rence au menu du bas

    // Buy Later section elements
    const newBuyLaterItemInput = document.getElementById('newBuyLaterItemInput');
    const addBuyLaterItemBtn = document.getElementById('addBuyLaterItemBtn');
    const buyLaterList = document.getElementById('buyLaterList');

    // Suggestions section elements
    const suggestionsTitle = document.getElementById('suggestionsTitle'); // Added for scroll
    const suggestionCategoryFilter = document.getElementById('suggestionCategoryFilter'); // Nouveau filtre de cat√©gorie
    const newSuggestionInput = document.getElementById('newSuggestionInput');
    const newSuggestionCategorySelect = document.getElementById('newSuggestionCategorySelect');
    const addSuggestionBtn = document.getElementById('addSuggestionBtn');
    const suggestionList = document.getElementById('suggestionList');

    // Categories section elements
    const newCategoryInput = document.getElementById('newCategoryInput');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoryList = document.getElementById('categoryList');
    const categoryOrderList = document.getElementById('categoryOrderList');
    // const saveCategoryOrderBtn = document.getElementById('saveCategoryOrderBtn'); // Removed as per request

    // Settings section elements
    const activeShareCodeSpan = document.getElementById('activeShareCode');
    const changeShareCodeBtn = document.getElementById('changeShareCodeBtn');

    // Nouvelle variable pour le bouton de bascule
    const toggleNavBtn = document.getElementById('toggleNavBtn');


    // --- Cat√©gories par d√©faut ---
    const initialDefaultCategories = [
        "Fruits et L√©gumes",
        "Produits Laitiers",
        "Viandes et Poissons",
        "Produits d'√âpicerie",
        "Boulangerie",
        "Boissons",
        "Surgel√©s",
        "Entretien",
        "Hygi√®ne",
        "Autres"
    ];

    // --- Fonctions utilitaires ---
    function generateShareCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    async function handleInitialLoad() {
        let shareCode = localStorage.getItem('lastShareCode');
        if (shareCode) {
            shareCodeInput.value = shareCode; // Set the input in settings
            await getOrCreateListByShareCode(shareCode);
            showSection('shoppingList'); // Show shopping list if connected
        } else {
            // If no share code, go to settings for the user to enter one
            showSection('settings');
            // Optionally, pre-fill with a generated code to suggest creation
            shareCodeInput.value = generateShareCode();
            alert("Bienvenue ! Veuillez entrer un code de partage ou cliquez sur 'Charger/Cr√©er Liste' pour en g√©n√©rer un nouveau.");
        }
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');

        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.getElementById('nav' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1)).classList.add('active');

        // Sp√©cifique pour la section settings
        if (sectionId === 'settings') {
            activeShareCodeSpan.textContent = currentShareCode || 'N/A';
        }
        // Charger les donn√©es sp√©cifiques √† la section si n√©cessaire
        if (sectionId === 'buyLater') {
            loadBuyLaterList();
        } else if (sectionId === 'suggestions') {
            updateSuggestionCategoryFilter(); // Mettre √† jour le filtre de cat√©gories
            loadSuggestions(); // Charger les suggestions (local storage)
        } else if (sectionId === 'categories') {
            renderCategories();
            loadCategoryOrder(); // Load categories and attach drag/drop listeners
        }
    }

    // Nouvelle fonction pour basculer le menu du bas
    function toggleBottomNav() {
        const bottomNav = document.querySelector('.bottom-nav');
        const icon = toggleNavBtn.querySelector('i');

        if (bottomNav.classList.contains('hidden-nav')) {
            bottomNav.classList.remove('hidden-nav');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            bottomNav.classList.add('hidden-nav');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
        updateBodyPadding(); // Met √† jour le padding du body apr√®s le basculement
    }

    // Nouvelle fonction pour ajuster le padding-bottom du body
    function updateBodyPadding() {
        const bottomNavHeight = bottomNav.offsetHeight;
        if (bottomNav.classList.contains('hidden-nav')) {
            document.body.style.paddingBottom = '20px'; // Un petit padding quand le menu est cach√©
        } else {
            document.body.style.paddingBottom = `${bottomNavHeight + 20}px`; // Hauteur du menu + un peu d'espace
        }
    }

    function updateSupabaseHeaders(shareCode) {
        if (supabase && supabase.rest) {
            supabase.rest.headers['X-Share-Code'] = shareCode;
            console.log(`Supabase headers updated with X-Share-Code: ${shareCode}`);
        } else {
            console.warn("Supabase client non initialis√© ou rest client non pr√™t, impossible de mettre √† jour les headers.");
        }
    }

    function getCategories() {
        return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
        localStorage.setItem('user_categories', JSON.stringify(categories));
    }

    function updateAllCategorySelects() {
        const categories = getCategories();
        const selects = document.querySelectorAll('select#newCategorySelect, select#newSuggestionCategorySelect');
        selects.forEach(select => {
            select.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        });
        if (categories.length > 0) {
            newCategorySelect.value = categories[0];
            newSuggestionCategorySelect.value = categories[0];
        }
    }

    function updateSuggestionCategoryFilter() {
        const categories = getCategories();
        suggestionCategoryFilter.innerHTML = '';

        // Add "Toutes les cat√©gories" option
        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'Toutes les cat√©gories';
        suggestionCategoryFilter.appendChild(allOption);

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            suggestionCategoryFilter.appendChild(option);
        });
        suggestionCategoryFilter.value = 'all'; // Default to "All Categories"
    }

    // --- Fonctions Supabase ---

    async function getOrCreateListByShareCode(code) {
        updateSupabaseHeaders(code);

        try {
            const { data: lists, error: selectError } = await supabase
                .from('lists')
                .select('id, name')
                .eq('share_code', code);

            if (selectError && selectError.code !== '406') {
                if (selectError.code === 'PGRST400' && selectError.message.includes('406')) {
                } else {
                  throw selectError;
                }
            }

            if (lists && lists.length > 0) {
                console.log(`Liste trouv√©e pour le code ${code}:`, lists[0]);
                currentListId = lists[0].id;
                currentShareCode = code;
                localStorage.setItem('lastShareCode', shareCodeInput.value); // Save on successful load
                setupRealtimeListener(currentListId);
                loadShoppingList();
                activeShareCodeSpan.textContent = currentShareCode; // Met √† jour l'affichage dans les param√®tres
                return lists[0];
            } else {
                console.log(`Aucune liste trouv√©e pour le code ${code}. Cr√©ation d'une nouvelle liste.`);
                const newList = {
                    name: `Liste ${code}`,
                    share_code: code
                };
                const { data: createdList, error: insertError } = await supabase
                    .from('lists')
                    .insert([newList])
                    .select('id, name');

                if (insertError) {
                    console.error("Erreur lors de la cr√©ation de la liste:", insertError);
                    alert("Erreur lors de la cr√©ation de la liste: " + insertError.message);
                    return null;
                } else {
                    console.log("Nouvelle liste cr√©√©e:", createdList[0]);
                    currentListId = createdList[0].id;
                    currentShareCode = code;
                    localStorage.setItem('lastShareCode', shareCodeInput.value); // Save on successful creation
                    setupRealtimeListener(currentListId);
                    loadShoppingList();
                    activeShareCodeSpan.textContent = currentShareCode; // Met √† jour l'affichage dans les param√®tres
                    return createdList[0];
                }
            }
        } catch (error) {
            console.error("Erreur inattendue dans getOrCreateListByShareCode:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
            return null;
        }
    }

    async function updateItemQuantity(itemId, newQuantity) {
        if (!currentListId) return;

        if (newQuantity <= 0) {
            // Si la quantit√© est 0 ou moins, supprimer l'article
            await deleteItem(itemId);
            return;
        }

        try {
            const { data, error } = await supabase
                .from('list_items')
                .update({ quantity: newQuantity })
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la mise √† jour de la quantit√© de l'article:", error);
                alert("Erreur lors de la mise √† jour de la quantit√© de l'article: " + error.message);
            }
            // La liste sera recharg√©e par le listener Realtime
        } catch (error) {
            console.error("Erreur inattendue lors de la mise √† jour de la quantit√©:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function addItem(name, quantity, category, listId = currentListId) { // listId can be optional, defaults to current
        if (!listId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        try {
            // Check if item already exists in the current list
            const { data: existingItems, error: selectError } = await supabase
                .from('list_items')
                .select('id, quantity')
                .eq('list_id', listId)
                .eq('name', name)
                .eq('category', category); // Include category in check

            if (selectError) throw selectError;

            if (existingItems && existingItems.length > 0) {
                // Item exists, update its quantity
                const existingItem = existingItems[0];
                const newQuantity = existingItem.quantity + quantity;
                const { data, error: updateError } = await supabase
                    .from('list_items')
                    .update({ quantity: newQuantity })
                    .eq('id', existingItem.id);
                if (updateError) throw updateError;
                console.log(`Quantit√© de l'article '${name}' mise √† jour √† ${newQuantity}.`);
            } else {
                // Item does not exist, insert new
                const { data, error: insertError } = await supabase
                    .from('list_items')
                    .insert([{ name, quantity, category, list_id: listId }]);
                if (insertError) throw insertError;
                console.log(`Article '${name}' ajout√© √† la liste.`);
            }

            // Add category to local storage if it doesn't exist
            if (category) {
                const currentCategories = getCategories();
                if (!currentCategories.includes(category)) {
                    currentCategories.push(category);
                    saveCategories(currentCategories);
                    updateAllCategorySelects(); // Update category dropdowns
                    updateSuggestionCategoryFilter(); // Update filter dropdown
                    renderCategories(); // Re-render category list in 'G√©rer les Cat√©gories'
                    loadCategoryOrder(); // Update category order list
                }
            }

            newItemInput.value = '';
            newQuantityInput.value = '1';
        } catch (error) {
            console.error("Erreur lors de l'ajout/mise √† jour de l'article:", error);
            alert("Erreur lors de l'ajout/mise √† jour de l'article: " + error.message);
        }
    }

    async function deleteItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('list_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de l'article:", error);
                alert("Erreur lors de la suppression de l'article: " + error.message);
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadShoppingList() {
        if (!currentListId) {
            shoppingListToBuy.innerHTML = '';
            // totalRemainingItemsSpan.textContent = '0'; // Removed
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('list_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement de la liste de courses:", error);
                alert("Erreur lors du chargement de la liste: " + error.message);
                return;
            }

            shoppingListToBuy.innerHTML = '';
            // let remainingItems = 0; // Removed

            const categories = getCategories();
            const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || categories;

            const groupedItems = {};
            // Initialize groupedItems with all known categories in order
            categoryOrder.forEach(cat => groupedItems[cat] = []);
            // Add any existing categories from items that might not be in the current user_categories
            items.forEach(item => {
                const category = item.category || 'Autres';
                if (!groupedItems[category]) {
                    groupedItems[category] = [];
                }
            });

            items.forEach(item => {
                const category = item.category || 'Autres';
                groupedItems[category].push(item);
                // remainingItems++; // Removed
            });

            // Render items for each category
            categoryOrder.forEach(category => {
                if (groupedItems[category] && groupedItems[category].length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    groupedItems[category].forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });
            // Handle items with categories not in the current category order (e.g., deleted categories)
            Object.keys(groupedItems).filter(cat => !categoryOrder.includes(cat)).forEach(category => {
                if (groupedItems[category].length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    groupedItems[category].forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });

            // totalRemainingItemsSpan.textContent = remainingItems; // Removed
        } catch (error) {
            console.error("Erreur inattendue lors du chargement de la liste de courses:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    function renderListItem(item, listElement) {
        const li = document.createElement('li');
        li.dataset.id = item.id;

        const itemInfo = document.createElement('div');
        itemInfo.classList.add('item-info');

        // Quantity control (moved to the left)
        const quantityControl = document.createElement('div');
        quantityControl.classList.add('quantity-control');

        const minusBtn = document.createElement('button');
        minusBtn.textContent = '-';
        minusBtn.onclick = () => updateItemQuantity(item.id, item.quantity - 1);
        quantityControl.appendChild(minusBtn);

        const quantitySpan = document.createElement('span');
        quantitySpan.textContent = item.quantity;
        quantityControl.appendChild(quantitySpan);

        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.onclick = () => updateItemQuantity(item.id, item.quantity + 1);
        quantityControl.appendChild(plusBtn);

        itemInfo.appendChild(quantityControl); // Append quantityControl first

        // Item name
        const itemName = document.createElement('span');
        itemName.textContent = item.name;
        itemInfo.appendChild(itemName); // Append itemName second

        li.appendChild(itemInfo);

        const itemActions = document.createElement('div');
        itemActions.classList.add('item-actions');

        const removeBtn = document.createElement('button');
        removeBtn.classList.add('remove-btn');
        removeBtn.onclick = () => deleteItem(item.id);
        itemActions.appendChild(removeBtn);

        li.appendChild(itemActions);
        listElement.appendChild(li);
    }

    function setupRealtimeListener() {
      if (window.supabaseChannel) {
          supabase.removeChannel(window.supabaseChannel);
      }

      if (!currentListId) {
          console.warn("Pas de currentListId d√©fini, impossible de configurer le listener Realtime.");
          return;
      }

      window.supabaseChannel = supabase.channel(`list_items_changes:${currentListId}`)
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'list_items',
            filter: `list_id=eq.${currentListId}`
        }, (payload) => {
            console.log('Changement Realtime d√©tect√©:', payload);
            loadShoppingList();
        })
        .subscribe();

        // Listener pour les changements sur buy_later_items
        window.supabaseBuyLaterChannel = supabase.channel(`buy_later_items_changes:${currentListId}`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'buy_later_items',
                filter: `list_id=eq.${currentListId}`
            }, (payload) => {
                console.log('Changement Buy Later Realtime d√©tect√©:', payload);
                if (document.getElementById('buyLater').classList.contains('hidden')) {
                  // Ne recharger que si la section est active pour √©viter des appels inutiles
                } else {
                  loadBuyLaterList();
                }
            })
            .subscribe();

      console.log(`Listeners Realtime configur√©s pour list_id: ${currentListId}`);
    }


    // --- Fonctions Buy Later (Supabase) ---
    async function addBuyLaterItem(name) {
        if (!currentListId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .insert([{ name, list_id: currentListId }]);
            if (error) {
                console.error("Erreur lors de l'ajout de l'article 'Acheter Plus Tard':", error);
                alert("Erreur lors de l'ajout de l'article 'Acheter Plus Tard': " + error.message);
            } else {
                // loadBuyLaterList est g√©r√© par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de l'ajout de l'article 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function deleteBuyLaterItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de l'article 'Acheter Plus Tard':", error);
                alert("Erreur lors de la suppression de l'article 'Acheter Plus Tard': " + error.message);
            } else {
                // loadBuyLaterList est g√©r√© par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression d'article 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadBuyLaterList() {
        if (!currentListId) {
            buyLaterList.innerHTML = '';
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('buy_later_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement de la liste 'Acheter Plus Tard':", error);
                alert("Erreur lors du chargement de la liste 'Acheter Plus Tard': " + error.message);
                return;
            }

            buyLaterList.innerHTML = '';
            if (items.length === 0) {
                buyLaterList.innerHTML = '<p style="text-align: center; color: #C71585; margin-top: 0.5rem;">Aucun article √† acheter plus tard pour le moment.</p>';
                return;
            }

            items.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${item.name}</span>
                    <div class="item-actions">
                        <button class="remove-btn" onclick="deleteBuyLaterItem('${item.id}')"><span>X</span></button>
                    </div>
                `;
                buyLaterList.appendChild(li);
            });
        } catch (error) {
            console.error("Erreur inattendue lors du chargement de la liste 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    // --- Fonctions Cat√©gories (local storage) ---
    function addCategory(categoryName) {
        if (!categoryName.trim()) {
            alert('Veuillez entrer un nom de cat√©gorie.');
            return;
        }
        let categories = getCategories();
        if (categories.some(cat => cat.toLowerCase() === categoryName.trim().toLowerCase())) {
            alert(`La cat√©gorie "${categoryName.trim()}" existe d√©j√† !`);
            return;
        }
        categories.push(categoryName.trim());
        saveCategories(categories);
        newCategoryInput.value = '';
        renderCategories(); // Re-render the categories list
        loadCategoryOrder(); // Update category order list and re-attach listeners
    }

    function deleteCategory(categoryName) {
        if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${categoryName}" ? Cela supprimera √©galement toutes les suggestions li√©es √† celle-ci.`)) {
            return;
        }
        let categories = getCategories();
        categories = categories.filter(cat => cat !== categoryName);
        saveCategories(categories);
        renderCategories(); // Re-render the categories list

        // Also delete suggestions associated with this category
        let suggestions = JSON.parse(localStorage.getItem('shopping_suggestions')) || [];
        suggestions = suggestions.filter(sug => sug.category !== categoryName);
        localStorage.setItem('shopping_suggestions', JSON.stringify(suggestions));
        loadSuggestions(); // Refresh suggestions list
    }

    function renderCategories() {
        const categories = getCategories();
        categoryList.innerHTML = ''; // Clear existing list
        if (categories.length === 0) {
            categoryList.innerHTML = '<p style="text-align: center; color: #C71585; margin-top: 0.5rem;">Aucune cat√©gorie d√©finie pour le moment. Ajoutez-en ci-dessus !</p>';
            return;
        }
        categories.forEach(category => {
            const li = document.createElement('li');
            li.dataset.category = category; // Add data-category for easier targeting

            const categoryNameSpan = document.createElement('span');
            categoryNameSpan.textContent = category;
            li.appendChild(categoryNameSpan);

            // Delete button for categories - using Font Awesome X icon
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('remove-btn'); // Use existing remove-btn style
            deleteBtn.innerHTML = '<i class="fas fa-xmark"></i>'; // Simple cross icon
            deleteBtn.onclick = () => deleteCategory(category);
            li.appendChild(deleteBtn);

            categoryList.appendChild(li);
        });
    }

    // Drag and drop for Category Order (local storage)
    let draggedItem = null;

    function loadCategoryOrder() {
        const categories = getCategories();
        let categoryOrder = JSON.parse(localStorage.getItem('category_order')) || categories;

        // Ensure all current categories are in the order, add new ones to the end
        const existingOrderSet = new Set(categoryOrder);
        categories.forEach(cat => {
            if (!existingOrderSet.has(cat)) {
                categoryOrder.push(cat);
            }
        });
        // Remove categories that no longer exist
        categoryOrder = categoryOrder.filter(cat => categories.includes(cat));

        localStorage.setItem('category_order', JSON.stringify(categoryOrder)); // Save the cleaned/updated order

        categoryOrderList.innerHTML = '';
        categoryOrder.forEach(category => {
            const li = document.createElement('li');
            li.textContent = category;
            li.setAttribute('draggable', 'true');
            li.dataset.category = category; // Store category name in data attribute

            // Add drag handle for better UX
            const dragHandle = document.createElement('span');
            dragHandle.classList.add('drag-handle');
            dragHandle.innerHTML = '<i class="fas fa-bars"></i>'; // Font Awesome bars icon
            li.prepend(dragHandle);

            categoryOrderList.appendChild(li);
        });

        // Re-attach event listeners after rendering
        addDragDropListeners();
    }

    function addDragDropListeners() {
        const listItems = categoryOrderList.querySelectorAll('li');

        listItems.forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                setTimeout(() => {
                    item.classList.add('dragging');
                }, 0);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', item.innerHTML); // Required for Firefox
            });

            item.addEventListener('dragend', () => {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
                saveCategoryOrderDirectly(); // Auto-save after drag end
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault(); // Allow drop
                const bounding = item.getBoundingClientRect();
                const offset = bounding.y + (bounding.height / 2);
                if (e.clientY - offset > 0) {
                    item.style.borderBottom = '2px solid #E75480';
                    item.style.borderTop = '';
                } else {
                    item.style.borderTop = '2px solid #E75480';
                    item.style.borderBottom = '';
                }
            });

            item.addEventListener('dragleave', () => {
                item.style.borderBottom = '';
                item.style.borderTop = '';
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedItem === item) {
                    return;
                }
                item.style.borderBottom = '';
                item.style.borderTop = '';

                const dropZone = e.clientY - item.getBoundingClientRect().y > item.offsetHeight / 2 ? 'after' : 'before';

                if (dropZone === 'after') {
                    item.parentNode.insertBefore(draggedItem, item.nextSibling);
                } else {
                    item.parentNode.insertBefore(draggedItem, item);
                }
                // No need to call saveCategoryOrderDirectly here, dragend will handle it
            });
        });
    }

    function saveCategoryOrderDirectly() {
        const newOrder = Array.from(categoryOrderList.children).map(li => li.dataset.category);
        localStorage.setItem('category_order', JSON.stringify(newOrder));
        loadShoppingList(); // Reload shopping list to reflect new order
    }


    // --- Fonctions Suggestions (local storage) ---

    function loadSuggestions() {
        let allSuggestions = JSON.parse(localStorage.getItem('shopping_suggestions')) || [];
        suggestionList.innerHTML = '';

        const selectedCategory = suggestionCategoryFilter.value;

        let filteredSuggestions = selectedCategory === 'all'
            ? allSuggestions
            : allSuggestions.filter(sug => sug.category === selectedCategory);

        filteredSuggestions.sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));

        if (filteredSuggestions.length === 0) {
            suggestionList.innerHTML = '<p style="text-align: center; color: #C71585; margin-top: 0.5rem;">Aucune suggestion pour cette cat√©gorie. Ajoutez-en ci-dessous !</p>';
        }

        filteredSuggestions.forEach((suggestion) => {
            const li = document.createElement('li'); // Create li instead of div
            li.classList.add('suggestion-item'); // Add class

            const suggestionTextSpan = document.createElement('span');
            suggestionTextSpan.classList.add('suggestion-item-text');
            suggestionTextSpan.textContent = suggestion.name;
            li.appendChild(suggestionTextSpan);

            const deleteSuggestionBtn = document.createElement('button');
            deleteSuggestionBtn.classList.add('remove-btn');
            deleteSuggestionBtn.innerHTML = '<i class="fas fa-xmark"></i>';
            deleteSuggestionBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm(`Supprimer la suggestion "${suggestion.name}" (${suggestion.category}) ?`)) {
                    deleteSuggestion(suggestion.name, suggestion.category);
                }
            };
            li.appendChild(deleteSuggestionBtn);

            suggestionTextSpan.addEventListener('click', () => {
                addItem(suggestion.name, 1, suggestion.category);
            });

            suggestionList.appendChild(li);
        });
    }

    function addSuggestion(suggestionName, category) {
      if (!suggestionName.trim() || !category.trim()) {
        alert('Veuillez entrer un nom de suggestion ET choisir une cat√©gorie.');
        return;
      }

      let suggestions = JSON.parse(localStorage.getItem('shopping_suggestions')) || [];
      const lowerCaseSuggestionName = suggestionName.trim().toLowerCase();

      if (!suggestions.some(sug => sug.name.toLowerCase() === lowerCaseSuggestionName && sug.category === category)) {
          suggestions.push({ name: suggestionName.trim(), category: category.trim() });
          localStorage.setItem('shopping_suggestions', JSON.stringify(suggestions));
          loadSuggestions();
          newSuggestionInput.value = ''; // Clear input
          newSuggestionCategorySelect.value = getCategories()[0] || ''; // Reset category select
      } else {
          alert(`"${suggestionName.trim()}" est d√©j√† une suggestion dans la cat√©gorie "${category}" !`);
      }
    }

    function deleteSuggestion(name, category) {
        let suggestions = JSON.parse(localStorage.getItem('shopping_suggestions')) || [];
        const updatedSuggestions = suggestions.filter(sug => !(sug.name === name && sug.category === category));
        localStorage.setItem('shopping_suggestions', JSON.stringify(updatedSuggestions));
        loadSuggestions();
    }


    // --- Event Listeners ---
    addItemBtn.addEventListener('click', () => {
        const name = newItemInput.value;
        const quantity = parseInt(newQuantityInput.value) || 1;
        const category = newCategorySelect.value;
        addItem(name, quantity, category);
    });

    addBuyLaterItemBtn.addEventListener('click', () => {
        const name = newBuyLaterItemInput.value;
        if (name) {
            addBuyLaterItem(name);
        } else {
            alert("Veuillez entrer un article.");
        }
    });

    addSuggestionBtn.addEventListener('click', () => {
        const name = newSuggestionInput.value;
        const category = newSuggestionCategorySelect.value;
        addSuggestion(name, category);
    });

    addCategoryBtn.addEventListener('click', () => {
        const name = newCategoryInput.value;
        addCategory(name);
    });

    categoryList.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-btn') || e.target.closest('.remove-btn')) {
            const btn = e.target.closest('.remove-btn');
            const categoryName = btn.parentNode.dataset.category;
            if (categoryName) {
                deleteCategory(categoryName);
            }
        }
    });

    // Navigation event listeners
    navShoppingList.addEventListener('click', () => showSection('shoppingList'));
    navBuyLater.addEventListener('click', () => showSection('buyLater'));
    navSuggestions.addEventListener('click', () => showSection('suggestions'));
    navCategories.addEventListener('click', () => showSection('categories'));
    navSettings.addEventListener('click', () => showSection('settings'));

    toggleNavBtn.addEventListener('click', toggleBottomNav);

    // Filter suggestions by category
    suggestionCategoryFilter.addEventListener('change', loadSuggestions);


    // Share code / Settings
    loadShareCodeBtn.addEventListener('click', async () => {
        const code = shareCodeInput.value.trim().toUpperCase();
        if (code) {
            await getOrCreateListByShareCode(code);
        } else {
            alert("Veuillez entrer un code de partage ou cliquez sur 'Charger/Cr√©er Liste' pour en g√©n√©rer un nouveau.");
        }
    });

    changeShareCodeBtn.addEventListener('click', () => {
        currentShareCode = null;
        currentListId = null;
        localStorage.removeItem('lastShareCode');
        if (window.supabaseChannel) {
            supabase.removeChannel(window.supabaseChannel);
        }
        if (window.supabaseBuyLaterChannel) {
            supabase.removeChannel(window.supabaseBuyLaterChannel);
        }
        alert("Vous avez √©t√© d√©connect√© de la liste actuelle. Veuillez entrer un nouveau code de partage.");
        shareCodeInput.value = generateShareCode(); // Propose a new code
        activeShareCodeSpan.textContent = 'N/A';
        shoppingListToBuy.innerHTML = ''; // Clear shopping list
        buyLaterList.innerHTML = ''; // Clear buy later list
        // Reload all selects and lists for fresh start
        updateAllCategorySelects();
        renderCategories();
        loadCategoryOrder();
        loadSuggestions();
        showSection('settings'); // Go back to settings
    });

    // --- Initialization on page load ---
    window.addEventListener('load', async () => {
        if (!localStorage.getItem('user_categories')) {
            localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
        }

        updateAllCategorySelects();

        // Initialisation du client Supabase
        if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase client initialized successfully.");
        } else {
            console.error("Erreur: La fonction 'createClient' de Supabase n'est pas d√©finie ou la biblioth√®que Supabase n'est pas charg√©e correctement.");
            alert("Erreur de chargement: La biblioth√®que Supabase n'a pas pu √™tre initialis√©e. V√©rifiez votre connexion internet ou la configuration.");
            return;
        }

        let attempts = 0;
        const maxAttempts = 20;
        const delayMs = 50;

        while (!supabase.rest && attempts < maxAttempts) {
            console.log(`Attente de supabase.rest (tentative ${attempts + 1}/${maxAttempts})...`);
            await new Promise(resolve => setTimeout(resolve, delayMs));
            attempts++;
        }

        if (supabase.rest) {
            console.log("supabase.rest est maintenant pr√™t !");
            await handleInitialLoad(); // This calls getOrCreateListByShareCode which calls loadShoppingList() and setupRealtimeListener()
            updateBodyPadding(); // Met √† jour le padding du body au chargement initial
        } else {
            console.error("Erreur: supabase.rest n'est pas devenu pr√™t apr√®s plusieurs tentatives. Impossible de d√©marrer l'application.");
            return;
        }

        // Show default section and load its content
        showSection('shoppingList'); // Ensure shoppingList is active on initial load
    });
  </script>
</body>
</html>