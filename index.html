<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shopping List 🛒</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 1rem;
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: none;
    }
    .section-container.active {
        display: block;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: bold;
      color: #6A057F;
    }
    input, button, select {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.4rem;
      border: 1px solid #DDA0DD;
      border-radius: 0.5rem;
      box-sizing: border-box;
      color: #333;
      font-size: 1rem;
    }
    button {
      background: #FF69B4;
      color: #FFFFFF;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover {
      background: #C71585;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    select {
        background: #F8F8FF;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='%23C71585' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%;
        background-size: 0.65em auto;
        padding-right: 2.5em;
    }

    /* Styles for navigation buttons */
    .navigation-buttons {
        text-align: center;
        margin-bottom: 2rem;
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }
    .navigation-buttons button {
        width: auto;
        padding: 0.8rem 1.8rem;
        font-size: 1.1rem;
        background-color: #EE82EE;
        color: #FFFFFF;
        border: 2px solid #DA70D6;
        border-radius: 25px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: inline-flex; /* Use flex to align icon and text */
        align-items: center;
        justify-content: center;
    }
    .navigation-buttons button.active {
        background: #FFD700;
        color: #6A057F;
        border-color: #FFA500;
        font-weight: bold;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .navigation-buttons button:hover:not(.active) {
        background-color: #DDA0DD;
        border-color: #BA55D3;
    }
    .navigation-buttons .toggle-options-btn {
        background-color: #9370DB; /* Couleur différente pour le bouton toggle */
        border-color: #8A2BE2;
        padding: 0.8rem 1.2rem; /* Plus petit pour l'icône */
    }
    .navigation-buttons .toggle-options-btn:hover {
        background-color: #8A2BE2;
        border-color: #6A057F;
    }
    .navigation-buttons .toggle-options-btn i {
        transition: transform 0.3s ease;
    }
    .navigation-buttons .option-button {
        display: none; /* Hidden by default */
    }
    .navigation-buttons.show-options .option-button {
        display: inline-flex; /* Show when parent has show-options class */
    }

    /* Styles for the shopping list */
    .shopping-list-item, .buy-later-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFF0F5;
      padding: 0.7rem 1.2rem;
      margin-top: 0.7rem;
      border-radius: 0.75rem;
      font-size: 1.1rem;
      color: #6A057F;
      border: 1px solid #FFC0CB;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      /* Prevent text selection on drag for iOS/Safari */
      -webkit-user-select: none; /* Safari */
      -moz-user-select: none;    /* Firefox */
      -ms-user-select: none;     /* IE10+ */
      user-select: none;         /* Standard */
    }
    .shopping-list-item .delete-btn, 
    .shopping-list-item .decrement-btn,
    .buy-later-item .delete-btn {
      background: none;
      border: none;
      color: #FF6347;
      font-size: 1.6rem;
      cursor: pointer;
      padding: 0 0.5rem;
      margin: 0;
      width: auto;
      transition: color 0.3s ease;
      line-height: 1; /* Ensure consistent vertical alignment */
    }
    .shopping-list-item .decrement-btn {
        color: #6A057F; /* Darker color for decrement */
        font-size: 1.8rem; /* Slightly larger for visibility */
        margin-right: 5px; /* Space between - and quantity */
    }
    .shopping-list-item .delete-btn:hover, 
    .buy-later-item .delete-btn:hover {
      color: #DC143C;
    }
    .shopping-list-item .decrement-btn:hover {
        color: #8A2BE2; /* Change color on hover for decrement */
    }

    .shopping-list-item span, .buy-later-item span {
        flex-grow: 1;
        padding-right: 10px;
    }
    .quantity {
        font-weight: bold;
        margin-left: 8px; /* Space after quantity */
        margin-right: 8px; /* Space before quantity if decrement is present */
        color: #FF8C00;
        min-width: 20px; /* Ensure space for quantity */
        text-align: center;
    }

    /* Styles for the suggestions list */
    .suggestions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 0.7rem;
      margin-top: 1.5rem;
    }
    .suggestion-item {
      position: relative;
      background: #9370DB;
      color: #FFFFFF;
      padding: 0.6rem 1rem;
      border-radius: 0.75rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      white-space: nowrap; /* Prevent wrapping */
      overflow: hidden; /* Hide overflow */
      text-overflow: ellipsis; /* Add ellipsis for overflowed text */
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-right: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .suggestion-item:hover {
      background: #8A2BE2;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .suggestion-item-text {
        flex-grow: 1;
        padding-right: 5px;
        font-weight: 500;
        overflow: hidden; /* Ensure text overflow ellipsis works */
        text-overflow: ellipsis;
        white-space: nowrap; /* Keep on single line */
    }
    .delete-suggestion-btn {
      background: none;
      border: none;
      color: #FFD700;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 0 0.2rem;
      margin: 0;
      width: auto;
      transition: color 0.3s ease;
      line-height: 1;
      flex-shrink: 0; /* Prevent button from shrinking */
    }
    .delete-suggestion-btn:hover {
      color: #FF4500;
    }

    .add-form { /* General style for add forms */
        margin-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
        padding-top: 1rem;
    }
    .filter-controls {
        margin-bottom: 1.5rem;
    }

    /* Style for empty list text */
    p[style*="text-align: center"] {
        color: #C71585 !important;
        font-style: italic;
        font-size: 0.95rem;
    }

    /* Category order list styles */
    #categoryOrderList, #manageCategoryList {
        list-style: none;
        padding: 0;
    }
    #categoryOrderList li, #manageCategoryList li {
        background: #F8F8FF;
        border: 1px solid #DDA0DD;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        color: #6A057F;
        cursor: grab; /* Indicate draggable */
        transition: background-color 0.2s ease, transform 0.2s ease;
        /* Prevent text selection on drag for iOS/Safari */
        -webkit-user-select: none; /* Safari */
        -moz-user-select: none;    /* Firefox */
        -ms-user-select: none;     /* IE10+ */
        user-select: none;         /* Standard */
    }
    #categoryOrderList li:hover {
        background-color: #E6E6FA;
        transform: scale(1.01);
    }
    #categoryOrderList li.dragging {
        opacity: 0.7;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .drag-handle {
        font-size: 1.5rem;
        cursor: grab;
        margin-right: 10px;
        color: #EE82EE;
    }
    #manageCategoryList li .delete-category-btn {
        background: none;
        border: none;
        color: #FF6347;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0 0.2rem;
        margin-left: 10px;
        transition: color 0.3s ease;
    }
    #manageCategoryList li .delete-category-btn:hover {
        color: #DC143C;
    }

    /* Styles for the new "Manage Categories" subsection */
    .manage-categories-subsection {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #DDA0DD;
    }
    .manage-categories-subsection h3 {
        color: #E75480;
        text-align: center;
        margin-bottom: 1rem;
    }

    /* Styles for share code section */
    .share-code-section {
        max-width: 600px;
        margin: 1rem auto;
        background: #FFFFFF;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 2rem;
    }
    .share-code-section h2 {
        margin-bottom: 1rem;
    }
    .share-code-section input {
        margin-bottom: 1rem;
    }
    .current-list-display {
        background: #F8F8FF;
        padding: 0.7rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
        font-weight: bold;
        color: #6A057F;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }
    .current-list-display button {
        width: auto;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        margin: 0;
        flex-shrink: 0;
    }

    @media (max-width: 640px) {
        .suggestions-grid {
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        }
        .navigation-buttons button {
          padding: 0.6rem 1rem;
          font-size: 0.9rem;
        }
        .navigation-buttons .toggle-options-btn {
            padding: 0.6rem 1rem; /* Adjust padding for smaller screens */
        }
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.error('SW error:', err));
      });
    }
  </script>
</head>
<body>
  <h1>My Shopping List 🛒</h1>

  <div class="share-code-section">
      <h2>Connect to Your List</h2>
      <p id="currentListDisplay" class="current-list-display">Not connected</p>
      <label for="shareCodeInput">Enter List Code:</label>
      <input type="text" id="shareCodeInput" placeholder="Enter a code or leave blank for new list" />
      <button id="connectListBtn">Connect / Create List</button>
  </div>

  <div class="navigation-buttons" id="navigationButtonsContainer">
    <button id="showShoppingListBtn" class="active">My List</button>
    <button id="toggleOptionsBtn" class="toggle-options-btn"><i class="fas fa-chevron-up"></i></button>
    <button id="showSuggestionsBtn" class="option-button">Suggestions</button>
    <button id="showCategoryOrderBtn" class="option-button">Order by Category</button>
    <button id="showBuyLaterBtn" class="option-button">Buy Later</button>
  </div>

  <div id="shoppingListSection" class="section-container active">
    <h2>Items to Buy</h2>
    <div id="shoppingList" style="margin-top: 1rem;">
      </div>
    <form id="shoppingForm" autocomplete="off" class="add-form">
        <label for="newItem">Add an item:</label>
        <input type="text" id="newItem" placeholder="Ex: Milk, Bread, Apples..." required />
        <button type="submit">Add to List ✅</button>
    </form>
  </div>

  <div id="suggestionsSection" class="section-container">
    <h2>Suggestions by Category</h2>
    <div class="filter-controls">
        <label for="categoryFilter">Filter by category:</label>
        <select id="categoryFilter">
            </select>
    </div>
    <div id="suggestionsList" class="suggestions-grid">
      </div>

    <form id="addSuggestionForm" autocomplete="off" class="add-form">
        <label for="newSuggestion">New suggestion:</label>
        <input type="text" id="newSuggestion" placeholder="Ex: Cheese, Chocolate..." required />
        
        <label for="suggestionCategory">Category:</label>
        <select id="suggestionCategory" required>
            </select>
        
        <button type="submit">Add as suggestion ✨</button>
    </form>
  </div>

  <div id="categoryOrderSection" class="section-container">
    <h2>Order Categories</h2>
    <p style="text-align: center; color: #6A057F; margin-top: 0.5rem;">Drag and drop categories to set their order in 'My List'.</p>
    <ul id="categoryOrderList">
        </ul>

    <div class="manage-categories-subsection">
        <h3>Manage Categories</h3>
        <form id="addCategoryForm" autocomplete="off" class="add-form">
            <label for="newCategoryName">Add new category:</label>
            <input type="text" id="newCategoryName" placeholder="Ex: Pet Food, Snacks..." required />
            <button type="submit">Add Category ➕</button>
        </form>
        <ul id="manageCategoryList">
            </ul>
    </div>
  </div>

  <div id="buyLaterSection" class="section-container">
    <h2>Items to Buy Later</h2>
    <div id="buyLaterList" style="margin-top: 1rem;">
    </div>
    <form id="buyLaterForm" autocomplete="off" class="add-form">
        <label for="newBuyLaterItem">Add item to buy later:</label>
        <input type="text" id="newBuyLaterItem" placeholder="Ex: New book, Fancy gadget..." required />
        <button type="submit">Add to Buy Later ➡️</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Supabase Configuration ---
    // REMPLACEZ CES VALEURS PAR LES VÔTRES !
    const supabaseUrl = 'https://cepqcretnxfhjbvdukkk.supabase.co'; // Exemple: 'https://abcdefghijk.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU'; // Exemple: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdo...
    
    const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

    // --- Global State for Supabase List Management ---
    let currentShareCode = null;
    let currentListId = null;
    let REALTIME_SUBSCRIPTION = null;

    // --- DOM Elements ---
    const shoppingForm = document.getElementById('shoppingForm');
    const newItemInput = document.getElementById('newItem');
    const shoppingListDiv = document.getElementById('shoppingList');

    const addSuggestionForm = document.getElementById('addSuggestionForm');
    const newSuggestionInput = document.getElementById('newSuggestion');
    const suggestionCategorySelect = document.getElementById('suggestionCategory');
    const suggestionsListDiv = document.getElementById('suggestionsList');
    const categoryFilterSelect = document.getElementById('categoryFilter');

    const buyLaterForm = document.getElementById('buyLaterForm');
    const newBuyLaterItemInput = document.getElementById('newBuyLaterItem');
    const buyLaterListDiv = document.getElementById('buyLaterList');

    const addCategoryForm = document.getElementById('addCategoryForm');
    const newCategoryNameInput = document.getElementById('newCategoryName');
    const manageCategoryList = document.getElementById('manageCategoryList');

    // Navigation buttons
    const navigationButtonsContainer = document.getElementById('navigationButtonsContainer');
    const showShoppingListBtn = document.getElementById('showShoppingListBtn');
    const toggleOptionsBtn = document.getElementById('toggleOptionsBtn');
    const toggleOptionsIcon = toggleOptionsBtn.querySelector('i');
    const showSuggestionsBtn = document.getElementById('showSuggestionsBtn');
    const showCategoryOrderBtn = document.getElementById('showCategoryOrderBtn');
    const showBuyLaterBtn = document.getElementById('showBuyLaterBtn');

    // Sections
    const shoppingListSection = document.getElementById('shoppingListSection');
    const suggestionsSection = document.getElementById('suggestionsSection');
    const categoryOrderSection = document.getElementById('categoryOrderSection');
    const buyLaterSection = document.getElementById('buyLaterSection');

    const categoryOrderList = document.getElementById('categoryOrderList');

    // Share code elements
    const shareCodeInput = document.getElementById('shareCodeInput');
    const connectListBtn = document.getElementById('connectListBtn');
    const currentListDisplay = document.getElementById('currentListDisplay');


    // Default categories (now only for initial setup)
    const initialDefaultCategories = [
        "Petit déjeuner", "Boisson", "Viande", "Fruit", "Légume",
        "Produit ménager", "Produit de beauté", "Autre"
    ];

    // --- Supabase Helper Functions ---

    // Function to update Supabase headers with the current share code
    function updateSupabaseHeaders() {
        if (currentShareCode) {
            supabase.rest.headers.set('X-Share-Code', currentShareCode);
            console.log('Supabase headers updated with X-Share-Code:', currentShareCode);
            currentListDisplay.innerHTML = `Connected to: <strong>${currentShareCode}</strong> <button id="changeListBtn">Change List</button>`;
            document.getElementById('changeListBtn').addEventListener('click', promptForShareCode);
        } else {
            supabase.rest.headers.delete('X-Share-Code');
            console.log('Supabase X-Share-Code header removed.');
            currentListDisplay.innerHTML = `Not connected <button id="changeListBtn">Connect to List</button>`;
            document.getElementById('changeListBtn').addEventListener('click', promptForShareCode);
        }
    }

    // Function to set up the Realtime listener for the current list
    function setupRealtimeListener() {
        // Unsubscribe from previous subscription if exists
        if (REALTIME_SUBSCRIPTION) {
            REALTIME_SUBSCRIPTION.unsubscribe();
            REALTIME_SUBSCRIPTION = null;
            console.log('Unsubscribed from previous Realtime listener.');
        }

        if (currentListId) {
            REALTIME_SUBSCRIPTION = supabase
                .channel(`items_for_list_${currentListId}`)
                .on(
                    'postgres_changes',
                    {
                        event: '*', // Listen for all events (INSERT, UPDATE, DELETE)
                        schema: 'public',
                        table: 'items', // Listen for changes on your 'items' table
                        filter: `list_id=eq.${currentListId}` // Only listen for items related to current list_id
                    },
                    (payload) => {
                        console.log('Realtime change received for current list:', payload);
                        // When a change arrives, reload the list for everyone
                        loadShoppingList();
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('Realtime listener configured for list_id:', currentListId);
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('Realtime channel error:', status);
                    }
                });
        } else {
            console.warn('No list ID available for Realtime subscription.');
        }
    }

    // Function to connect to a list via share code (or create if not exists)
    async function connectToListByShareCode(code) {
        if (!code) { // If no code provided, generate a new one
            code = Math.random().toString(36).substring(2, 8); // Simple random code
            alert(`No code entered. Creating a new list with code: ${code}`);
        }
        
        code = code.trim(); // Trim whitespace

        try {
            // Try to find the list
            let { data: list, error: fetchError } = await supabase
                .from('lists')
                .select('id, name, share_code')
                .eq('share_code', code)
                .single();

            if (fetchError && fetchError.code === 'PGRST116') { // No rows found
                console.log(`Aucune liste trouvée pour le code ${code}. Création d'une nouvelle liste.`);
                const listName = `Ma liste ${code}`; // Simple name for new list
                let { data: newlist, error: createError } = await supabase
                    .from('lists')
                    .insert([{ name: listName, share_code: code }])
                    .select('id, name, share_code')
                    .single();

                if (createError) {
                    console.error('Erreur lors de la création de la liste:', createError);
                    alert('Failed to create new list: ' + createError.message);
                    currentShareCode = null;
                    currentListId = null;
                    updateSupabaseHeaders(); // Reset display
                    return;
                }
                console.log('Nouvelle liste créée:', newlist);
                list = newlist; // Use the newly created list
            } else if (fetchError) {
                console.error('Erreur lors de la recherche de la liste:', fetchError);
                alert('Failed to connect to list: ' + fetchError.message);
                currentShareCode = null;
                currentListId = null;
                updateSupabaseHeaders(); // Reset display
                return;
            }

            // Successfully connected or created
            currentShareCode = list.share_code;
            currentListId = list.id;
            localStorage.setItem('last_share_code', currentShareCode); // Remember code
            updateSupabaseHeaders(); // Update headers with new share code
            setupRealtimeListener(); // Setup Realtime for the new list ID
            loadShoppingList(); // Load items for the newly connected list
            alert(`Connecté à la liste: ${list.name} (Code: ${currentShareCode})`);
            shareCodeInput.value = ''; // Clear input field
            console.log(`Connecté à la liste: ${list.name} (ID: ${currentListId}, Code: ${currentShareCode})`);

        } catch (error) {
            console.error('Erreur inattendue lors de la connexion/création de la liste:', error);
            alert('An unexpected error occurred while connecting/creating the list.');
            currentShareCode = null;
            currentListId = null;
            updateSupabaseHeaders(); // Reset display
        }
    }

    // Function to prompt for share code on load or when changing list
    async function promptForShareCode() {
        let code = localStorage.getItem('last_share_code');
        if (!code) {
             // Use the new input field for the code
             currentListDisplay.innerHTML = `<input type="text" id="shareCodePromptInput" placeholder="Enter list code..." value="${shareCodeInput.value}"/> <button id="confirmShareCodeBtn">Go</button>`;
             document.getElementById('confirmShareCodeBtn').addEventListener('click', async () => {
                 const input = document.getElementById('shareCodePromptInput');
                 if (input) {
                     await connectToListByShareCode(input.value);
                 }
             });
             // Also listen to the main connectListBtn if the input is used there
             connectListBtn.removeEventListener('click', handleConnectListBtnClick); // Remove existing
             connectListBtn.addEventListener('click', handleConnectListBtnClick); // Re-add for main use
        } else {
            console.log('Found saved share code:', code);
            shareCodeInput.value = code; // Pre-fill the input field
            await connectToListByShareCode(code);
        }
    }

    async function handleConnectListBtnClick() {
        await connectToListByShareCode(shareCodeInput.value);
    }


    // --- Category Management (core functions) ---

    function getCategories() {
        return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
        localStorage.setItem('user_categories', JSON.stringify(categories));
        updateAllCategorySelects(); // Update all selects when categories change
        loadCategoryOrder(); // Update order list (also reloads manage list within it now)
        loadShoppingList(); // Reload shopping list to reflect category changes
        loadSuggestions(); // Reload suggestions to reflect category changes
    }

    function addCategory(categoryName) {
        if (!categoryName.trim()) {
            alert('Please enter a category name.');
            return;
        }
        let categories = getCategories();
        if (categories.some(cat => cat.toLowerCase() === categoryName.trim().toLowerCase())) {
            alert(`Category "${categoryName.trim()}" already exists!`);
            return;
        }
        categories.push(categoryName.trim());
        saveCategories(categories);
        newCategoryNameInput.value = '';
    }

    function deleteCategory(categoryName) {
        if (!confirm(`Are you sure you want to delete the category "${categoryName}"? This will also remove any suggestions linked to it.`)) {
            return;
        }
        let categories = getCategories();
        categories = categories.filter(cat => cat !== categoryName);
        saveCategories(categories);

        // Also delete suggestions associated with this category
        let suggestions = JSON.parse(localStorage.getItem('shopping_suggestions')) || [];
        suggestions = suggestions.filter(sug => sug.category !== categoryName);
        localStorage.setItem('shopping_suggestions', JSON.stringify(suggestions));
        loadSuggestions(); // Refresh suggestions list
    }

    function updateAllCategorySelects() {
        const categories = getCategories();
        const allCategoryOptions = ['Toutes', ...categories]; // Add 'Toutes' for filter

        // Update categoryFilterSelect
        categoryFilterSelect.innerHTML = '';
        allCategoryOptions.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            categoryFilterSelect.appendChild(option);
        });

        // Update suggestionCategorySelect
        suggestionCategorySelect.innerHTML = '<option value="">Choisir une catégorie</option>';
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            suggestionCategorySelect.appendChild(option);
        });
    }

    function loadManageCategories() {
        const categories = getCategories();
        manageCategoryList.innerHTML = '';
        if (categories.length === 0) {
            manageCategoryList.innerHTML = '<p style="text-align: center; color: #C71585; margin-top: 0.5rem;">No categories defined yet. Add some above!</p>';
            return;
        }
        categories.forEach(category => {
            const li = document.createElement('li');
            li.textContent = category;
            li.innerHTML = `
                <span>${category}</span>
                <button class="delete-category-btn" data-category="${category}">✖</button>
            `;
            manageCategoryList.appendChild(li);
        });
    }

    // --- Shopping list management functions (NOW USING SUPABASE) ---

    async function loadShoppingList() {
        if (!currentListId) {
            shoppingListDiv.innerHTML = '<p style="text-align: center; color: #C71585; margin-top: 0.5rem;">Connect to a list to see items.</p>';
            return;
        }

        const { data: items, error } = await supabase
            .from('items')
            .select('*')
            .eq('list_id', currentListId)
            .order('name', { ascending: true }); // Order alphabetically

        if (error) {
            console.error('Erreur lors du chargement de la liste de courses:', error);
            shoppingListDiv.innerHTML = '<p style="text-align: center; color: #DC143C;">Error loading list. Please try again.</p>';
            return;
        }

        shoppingListDiv.innerHTML = '';

        if (items.length === 0) {
            shoppingListDiv.innerHTML = '<p style="text-align: center; color: #C71585; margin-top: 0.5rem;">Your list is empty for now!</p>';
            return;
        }

        const currentCategoryOrder = JSON.parse(localStorage.getItem('category_order')) || getCategories();
        const categorizedItems = {};
        currentCategoryOrder.forEach(cat => categorizedItems[cat] = []);

        const itemsInOtherOrUncategorized = [];

        items.forEach(item => {
            const category = getCategoryForItem(item.name);
            if (currentCategoryOrder.includes(category)) {
                categorizedItems[category].push(item);
            } else {
                itemsInOtherOrUncategorized.push(item);
            }
        });

        currentCategoryOrder.forEach(category => {
            if (categorizedItems[category] && categorizedItems[category].length > 0) {
                const categoryHeader = document.createElement('h3');
                categoryHeader.style.color = '#E75480';
                categoryHeader.style.marginTop = '1rem';
                categoryHeader.textContent = category;
                shoppingListDiv.appendChild(categoryHeader);

                categorizedItems[category].forEach((item) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shopping-list-item';
                    itemDiv.innerHTML = `
                        <button class="decrement-btn" data-item-id="${item.id}">-</button>
                        <span class="quantity">${item.quantity}x</span>
                        <span>${item.name}</span>
                        <button class="delete-btn" data-item-id="${item.id}">✖</button>
                    `;
                    shoppingListDiv.appendChild(itemDiv);
                });
            }
        });

        if (itemsInOtherOrUncategorized.length > 0) {
            const otherCategoryHeader = document.createElement('h3');
            otherCategoryHeader.style.color = '#E75480';
            otherCategoryHeader.style.marginTop = '1rem';
            otherCategoryHeader.textContent = 'Autre / Non classé';
            shoppingListDiv.appendChild(otherCategoryHeader);

            itemsInOtherOrUncategorized.forEach((item) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shopping-list-item';
                itemDiv.innerHTML = `
                    <button class="decrement-btn" data-item-id="${item.id}">-</button>
                    <span class="quantity">${item.quantity}x</span>
                    <span>${item.name}</span>
                    <button class="delete-btn" data-item-id="${item.id}">✖</button>
                `;
                shoppingListDiv.appendChild(itemDiv);
            });
        }
    }

    async function addShoppingItem(itemName) {
      if (!itemName.trim() || !currentListId) return;

      const lowerCaseItemName = itemName.trim().toLowerCase();

      // Check if item already exists in DB for this list
      const { data: existingItems, error: fetchError } = await supabase
        .from('items')
        .select('id, quantity')
        .eq('list_id', currentListId)
        .ilike('name', lowerCaseItemName);

      if (fetchError) {
        console.error('Erreur lors de la recherche de l\'article:', fetchError);
        alert('Failed to check for existing item.');
        return;
      }

      if (existingItems && existingItems.length > 0) {
        const itemToUpdate = existingItems[0];
        const { error: updateError } = await supabase
          .from('items')
          .update({ quantity: itemToUpdate.quantity + 1 })
          .eq('id', itemToUpdate.id);

        if (updateError) {
          console.error('Erreur lors de l\'incrémentation de la quantité:', updateError);
          alert('Failed to update item quantity.');
        }
      } else {
        const { error: insertError } = await supabase
          .from('items')
          .insert([{ name: itemName.trim(), quantity: 1, list_id: currentListId }]);

        if (insertError) {
          console.error('Erreur lors de l\'ajout de l\'article:', insertError);
          alert('Failed to add new item.');
        }
      }
      // Realtime listener will handle reloading loadShoppingList()
    }

    async function decrementShoppingItemById(itemId) {
        const { data: item, error: fetchError } = await supabase
            .from('items')
            .select('quantity')
            .eq('id', itemId)
            .single();

        if (fetchError) {
            console.error('Erreur lors de la recherche de l\'article pour décrémenter:', fetchError);
            alert('Failed to find item to decrement.');
            return;
        }

        if (item.quantity > 1) {
            const { error: updateError } = await supabase
                .from('items')
                .update({ quantity: item.quantity - 1 })
                .eq('id', itemId);

            if (updateError) {
                console.error('Erreur lors de la décrémentation de la quantité:', updateError);
                alert('Failed to decrement item quantity.');
            }
        } else {
            // If quantity is 1, delete the item
            await deleteShoppingItemById(itemId);
        }
        // Realtime listener will handle reloading loadShoppingList()
    }

    async function deleteShoppingItemById(itemId) {
      const { error } = await supabase
        .from('items')
        .delete()
        .eq('id', itemId);

      if (error) {
        console.error('Erreur lors de la suppression de l\'article:', error);
        alert('Failed to delete item.');
      }
      // Realtime listener will handle reloading loadShoppingList()
    }

    function getCategoryForItem(itemName) {
        const suggestions = JSON.parse(localStorage.getItem('shopping_suggestions')) || [];
        const foundSuggestion = suggestions.find(sug => sug.name.toLowerCase() === itemName.toLowerCase());
        return foundSuggestion ? foundSuggestion.category : 'Autre';
    }

    // --- Suggestions management functions ---

    function loadSuggestions() {
      let allSuggestions = JSON.parse(localStorage.getItem('shopping_suggestions')) || [];
      suggestionsListDiv.innerHTML = '';

      const selectedCategory = categoryFilterSelect.value;
      
      let filteredSuggestions = selectedCategory === 'Toutes' 
        ? allSuggestions 
        : allSuggestions.filter(sug => sug.category === selectedCategory);

      // Sort filtered suggestions alphabetically
      filteredSuggestions.sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));

      if (filteredSuggestions.length === 0) {
          suggestionsListDiv.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #C71585;">No suggestions for this category. Add some below!</p>';
      }

      filteredSuggestions.forEach((suggestion) => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'suggestion-item';
        suggestionDiv.innerHTML = `
            <span class="suggestion-item-text">${suggestion.name}</span>
            <button class="delete-suggestion-btn" data-name="${suggestion.name}" data-category="${suggestion.category}">✖</button>
        `;
        
        suggestionDiv.querySelector('.suggestion-item-text').addEventListener('click', () => {
          addShoppingItem(suggestion.name); 
        });

        suggestionDiv.querySelector('.delete-suggestion-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            const nameToDelete = e.target.dataset.name;
            const categoryToDelete = e.target.dataset.category;
            if (confirm(`Delete suggestion "${nameToDelete}" (${categoryToDelete})?`)) {
                deleteSuggestion(nameToDelete, categoryToDelete);
            }
        });

        suggestionsListDiv.appendChild(suggestionDiv);
      });
    }

    function addSuggestion(suggestionName, category) {
      if (!suggestionName.trim() || !category.trim()) {
        alert('Please enter a suggestion name AND choose a category.');
        return;
      }

      let suggestions = JSON.parse(localStorage.getItem('shopping_suggestions')) || [];
      const lowerCaseSuggestionName = suggestionName.trim().toLowerCase();

      if (!suggestions.some(sug => sug.name.toLowerCase() === lowerCaseSuggestionName && sug.category === category)) {
          suggestions.push({ name: suggestionName.trim(), category: category.trim() });
          localStorage.setItem('shopping_suggestions', JSON.stringify(suggestions));
          loadSuggestions(); 
      } else {
          alert(`"${suggestionName.trim()}" is already a suggestion in the "${category}" category!`);
      }
    }

    function deleteSuggestion(name, category) {
        let suggestions = JSON.parse(localStorage.getItem('shopping_suggestions')) || [];
        const updatedSuggestions = suggestions.filter(sug => !(sug.name === name && sug.category === category));
        localStorage.setItem('shopping_suggestions', JSON.stringify(updatedSuggestions));
        loadSuggestions();
    }

    // --- Buy Later list management functions ---

    function loadBuyLaterList() {
        let items = JSON.parse(localStorage.getItem('buy_later_items')) || [];
        buyLaterListDiv.innerHTML = '';

        if (items.length === 0) {
            buyLaterListDiv.innerHTML = '<p style="text-align: center; color: #C71585; margin-top: 0.5rem;">Your "Buy Later" list is empty!</p>';
            return;
        }

        // Sort buy later items alphabetically
        items.sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));

        items.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'buy-later-item';
            // Use item name for deletion
            itemDiv.innerHTML = `
                <span>${item.name}</span>
                <button class="delete-btn" data-item-name="${item.name}">✖</button>
            `;
            buyLaterListDiv.appendChild(itemDiv);
        });
    }

    function addBuyLaterItem(itemName) {
        if (!itemName.trim()) return;

        let items = JSON.parse(localStorage.getItem('buy_later_items')) || [];
        if (!items.some(item => item.name.toLowerCase() === itemName.trim().toLowerCase())) {
            items.push({ name: itemName.trim() });
            localStorage.setItem('buy_later_items', JSON.stringify(items));
            loadBuyLaterList();
        } else {
            alert(`"${itemName.trim()}" is already in your "Buy Later" list!`);
        }
    }

    function deleteBuyLaterItemByName(itemName) {
        let items = JSON.parse(localStorage.getItem('buy_later_items')) || [];
        items = items.filter(item => item.name !== itemName);
        localStorage.setItem('buy_later_items', JSON.stringify(items));
        loadBuyLaterList();
    }

    // --- Category Order management functions (Drag and Drop) ---

    let draggedItem = null;
    let touchStartTimer = null; // Timer for long press
    const LONG_PRESS_THRESHOLD = 500; // ms for long press

    function loadCategoryOrder() {
        const allAvailableCategories = getCategories();
        let categoryOrder = JSON.parse(localStorage.getItem('category_order')) || allAvailableCategories;
        
        categoryOrder = categoryOrder.filter(cat => allAvailableCategories.includes(cat));
        categoryOrder = [...new Set(categoryOrder)];
        
        allAvailableCategories.forEach(cat => {
            if (!categoryOrder.includes(cat)) {
                categoryOrder.push(cat);
            }
        });

        categoryOrderList.innerHTML = '';

        if (categoryOrder.length === 0) {
            categoryOrderList.innerHTML = '<p style="text-align: center; color: #C71585; margin-top: 0.5rem;">No categories to order. Add some in "Manage Categories" below!</p>';
        } else {
            categoryOrder.forEach(category => {
                const li = document.createElement('li');
                li.textContent = category;
                li.setAttribute('draggable', true); // Keep for desktop
                li.dataset.category = category;
                li.innerHTML = `<span class="drag-handle">⠿</span> ${category}`;

                // Touch events for mobile (long press to drag)
                li.addEventListener('touchstart', (e) => {
                    e.stopPropagation(); // Prevent immediate text selection/scroll interference
                    if (touchStartTimer) clearTimeout(touchStartTimer);
                    
                    touchStartTimer = setTimeout(() => {
                        draggedItem = li;
                        li.classList.add('dragging');
                        // Optional: Add haptic feedback for long press
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, LONG_PRESS_THRESHOLD);
                }, { passive: false }); 

                li.addEventListener('touchmove', (e) => {
                    if (touchStartTimer) clearTimeout(touchStartTimer); // Cancel long press if moved
                    if (!draggedItem) return; // Only proceed if drag is active

                    e.preventDefault(); // Prevent scrolling while dragging
                    const touch = e.touches[0];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);
                    
                    if (target && target.closest('#categoryOrderList li') && target.closest('#categoryOrderList li') !== draggedItem) {
                        const draggingOver = target.closest('#categoryOrderList li');
                        const container = categoryOrderList;
                        const children = Array.from(container.children);

                        const draggingOverIndex = children.indexOf(draggingOver);
                        const draggedItemIndex = children.indexOf(draggedItem);

                        const rect = draggingOver.getBoundingClientRect();
                        const offset = touch.clientY - rect.top;

                        if (draggedItemIndex < draggingOverIndex) {
                            if (offset > rect.height / 2) {
                                container.insertBefore(draggedItem, draggingOver.nextSibling);
                            }
                        } else {
                            if (offset < rect.height / 2) {
                                container.insertBefore(draggedItem, draggingOver);
                            }
                        }
                    }
                }, { passive: false });

                li.addEventListener('touchend', () => {
                    if (touchStartTimer) clearTimeout(touchStartTimer);
                    if (draggedItem) {
                        draggedItem.classList.remove('dragging');
                        draggedItem = null;
                        saveCategoryOrder();
                        loadShoppingList();
                    }
                });

                // Standard desktop drag events
                li.addEventListener('dragstart', (e) => {
                    draggedItem = li;
                    setTimeout(() => li.classList.add('dragging'), 0);
                });

                li.addEventListener('dragend', () => {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                    saveCategoryOrder();
                    loadShoppingList();
                });

                li.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const draggingOver = li;
                    const container = categoryOrderList;
                    const children = Array.from(container.children);

                    if (draggedItem === draggingOver) return;

                    const draggingOverIndex = children.indexOf(draggingOver);
                    const draggedItemIndex = children.indexOf(draggedItem);

                    const rect = draggingOver.getBoundingClientRect();
                    const offset = e.clientY - rect.top;

                    if (draggedItemIndex < draggingOverIndex) {
                        if (offset > rect.height / 2) {
                            container.insertBefore(draggedItem, draggingOver.nextSibling);
                        }
                    } else {
                        if (offset < rect.height / 2) {
                            container.insertBefore(draggedItem, draggingOver);
                        }
                    }
                });

                categoryOrderList.appendChild(li);
            });
        }
        saveCategoryOrder();
        loadManageCategories();
    }

    function saveCategoryOrder() {
        const order = Array.from(categoryOrderList.children).map(li => li.dataset.category);
        localStorage.setItem('category_order', JSON.stringify(order));
    }


    // --- Section navigation functions ---
    function showSection(sectionToShow) {
        // Hide all sections
        shoppingListSection.classList.remove('active');
        suggestionsSection.classList.remove('active');
        categoryOrderSection.classList.remove('active');
        buyLaterSection.classList.remove('active');

        // Remove 'active' class from all navigation buttons
        showShoppingListBtn.classList.remove('active');
        showSuggestionsBtn.classList.remove('active');
        showCategoryOrderBtn.classList.remove('active');
        showBuyLaterBtn.classList.remove('active');

        // Show the desired section and update the active button
        if (sectionToShow === 'shoppingList') {
            shoppingListSection.classList.add('active');
            showShoppingListBtn.classList.add('active');
            loadShoppingList(); // Reload from DB
        } else if (sectionToShow === 'suggestions') {
            suggestionsSection.classList.add('active');
            showSuggestionsBtn.classList.add('active');
            updateAllCategorySelects();
            loadSuggestions();
        } else if (sectionToShow === 'categoryOrder') {
            categoryOrderSection.classList.add('active');
            showCategoryOrderBtn.classList.add('active');
            loadCategoryOrder();
        } else if (sectionToShow === 'buyLater') {
            buyLaterSection.classList.add('active');
            showBuyLaterBtn.classList.add('active');
            loadBuyLaterList();
        }
    }

    // --- Event handlers ---

    shoppingForm.addEventListener('submit', e => {
      e.preventDefault();
      addShoppingItem(newItemInput.value);
      newItemInput.value = '';
    });

    shoppingListDiv.addEventListener('click', e => {
      if (e.target.classList.contains('delete-btn')) {
        const itemId = e.target.dataset.itemId;
        deleteShoppingItemById(itemId);
      } else if (e.target.classList.contains('decrement-btn')) {
        const itemId = e.target.dataset.itemId;
        decrementShoppingItemById(itemId);
      }
    });

    addSuggestionForm.addEventListener('submit', e => {
      e.preventDefault();
      const newSugName = newSuggestionInput.value;
      const sugCategory = suggestionCategorySelect.value;
      
      if (!sugCategory) {
          alert("Please select a category for the suggestion.");
          return;
      }

      addSuggestion(newSugName, sugCategory);
      newSuggestionInput.value = '';
    });

    categoryFilterSelect.addEventListener('change', loadSuggestions);

    buyLaterForm.addEventListener('submit', e => {
        e.preventDefault();
        addBuyLaterItem(newBuyLaterItemInput.value);
        newBuyLaterItemInput.value = '';
    });

    buyLaterListDiv.addEventListener('click', e => {
        if (e.target.classList.contains('delete-btn')) {
            const itemName = e.target.dataset.itemName;
            deleteBuyLaterItemByName(itemName);
        }
    });

    addCategoryForm.addEventListener('submit', e => {
        e.preventDefault();
        addCategory(newCategoryNameInput.value);
    });

    manageCategoryList.addEventListener('click', e => {
        if (e.target.classList.contains('delete-category-btn')) {
            const categoryToDelete = e.target.dataset.category;
            deleteCategory(categoryToDelete);
        }
    });

    // Event handlers for navigation buttons
    showShoppingListBtn.addEventListener('click', () => showSection('shoppingList'));
    showSuggestionsBtn.addEventListener('click', () => showSection('suggestions'));
    showCategoryOrderBtn.addEventListener('click', () => showSection('categoryOrder'));
    showBuyLaterBtn.addEventListener('click', () => showSection('buyLater'));

    // Toggle options functionality
    let optionsVisible = true; // Start with options visible
    toggleOptionsBtn.addEventListener('click', () => {
        optionsVisible = !optionsVisible;
        if (optionsVisible) {
            navigationButtonsContainer.classList.add('show-options');
            toggleOptionsIcon.classList.remove('fa-chevron-down');
            toggleOptionsIcon.classList.add('fa-chevron-up');
        } else {
            navigationButtonsContainer.classList.remove('show-options');
            toggleOptionsIcon.classList.remove('fa-chevron-up');
            toggleOptionsIcon.classList.add('fa-chevron-down');
            // If the current section is one of the hidden ones, switch to "My List"
            if (!shoppingListSection.classList.contains('active')) {
                showSection('shoppingList');
            }
        }
    });

    // Event listener for the Connect/Create List button
    connectListBtn.addEventListener('click', handleConnectListBtnClick);


    // --- Initialization on page load ---
    window.addEventListener('load', () => {
      if (!localStorage.getItem('user_categories')) {
          localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
      }
      if (!localStorage.getItem('category_order')) {
          localStorage.setItem('category_order', JSON.stringify(getCategories()));
      }

      updateAllCategorySelects();
      loadSuggestions(); // Suggestions are still local
      loadBuyLaterList(); // Buy Later is still local
      loadCategoryOrder(); // Categories are still local

      showSection('shoppingList');
      // Ensure options are visible on initial load
      navigationButtonsContainer.classList.add('show-options');
      toggleOptionsIcon.classList.remove('fa-chevron-down');
      toggleOptionsIcon.classList.add('fa-chevron-up');

      // Prompt for share code as soon as the page loads
      promptForShareCode();
    });
  </script>
</body>
</html>