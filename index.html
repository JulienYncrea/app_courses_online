<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shopping List üõí</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 1rem;
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      cursor: pointer; /* Indicate clickable titles for scrolling */
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 6rem; /* Added space for bottom nav */
    }
    input[type="text"], input[type="number"], select, button {
      width: calc(100% - 20px);
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      background-color: #E75480;
      color: white;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #D4426A;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #f9f9f9;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      flex-wrap: wrap; /* Permet aux √©l√©ments de passer √† la ligne */
    }
    .item-info {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .item-actions, .category-actions, .suggestion-actions {
      display: flex;
      gap: 0.5rem; /* Espace entre les boutons */
      margin-top: 0.5rem; /* Espace si les boutons passent en dessous */
    }
    .item-actions button, .category-actions button, .suggestion-actions button {
      width: auto;
      padding: 0.5rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 0.4rem;
      margin-bottom: 0; /* Override default button margin */
    }
    
    /* Styles for discrete delete buttons */
    .discrete-remove-btn {
      background: none;
      border: none;
      color: #f44336;
      font-size: 1.2rem;
      padding: 0.2rem;
      cursor: pointer;
      width: auto; /* Override general button width */
    }
    .discrete-remove-btn:hover {
      color: #d32f2f;
      background: none;
    }

    .quantity-control {
        display: flex;
        align-items: center;
        gap: 0.2rem;
        margin-left: 0.5rem;
    }
    .quantity-control button {
        width: 30px;
        height: 30px;
        padding: 0;
        font-size: 1.2rem;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #ddd;
        color: #333;
    }
    .quantity-control button:hover {
        background-color: #ccc;
    }
    .quantity-control span {
        min-width: 20px;
        text-align: center;
        font-weight: bold;
    }

    /* Removed total-items CSS as the element is removed */

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #E75480;
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
    }
    .nav-item {
      color: white;
      text-align: center;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .nav-item i {
      font-size: 1.5rem;
      margin-bottom: 0.2rem;
    }
    .nav-item.active {
      font-weight: bold;
      color: #FAD0C4;
    }

    /* Style pour les sections cach√©es */
    .section.hidden {
      display: none;
    }

    /* Style pour la liste de suggestions */
    #suggestionList li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        cursor: pointer; /* Indiquer que l'√©l√©ment est cliquable */
    }
    #suggestionList .suggestion-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column; /* Nom et cat√©gorie sur des lignes diff√©rentes */
    }
    #suggestionList .suggestion-info .name {
        font-weight: bold;
    }
    #suggestionList .suggestion-info .category {
        font-size: 0.85em;
        color: #666;
    }

    /* Styles pour les titres de cat√©gorie dans la liste de courses */
    .section-container h3 {
        color: #E75480;
        border-bottom: 1px solid #FFD1DC;
        padding-bottom: 0.3rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div id="shoppingList" class="section-container section">
    <h1 id="shoppingListTitle">Ma Liste de Courses üõí</h1>
    
    <ul id="shoppingListToBuy" class="item-list"></ul>
    <div id="addItemForm">
        <h3>Ajouter un article</h3>
        <input type="text" id="newItemInput" placeholder="Ajouter un article" />
        <input type="number" id="newQuantityInput" placeholder="Quantit√© (optionnel)" value="1" min="1" />
        <select id="newCategorySelect"></select>
        <button id="addItemBtn">Ajouter √† la liste</button>
    </div>
  </div>

  <div id="buyLater" class="section-container section hidden">
    <h2>Acheter Plus Tard üõí</h2>
    <input type="text" id="newBuyLaterItemInput" placeholder="Article √† acheter plus tard" />
    <button id="addBuyLaterItemBtn">Ajouter</button>
    <ul id="buyLaterList"></ul>
  </div>

  <div id="suggestions" class="section-container section hidden">
    <h2 id="suggestionsTitle">Suggestions üí°</h2>
    <ul id="suggestionList"></ul> <h3>Ajouter une suggestion</h3>
    <input type="text" id="newSuggestionInput" placeholder="Sugg√©rer un article" />
    <select id="newSuggestionCategorySelect"></select>
    <button id="addSuggestionBtn">Ajouter Suggestion</button>
  </div>

  <div id="categories" class="section-container section hidden">
    <h2>G√©rer les Cat√©gories üìÇ</h2>
    <h3>Vos Cat√©gories</h3>
    <input type="text" id="newCategoryInput" placeholder="Nouvelle cat√©gorie" />
    <button id="addCategoryBtn">Ajouter Cat√©gorie</button>
    <ul id="categoryList"></ul>
    <h3>Ordre des Cat√©gories</h3>
    <ul id="categoryOrderList" class="sortable-list"></ul>
    <button id="saveCategoryOrderBtn">Sauvegarder Ordre</button>
  </div>

  <div id="settings" class="section-container section hidden">
    <h2>Param√®tres ‚öôÔ∏è</h2>
    <p>Code de la liste active : <strong id="activeShareCode">N/A</strong></p>
    <hr>
    <h3>Charger / Cr√©er une liste</h3>
    <input type="text" id="shareCodeInput" placeholder="Entrez un code de partage" />
    <button id="loadShareCodeBtn">Charger/Cr√©er Liste</button>
    <hr>
    <button id="changeShareCodeBtn">Changer de liste / D√©connecter</button>
  </div>


  <div class="bottom-nav">
    <div class="nav-item active" id="navShoppingList">
      <i class="fas fa-shopping-basket"></i>
      <span>Ma Liste</span>
    </div>
    <div class="nav-item" id="navBuyLater">
      <i class="fas fa-clock"></i>
      <span>Plus Tard</span>
    </div>
    <div class="nav-item" id="navSuggestions">
      <i class="fas fa-lightbulb"></i>
      <span>Suggestions</span>
    </div>
    <div class="nav-item" id="navCategories">
      <i class="fas fa-folder"></i>
      <span>Cat√©gories</span>
    </div>
    <div class="nav-item" id="navSettings">
      <i class="fas fa-cog"></i>
      <span>Param√®tres</span>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Configuration Supabase ---
    const SUPABASE_URL = 'https://cepqcretnxfhjbvdukkk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGbidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEEEOU';

    let supabase = null; // Sera initialis√© dans window.addEventListener('load')

    // --- Variables Globales ---
    let currentShareCode = null;
    let currentListId = null;
    const shoppingListToBuy = document.getElementById('shoppingListToBuy');
    // const totalRemainingItemsSpan = document.getElementById('totalRemainingItems'); // Removed
    const newItemInput = document.getElementById('newItemInput');
    const newQuantityInput = document.getElementById('newQuantityInput');
    const newCategorySelect = document.getElementById('newCategorySelect');
    const addItemBtn = document.getElementById('addItemBtn');
    const shoppingListTitle = document.getElementById('shoppingListTitle'); // Added for scroll
    
    // Moved to settings section
    const shareCodeInput = document.getElementById('shareCodeInput'); 
    const loadShareCodeBtn = document.getElementById('loadShareCodeBtn');
    const addItemForm = document.getElementById('addItemForm');

    // Sections
    const shoppingListSection = document.getElementById('shoppingList');
    const buyLaterSection = document.getElementById('buyLater');
    const suggestionsSection = document.getElementById('suggestions');
    const categoriesSection = document.getElementById('categories');
    const settingsSection = document.getElementById('settings');

    // Navigation
    const navShoppingList = document.getElementById('navShoppingList');
    const navBuyLater = document.getElementById('navBuyLater');
    const navSuggestions = document.getElementById('navSuggestions');
    const navCategories = document.getElementById('navCategories');
    const navSettings = document.getElementById('navSettings');

    // Buy Later section elements
    const newBuyLaterItemInput = document.getElementById('newBuyLaterItemInput');
    const addBuyLaterItemBtn = document.getElementById('addBuyLaterItemBtn');
    const buyLaterList = document.getElementById('buyLaterList');

    // Suggestions section elements
    const suggestionsTitle = document.getElementById('suggestionsTitle'); // Added for scroll
    const newSuggestionInput = document.getElementById('newSuggestionInput');
    const newSuggestionCategorySelect = document.getElementById('newSuggestionCategorySelect');
    const addSuggestionBtn = document.getElementById('addSuggestionBtn');
    const suggestionList = document.getElementById('suggestionList');

    // Categories section elements
    const newCategoryInput = document.getElementById('newCategoryInput');
    const addCategoryBtn = document = document.getElementById('addCategoryBtn');
    const categoryList = document.getElementById('categoryList');
    const categoryOrderList = document.getElementById('categoryOrderList');
    const saveCategoryOrderBtn = document.getElementById('saveCategoryOrderBtn');

    // Settings section elements
    const activeShareCodeSpan = document.getElementById('activeShareCode');
    const changeShareCodeBtn = document.getElementById('changeShareCodeBtn');


    // --- Cat√©gories par d√©faut ---
    const initialDefaultCategories = [
        "Fruits et L√©gumes",
        "Produits Laitiers",
        "Viandes et Poissons",
        "Produits d'√âpicerie",
        "Boulangerie",
        "Boissons",
        "Surgel√©s",
        "Entretien",
        "Hygi√®ne",
        "Autres"
    ];

    // --- Fonctions utilitaires ---
    function generateShareCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    async function handleInitialLoad() {
        let shareCode = localStorage.getItem('lastShareCode');
        if (shareCode) {
            shareCodeInput.value = shareCode; // Set the input in settings
            await getOrCreateListByShareCode(shareCode);
            showSection('shoppingList'); // Show shopping list if connected
        } else {
            // If no share code, go to settings for the user to enter one
            showSection('settings');
            // Optionally, pre-fill with a generated code to suggest creation
            shareCodeInput.value = generateShareCode(); 
            alert("Bienvenue ! Veuillez entrer un code de partage ou cliquez sur 'Charger/Cr√©er Liste' pour en g√©n√©rer un nouveau.");
        }
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');

        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.getElementById('nav' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1)).classList.add('active');

        // Sp√©cifique pour la section settings
        if (sectionId === 'settings') {
            activeShareCodeSpan.textContent = currentShareCode || 'N/A';
        }
        // Charger les donn√©es sp√©cifiques √† la section si n√©cessaire
        if (sectionId === 'buyLater') {
            loadBuyLaterList();
        } else if (sectionId === 'suggestions') {
            loadSuggestions();
        } else if (sectionId === 'categories') {
            renderCategories();
            loadCategoryOrder();
        }
    }

    function updateSupabaseHeaders(shareCode) {
        if (supabase && supabase.rest) {
            supabase.rest.headers['X-Share-Code'] = shareCode;
            console.log(`Supabase headers updated with X-Share-Code: ${shareCode}`);
        } else {
            console.warn("Supabase client non initialis√© ou rest client non pr√™t, impossible de mettre √† jour les headers.");
        }
    }

    function getCategories() {
        return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
        localStorage.setItem('user_categories', JSON.stringify(categories));
    }

    function updateAllCategorySelects() {
        const categories = getCategories();
        const selects = document.querySelectorAll('select#newCategorySelect, select#newSuggestionCategorySelect');
        selects.forEach(select => {
            select.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        });
        if (categories.length > 0) {
            newCategorySelect.value = categories[0];
            newSuggestionCategorySelect.value = categories[0];
        }
    }

    // --- Fonctions Supabase ---

    async function getOrCreateListByShareCode(code) {
        updateSupabaseHeaders(code);
        
        try {
            const { data: lists, error: selectError } = await supabase
                .from('lists')
                .select('id, name')
                .eq('share_code', code);

            if (selectError && selectError.code !== '406') {
                if (selectError.code === 'PGRST400' && selectError.message.includes('406')) {
                } else {
                  throw selectError;
                }
            }

            if (lists && lists.length > 0) {
                console.log(`Liste trouv√©e pour le code ${code}:`, lists[0]);
                currentListId = lists[0].id;
                currentShareCode = code;
                localStorage.setItem('lastShareCode', shareCodeInput.value); // Save on successful load
                // addItemForm.classList.remove('hidden'); // No longer hidden by default for shoppingList section
                setupRealtimeListener(currentListId);
                loadShoppingList();
                activeShareCodeSpan.textContent = currentShareCode; // Met √† jour l'affichage dans les param√®tres
                return lists[0];
            } else {
                console.log(`Aucune liste trouv√©e pour le code ${code}. Cr√©ation d'une nouvelle liste.`);
                const newList = {
                    name: `Liste ${code}`,
                    share_code: code
                };
                const { data: createdList, error: insertError } = await supabase
                    .from('lists')
                    .insert([newList])
                    .select('id, name');

                if (insertError) {
                    console.error("Erreur lors de la cr√©ation de la liste:", insertError);
                    alert("Erreur lors de la cr√©ation de la liste: " + insertError.message);
                    return null;
                } else {
                    console.log("Nouvelle liste cr√©√©e:", createdList[0]);
                    currentListId = createdList[0].id;
                    currentShareCode = code;
                    localStorage.setItem('lastShareCode', shareCodeInput.value); // Save on successful creation
                    // addItemForm.classList.remove('hidden'); // No longer hidden by default for shoppingList section
                    setupRealtimeListener(currentListId);
                    loadShoppingList();
                    activeShareCodeSpan.textContent = currentShareCode; // Met √† jour l'affichage dans les param√®tres
                    return createdList[0];
                }
            }
        } catch (error) {
            console.error("Erreur inattendue dans getOrCreateListByShareCode:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
            return null;
        }
    }

    async function updateItemQuantity(itemId, newQuantity) {
        if (!currentListId) return;

        if (newQuantity <= 0) {
            // Si la quantit√© est 0 ou moins, supprimer l'article
            await deleteItem(itemId);
            return;
        }

        try {
            const { data, error } = await supabase
                .from('list_items')
                .update({ quantity: newQuantity })
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la mise √† jour de la quantit√© de l'article:", error);
                alert("Erreur lors de la mise √† jour de la quantit√© de l'article: " + error.message);
            }
            // La liste sera recharg√©e par le listener Realtime
        } catch (error) {
            console.error("Erreur inattendue lors de la mise √† jour de la quantit√©:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function addItem(name, quantity, category, listId) {
        if (!listId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        try {
            // Check if item already exists in the current list
            const { data: existingItems, error: selectError } = await supabase
                .from('list_items')
                .select('id, quantity')
                .eq('list_id', listId)
                .eq('name', name)
                .eq('category', category); // Include category in check

            if (selectError) throw selectError;

            if (existingItems && existingItems.length > 0) {
                // Item exists, update its quantity
                const existingItem = existingItems[0];
                const newQuantity = existingItem.quantity + quantity;
                const { data, error: updateError } = await supabase
                    .from('list_items')
                    .update({ quantity: newQuantity })
                    .eq('id', existingItem.id);
                if (updateError) throw updateError;
                console.log(`Quantit√© de l'article '${name}' mise √† jour √† ${newQuantity}.`);
            } else {
                // Item does not exist, insert new
                const { data, error: insertError } = await supabase
                    .from('list_items')
                    .insert([{ name, quantity, category, list_id: listId }]);
                if (insertError) throw insertError;
                console.log(`Article '${name}' ajout√© √† la liste.`);
            }

            // Add category to local storage if it doesn't exist
            if (category) {
                const currentCategories = getCategories();
                if (!currentCategories.includes(category)) {
                    currentCategories.push(category);
                    saveCategories(currentCategories);
                    updateAllCategorySelects(); // Update category dropdowns
                    renderCategories(); // Re-render category list in 'G√©rer les Cat√©gories'
                    loadCategoryOrder(); // Update category order list
                }
            }

            newItemInput.value = '';
            newQuantityInput.value = '1';
        } catch (error) {
            console.error("Erreur lors de l'ajout/mise √† jour de l'article:", error);
            alert("Erreur lors de l'ajout/mise √† jour de l'article: " + error.message);
        }
    }
    
    async function deleteItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('list_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de l'article:", error);
                alert("Erreur lors de la suppression de l'article: " + error.message);
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadShoppingList() {
        if (!currentListId) {
            shoppingListToBuy.innerHTML = '';
            // totalRemainingItemsSpan.textContent = '0'; // Removed
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('list_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement de la liste de courses:", error);
                alert("Erreur lors du chargement de la liste: " + error.message);
                return;
            }

            shoppingListToBuy.innerHTML = '';
            // let remainingItems = 0; // Removed

            const categories = getCategories();
            const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || categories;

            const groupedItems = {};
            // Initialize groupedItems with all known categories in order
            categoryOrder.forEach(cat => groupedItems[cat] = []);
            // Add any existing categories from items that might not be in the current user_categories
            items.forEach(item => {
                const category = item.category || 'Autres';
                if (!groupedItems[category]) {
                    groupedItems[category] = [];
                }
            });

            items.forEach(item => {
                const category = item.category || 'Autres';
                groupedItems[category].push(item);
                // remainingItems++; // Removed
            });

            // Render items for each category
            categoryOrder.forEach(category => {
                if (groupedItems[category] && groupedItems[category].length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    groupedItems[category].forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });
            // Handle items with categories not in the current category order (e.g., deleted categories)
            Object.keys(groupedItems).filter(cat => !categoryOrder.includes(cat)).forEach(category => {
                if (groupedItems[category].length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    groupedItems[category].forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });
            
            // totalRemainingItemsSpan.textContent = remainingItems; // Removed
        } catch (error) {
            console.error("Erreur inattendue lors du chargement de la liste de courses:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    function renderListItem(item, listElement) {
        const li = document.createElement('li');
        li.dataset.id = item.id;

        const itemInfo = document.createElement('div');
        itemInfo.classList.add('item-info');

        const itemName = document.createElement('span');
        itemName.textContent = item.name;
        itemInfo.appendChild(itemName);

        const quantityControl = document.createElement('div');
        quantityControl.classList.add('quantity-control');

        const minusBtn = document.createElement('button');
        minusBtn.textContent = '-';
        minusBtn.onclick = () => updateItemQuantity(item.id, item.quantity - 1);
        quantityControl.appendChild(minusBtn);

        const quantitySpan = document.createElement('span');
        quantitySpan.textContent = item.quantity;
        quantityControl.appendChild(quantitySpan);

        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.onclick = () => updateItemQuantity(item.id, item.quantity + 1);
        quantityControl.appendChild(plusBtn);

        itemInfo.appendChild(quantityControl);
        li.appendChild(itemInfo);

        const itemActions = document.createElement('div');
        itemActions.classList.add('item-actions');

        const removeBtn = document.createElement('button');
        removeBtn.classList.add('discrete-remove-btn'); /* New class for discreet button */
        removeBtn.innerHTML = '<i class="fas fa-times"></i>'; /* Cross icon */
        removeBtn.onclick = () => deleteItem(item.id);
        itemActions.appendChild(removeBtn);

        li.appendChild(itemActions);
        listElement.appendChild(li);
    }

    function setupRealtimeListener() {
      if (window.supabaseChannel) {
          supabase.removeChannel(window.supabaseChannel);
      }

      if (!currentListId) {
          console.warn("Pas de currentListId d√©fini, impossible de configurer le listener Realtime.");
          return;
      }

      window.supabaseChannel = supabase.channel(`list_items_changes:${currentListId}`)
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'list_items',
            filter: `list_id=eq.${currentListId}`
        }, (payload) => {
            console.log('Changement Realtime d√©tect√©:', payload);
            loadShoppingList();
        })
        .subscribe();

        // Listener pour les changements sur buy_later_items
        window.supabaseBuyLaterChannel = supabase.channel(`buy_later_items_changes:${currentListId}`)
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'buy_later_items',
                filter: `list_id=eq.${currentListId}`
            }, (payload) => {
                console.log('Changement Buy Later Realtime d√©tect√©:', payload);
                if (document.getElementById('buyLater').classList.contains('hidden')) {
                  // Ne recharger que si la section est active pour √©viter des appels inutiles
                } else {
                  loadBuyLaterList();
                }
            })
            .subscribe();
        
      console.log(`Listeners Realtime configur√©s pour list_id: ${currentListId}`);
    }


    // --- Fonctions Buy Later ---
    async function addBuyLaterItem(name) {
        if (!currentListId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .insert([{ name, list_id: currentListId }]);
            if (error) {
                console.error("Erreur lors de l'ajout de l'article 'Acheter Plus Tard':", error);
                alert("Erreur lors de l'ajout de l'article 'Acheter Plus Tard': " + error.message);
            } else {
                newBuyLaterItemInput.value = '';
                // loadBuyLaterList est g√©r√© par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de l'ajout de l'article 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function deleteBuyLaterItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de l'article 'Acheter Plus Tard':", error);
                alert("Erreur lors de la suppression de l'article 'Acheter Plus Tard': " + error.message);
            } else {
                // loadBuyLaterList est g√©r√© par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression d'article 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadBuyLaterList() {
        if (!currentListId) {
            buyLaterList.innerHTML = '';
            return;
        }
        updateSupabaseHeaders(currentShareCode);

        try {
            const { data: items, error } = await supabase
                .from('buy_later_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement de la liste 'Acheter Plus Tard':", error);
                alert("Erreur lors du chargement de la liste 'Acheter Plus Tard': " + error.message);
                return;
            }

            buyLaterList.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.name;
                const removeBtn = document.createElement('button');
                removeBtn.classList.add('discrete-remove-btn');
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = () => deleteBuyLaterItem(item.id);
                li.appendChild(removeBtn);
                buyLaterList.appendChild(li);
            });
        } catch (error) {
            console.error("Erreur inattendue lors du chargement de la liste 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }


    // --- Fonctions Suggestions (Local Storage) ---

    // Local suggestions storage
    function getLocalSuggestions(listId) {
        if (!listId) return [];
        const key = `local_suggestions_${listId}`;
        return JSON.parse(localStorage.getItem(key)) || [];
    }

    function saveLocalSuggestions(listId, suggestions) {
        if (!listId) return;
        const key = `local_suggestions_${listId}`;
        localStorage.setItem(key, JSON.stringify(suggestions));
    }

    async function addSuggestion(name, category) {
        if (!currentListId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        const suggestions = getLocalSuggestions(currentListId);
        // Generate a simple unique ID for local items
        const newSuggestion = { id: Date.now(), name, category }; 
        suggestions.push(newSuggestion);
        saveLocalSuggestions(currentListId, suggestions);
        newSuggestionInput.value = '';
        loadSuggestions(); // Reload to update UI
    }

    async function deleteSuggestion(itemId) {
        if (!currentListId) return;
        let suggestions = getLocalSuggestions(currentListId);
        suggestions = suggestions.filter(item => item.id !== itemId);
        saveLocalSuggestions(currentListId, suggestions);
        loadSuggestions(); // Reload to update UI
    }

    async function loadSuggestions() {
        if (!currentListId) {
            suggestionList.innerHTML = '';
            return;
        }
        const items = getLocalSuggestions(currentListId);

        suggestionList.innerHTML = '';
        
        const categories = getCategories();
        const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || categories;

        const groupedItems = {};
        // Initialize groupedItems with all known categories in order
        categoryOrder.forEach(cat => groupedItems[cat] = []);
        // Add any existing categories from items that might not be in the current user_categories
        items.forEach(item => {
            const category = item.category || 'Autres';
            if (!groupedItems[category]) {
                groupedItems[category] = [];
            }
            groupedItems[category].push(item);
        });

        // Render items for each category, sorted
        categoryOrder.forEach(category => {
            if (groupedItems[category] && groupedItems[category].length > 0) {
                const categoryHeader = document.createElement('h3');
                categoryHeader.textContent = category;
                suggestionList.appendChild(categoryHeader);
                groupedItems[category].forEach(item => renderSuggestionItem(item, suggestionList));
            }
        });
        // Handle items with categories not in the current category order
        Object.keys(groupedItems).filter(cat => !categoryOrder.includes(cat)).forEach(category => {
            if (groupedItems[category].length > 0) {
                const categoryHeader = document.createElement('h3');
                categoryHeader.textContent = category;
                suggestionList.appendChild(categoryHeader);
                groupedItems[category].forEach(item => renderSuggestionItem(item, suggestionList));
            }
        });
    }

    function renderSuggestionItem(item, listElement) {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        li.style.cursor = 'pointer';

        const suggestionInfo = document.createElement('div');
        suggestionInfo.classList.add('suggestion-info');
        const nameSpan = document.createElement('span');
        nameSpan.classList.add('name');
        nameSpan.textContent = item.name;
        const categorySpan = document.createElement('span');
        categorySpan.classList.add('category');
        categorySpan.textContent = item.category ? `Cat√©gorie: ${item.category}` : 'Pas de cat√©gorie';
        suggestionInfo.appendChild(nameSpan);
        suggestionInfo.appendChild(categorySpan);
        li.appendChild(suggestionInfo);

        // Click handler for adding to main list and incrementing quantity
        li.onclick = async () => {
            await addItem(item.name, 1, item.category, currentListId);
        };

        const suggestionActions = document.createElement('div');
        suggestionActions.classList.add('suggestion-actions');

        const removeBtn = document.createElement('button');
        removeBtn.classList.add('discrete-remove-btn'); /* New class for discreet button */
        removeBtn.innerHTML = '<i class="fas fa-times"></i>'; /* Cross icon */
        removeBtn.onclick = (event) => {
            event.stopPropagation();
            deleteSuggestion(item.id);
        };
        suggestionActions.appendChild(removeBtn);

        li.appendChild(suggestionActions);
        listElement.appendChild(li);
    }


    // --- Fonctions Cat√©gories ---
    function renderCategories() {
        const categories = getCategories();
        categoryList.innerHTML = '';
        categories.forEach(cat => {
            const li = document.createElement('li');
            li.textContent = cat;
            
            const categoryActions = document.createElement('div');
            categoryActions.classList.add('category-actions');

            const removeBtn = document.createElement('button');
            removeBtn.classList.add('discrete-remove-btn'); /* New class for discreet button */
            removeBtn.innerHTML = '<i class="fas fa-times"></i>'; /* Cross icon */
            removeBtn.onclick = () => {
                if (confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${cat}" ? Les articles existants de cette cat√©gorie ne seront pas supprim√©s, mais leur cat√©gorie pourrait devenir "Autres".`)) {
                    const updatedCategories = categories.filter(c => c !== cat);
                    saveCategories(updatedCategories);
                    updateAllCategorySelects();
                    renderCategories();
                    loadCategoryOrder();
                    loadShoppingList(); // Recharger la liste pour refl√©ter le changement de cat√©gorie
                }
            };
            categoryActions.appendChild(removeBtn);
            li.appendChild(categoryActions); // Append actions to the li
            categoryList.appendChild(li);
        });
    }

    function addCategory() {
        const newCat = newCategoryInput.value.trim();
        if (newCat && !getCategories().includes(newCat)) {
            const categories = getCategories();
            categories.push(newCat);
            saveCategories(categories);
            newCategoryInput.value = '';
            updateAllCategorySelects();
            renderCategories();
            loadCategoryOrder();
        } else if (newCat) {
            alert("Cette cat√©gorie existe d√©j√†.");
        }
    }

    function loadCategoryOrder() {
        const categories = getCategories();
        const currentOrder = JSON.parse(localStorage.getItem('category_order')) || [];

        const filteredOrder = currentOrder.filter(cat => categories.includes(cat));
        const newCategories = categories.filter(cat => !filteredOrder.includes(cat));
        const finalOrder = [...filteredOrder, ...newCategories];

        localStorage.setItem('category_order', JSON.stringify(finalOrder));
        renderCategoryOrder(finalOrder);
    }

    function renderCategoryOrder(order) {
        categoryOrderList.innerHTML = '';
        order.forEach(cat => {
            const li = document.createElement('li');
            li.textContent = cat;
            li.dataset.category = cat;
            li.draggable = true;
            categoryOrderList.appendChild(li);
        });
        addDragAndDropListeners();
    }

    function addDragAndDropListeners() {
        let draggedItem = null;

        categoryOrderList.querySelectorAll('li').forEach(item => {
            item.addEventListener('dragstart', () => {
                draggedItem = item;
                setTimeout(() => item.style.display = 'none', 0);
            });

            item.addEventListener('dragend', () => {
                setTimeout(() => {
                    draggedItem.style.display = 'flex';
                    draggedItem = null;
                }, 0);
            });

            item.addEventListener('dragover', e => e.preventDefault());

            item.addEventListener('dragenter', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '#f0f0f0';
            });

            item.addEventListener('dragleave', function() {
                this.style.backgroundColor = '';
            });

            item.addEventListener('drop', function() {
                this.style.backgroundColor = '';
                if (draggedItem && draggedItem !== this) {
                    const thisIndex = Array.from(categoryOrderList.children).indexOf(this);
                    const draggedIndex = Array.from(categoryOrderList.children).indexOf(draggedItem);

                    if (thisIndex > draggedIndex) {
                        categoryOrderList.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        categoryOrderList.insertBefore(draggedItem, this);
                    }
                }
            });
        });
    }

    function saveCategoryOrder() {
        const newOrder = Array.from(categoryOrderList.children).map(li => li.dataset.category);
        localStorage.setItem('category_order', JSON.stringify(newOrder));
        alert("Ordre des cat√©gories sauvegard√© !");
        loadShoppingList();
    }

    // --- Listeners d'√©v√©nements ---
    loadShareCodeBtn.addEventListener('click', async () => {
        const code = shareCodeInput.value.trim();
        if (code) {
            await getOrCreateListByShareCode(code);
            if (currentListId) { // If successfully connected/created
                showSection('shoppingList'); // Go to My List
            }
        } else {
            alert("Veuillez entrer un code de partage.");
        }
    });

    addItemBtn.addEventListener('click', () => {
        const name = newItemInput.value.trim();
        const quantity = parseInt(newQuantityInput.value) || 1;
        const category = newCategorySelect.value;
        if (name && currentListId) {
            addItem(name, quantity, category, currentListId);
        } else if (!name) {
            alert("Veuillez entrer le nom de l'article.");
        }
    });

    // Navigation Buttons Listeners
    navShoppingList.addEventListener('click', () => showSection('shoppingList'));
    navBuyLater.addEventListener('click', () => showSection('buyLater'));
    navSuggestions.addEventListener('click', () => showSection('suggestions'));
    navCategories.addEventListener('click', () => showSection('categories'));
    navSettings.addEventListener('click', () => showSection('settings'));

    // Scroll to form listeners
    shoppingListTitle.addEventListener('click', () => {
        addItemForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    suggestionsTitle.addEventListener('click', () => {
        newSuggestionInput.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Buy Later Listeners
    addBuyLaterItemBtn.addEventListener('click', () => {
        const name = newBuyLaterItemInput.value.trim();
        if (name) {
            addBuyLaterItem(name);
        } else {
            alert("Veuillez entrer un article.");
        }
    });

    // Suggestions Listeners
    addSuggestionBtn.addEventListener('click', () => {
        const name = newSuggestionInput.value.trim();
        const category = newSuggestionCategorySelect.value; // R√©cup√®re la cat√©gorie de la suggestion
        if (name) {
            addSuggestion(name, category);
        } else {
            alert("Veuillez entrer une suggestion.");
        }
    });

    // Categories Listeners
    addCategoryBtn.addEventListener('click', addCategory);
    saveCategoryOrderBtn.addEventListener('click', saveCategoryOrder);

    // Settings Listeners
    changeShareCodeBtn.addEventListener('click', () => {
        if (confirm("Voulez-vous vraiment changer de liste ? Cela vous d√©connectera de la liste actuelle.")) {
            localStorage.removeItem('lastShareCode'); // Efface le code m√©moris√©
            location.reload(); // Recharge l'application pour redemander un code
        }
    });

    // --- Initialization on page load ---
    window.addEventListener('load', async () => {
      if (!localStorage.getItem('user_categories')) {
          localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
      }
      // Ensure category_order is initialized, and includes all current categories
      let currentCategoryOrder = JSON.parse(localStorage.getItem('category_order'));
      const allCategories = getCategories();
      if (!currentCategoryOrder || !allCategories.every(cat => currentCategoryOrder.includes(cat))) {
          localStorage.setItem('category_order', JSON.stringify(allCategories));
      }

      updateAllCategorySelects();
      
      // Initialisation du client Supabase
      if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("Supabase client initialized successfully.");
      } else {
          console.error("Erreur: La fonction 'createClient' de Supabase n'est pas d√©finie ou la biblioth√®que Supabase n'est pas charg√©e correctement.");
          alert("Erreur de chargement: La biblioth√®que Supabase n'a pas pu √™tre initialis√©e. V√©rifiez votre connexion internet ou la configuration.");
          return;
      }

      let attempts = 0;
      const maxAttempts = 20;
      const delayMs = 50;

      while (!supabase.rest && attempts < maxAttempts) {
          console.log(`Attente de supabase.rest (tentative ${attempts + 1}/${maxAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, delayMs));
          attempts++;
      }

      if (supabase.rest) {
          console.log("supabase.rest est maintenant pr√™t !");
          await handleInitialLoad();
      } else {
          console.error("Erreur: supabase.rest n'est pas devenu pr√™t apr√®s plusieurs tentatives. Impossible de d√©marrer l'application.");
          return;
      }
    });
  </script>
</body>
</html>