<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shopping List üõí</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 1rem;
      background: linear-gradient(to bottom right, #FAD0C4, #FFD1DC);
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #E75480;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .section-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    input[type="text"], input[type="number"], select, button {
      width: calc(100% - 20px);
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      background-color: #E75480;
      color: white;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #D4426A;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #f9f9f9;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    li.bought {
      text-decoration: line-through;
      color: #888;
      background-color: #e9e9e9;
    }
    .item-actions button {
      width: auto;
      padding: 0.5rem 0.8rem;
      margin-left: 0.5rem;
      font-size: 0.9rem;
      border-radius: 0.4rem;
    }
    .item-actions .remove-btn {
      background-color: #f44336;
    }
    .item-actions .remove-btn:hover {
      background-color: #d32f2f;
    }
    .item-actions .buy-btn {
      background-color: #4CAF50;
    }
    .item-actions .buy-btn:hover {
      background-color: #45a049;
    }
    .item-actions .undo-btn {
      background-color: #ff9800;
    }
    .item-actions .undo-btn:hover {
      background-color: #e68a00;
    }
    .hidden {
      display: none;
    }
    .tab-buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .tab-buttons button {
      flex: 1;
      margin: 0 0.2rem;
      background-color: #f0f0f0;
      color: #E75480;
      border: 1px solid #E75480;
    }
    .tab-buttons button.active {
      background-color: #E75480;
      color: white;
    }
    .total-items {
        text-align: right;
        font-weight: bold;
        margin-top: 1rem;
        color: #E75480;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #E75480;
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
    }
    .nav-item {
      color: white;
      text-align: center;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .nav-item i {
      font-size: 1.5rem;
      margin-bottom: 0.2rem;
    }
    .nav-item.active {
      font-weight: bold;
      color: #FAD0C4;
    }

    /* Styles pour la barre de navigation √©tendue */
    .navigation-buttons {
      position: fixed;
      bottom: 4.5rem; /* Juste au-dessus de la barre de navigation principale */
      left: 0;
      width: 100%;
      background-color: #FFF;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      padding: 0.5rem 0;
      z-index: 999;
      transform: translateY(100%); /* Masqu√© par d√©faut */
      transition: transform 0.3s ease-out;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      overflow: hidden; /* Cache le contenu qui d√©passe pendant l'animation */
    }

    .navigation-buttons.show-options {
      transform: translateY(0); /* Affiche la barre */
    }

    .navigation-buttons button {
        background: none;
        border: none;
        color: #E75480;
        padding: 0.8rem 1rem;
        text-align: left;
        width: 100%;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
    }

    .navigation-buttons button i {
        margin-right: 0.5rem;
        font-size: 1.2rem;
    }

    .navigation-buttons button:hover {
        background-color: #f0f0f0;
    }

    /* Ic√¥ne de la fl√®che de basculement */
    .toggle-options {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        padding: 0.2rem 0;
        background-color: #E75480; /* Couleur de la barre inf√©rieure */
        color: white;
        cursor: pointer;
        font-size: 1.2rem;
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
        position: absolute;
        top: -1.5rem; /* Pour chevaucher l√©g√®rement la barre √©tendue */
        left: 0;
        z-index: 1001; /* Au-dessus de tout */
    }
    .nav-item.options {
        position: relative; /* Pour positionner la fl√®che par rapport √† cet √©l√©ment */
    }

    /* Style pour les sections cach√©es */
    .section.hidden {
      display: none;
    }

  </style>
</head>
<body>
  <div id="shoppingList" class="section-container section">
    <h1>Ma Liste de Courses üõí</h1>
    <input type="text" id="shareCodeInput" placeholder="Entrez un code de partage" />
    <button id="loadShareCodeBtn">Charger/Cr√©er Liste</button>

    <div id="addItemForm" class="hidden">
        <input type="text" id="newItemInput" placeholder="Ajouter un article" />
        <input type="number" id="newQuantityInput" placeholder="Quantit√© (optionnel)" value="1" min="1" />
        <select id="newCategorySelect"></select>
        <button id="addItemBtn">Ajouter √† la liste</button>
    </div>
    
    <div class="tab-buttons" id="itemTabs">
      <button class="tab-btn active" data-tab="toBuy">√Ä Acheter</button>
      <button class="tab-btn" data-tab="bought">Achet√©s</button>
    </div>
    
    <ul id="shoppingListToBuy" class="item-list"></ul>
    <ul id="shoppingListBought" class="item-list hidden"></ul>

    <p class="total-items">Articles restants : <span id="totalRemainingItems">0</span></p>
  </div>

  <div id="buyLater" class="section-container section hidden">
    <h2>Acheter Plus Tard üõí</h2>
    <input type="text" id="newBuyLaterItemInput" placeholder="Article √† acheter plus tard" />
    <button id="addBuyLaterItemBtn">Ajouter</button>
    <ul id="buyLaterList"></ul>
  </div>

  <div id="suggestions" class="section-container section hidden">
    <h2>Suggestions üí°</h2>
    <input type="text" id="newSuggestionInput" placeholder="Sugg√©rer un article" />
    <button id="addSuggestionBtn">Ajouter Suggestion</button>
    <ul id="suggestionList"></ul>
  </div>

  <div id="categories" class="section-container section hidden">
    <h2>G√©rer les Cat√©gories üìÇ</h2>
    <input type="text" id="newCategoryInput" placeholder="Nouvelle cat√©gorie" />
    <button id="addCategoryBtn">Ajouter Cat√©gorie</button>
    <ul id="categoryList"></ul>
    <h3>Ordre des Cat√©gories</h3>
    <ul id="categoryOrderList" class="sortable-list"></ul>
    <button id="saveCategoryOrderBtn">Sauvegarder Ordre</button>
  </div>

  <div class="navigation-buttons">
    <button id="optionsMyListBtn"><i class="fas fa-shopping-basket"></i> Ma Liste</button>
    <button id="optionsBuyLaterBtn"><i class="fas fa-clock"></i> Acheter Plus Tard</button>
    <button id="optionsSuggestionsBtn"><i class="fas fa-lightbulb"></i> Suggestions</button>
    <button id="optionsCategoriesBtn"><i class="fas fa-folder"></i> G√©rer Cat√©gories</button>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" id="navShoppingList">
      <i class="fas fa-shopping-basket"></i>
      <span>Ma Liste</span>
    </div>
    <div class="nav-item" id="navBuyLater">
      <i class="fas fa-clock"></i>
      <span>Plus Tard</span>
    </div>
    <div class="nav-item" id="navSuggestions">
      <i class="fas fa-lightbulb"></i>
      <span>Suggestions</span>
    </div>
    <div class="nav-item" id="navCategories">
      <i class="fas fa-folder"></i>
      <span>Cat√©gories</span>
    </div>
    <div class="nav-item options" id="navOptions">
        <i class="fas fa-bars"></i>
        <span>Options</span>
        <i class="fas fa-chevron-down toggle-options" id="toggleOptionsIcon"></i>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Configuration Supabase ---
    const SUPABASE_URL = 'https://cepqcretnxfhjbvdukkk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcHFjcmV0bnhmaGpidmR1a2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTc1NDcsImV4cCI6MjA2NjE5MzU0N30.H56IGRN14FpfHXQVODKsmTbqMEe27_gcCcgGLphEEOU';

    let supabase = null; // Sera initialis√© dans window.addEventListener('load')

    // --- Variables Globales ---
    let currentShareCode = null;
    let currentListId = null;
    const shoppingListToBuy = document.getElementById('shoppingListToBuy');
    const shoppingListBought = document.getElementById('shoppingListBought');
    const totalRemainingItemsSpan = document.getElementById('totalRemainingItems');
    const newItemInput = document.getElementById('newItemInput');
    const newQuantityInput = document.getElementById('newQuantityInput');
    const newCategorySelect = document.getElementById('newCategorySelect');
    const addItemBtn = document.getElementById('addItemBtn');
    const shareCodeInput = document.getElementById('shareCodeInput');
    const loadShareCodeBtn = document.getElementById('loadShareCodeBtn');
    const addItemForm = document.getElementById('addItemForm');

    // Sections
    const shoppingListSection = document.getElementById('shoppingList');
    const buyLaterSection = document.getElementById('buyLater');
    const suggestionsSection = document.getElementById('suggestions');
    const categoriesSection = document.getElementById('categories');

    // Navigation
    const navShoppingList = document.getElementById('navShoppingList');
    const navBuyLater = document.getElementById('navBuyLater');
    const navSuggestions = document.getElementById('navSuggestions');
    const navCategories = document.getElementById('navCategories');
    const navOptions = document.getElementById('navOptions');
    const navigationButtonsContainer = document.querySelector('.navigation-buttons');
    const toggleOptionsIcon = document.getElementById('toggleOptionsIcon');

    // Options Navigation Buttons
    const optionsMyListBtn = document.getElementById('optionsMyListBtn');
    const optionsBuyLaterBtn = document.getElementById('optionsBuyLaterBtn');
    const optionsSuggestionsBtn = document.getElementById('optionsSuggestionsBtn');
    const optionsCategoriesBtn = document.getElementById('optionsCategoriesBtn');

    // Buy Later section elements
    const newBuyLaterItemInput = document.getElementById('newBuyLaterItemInput');
    const addBuyLaterItemBtn = document.getElementById('addBuyLaterItemBtn');
    const buyLaterList = document.getElementById('buyLaterList');

    // Suggestions section elements
    const newSuggestionInput = document.getElementById('newSuggestionInput');
    const addSuggestionBtn = document.getElementById('addSuggestionBtn');
    const suggestionList = document.getElementById('suggestionList');

    // Categories section elements
    const newCategoryInput = document.getElementById('newCategoryInput');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoryList = document.getElementById('categoryList');
    const categoryOrderList = document.getElementById('categoryOrderList');
    const saveCategoryOrderBtn = document.getElementById('saveCategoryOrderBtn');


    // --- Cat√©gories par d√©faut ---
    const initialDefaultCategories = [
        "Fruits et L√©gumes",
        "Produits Laitiers",
        "Viandes et Poissons",
        "Produits d'√âpicerie",
        "Boulangerie",
        "Boissons",
        "Surgel√©s",
        "Entretien",
        "Hygi√®ne",
        "Autres"
    ];

    // --- Fonctions utilitaires ---
    function generateShareCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');

        // Update active class for bottom navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.getElementById('nav' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1)).classList.add('active');
    }

    function updateSupabaseHeaders(shareCode) {
        console.log("Dans updateSupabaseHeaders:");
        console.log("supabase est :", supabase);
        console.log("supabase.postgrest est :", supabase ? supabase.postgrest : 'non d√©fini');

        if (supabase && supabase.postgrest) {
            supabase.postgrest.headers['X-Share-Code'] = shareCode;
            console.log(`Supabase headers updated with X-Share-Code: ${shareCode}`);
        } else {
            console.warn("Supabase client non initialis√© ou postgrest non pr√™t, impossible de mettre √† jour les headers.");
        }
    }

    function getCategories() {
        return JSON.parse(localStorage.getItem('user_categories')) || initialDefaultCategories;
    }

    function saveCategories(categories) {
        localStorage.setItem('user_categories', JSON.stringify(categories));
    }

    function updateAllCategorySelects() {
        const categories = getCategories();
        const selects = document.querySelectorAll('select#newCategorySelect');
        selects.forEach(select => {
            select.innerHTML = ''; // Clear existing options
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        });
        // Set initial selection to the first category if available
        if (categories.length > 0) {
            newCategorySelect.value = categories[0];
        }
    }

    // --- Fonctions Supabase ---

    async function getOrCreateListByShareCode(code) {
        updateSupabaseHeaders(code);
        
        try {
            // Tente de r√©cup√©rer la liste existante
            const { data: lists, error: selectError } = await supabase
                .from('lists')
                .select('id, name') // S√©lectionne l'ID et le nom de la liste
                .eq('share_code', code);

            if (selectError && selectError.code !== '406') { // Ignorer 406 car c'est une erreur RLS "pas trouv√©e"
                console.error("Erreur Supabase lors de la r√©cup√©ration de la liste:", selectError);
                // Si l'erreur n'est pas une violation RLS 406 (Not Acceptable), on la logue
                if (selectError.code === 'PGRST400' && selectError.message.includes('406')) {
                  // C'est l'erreur 406 cach√©e derri√®re PGRST400, on la g√®re
                  // On continue pour tenter de cr√©er la liste
                } else {
                  throw selectError; // Relancer d'autres types d'erreurs
                }
            }

            if (lists && lists.length > 0) {
                console.log(`Liste trouv√©e pour le code ${code}:`, lists[0]);
                currentListId = lists[0].id;
                currentShareCode = code;
                shareCodeInput.value = code; // Met √† jour l'input avec le code
                addItemForm.classList.remove('hidden'); // Affiche le formulaire d'ajout
                // Initialise le listener Realtime pour cette liste
                setupRealtimeListener(currentListId);
                loadShoppingList(); // Charge les articles de la liste existante
                return lists[0];
            } else {
                console.log(`Aucune liste trouv√©e pour le code ${code}. Cr√©ation d'une nouvelle liste.`);
                const newList = {
                    name: `Liste ${code}`, // Nom par d√©faut
                    share_code: code
                };
                const { data: createdList, error: insertError } = await supabase
                    .from('lists')
                    .insert([newList])
                    .select('id, name'); // S'assurer de s√©lectionner l'ID

                if (insertError) {
                    console.error("Erreur lors de la cr√©ation de la liste:", insertError);
                    alert("Erreur lors de la cr√©ation de la liste: " + insertError.message);
                    return null;
                } else {
                    console.log("Nouvelle liste cr√©√©e:", createdList[0]);
                    currentListId = createdList[0].id;
                    currentShareCode = code;
                    shareCodeInput.value = code;
                    addItemForm.classList.remove('hidden');
                    // Initialise le listener Realtime pour cette nouvelle liste
                    setupRealtimeListener(currentListId);
                    loadShoppingList(); // Charge la liste vide (nouvellement cr√©√©e)
                    return createdList[0];
                }
            }
        } catch (error) {
            console.error("Erreur inattendue dans getOrCreateListByShareCode:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
            return null;
        }
    }

    async function addItem(name, quantity, category, listId) {
        if (!listId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('list_items')
                .insert([{ name, quantity, category, list_id: listId, bought: false }]);
            if (error) {
                console.error("Erreur lors de l'ajout de l'article:", error);
                alert("Erreur lors de l'ajout de l'article: " + error.message);
            } else {
                newItemInput.value = '';
                newQuantityInput.value = '1';
                // La liste sera recharg√©e par le listener Realtime
            }
        } catch (error) {
            console.error("Erreur inattendue lors de l'ajout de l'article:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function updateItemStatus(itemId, status) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('list_items')
                .update({ bought: status })
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la mise √† jour du statut de l'article:", error);
                alert("Erreur lors de la mise √† jour du statut de l'article: " + error.message);
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la mise √† jour du statut:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function deleteItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('list_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de l'article:", error);
                alert("Erreur lors de la suppression de l'article: " + error.message);
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadShoppingList() {
        if (!currentListId) {
            shoppingListToBuy.innerHTML = '';
            shoppingListBought.innerHTML = '';
            totalRemainingItemsSpan.textContent = '0';
            return;
        }
        updateSupabaseHeaders(currentShareCode); // S'assurer que l'en-t√™te est mis √† jour avant le select

        try {
            const { data: items, error } = await supabase
                .from('list_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true }); // Trier par ID pour un ordre stable

            if (error) {
                console.error("Erreur lors du chargement de la liste de courses:", error);
                alert("Erreur lors du chargement de la liste: " + error.message);
                return;
            }

            shoppingListToBuy.innerHTML = '';
            shoppingListBought.innerHTML = '';
            let remainingItems = 0;

            const categories = getCategories();
            const categoryOrder = JSON.parse(localStorage.getItem('category_order')) || categories;

            // Group items by category
            const groupedItems = {};
            categoryOrder.forEach(cat => groupedItems[cat] = { toBuy: [], bought: [] });

            items.forEach(item => {
                const category = item.category || 'Autres'; // Default to 'Autres' if category is null/undefined
                if (!groupedItems[category]) {
                    // Handle categories not in user_categories (e.g., deleted category)
                    groupedItems[category] = { toBuy: [], bought: [] };
                }

                if (item.bought) {
                    groupedItems[category].bought.push(item);
                } else {
                    groupedItems[category].toBuy.push(item);
                    remainingItems++;
                }
            });

            // Render items in category order
            categoryOrder.forEach(category => {
                // Render "To Buy" items for this category
                if (groupedItems[category] && groupedItems[category].toBuy.length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListToBuy.appendChild(categoryHeader);
                    groupedItems[category].toBuy.forEach(item => renderListItem(item, shoppingListToBuy));
                }
            });

            // Render "Bought" items for this category
            categoryOrder.forEach(category => {
                if (groupedItems[category] && groupedItems[category].bought.length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category;
                    shoppingListBought.appendChild(categoryHeader);
                    groupedItems[category].bought.forEach(item => renderListItem(item, shoppingListBought));
                }
            });

            totalRemainingItemsSpan.textContent = remainingItems;
            updateTabCounts();

        } catch (error) {
            console.error("Erreur inattendue lors du chargement de la liste de courses:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    function renderListItem(item, listElement) {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        li.classList.toggle('bought', item.bought);

        const itemName = document.createElement('span');
        itemName.textContent = `${item.name} (${item.quantity})`;
        li.appendChild(itemName);

        const itemActions = document.createElement('div');
        itemActions.classList.add('item-actions');

        if (item.bought) {
            const undoBtn = document.createElement('button');
            undoBtn.textContent = 'Annuler';
            undoBtn.classList.add('undo-btn');
            undoBtn.onclick = () => updateItemStatus(item.id, false);
            itemActions.appendChild(undoBtn);
        } else {
            const buyBtn = document.createElement('button');
            buyBtn.textContent = 'Acheter';
            buyBtn.classList.add('buy-btn');
            buyBtn.onclick = () => updateItemStatus(item.id, true);
            itemActions.appendChild(buyBtn);
        }

        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Supprimer';
        removeBtn.classList.add('remove-btn');
        removeBtn.onclick = () => deleteItem(item.id);
        itemActions.appendChild(removeBtn);

        li.appendChild(itemActions);
        listElement.appendChild(li);
    }

    function setupRealtimeListener() {
      // Si un listener existe d√©j√†, le supprimer pour √©viter les doublons
      if (window.supabaseChannel) {
          supabase.removeChannel(window.supabaseChannel);
      }

      if (!currentListId) {
          console.warn("Pas de currentListId d√©fini, impossible de configurer le listener Realtime.");
          return;
      }

      // Cr√©er un nouveau canal sp√©cifique √† la liste_id
      window.supabaseChannel = supabase.channel(`list_items_changes:${currentListId}`)
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'list_items',
            filter: `list_id=eq.${currentListId}` // Filtrer les √©v√©nements par list_id
        }, (payload) => {
            console.log('Changement Realtime d√©tect√©:', payload);
            loadShoppingList(); // Recharger la liste quand un changement survient
        })
        .subscribe();

      console.log(`Listener Realtime configur√© pour list_id: ${currentListId}`);
    }


    // --- Fonctions Buy Later ---
    async function addBuyLaterItem(name) {
        if (!currentListId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .insert([{ name, list_id: currentListId }]);
            if (error) {
                console.error("Erreur lors de l'ajout de l'article 'Acheter Plus Tard':", error);
                alert("Erreur lors de l'ajout de l'article 'Acheter Plus Tard': " + error.message);
            } else {
                newBuyLaterItemInput.value = '';
                loadBuyLaterList();
            }
        } catch (error) {
            console.error("Erreur inattendue lors de l'ajout de l'article 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function deleteBuyLaterItem(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('buy_later_items')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de l'article 'Acheter Plus Tard':", error);
                alert("Erreur lors de la suppression de l'article 'Acheter Plus Tard': " + error.message);
            } else {
                loadBuyLaterList();
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression d'article 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadBuyLaterList() {
        if (!currentListId) {
            buyLaterList.innerHTML = '';
            return;
        }
        updateSupabaseHeaders(currentShareCode); // Assurez-vous que l'en-t√™te est mis √† jour

        try {
            const { data: items, error } = await supabase
                .from('buy_later_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement de la liste 'Acheter Plus Tard':", error);
                alert("Erreur lors du chargement de la liste 'Acheter Plus Tard': " + error.message);
                return;
            }

            buyLaterList.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.name;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Supprimer';
                removeBtn.classList.add('remove-btn');
                removeBtn.onclick = () => deleteBuyLaterItem(item.id);
                li.appendChild(removeBtn);
                buyLaterList.appendChild(li);
            });
        } catch (error) {
            console.error("Erreur inattendue lors du chargement de la liste 'Acheter Plus Tard':", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }


    // --- Fonctions Suggestions ---
    async function addSuggestion(name) {
        if (!currentListId) {
            alert("Veuillez charger ou cr√©er une liste d'abord.");
            return;
        }
        try {
            const { data, error } = await supabase
                .from('suggestions')
                .insert([{ name, list_id: currentListId }]);
            if (error) {
                console.error("Erreur lors de l'ajout de la suggestion:", error);
                alert("Erreur lors de l'ajout de la suggestion: " + error.message);
            } else {
                newSuggestionInput.value = '';
                loadSuggestions();
            }
        } catch (error) {
            console.error("Erreur inattendue lors de l'ajout de la suggestion:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function deleteSuggestion(itemId) {
        if (!currentListId) return;
        try {
            const { data, error } = await supabase
                .from('suggestions')
                .delete()
                .eq('id', itemId);
            if (error) {
                console.error("Erreur lors de la suppression de la suggestion:", error);
                alert("Erreur lors de la suppression de la suggestion: " + error.message);
            } else {
                loadSuggestions();
            }
        } catch (error) {
            console.error("Erreur inattendue lors de la suppression de suggestion:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }

    async function loadSuggestions() {
        if (!currentListId) {
            suggestionList.innerHTML = '';
            return;
        }
        updateSupabaseHeaders(currentShareCode); // Assurez-vous que l'en-t√™te est mis √† jour

        try {
            const { data: items, error } = await supabase
                .from('suggestions')
                .select('*')
                .eq('list_id', currentListId)
                .order('id', { ascending: true });

            if (error) {
                console.error("Erreur lors du chargement des suggestions:", error);
                alert("Erreur lors du chargement des suggestions: " + error.message);
                return;
            }

            suggestionList.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.name;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Supprimer';
                removeBtn.classList.add('remove-btn');
                removeBtn.onclick = () => deleteSuggestion(item.id);
                li.appendChild(removeBtn);
                suggestionList.appendChild(li);
            });
        } catch (error) {
            console.error("Erreur inattendue lors du chargement des suggestions:", error);
            alert("Une erreur inattendue est survenue: " + error.message);
        }
    }


    // --- Fonctions Cat√©gories ---
    function renderCategories() {
        const categories = getCategories();
        categoryList.innerHTML = '';
        categories.forEach(cat => {
            const li = document.createElement('li');
            li.textContent = cat;
            if (!initialDefaultCategories.includes(cat)) { // Allow removal only for custom categories
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Supprimer';
                removeBtn.classList.add('remove-btn');
                removeBtn.onclick = () => {
                    if (confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${cat}" ? Les articles existants de cette cat√©gorie ne seront pas supprim√©s, mais leur cat√©gorie pourrait devenir "Autres".`)) {
                        const updatedCategories = categories.filter(c => c !== cat);
                        saveCategories(updatedCategories);
                        updateAllCategorySelects();
                        renderCategories();
                        loadCategoryOrder(); // Update order list after removal
                    }
                };
                li.appendChild(removeBtn);
            }
            categoryList.appendChild(li);
        });
    }

    function addCategory() {
        const newCat = newCategoryInput.value.trim();
        if (newCat && !getCategories().includes(newCat)) {
            const categories = getCategories();
            categories.push(newCat);
            saveCategories(categories);
            newCategoryInput.value = '';
            updateAllCategorySelects();
            renderCategories();
            loadCategoryOrder(); // Add new category to sortable list
        } else if (newCat) {
            alert("Cette cat√©gorie existe d√©j√†.");
        }
    }

    function loadCategoryOrder() {
        const categories = getCategories();
        const currentOrder = JSON.parse(localStorage.getItem('category_order')) || [];

        // Filter out deleted categories and add new ones to the end
        const filteredOrder = currentOrder.filter(cat => categories.includes(cat));
        const newCategories = categories.filter(cat => !filteredOrder.includes(cat));
        const finalOrder = [...filteredOrder, ...newCategories];

        localStorage.setItem('category_order', JSON.stringify(finalOrder));
        renderCategoryOrder(finalOrder);
    }

    function renderCategoryOrder(order) {
        categoryOrderList.innerHTML = '';
        order.forEach(cat => {
            const li = document.createElement('li');
            li.textContent = cat;
            li.dataset.category = cat;
            li.draggable = true;
            categoryOrderList.appendChild(li);
        });
        addDragAndDropListeners();
    }

    function addDragAndDropListeners() {
        let draggedItem = null;

        categoryOrderList.querySelectorAll('li').forEach(item => {
            item.addEventListener('dragstart', () => {
                draggedItem = item;
                setTimeout(() => item.style.display = 'none', 0);
            });

            item.addEventListener('dragend', () => {
                setTimeout(() => {
                    draggedItem.style.display = 'flex'; // Restore display after drop
                    draggedItem = null;
                }, 0);
            });

            item.addEventListener('dragover', e => e.preventDefault());

            item.addEventListener('dragenter', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '#f0f0f0';
            });

            item.addEventListener('dragleave', function() {
                this.style.backgroundColor = '';
            });

            item.addEventListener('drop', function() {
                this.style.backgroundColor = '';
                if (draggedItem && draggedItem !== this) {
                    const thisIndex = Array.from(categoryOrderList.children).indexOf(this);
                    const draggedIndex = Array.from(categoryOrderList.children).indexOf(draggedItem);

                    if (thisIndex > draggedIndex) {
                        categoryOrderList.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        categoryOrderList.insertBefore(draggedItem, this);
                    }
                }
            });
        });
    }

    function saveCategoryOrder() {
        const newOrder = Array.from(categoryOrderList.children).map(li => li.dataset.category);
        localStorage.setItem('category_order', JSON.stringify(newOrder));
        alert("Ordre des cat√©gories sauvegard√© !");
        loadShoppingList(); // Recharger la liste pour appliquer le nouvel ordre
    }

    // --- Gestion des onglets Achet√©s/√Ä Acheter ---
    function updateTabCounts() {
        const toBuyCount = shoppingListToBuy.querySelectorAll('li:not(.bought)').length;
        const boughtCount = shoppingListBought.querySelectorAll('li.bought').length;

        document.querySelector('.tab-btn[data-tab="toBuy"]').textContent = `√Ä Acheter (${toBuyCount})`;
        document.querySelector('.tab-btn[data-tab="bought"]').textContent = `Achet√©s (${boughtCount})`;
    }

    // --- Listeners d'√©v√©nements ---
    loadShareCodeBtn.addEventListener('click', () => {
        const code = shareCodeInput.value.trim();
        if (code) {
            getOrCreateListByShareCode(code);
        } else {
            alert("Veuillez entrer un code de partage.");
        }
    });

    addItemBtn.addEventListener('click', () => {
        const name = newItemInput.value.trim();
        const quantity = parseInt(newQuantityInput.value) || 1;
        const category = newCategorySelect.value;
        if (name && currentListId) {
            addItem(name, quantity, category, currentListId);
        } else if (!name) {
            alert("Veuillez entrer le nom de l'article.");
        }
    });

    document.getElementById('itemTabs').addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-btn')) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            const tab = e.target.dataset.tab;
            if (tab === 'toBuy') {
                shoppingListToBuy.classList.remove('hidden');
                shoppingListBought.classList.add('hidden');
            } else {
                shoppingListToBuy.classList.add('hidden');
                shoppingListBought.classList.remove('hidden');
            }
        }
    });

    // Navigation Buttons Listeners
    navShoppingList.addEventListener('click', () => showSection('shoppingList'));
    navBuyLater.addEventListener('click', () => showSection('buyLater'));
    navSuggestions.addEventListener('click', () => showSection('suggestions'));
    navCategories.addEventListener('click', () => showSection('categories'));

    navOptions.addEventListener('click', () => {
        // Toggle visibility of the extended navigation buttons
        navigationButtonsContainer.classList.toggle('show-options');
        toggleOptionsIcon.classList.toggle('fa-chevron-down');
        toggleOptionsIcon.classList.toggle('fa-chevron-up');

        // If the navigation buttons are shown, and the current section is one of the hidden ones, switch to "My List"
        // This prevents the main content from being obscured when opening the menu
        if (navigationButtonsContainer.classList.contains('show-options')) {
            if (buyLaterSection.classList.contains('active') || suggestionsSection.classList.contains('active') || categoriesSection.classList.contains('active')) {
                showSection('shoppingList'); // Or any default visible section
            }
        } else {
            // If the current section is one of the hidden ones, switch to "My List"
            if (!shoppingListSection.classList.contains('active')) {
                showSection('shoppingList');
            }
        }
    });

    // Options menu buttons
    optionsMyListBtn.addEventListener('click', () => {
        showSection('shoppingList');
        navigationButtonsContainer.classList.remove('show-options');
        toggleOptionsIcon.classList.remove('fa-chevron-up');
        toggleOptionsIcon.classList.add('fa-chevron-down');
    });

    optionsBuyLaterBtn.addEventListener('click', () => {
        showSection('buyLater');
        navigationButtonsContainer.classList.remove('show-options');
        toggleOptionsIcon.classList.remove('fa-chevron-up');
        toggleOptionsIcon.classList.add('fa-chevron-down');
    });

    optionsSuggestionsBtn.addEventListener('click', () => {
        showSection('suggestions');
        navigationButtonsContainer.classList.remove('show-options');
        toggleOptionsIcon.classList.remove('fa-chevron-up');
        toggleOptionsIcon.classList.add('fa-chevron-down');
    });

    optionsCategoriesBtn.addEventListener('click', () => {
        showSection('categories');
        navigationButtonsContainer.classList.remove('show-options');
        toggleOptionsIcon.classList.remove('fa-chevron-up');
        toggleOptionsIcon.classList.add('fa-chevron-down');
    });


    // Buy Later Listeners
    addBuyLaterItemBtn.addEventListener('click', () => {
        const name = newBuyLaterItemInput.value.trim();
        if (name) {
            addBuyLaterItem(name);
        } else {
            alert("Veuillez entrer un article.");
        }
    });

    // Suggestions Listeners
    addSuggestionBtn.addEventListener('click', () => {
        const name = newSuggestionInput.value.trim();
        if (name) {
            addSuggestion(name);
        } else {
            alert("Veuillez entrer une suggestion.");
        }
    });

    // Categories Listeners
    addCategoryBtn.addEventListener('click', addCategory);
    saveCategoryOrderBtn.addEventListener('click', saveCategoryOrder);


    // --- Initialization on page load ---
    window.addEventListener('load', async () => {
      // Initialize local storage defaults
      if (!localStorage.getItem('user_categories')) {
          localStorage.setItem('user_categories', JSON.stringify(initialDefaultCategories));
      }
      if (!localStorage.getItem('category_order')) {
          localStorage.setItem('category_order', JSON.stringify(getCategories()));
      }

      // Update UI elements based on local storage
      updateAllCategorySelects();
      loadSuggestions(); // Might load from DB later
      loadBuyLaterList(); // Might load from DB later
      loadCategoryOrder(); 

      // Initialisation du client Supabase
      if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("Supabase client initialized successfully.");
      } else {
          console.error("Erreur: La fonction 'createClient' de Supabase n'est pas d√©finie ou la biblioth√®que Supabase n'est pas charg√©e correctement.");
          alert("Erreur de chargement: La biblioth√®que Supabase n'a pas pu √™tre initialis√©e. V√©rifiez votre connexion internet ou la configuration.");
          return; // Arr√™ter l'ex√©cution si Supabase n'est pas initialis√©
      }

      // --- NOUVEAU CODE : Attendre que supabase.postgrest soit pr√™t ---
      let attempts = 0;
      const maxAttempts = 20; // Essayer jusqu'√† 20 fois
      const delayMs = 50;     // Attendre 50ms entre chaque tentative

      while (!supabase.postgrest && attempts < maxAttempts) {
          console.log(`Attente de supabase.postgrest (tentative ${attempts + 1}/${maxAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, delayMs));
          attempts++;
      }

      if (supabase.postgrest) {
          console.log("supabase.postgrest est maintenant pr√™t !");
          // Appeler les fonctions qui d√©pendent de Supabase ici
          await promptForShareCode(); // Appelez ceci APR√àS que postgrest soit pr√™t
      } else {
          console.error("Erreur: supabase.postgrest n'est pas devenu pr√™t apr√®s plusieurs tentatives. Impossible de d√©marrer l'application.");
          // G√©rer l'erreur, par exemple afficher un message √† l'utilisateur
          return;
      }
      // --- FIN NOUVEAU CODE ---

      // IMPORTANT : Initialise le listener Realtime de Supabase
      // setupRealtimeListener() doit √™tre appel√© APR√àS qu'une liste soit charg√©e/cr√©√©e (dans getOrCreateListByShareCode)
      // et donc apr√®s que currentListId soit d√©fini.
      // Il a √©t√© d√©plac√© dans getOrCreateListByShareCode.

      // loadShoppingList() est maintenant appel√©e apr√®s la cr√©ation/chargement de la liste dans getOrCreateListByShareCode.

      showSection('shoppingList');
      // Ensure options are hidden on initial load and arrow points down
      navigationButtonsContainer.classList.remove('show-options');
      toggleOptionsIcon.classList.remove('fa-chevron-up');
      toggleOptionsIcon.classList.add('fa-chevron-down');
    });
  </script>
</body>
</html>